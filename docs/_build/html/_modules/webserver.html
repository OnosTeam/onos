

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>webserver &mdash; ONOS  documentation</title>
  

  
  

  
  <link href='https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700' rel='stylesheet' type='text/css'>

  
  
    

  

  
  
    <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  

  
    <link rel="top" title="ONOS  documentation" href="../index.html"/>
        <link rel="up" title="Module code" href="index.html"/> 

  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/modernizr/2.6.2/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-nav-search">
        <a href="../index.html" class="fa fa-home"> ONOS</a>
        <div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
        
        
            <ul>
<li class="toctree-l1"><a class="reference internal" href="../arduino_handler.html">arduino_handler module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../arduinoserial.html">arduinoserial module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../conf.html">conf module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../globalVar.html">globalVar module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../hw_node.html">hw_node module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../mail_agent.html">mail_agent module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../node_query_handler.html">node_query_handler module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../pcduino.html">pcduino module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../router_handler.html">router_handler module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../time_zone.html">time_zone module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../web_object.html">web_object module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../webserver.html">webserver module</a></li>
</ul>

        
      </div>
      &nbsp;
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../index.html">ONOS</a>
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../index.html">Docs</a> &raquo;</li>
      
          <li><a href="index.html">Module code</a> &raquo;</li>
      
    <li>webserver</li>
      <li class="wy-breadcrumbs-aside">
        
      </li>
  </ul>
  <hr/>
</div>
          <div role="main">
            
  <h1>Source code for webserver</h1><div class="highlight"><pre>
<span class="c">#   Copyright 2014 Marco Rigoni                                               #</span>
<span class="c">#   ElettronicaOpenSource.com   elettronicaopensource@gmail.com               #</span>
<span class="c">#   This program is free software: you can redistribute it and/or modify      #</span>
<span class="c">#   it under the terms of the GNU General Public License as published by      #</span>
<span class="c">#   the Free Software Foundation, either version 3 of the License, or         #</span>
<span class="c">#   (at your option) any later version.                                       # </span>
<span class="c">#																			  #</span>
<span class="c">#   This program is distributed in the hope that it will be useful,           #</span>
<span class="c">#   but WITHOUT ANY WARRANTY; without even the implied warranty of            #</span>
<span class="c">#   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the             #</span>
<span class="c">#   GNU General Public License for more details.                              #</span>
<span class="c">#                                                                             #</span>
<span class="c">#   You should have received a copy of the GNU General Public License         #</span>
<span class="c">#   along with this program.  If not, see &lt;http://www.gnu.org/licenses/&gt;.     #</span>

<span class="c">#a way to run it on back ground:  sudo python webserver.py &gt;file.log 2&gt;&amp;1</span>



<span class="c">#usefull sources  http://en.wikipedia.org/wiki/List_of_HTTP_status_codes</span>
<span class="c"># -*- coding: UTF-8 -*-</span>


<span class="kn">from</span> <span class="nn">conf</span> <span class="kn">import</span> <span class="o">*</span>           <span class="c"># import parameter from conf.py  which will read the data from the  json </span>
<span class="kn">from</span> <span class="nn">mail_agent</span> <span class="kn">import</span> <span class="o">*</span>

<span class="k">global</span> <span class="n">scenarioDict</span>
<span class="k">global</span> <span class="n">object_dict</span>
<span class="k">global</span> <span class="n">zoneDict</span>
<span class="k">global</span> <span class="nb">exit</span>  <span class="c">#exit is on conf.py  f exit ==1 all the program stop and exit</span>

<span class="nb">exit</span><span class="o">=</span><span class="mi">0</span>
<span class="n">check_log_len_time</span><span class="o">=</span><span class="mi">1</span>

<span class="n">default_new_zone_value</span><span class="o">=</span><span class="s">&quot;TYPE_NEW_ROOM_HERE_AND_CLICK_SUBMIT&quot;</span>
<span class="n">default_new_obj_value</span><span class="o">=</span><span class="s">&quot;TYPE A NEW OBJECT NAME HERE&quot;</span>
<span class="n">default_new_obj_value2</span><span class="o">=</span><span class="s">&quot;TYPE_A_NEW_OBJECT_NAME_HERE&quot;</span>
<span class="n">default_rename_zone_value</span><span class="o">=</span><span class="s">&quot;RENAME IT AND CLICK SUBMIT&quot;</span>
<span class="n">default_rename_zone_value2</span><span class="o">=</span><span class="s">&quot;RENAME_IT_AND_CLICK_SUBMIT&quot;</span>
<span class="c">#new_head_meta=&#39;&lt;meta http-equiv=&quot;Refresh&quot; content=&quot;1&quot;&gt;&#39;</span>
<span class="n">new_head_meta</span><span class="o">=</span><span class="s">&#39;&#39;&#39;&#39;&#39;&#39;</span>
<span class="n">in_file</span><span class="o">=</span><span class="s">&#39;&#39;</span>
<span class="n">onos_automatic_javascript</span><span class="o">=</span><span class="s">&#39;&#39;</span>
<span class="k">try</span><span class="p">:</span>
  <span class="k">with</span> <span class="n">codecs</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s">&quot;refreshPage.html&quot;</span><span class="p">,</span><span class="s">&#39;r&#39;</span><span class="p">,</span><span class="n">encoding</span><span class="o">=</span><span class="s">&#39;utf8&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
      <span class="n">in_file</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
      <span class="n">onos_automatic_javascript</span><span class="o">=</span><span class="n">in_file</span>

<span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">e</span> <span class="p">:</span>
  <span class="k">print</span> <span class="s">&quot;error i can&#39;t find refreshPage.html,    e:&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">)</span>
  <span class="n">errorQueue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="s">&quot;error i can&#39;t find refreshPage.html,    e:&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">))</span>
  <span class="n">onos_automatic_javascript</span><span class="o">=</span><span class="s">&quot;error_loading refreshPage.html&quot;</span>

<span class="c">#in_file=open(&quot;refreshPage.html&quot;,&quot;r&quot;)     #get the javascript code to reload the webpages</span>
<span class="c">#new_javascript= in_file.read()</span>
<span class="c">#onos_automatic_javascript=in_file</span>

<span class="c">#document.getElementById(&quot;content&quot;).innerHTML = &quot;whatever&quot;;</span>

<span class="n">web_page_not_found</span><span class="o">=</span><span class="s">&#39;&lt;html&gt;&lt;head&gt;&lt;style type=&quot;text/css&quot;&gt;&lt;/style&gt;&lt;/head&gt;&lt;body&gt;error  no index.html found in the  directory &lt;/body&gt;&lt;/html&gt;&#39;</span> 


<span class="k">print</span> <span class="s">&quot;fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff&quot;</span>





<span class="n">get_zone_manager_inner_html</span><span class="o">=</span><span class="s">&#39;&#39;&#39;&lt;!DOCTYPE html&gt;</span>
<span class="s">&lt;html&gt;</span>
<span class="s">&lt;head&gt;</span>
<span class="s">  &lt;link rel=&quot;stylesheet&quot; href=&quot;/css/zone-setup-css.css&quot; type=&quot;text/css&quot; media=&quot;all&quot; /&gt;</span>
<span class="s">  &lt;meta name=&quot;viewport&quot; content=&quot;width=device-width&quot; , initial-scale=1, maximum-scale=1&quot;&gt; </span>
<span class="s">  &lt;meta charset=&quot;utf-8&quot;&gt;</span>
<span class="s">  &lt;title&gt;O.N.O.S&lt;/title&gt;</span>
<span class="s">&lt;script type=&quot;text/javascript&quot; language=&quot;javascript&quot;&gt;function SelectAll(id){    document.getElementById(id).focus();   document.getElementById(id).select();}&lt;/script&gt;</span>
<span class="s">&lt;/head&gt;</span>
<span class="s">&lt;body&gt;</span>
<span class="s">&lt;form action=&quot;&quot; method=&quot;POST&quot;&gt;&lt;input type=&quot;hidden&quot; name=&quot;zone_manager&quot; value=&quot;/setup/zone_manager&quot;&gt;</span>

<span class="s">  </span>
<span class="s">&lt;div id=&quot;buttons&quot;&gt;</span>
<span class="s">  &lt;input type=&quot;submit&quot; value=&quot;Submit&quot;&gt;</span>
<span class="s">  &lt;a href=&quot;/&quot;&gt;&lt;div id=&quot;home&quot;&gt;HOME&lt;/div&gt;&lt;/a&gt;</span>
<span class="s">  &lt;a href=&quot;/setup/&quot;&gt;&lt;div id=&quot;back&quot;&gt;BACK&lt;/div&gt;&lt;/a&gt;</span>

<span class="s">&lt;/div&gt;</span>
<span class="s">  </span>

<span class="s"> &lt;div id=&quot;header&quot;&gt;ZONE SETUP&lt;/div&gt;</span>


<span class="s">&lt;div id=&quot;riga&quot;&gt;</span>

<span class="s">&lt;input type=&quot;text&quot; id=&quot;new_room_form&quot;  name=&quot;new_room&quot; onclick=&quot;SelectAll(&#39;new_room_form&#39;)&quot;;  value=&quot;TYPE NEW ROOM HERE AND CLICK SUBMIT&quot;&gt;</span>

<span class="s">&lt;/div&gt;</span>
<span class="s">&#39;&#39;&#39;</span>





<span class="n">oldpag</span><span class="o">=</span><span class="s">&quot; &quot;</span>
<span class="n">old_zoneDict</span><span class="o">=</span><span class="p">{}</span>
<span class="n">old_object_dict</span><span class="o">=</span><span class="p">{}</span>
<span class="n">old_web_page</span><span class="o">=</span><span class="s">&quot; &quot;</span>

<span class="n">baseDir</span><span class="o">=</span><span class="s">&quot;&quot;</span>

<span class="n">nothing_changed</span><span class="o">=</span><span class="mi">0</span>






<span class="c">#object_dict  contain all the web_object  and the key of the dictionary for each web_object is the name of the web_object</span>


<span class="n">notes</span><span class="o">=</span><span class="s">&quot;Enter_The_Web_Object_Notes&quot;</span>
<span class="n">no_pin_selected</span><span class="o">=</span><span class="s">&quot;no_pin&quot;</span>
<span class="n">type_b</span><span class="o">=</span><span class="s">&quot;checked&quot;</span>
<span class="n">type_sb</span><span class="o">=</span><span class="s">&quot;&quot;</span>
<span class="n">type_l</span><span class="o">=</span><span class="s">&quot;&quot;</span>
<span class="n">current_status0</span><span class="o">=</span><span class="s">&quot; &quot;</span>
<span class="n">current_status1</span><span class="o">=</span><span class="s">&quot; &quot;</span>
<span class="n">style0</span><span class="o">=</span><span class="s">&quot;/*Enter here the style you want your web object to have when its status is 0 */&quot;</span>
<span class="n">style1</span><span class="o">=</span><span class="s">&quot;/*Enter here the style you want your web object to have when its status is 0 */&quot;</span>
<span class="n">html0</span><span class="o">=</span><span class="s">&quot;&lt;!-- Enter here the html you want your web object to display when its status is 0  --&gt;&quot;</span>
<span class="n">html1</span><span class="o">=</span><span class="s">&quot;&lt;!-- Enter here the html you want your web object to display when its status is 1  --&gt;&quot;</span>
<span class="n">autoCssIndicator</span><span class="o">=</span><span class="s">&#39;/*soacdnrtc start of automatic css,do not remove this comment*/&#39;</span>
<span class="n">reload_page_indicator</span><span class="o">=</span><span class="s">&#39;&lt;!--soacdnrtc start of the part reloaded by the browser by javascript --&gt; &lt;div id=&quot;ReloadThis&quot; &gt;&#39;</span>
<span class="n">reload_page_end_indicator</span><span class="o">=</span><span class="s">&#39;&lt;!--soacdnrtc end of the part reloaded by the browser by javascript--&gt;&lt;/div&gt;&#39;</span>
<span class="n">command0</span><span class="o">=</span><span class="s">&quot; &quot;</span>
<span class="n">command1</span><span class="o">=</span><span class="s">&quot; &quot;</span>
<span class="n">init_command</span><span class="o">=</span><span class="s">&quot; &quot;</span>



 


<span class="c">#os.system(&#39;&#39;&#39;ntpd -q -p 0.openwrt.pool.ntp.org&#39;&#39;&#39;) </span>

<span class="c">#try:</span>
  
<span class="c">#  prof = open(&#39;/etc/profile&#39;, &#39;r&#39;)</span>
<span class="c">#  profile=prof.read()</span>
<span class="c">#  prof.close()</span>
   <span class="c">#print profile</span>
<span class="c">#  if (string.find(profile,timezone)== -1) :</span>
<span class="c">#    os.system(&#39;echo &quot;export TZ=&#39;+timezone+&#39;&quot;&gt;&gt; /etc/profile&#39;) ##export TZ=&quot;CET-1CEST,M3.5.0,M10.5.0/3&quot;</span>
<span class="c">#    print &quot; onos set the timezone to:&quot;+timezone</span>
<span class="c">#    os.system(&quot;source /etc/profile&quot;) #reload the profile to update time</span>
<span class="c">#  else:</span>
<span class="c">#    print &quot;timezone ok&quot;</span>
  <span class="c">#banana to add the change of the line to change the timezone</span>
<span class="c">#except:</span>
<span class="c">#  print &quot;error onos can&#39;t set the timezone!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!&quot;</span>





<span class="k">def</span> <span class="nf">compareText</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">):</span> <span class="c">#return true if a==b</span>
<div class="viewcode-block" id="compareText"><a class="viewcode-back" href="../webserver.html#webserver.compareText">[docs]</a>  <span class="n">ret</span><span class="o">=</span><span class="mi">0</span> 
  <span class="k">try</span><span class="p">:</span>
    <span class="n">a</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s">&#39;UTF-8&#39;</span><span class="p">)</span><span class="o">==</span><span class="n">b</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s">&#39;UTF-8&#39;</span><span class="p">)</span>
    <span class="n">ret</span><span class="o">=</span><span class="mi">1</span>
  <span class="k">except</span><span class="p">:</span>
    <span class="n">ret</span><span class="o">=-</span><span class="mi">1</span>  
    <span class="k">print</span> <span class="s">&quot;error cant decode &quot;</span><span class="p">,</span><span class="n">a</span>
    <span class="k">print</span> <span class="s">&quot;or&quot;</span>
    <span class="k">print</span> <span class="s">&quot;cant decode &quot;</span><span class="p">,</span><span class="n">b</span>

   
  <span class="k">return</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">sortZonesByOrderNumber</span><span class="p">():</span></div>
<div class="viewcode-block" id="sortZonesByOrderNumber"><a class="viewcode-back" href="../webserver.html#webserver.sortZonesByOrderNumber">[docs]</a>  <span class="k">print</span> <span class="s">&quot;sortZonesByOrderNumber() executed&quot;</span>
  <span class="n">zone_list</span><span class="o">=</span><span class="p">[]</span>
  <span class="k">print</span> <span class="n">zoneDict</span>
  <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">range</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">zoneDict</span><span class="o">.</span><span class="n">keys</span><span class="p">())):</span>
    <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">zoneDict</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">a</span><span class="o">==</span><span class="n">zoneDict</span><span class="p">[</span><span class="n">b</span><span class="p">][</span><span class="s">&quot;order&quot;</span><span class="p">])</span> <span class="p">:</span>  <span class="c"># select the next zone by the order number</span>
        <span class="n">zone_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
  <span class="k">print</span> <span class="s">&quot;list returned:&quot;</span><span class="p">,</span><span class="n">zone_list</span>
  <span class="k">return</span><span class="p">(</span><span class="n">zone_list</span><span class="p">)</span>
   


<span class="k">def</span> <span class="nf">changeWebObjectType</span><span class="p">(</span><span class="n">objName</span><span class="p">,</span><span class="n">typeToSet</span><span class="p">):</span><span class="c">#change the type of webobject and the relative pin mode in hardware_node class</span></div>
<div class="viewcode-block" id="changeWebObjectType"><a class="viewcode-back" href="../webserver.html#webserver.changeWebObjectType">[docs]</a>  <span class="k">print</span> <span class="s">&quot;executed changeWebObjectType() with :&quot;</span><span class="o">+</span><span class="n">objName</span>
  <span class="k">if</span> <span class="n">objName</span> <span class="ow">in</span> <span class="n">object_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span> <span class="c">#if the web object exist</span>
    <span class="n">object_dict</span><span class="p">[</span><span class="n">objName</span><span class="p">]</span><span class="o">.</span><span class="n">setType</span><span class="p">(</span><span class="n">typeToSet</span><span class="p">)</span>
    <span class="n">pinList</span><span class="o">=</span><span class="n">object_dict</span><span class="p">[</span><span class="n">objName</span><span class="p">]</span><span class="o">.</span><span class="n">getAttachedPinList</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">pinList</span><span class="o">!=</span><span class="p">[</span><span class="mi">9999</span><span class="p">]</span> <span class="p">:</span> <span class="c">#if there is a pin attached to this webobject</span>

      <span class="n">obj_type</span><span class="o">=</span><span class="n">object_dict</span><span class="p">[</span><span class="n">objName</span><span class="p">]</span><span class="o">.</span><span class="n">getType</span><span class="p">()</span>
      <span class="n">SerialNumber</span><span class="o">=</span><span class="n">object_dict</span><span class="p">[</span><span class="n">objName</span><span class="p">]</span><span class="o">.</span><span class="n">getHwNodeSerialNumber</span><span class="p">()</span>
      <span class="n">pins_to_set</span><span class="o">=</span><span class="n">object_dict</span><span class="p">[</span><span class="n">objName</span><span class="p">]</span><span class="o">.</span><span class="n">getAttachedPinList</span><span class="p">()</span>
      <span class="n">node_address</span><span class="o">=</span><span class="n">nodeDict</span><span class="p">[</span><span class="n">SerialNumber</span><span class="p">]</span><span class="o">.</span><span class="n">getNodeAddress</span><span class="p">()</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">obj_type</span><span class="o">==</span><span class="s">&quot;sr_relay&quot;</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">len</span> <span class="p">(</span><span class="n">pins_to_set</span><span class="p">)</span><span class="o">!=</span><span class="mi">2</span><span class="p">:</span>
          <span class="k">print</span> <span class="s">&quot;error , number of pins different from 2 for sr_relay type &quot;</span>
          <span class="n">errorQueue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="s">&quot;error , number of pins different from 2 for sr_relay type &quot;</span><span class="p">)</span>
          <span class="k">return</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>   

        <span class="n">hardware</span><span class="o">.</span><span class="n">setHwPinMode</span><span class="p">(</span><span class="n">node_address</span><span class="p">,</span><span class="n">pins_to_set</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="s">&quot;DOUTPUT&quot;</span><span class="p">)</span>
        <span class="n">hardware</span><span class="o">.</span><span class="n">setHwPinMode</span><span class="p">(</span><span class="n">node_address</span><span class="p">,</span><span class="n">pins_to_set</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="s">&quot;DOUTPUT&quot;</span><span class="p">)</span>
        <span class="n">nodeDict</span><span class="p">[</span><span class="n">SerialNumber</span><span class="p">]</span><span class="o">.</span><span class="n">setNodePinMode</span><span class="p">(</span><span class="n">pins_to_set</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="s">&quot;DOUTPUT&quot;</span><span class="p">)</span> 
        <span class="n">nodeDict</span><span class="p">[</span><span class="n">SerialNumber</span><span class="p">]</span><span class="o">.</span><span class="n">setNodePinMode</span><span class="p">(</span><span class="n">pins_to_set</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="s">&quot;DOUTPUT&quot;</span><span class="p">)</span> 

        <span class="k">return</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

      <span class="k">if</span> <span class="nb">len</span> <span class="p">(</span><span class="n">pins_to_set</span><span class="p">)</span><span class="o">!=</span><span class="mi">1</span><span class="p">:</span>   <span class="c"># under this i put every object with one single hardware pin </span>
          <span class="k">print</span> <span class="s">&quot;error , number of pins different from 1 for this obj type &quot;</span>
          <span class="n">errorQueue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="s">&quot;error , number of pins different from 1 for this obj type  &quot;</span><span class="p">)</span>
          <span class="k">return</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>   

      <span class="k">if</span> <span class="p">((</span><span class="n">typeToSet</span><span class="o">==</span><span class="s">&quot;b&quot;</span><span class="p">)</span><span class="o">|</span><span class="p">(</span><span class="n">typeToSet</span><span class="o">==</span><span class="s">&quot;sb&quot;</span><span class="p">)):</span>
        <span class="n">hardware</span><span class="o">.</span><span class="n">setHwPinMode</span><span class="p">(</span><span class="n">node_address</span><span class="p">,</span><span class="n">pins_to_set</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="s">&quot;DOUTPUT&quot;</span><span class="p">)</span>
        <span class="n">nodeDict</span><span class="p">[</span><span class="n">SerialNumber</span><span class="p">]</span><span class="o">.</span><span class="n">setNodePinMode</span><span class="p">(</span><span class="n">pins_to_set</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="s">&quot;DOUTPUT&quot;</span><span class="p">)</span>  
      <span class="k">if</span> <span class="p">(</span><span class="n">typeToSet</span><span class="o">==</span><span class="s">&quot;d_sensor&quot;</span><span class="p">):</span> 
        <span class="n">hardware</span><span class="o">.</span><span class="n">setHwPinMode</span><span class="p">(</span><span class="n">node_address</span><span class="p">,</span><span class="n">pins_to_set</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="s">&quot;DINPUT&quot;</span><span class="p">)</span> 
        <span class="n">nodeDict</span><span class="p">[</span><span class="n">SerialNumber</span><span class="p">]</span><span class="o">.</span><span class="n">setNodePinMode</span><span class="p">(</span><span class="n">pins_to_set</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="s">&quot;DINPUT&quot;</span><span class="p">)</span> 
      <span class="k">if</span> <span class="p">(</span><span class="n">typeToSet</span><span class="o">==</span><span class="s">&quot;a_sensor&quot;</span><span class="p">):</span>  
        <span class="n">hardware</span><span class="o">.</span><span class="n">setHwPinMode</span><span class="p">(</span><span class="n">node_address</span><span class="p">,</span><span class="n">pins_to_set</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="s">&quot;AINPUT&quot;</span><span class="p">)</span> 
        <span class="n">nodeDict</span><span class="p">[</span><span class="n">SerialNumber</span><span class="p">]</span><span class="o">.</span><span class="n">setNodePinMode</span><span class="p">(</span><span class="n">pins_to_set</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="s">&quot;AINPUT&quot;</span><span class="p">)</span> 
      <span class="k">if</span> <span class="p">(</span><span class="n">typeToSet</span><span class="o">==</span><span class="s">&quot;pwm_output&quot;</span><span class="p">):</span>  
        <span class="n">hardware</span><span class="o">.</span><span class="n">setHwPinMode</span><span class="p">(</span><span class="n">node_address</span><span class="p">,</span><span class="n">pins_to_set</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="s">&quot;AOUTPUT&quot;</span><span class="p">)</span> 
        <span class="n">nodeDict</span><span class="p">[</span><span class="n">SerialNumber</span><span class="p">]</span><span class="o">.</span><span class="n">setNodePinMode</span><span class="p">(</span><span class="n">pins_to_set</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="s">&quot;AOUTPUT&quot;</span><span class="p">)</span> 






  <span class="k">else</span><span class="p">:</span>
    <span class="k">print</span> <span class="s">&quot;the webobject:&quot;</span><span class="o">+</span><span class="n">objName</span><span class="o">+</span><span class="s">&quot; doesn&#39;t exist&quot;</span>

  <span class="k">return</span><span class="p">()</span>


<span class="k">def</span> <span class="nf">replace_functions</span><span class="p">(</span><span class="n">scenario_functions</span><span class="p">,</span><span class="n">scenario_name</span><span class="p">):</span><span class="c">#given a string ,replace web_object names with their value  obsolete</span></div>
<div class="viewcode-block" id="replace_functions"><a class="viewcode-back" href="../webserver.html#webserver.replace_functions">[docs]</a>

  <span class="n">scenario_functions</span><span class="o">=</span><span class="n">scenario_functions</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&quot;!&quot;</span><span class="p">,</span><span class="s">&quot;not &quot;</span><span class="p">)</span>  
  <span class="k">while</span> <span class="mi">1</span><span class="p">:</span>  <span class="c"># until all the objects are replaced by their value</span>

    <span class="k">try</span><span class="p">:</span>
      <span class="n">objname</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s">r&quot;#_.+?_#&quot;</span><span class="p">,</span><span class="n">scenario_functions</span><span class="p">)</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">)[</span><span class="mi">2</span><span class="p">:</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">e</span> <span class="p">:</span>
      <span class="k">print</span> <span class="s">&quot;no objects found in the scenario_functions or scenario_functions fully analyzed &quot;</span><span class="o">+</span><span class="s">&quot; e:&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">)</span>
      <span class="c">#errorQueue.put(&quot;no objects found in the scenario_functions or scenario_functions fully analyzed &quot;+&quot; e:&quot;+str(e.args)) </span>
      <span class="k">break</span>
        <span class="c">#errorQueue.put(&quot;error00 in the scenario operation search ,scenario_functions: &quot;+scenario_functions)</span>

    <span class="k">if</span> <span class="n">objname</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
      <span class="k">print</span> <span class="p">(</span><span class="s">&quot;error002 in the scenario operation search ,nonetype &quot;</span><span class="o">+</span><span class="n">scenario_functions</span><span class="p">)</span>
      <span class="n">errorQueue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="s">&quot;error002 in the scenario operation search ,nonetype &quot;</span><span class="o">+</span><span class="n">scenario_functions</span><span class="p">)</span>
      <span class="k">return</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
 
    <span class="k">try</span><span class="p">:</span>
      <span class="n">scenario_functions</span><span class="o">=</span><span class="n">scenario_functions</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&quot;#_&quot;</span><span class="o">+</span><span class="n">objname</span><span class="o">+</span><span class="s">&quot;_#&quot;</span><span class="p">,</span><span class="nb">str</span><span class="p">(</span><span class="n">object_dict</span><span class="p">[</span><span class="n">objname</span><span class="p">]</span><span class="o">.</span><span class="n">getStatusForScenario</span><span class="p">()))</span>      
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">e</span> <span class="p">:</span>
      <span class="k">print</span> <span class="s">&quot;error01 the webobject does not exist in the dict, i close the scenario check,objname: &quot;</span><span class="o">+</span><span class="n">objname</span><span class="o">+</span><span class="s">&quot; e:&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">)</span>

      <span class="n">errorQueue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="s">&quot;error01 the webobject does not exist in the dict, i close the scenario check ,objname: &quot;</span><span class="o">+</span><span class="n">objname</span><span class="o">+</span><span class="s">&quot; e:&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">))</span>

      <span class="k">return</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
 <span class="c"># now all the obj value are replaced</span>

  <span class="k">try</span><span class="p">:</span><span class="c"># replace all the #p_webobjectname_# with the previous webobject status value</span>
    <span class="n">scenario_functions</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s">r&#39;#p_.+?_#&#39;</span><span class="p">,</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span> <span class="n">object_dict</span><span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">)[</span><span class="mi">3</span><span class="p">:</span><span class="o">-</span><span class="mi">2</span><span class="p">]]</span><span class="o">.</span><span class="n">getPreviousStatusForScenario</span><span class="p">()),</span><span class="n">scenario_functions</span><span class="p">)</span>
  <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">e</span> <span class="p">:</span>
    <span class="k">print</span> <span class="s">&quot;error1 the webobject does not exist in the dict, i close the scenario check&quot;</span><span class="o">+</span><span class="s">&quot; e:&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">)</span>
    <span class="n">errorQueue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="s">&quot;error1 the webobject does not exist in the dict, i close the scenario check: scenario_condition:&quot;</span><span class="o">+</span><span class="n">scenario_functions</span><span class="o">+</span><span class="s">&quot;,scenario_name&quot;</span><span class="o">+</span><span class="n">scenario_name</span><span class="o">+</span><span class="s">&quot; e:&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">))</span>

    <span class="k">return</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
  <span class="k">print</span> <span class="s">&quot;scenario_functions replaced:&quot;</span><span class="p">,</span><span class="n">scenario_functions</span>
  <span class="k">return</span><span class="p">(</span><span class="n">scenario_functions</span><span class="p">)</span>




<span class="k">def</span> <span class="nf">replace_conditions</span><span class="p">(</span><span class="n">scenario_conditions</span><span class="p">,</span><span class="n">scenario_name</span><span class="p">):</span><span class="c">#given a string ,replace web_object names with their value </span></div>
<div class="viewcode-block" id="replace_conditions"><a class="viewcode-back" href="../webserver.html#webserver.replace_conditions">[docs]</a>
  <span class="n">obj_list</span><span class="o">=</span><span class="p">[]</span>
  <span class="n">scenario_conditions</span><span class="o">=</span><span class="n">scenario_conditions</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&quot;!&quot;</span><span class="p">,</span><span class="s">&quot;not &quot;</span><span class="p">)</span>  
  <span class="k">while</span> <span class="mi">1</span><span class="p">:</span>  <span class="c"># until all the objects are replaced by their value</span>
    <span class="n">objname_prev</span><span class="o">=</span><span class="s">&quot;&quot;</span>




    <span class="k">try</span><span class="p">:</span>
      <span class="n">objname</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s">r&quot;#_.+?_#&quot;</span><span class="p">,</span><span class="n">scenario_conditions</span><span class="p">)</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">)[</span><span class="mi">2</span><span class="p">:</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>
      
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">e</span> <span class="p">:</span> <span class="c">#ended the simple objects status</span>

      <span class="c">#errorQueue.put(&quot;no objects found in the scenario_conditions or scenario_conditions fully analyzed &quot;+&quot; e:&quot;+str(e.args)) </span>
      <span class="k">try</span><span class="p">:</span>
        <span class="n">objname_prev</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s">r&quot;#p_.+?_#&quot;</span><span class="p">,</span><span class="n">scenario_conditions</span><span class="p">)</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">)[</span><span class="mi">3</span><span class="p">:</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>
      <span class="k">except</span><span class="p">:</span>         <span class="c">#no previus object status found , serch terminated</span>
        <span class="n">objname_prev</span><span class="o">=</span><span class="s">&quot;&quot;</span>
        <span class="k">print</span> <span class="s">&quot;no objects found in the scenario_conditions or scenario_conditions fully analyzed &quot;</span><span class="o">+</span><span class="s">&quot; e:&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">)</span>
        <span class="k">break</span>
        <span class="c">#errorQueue.put(&quot;error00 in the scenario operation search ,scenario_conditions: &quot;+scenario_conditions)</span>


    <span class="k">if</span> <span class="n">objname</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
      <span class="k">print</span> <span class="p">(</span><span class="s">&quot;error002 in the scenario operation search ,nonetype &quot;</span><span class="o">+</span><span class="n">scenario_conditions</span><span class="p">)</span>
      <span class="n">errorQueue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="s">&quot;error002 in the scenario operation search ,nonetype &quot;</span><span class="o">+</span><span class="n">scenario_conditions</span><span class="p">)</span>
      <span class="k">return</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
 
    <span class="k">try</span><span class="p">:</span>
      <span class="n">scenario_conditions</span><span class="o">=</span><span class="n">scenario_conditions</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&quot;#_&quot;</span><span class="o">+</span><span class="n">objname</span><span class="o">+</span><span class="s">&quot;_#&quot;</span><span class="p">,</span><span class="nb">str</span><span class="p">(</span><span class="n">object_dict</span><span class="p">[</span><span class="n">objname</span><span class="p">]</span><span class="o">.</span><span class="n">getStatusForScenario</span><span class="p">()))</span>   
      <span class="n">obj_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">objname</span><span class="p">)</span>   
      <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">objname_prev</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span> <span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="n">objname_prev</span><span class="o">!=</span><span class="s">&quot;&quot;</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="n">objname_prev</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">obj_list</span> <span class="p">):</span>  <span class="c">#if there is a #p_objectName_#</span>
        <span class="n">obj_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">objname</span><span class="p">)</span>
       


    <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">e</span> <span class="p">:</span>
      <span class="k">print</span> <span class="s">&quot;error01 the webobject does not exist in the dict, i close the scenario check,objname: &quot;</span><span class="o">+</span><span class="n">objname</span><span class="o">+</span><span class="s">&quot; e:&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">)</span>

      <span class="n">errorQueue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="s">&quot;error01 the webobject does not exist in the dict, i close the scenario check ,objname: &quot;</span><span class="o">+</span><span class="n">objname</span><span class="o">+</span><span class="s">&quot; e:&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">))</span>

      <span class="k">return</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
 <span class="c"># now all the obj value are replaced</span>

  <span class="k">try</span><span class="p">:</span><span class="c"># replace all the #p_webobjectname_# with the previous webobject status value</span>
    <span class="n">scenario_conditions</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s">r&#39;#p_.+?_#&#39;</span><span class="p">,</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span> <span class="n">object_dict</span><span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">)[</span><span class="mi">3</span><span class="p">:</span><span class="o">-</span><span class="mi">2</span><span class="p">]]</span><span class="o">.</span><span class="n">getPreviousStatusForScenario</span><span class="p">()),</span><span class="n">scenario_conditions</span><span class="p">)</span>
  <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">e</span> <span class="p">:</span>
    <span class="k">print</span> <span class="s">&quot;error1 the webobject does not exist in the dict, i close the scenario check&quot;</span><span class="o">+</span><span class="s">&quot; e:&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">)</span>
    <span class="n">errorQueue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="s">&quot;error1 the webobject does not exist in the dict, i close the scenario check: scenario_condition:&quot;</span><span class="o">+</span><span class="n">scenario_conditions</span><span class="o">+</span><span class="s">&quot;,scenario_name&quot;</span><span class="o">+</span><span class="n">scenario_name</span><span class="o">+</span><span class="s">&quot; e:&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">))</span>

    <span class="k">return</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
  <span class="k">print</span> <span class="s">&quot;scenario_conditions replaced:&quot;</span><span class="p">,</span><span class="n">scenario_conditions</span>
  <span class="k">return</span><span class="p">([</span><span class="n">scenario_conditions</span><span class="p">,</span><span class="n">obj_list</span><span class="p">])</span>




<span class="k">def</span> <span class="nf">checkwebObjectScenarios</span><span class="p">(</span><span class="n">scenario_name</span><span class="p">):</span><span class="c">#check all the webobjects in the scenario passed</span></div>
<div class="viewcode-block" id="checkwebObjectScenarios"><a class="viewcode-back" href="../webserver.html#webserver.checkwebObjectScenarios">[docs]</a>  <span class="k">print</span> <span class="s">&quot;checkwebObjectScenarios() executed&quot;</span>
  <span class="k">if</span> <span class="n">scenarios_enable</span><span class="o">==</span><span class="mi">0</span> <span class="p">:</span>
    <span class="k">print</span> <span class="s">&quot;scenario disabled&quot;</span>
    <span class="k">return</span><span class="p">()</span>



  <span class="k">try</span><span class="p">:</span>
    <span class="n">scenario_to_check</span><span class="o">=</span><span class="n">scenarioDict</span><span class="p">[</span><span class="n">scenario_name</span><span class="p">]</span><span class="c">#get the scenario from the dictionary</span>
  <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
    <span class="k">print</span> <span class="s">&quot;error scenarioname:&quot;</span><span class="o">+</span><span class="n">scenario_name</span><span class="o">+</span><span class="s">&quot; not found in the dict&quot;</span>
    <span class="n">errorQueue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="s">&quot; error scenarioname:&quot;</span><span class="o">+</span><span class="n">scenario_name</span><span class="o">+</span><span class="s">&quot; not found in the dict&quot;</span><span class="p">)</span>
    <span class="k">return</span><span class="p">()</span>

<span class="c">#scenario dictionary structure:</span>

<span class="c">#     webObjectScenarios[&quot;change_lampobj&quot;]{&quot;enabled&quot;:1,&quot;setType&quot;:&quot;condition_to_set_status&quot;,&quot;one_time_shot&quot;:0,&quot;autodelete&quot;:0,&quot;actType&quot;:&quot;nodelay&quot;,&quot;conditions&quot;:[cond1&amp;cond2|cond3],&quot;math&quot;:&quot;&quot;,&quot;functionsToRun&quot;:[lamp1=0,lamp2=#_lamp2_#+1...],&quot;afterDelayFunctionsToRun&quot;:[],&quot;delayTime&quot;:0,&quot;priority&quot;:0}</span>

<span class="c">#  try:  #if the index exist</span>
<span class="c">#    scenario_web_obj_to_read=scenario_to_check[&quot;web_obj_to_read&quot;]</span>
<span class="c">#  except IndexError:#set the value to default</span>
<span class="c">#    print &quot;warning no object found in this scenario condition or math&quot;</span>
<span class="c">#    scenario_web_obj_to_read=[]</span>

  <span class="k">try</span><span class="p">:</span>  <span class="c">#if the reference exist</span>
    <span class="n">scenario_enabled</span><span class="o">=</span><span class="n">scenario_to_check</span><span class="p">[</span><span class="s">&quot;enabled&quot;</span><span class="p">]</span>
  <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span><span class="c">#set the value to default</span>
    <span class="n">scenario_enabled</span><span class="o">=</span><span class="mi">1</span>

  <span class="k">if</span> <span class="n">scenario_enabled</span><span class="o">!=</span><span class="mi">1</span><span class="p">:</span><span class="c"># if the scenario is disabled  exit</span>
    <span class="k">print</span> <span class="s">&quot;scenario:&quot;</span><span class="o">+</span><span class="n">scenario_name</span><span class="o">+</span><span class="s">&quot; is disabled&quot;</span>
    <span class="k">return</span><span class="p">()</span>

<span class="c">#  try:   #if the reference exist</span>
<span class="c">#    scenario_set_type=scenario_to_check[&quot;setType&quot;]</span>
<span class="c">#  except KeyError:</span>
<span class="c">#    print &quot;error scenario_set_type not in the scenario dictionary&quot;</span>

  <span class="k">try</span><span class="p">:</span>   <span class="c">#if the reference exist</span>
    <span class="n">type_after_run</span><span class="o">=</span><span class="n">scenario_to_check</span><span class="p">[</span><span class="s">&quot;type_after_run&quot;</span><span class="p">]</span>
  <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span><span class="c">#set the value to default</span>
    <span class="n">type_after_run</span><span class="o">=</span><span class="s">&quot;0&quot;</span>

  <span class="k">try</span><span class="p">:</span>  <span class="c">#if the reference exist</span>
    <span class="n">scenario_priority</span><span class="o">=</span><span class="n">scenario_to_check</span><span class="p">[</span><span class="s">&quot;priority&quot;</span><span class="p">]</span>
  <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span><span class="c">#set the value to default</span>
    <span class="n">scenario_priority</span><span class="o">=</span><span class="mi">0</span>

<span class="c">#  try:  #if the reference exist</span>
<span class="c">#    scenario_math=scenario_to_check[&quot;math&quot;]</span>
<span class="c">#  except KeyError: #set the value to default</span>
<span class="c">#    scenario_math=&quot;&quot;</span>

  <span class="k">try</span><span class="p">:</span>  <span class="c">#if the reference exist</span>
    <span class="n">scenario_conditions</span><span class="o">=</span><span class="n">scenario_to_check</span><span class="p">[</span><span class="s">&quot;conditions&quot;</span><span class="p">]</span>

  <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span><span class="c">#set the value to default</span>
    <span class="k">print</span> <span class="s">&quot;error conditions not in scenario dictionary&quot;</span>
    <span class="n">errorQueue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="s">&quot;error conditions not in scenario dictionary&quot;</span><span class="p">)</span>
    <span class="n">scenario_conditions</span><span class="o">=</span><span class="s">&quot;0&quot;</span>

  <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">scenario_conditions</span><span class="p">)</span><span class="o">&lt;</span><span class="mi">1</span><span class="p">:</span>
    <span class="n">scenario_conditions</span><span class="o">=</span><span class="s">&quot;0&quot;</span>
    <span class="k">print</span> <span class="s">&quot;error scenario conditions of &quot;</span><span class="o">+</span><span class="n">scenario_name</span><span class="o">+</span><span class="s">&quot;are a void string&quot;</span>
    <span class="n">errorQueue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="s">&quot;error scenario conditions of  &quot;</span><span class="o">+</span><span class="n">scenario_name</span><span class="o">+</span><span class="s">&quot;  are a void string&quot;</span><span class="p">)</span>


  <span class="k">print</span> <span class="s">&quot;scenario scenario_conditions : &quot;</span><span class="p">,</span><span class="n">scenario_conditions</span> 
  <span class="k">if</span> <span class="p">(</span><span class="n">scenario_conditions</span><span class="o">!=</span><span class="s">&quot;0&quot;</span><span class="p">)</span><span class="ow">and</span><span class="p">(</span><span class="n">scenario_conditions</span><span class="o">!=</span><span class="s">&quot;1&quot;</span><span class="p">):</span>
    <span class="n">scenario_conditions</span><span class="o">=</span><span class="n">replace_conditions</span><span class="p">(</span><span class="n">scenario_conditions</span><span class="p">,</span><span class="n">scenario_name</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
  <span class="k">if</span> <span class="n">scenario_conditions</span><span class="o">==-</span><span class="mi">1</span><span class="p">:</span>
    <span class="k">return</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
  
  <span class="k">print</span> <span class="s">&quot;scenario conditions after replace : &quot;</span><span class="p">,</span><span class="n">scenario_conditions</span>
  <span class="n">cond</span><span class="o">=</span><span class="mi">0</span>  <span class="c">#if the conditions are a void string ..</span>
  <span class="k">try</span><span class="p">:</span>
    <span class="n">cond</span><span class="o">=</span><span class="nb">eval</span><span class="p">(</span><span class="n">scenario_conditions</span><span class="p">)</span>
  <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">e</span> <span class="p">:</span>
    <span class="k">print</span> <span class="s">&quot;error in eval(&quot;</span><span class="o">+</span><span class="n">scenario_name</span><span class="o">+</span><span class="s">&quot;), scenario_conditions=&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">scenario_conditions</span><span class="p">)</span><span class="o">+</span><span class="s">&quot; e:&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">)</span>
    <span class="n">errorQueue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="s">&quot;error in eval(&quot;</span><span class="o">+</span><span class="n">scenario_name</span><span class="o">+</span><span class="s">&quot;), scenario_conditions=&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">scenario_conditions</span><span class="p">)</span><span class="o">+</span><span class="s">&quot; e:&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">))</span>

  <span class="k">if</span> <span class="p">(</span><span class="n">cond</span><span class="o">==</span><span class="mi">1</span><span class="p">):</span>  <span class="c">#the condition are true , onos will execute the operations</span>

    <span class="k">print</span> <span class="s">&quot;scenario conditions are true&quot;</span>

<span class="c">#    try:# replace all #_webobjectname_# with the webobjectname status value</span>
<span class="c">#      scenario_math=re.sub(r&#39;#_.+?_#&#39;,lambda x: str(object_dict[x.group(0)[2:-2]].getStatus()),scenario_math)</span>
<span class="c">#    except:</span>
<span class="c">#      print &quot;error the webobject does not exist in the dict, i close the scenario scenario_math check&quot;</span>
<span class="c">#      errorQueue.put(&quot;error2 the webobject does not exist in the dict, i close the scenario check: scenario_math:&quot;+scenario_math)</span>
<span class="c">#      return()</span>

<span class="c">#    try:# and all the #p_webobjectname_# with the previous webobject status value</span>
<span class="c">#      scenario_math=re.sub(r&#39;#p_.+?_#&#39;,lambda x: str(object_dict[x.group(0)[3:-2]].getPreviousStatus()),scenario_math)</span>
<span class="c">#    except :</span>
<span class="c">#      print &quot;error the webobject does not exist in the dict, i close the scenario scenario_math check&quot;</span>
<span class="c">#      errorQueue.put(&quot;error3 the webobject does not exist in the dict, i close the scenario check: #scenario_math:&quot;+scenario_math)</span>
<span class="c">#      return()</span>



<span class="c">#    print &quot;scenario scenario_math: &quot;,scenario_math</span>
<span class="c">#    if len(scenario_math)&gt; 1: </span>
<span class="c">#      try:</span>
<span class="c">#        mathResultValue=str(eval(scenario_math))   #calculating the math expression from scenario_math</span>
<span class="c">#      except:</span>
<span class="c">#        print &quot;error in eval(scenario_math) ,scenario_math=&quot;+str(scenario_math)</span>
<span class="c">#        errorQueue.put(&quot;error in eval(scenario_math) ,scenario_math=&quot;+str(scenario_math))</span>
<span class="c">#    else:</span>
<span class="c">#      mathResultValue=&quot;&quot;</span>

    <span class="n">executionList</span><span class="o">=</span><span class="p">[]</span>

    <span class="c">#if &quot;functions_to_run&quot; in scenario_to_check.keys():  #if the reference exist</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="n">scenario_functions_to_run</span><span class="o">=</span><span class="n">scenario_to_check</span><span class="p">[</span><span class="s">&quot;functionsToRun&quot;</span><span class="p">]</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">e</span> <span class="p">:</span>
      <span class="k">print</span> <span class="s">&quot;scenario_functions_to_run of &quot;</span><span class="o">+</span><span class="n">scenario_name</span><span class="o">+</span> <span class="s">&quot; scenario is empty&quot;</span><span class="o">+</span><span class="s">&quot; e:&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">)</span>

      <span class="n">errorQueue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="s">&quot;scenario_functions_to_run of &quot;</span><span class="o">+</span><span class="n">scenario_name</span><span class="o">+</span> <span class="s">&quot; scenario is empty&quot;</span><span class="o">+</span><span class="s">&quot; e:&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">))</span>

      <span class="n">scenario_functions_to_run</span><span class="o">=</span><span class="p">[]</span>

    <span class="c">#if &quot;afterDelayFunctionsToRun&quot; in scenario_to_check.keys():  #if the reference exist</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="n">afterDelayFunctionsToRun</span><span class="o">=</span><span class="n">scenario_to_check</span><span class="p">[</span><span class="s">&quot;afterDelayFunctionsToRun&quot;</span><span class="p">]</span>
    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span><span class="c">#set the value to default</span>
      <span class="n">afterDelayFunctionsToRun</span><span class="o">=</span><span class="p">[]</span>

    <span class="k">try</span><span class="p">:</span>
      <span class="n">delayTime</span><span class="o">=</span><span class="n">scenario_to_check</span><span class="p">[</span><span class="s">&quot;delayTime&quot;</span><span class="p">]</span>
    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span><span class="c">#set the value to default</span>
      <span class="n">delayTime</span><span class="o">=</span><span class="mi">0</span>


      
    <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">scenario_functions_to_run</span><span class="p">:</span>   <span class="c">#for each line of the functions_to_run</span>
        <span class="c">#f=f.replace(&quot;#condvalue#&quot;,&quot;1&quot;)  </span>
      <span class="c">#f=f.replace(&quot;#mathvalue#&quot;,mathResultValue)   </span>
      <span class="n">f</span><span class="o">=</span><span class="n">f</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&quot;==&quot;</span><span class="p">,</span><span class="s">&quot;=&quot;</span><span class="p">)</span>    <span class="c">#replace == with =</span>
      <span class="n">f</span><span class="o">=</span><span class="n">f</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&quot;!&quot;</span><span class="p">,</span><span class="s">&quot;not &quot;</span><span class="p">)</span>   
      <span class="n">point</span><span class="o">=</span><span class="n">f</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&quot;=&quot;</span><span class="p">)</span>
      <span class="n">f_before_equal_sign</span><span class="o">=</span><span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">point</span><span class="p">]</span>
      <span class="n">f_before_equal_sign</span><span class="o">=</span><span class="n">f_before_equal_sign</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&quot;#_&quot;</span><span class="p">,</span><span class="s">&quot;&quot;</span><span class="p">)</span>
      <span class="n">f_before_equal_sign</span><span class="o">=</span><span class="n">f_before_equal_sign</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&quot;#p_&quot;</span><span class="p">,</span><span class="s">&quot;&quot;</span><span class="p">)</span>
      <span class="n">f_before_equal_sign</span><span class="o">=</span><span class="n">f_before_equal_sign</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&quot;_#&quot;</span><span class="p">,</span><span class="s">&quot;&quot;</span><span class="p">)</span>

      <span class="n">f</span><span class="o">=</span><span class="n">f</span><span class="p">[</span><span class="n">point</span><span class="o">+</span><span class="mi">1</span><span class="p">:]</span>
      

      <span class="k">while</span> <span class="mi">1</span><span class="p">:</span>  <span class="c"># untill all the objects are replaced by their value</span>

        <span class="k">try</span><span class="p">:</span>
          <span class="n">objname</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s">r&quot;#_.+?_#&quot;</span><span class="p">,</span><span class="n">f</span><span class="p">)</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">)[</span><span class="mi">2</span><span class="p">:</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>
        <span class="k">except</span><span class="p">:</span>
          <span class="k">print</span> <span class="s">&quot;no objects found in the function_to_run  or function_to_run fully analyzed &quot;</span>
          <span class="k">break</span>
          <span class="c">#errorQueue.put(&quot;error00 in the scenario operation search ,scenario_conditions: &quot;+scenario_conditions)</span>

        <span class="k">if</span> <span class="n">objname</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
          <span class="k">print</span> <span class="s">&quot;error003 in the scenario operation search ,nonetype &quot;</span><span class="o">+</span><span class="n">f</span>
          <span class="n">errorQueue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="s">&quot;error003 in the scenario operation search ,nonetype &quot;</span><span class="o">+</span><span class="n">f</span><span class="p">)</span>
          <span class="k">break</span>
 
        <span class="k">try</span><span class="p">:</span>
          <span class="n">f</span><span class="o">=</span><span class="n">f</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&quot;#_&quot;</span><span class="o">+</span><span class="n">objname</span><span class="o">+</span><span class="s">&quot;_#&quot;</span><span class="p">,</span><span class="nb">str</span><span class="p">(</span><span class="n">object_dict</span><span class="p">[</span><span class="n">objname</span><span class="p">]</span><span class="o">.</span><span class="n">getStatusForScenario</span><span class="p">()))</span>      
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">e</span> <span class="p">:</span>
          <span class="k">print</span> <span class="s">&quot;error003 the webobject does not exist in the dict, i close the scenario check of:&quot;</span><span class="o">+</span><span class="n">scenario_name</span><span class="o">+</span><span class="s">&quot;,objname: &quot;</span><span class="o">+</span><span class="n">objname</span><span class="o">+</span><span class="s">&quot; e:&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">)</span>
          <span class="n">errorQueue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="s">&quot;error003 the webobject does not exist in the dict, i close the scenario check of:&quot;</span><span class="o">+</span><span class="n">scenario_name</span><span class="o">+</span><span class="s">&quot;,objname: &quot;</span><span class="o">+</span><span class="n">objname</span><span class="o">+</span><span class="s">&quot; e:&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">))</span>
          <span class="k">return</span><span class="p">()</span>
 <span class="c"># now all the obj value are replaced</span>



      <span class="c">#try:# replace all #_webobjectname_# with the webobjectname status value</span>
      <span class="c">#  f=re.sub(r&#39;#_.+?_#&#39;,lambda x: str(object_dict[x.group(0)[2:-2]].getStatus()),f)</span>
      <span class="c">#except KeyError:</span>
      <span class="c">#  print &quot;error0 the webobject does not exist in the dict, i close the scenario check,operation:&quot;+f</span>
      <span class="c">#  errorQueue.put(&quot; error0 the webobject does not exist in the dict, i close the scenario check,operation:&quot;+f)</span>
      <span class="c">#  return()</span>

      <span class="k">try</span><span class="p">:</span><span class="c"># replcace all the #p_webobjectname_# with the previous webobject status value</span>
        <span class="n">f</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s">r&#39;#p_.+?_#&#39;</span><span class="p">,</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">object_dict</span><span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">)[</span><span class="mi">3</span><span class="p">:</span><span class="o">-</span><span class="mi">2</span><span class="p">]]</span><span class="o">.</span><span class="n">getPreviousStatusForScenario</span><span class="p">()),</span><span class="n">f</span><span class="p">)</span>
      <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">e</span> <span class="p">:</span>
        <span class="k">print</span> <span class="s">&quot;error2 the webobject does not exist in the dict, i close the scenario function to run check&quot;</span><span class="o">+</span><span class="s">&quot; e:&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">)</span>
        <span class="n">errorQueue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="s">&quot; error2 the webobject does not exist in the dict, i close the scenario function to run check&quot;</span><span class="o">+</span><span class="s">&quot; e:&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">))</span>

        <span class="k">return</span><span class="p">()</span>
      
      <span class="n">executionList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">f_before_equal_sign</span><span class="o">+</span><span class="s">&quot;=&quot;</span><span class="o">+</span><span class="n">f</span><span class="p">)</span>

   <span class="c"># if (scenario_set_type==&quot;condition_to_set_status&quot;) :  # scenario_set_type  is  condition_to_set_status</span>
      <span class="c">#execute the  executionList</span>
    <span class="k">print</span> <span class="s">&quot;conditions verified and true, i execute the executionList &quot;</span>
       
    <span class="n">statusToSet</span><span class="o">=</span><span class="s">&quot;void&quot;</span>
    <span class="k">try</span><span class="p">:</span> 
      <span class="k">for</span> <span class="n">op</span> <span class="ow">in</span> <span class="n">executionList</span><span class="p">:</span>
        <span class="k">print</span> <span class="s">&quot;operation to execute: &quot;</span><span class="p">,</span><span class="n">op</span>
        <span class="n">obj_to_change</span><span class="o">=</span><span class="s">&quot;void&quot;</span>
        <span class="n">str_status</span><span class="o">=</span><span class="s">&quot;void&quot;</span>

        <span class="k">try</span><span class="p">:</span>
          <span class="n">obj_to_change</span><span class="o">=</span><span class="n">op</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&quot;=&quot;</span> <span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
          <span class="n">str_status</span><span class="o">=</span><span class="n">op</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&quot;=&quot;</span> <span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">e</span> <span class="p">:</span>
          <span class="k">print</span> <span class="p">(</span><span class="s">&quot;error in the split of op in executionList ,op=&quot;</span><span class="o">+</span><span class="n">op</span><span class="o">+</span><span class="s">&quot;obj_to_change:&quot;</span><span class="o">+</span><span class="n">obj_to_change</span><span class="o">+</span><span class="s">&quot;,str_status:&quot;</span><span class="o">+</span><span class="n">str_status</span><span class="o">+</span><span class="s">&quot; e:&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">))</span>

          <span class="n">errorQueue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="s">&quot;error in the split of op in executionList ,op=&quot;</span><span class="o">+</span><span class="n">op</span><span class="o">+</span><span class="s">&quot;obj_to_change:&quot;</span><span class="o">+</span><span class="n">obj_to_change</span><span class="o">+</span><span class="s">&quot;,str_status:&quot;</span><span class="o">+</span><span class="n">str_status</span><span class="o">+</span><span class="s">&quot; e:&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">))</span>

        
        <span class="k">try</span><span class="p">:</span>
          <span class="n">statusToSet</span><span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="nb">eval</span><span class="p">(</span><span class="n">str_status</span><span class="p">))</span>

        <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">e</span> <span class="p">:</span>  <span class="c">#happens if statusToSet=  inactive or  onoswait</span>
          <span class="n">statusToSet</span><span class="o">=</span><span class="n">str_status</span>
          <span class="k">print</span> <span class="s">&quot;error in the eval of for op in executionList :str_status=&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">str_status</span><span class="p">)</span><span class="o">+</span><span class="s">&quot;,op=&quot;</span><span class="o">+</span><span class="n">op</span><span class="o">+</span><span class="s">&quot; e:&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">)</span>

          <span class="n">errorQueue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="s">&quot;error in the eval of for op in executionList :str_status=&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">str_status</span><span class="p">)</span><span class="o">+</span><span class="s">&quot;,op=&quot;</span><span class="o">+</span><span class="n">op</span><span class="o">+</span><span class="s">&quot; e:&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">))</span>


        <span class="k">if</span> <span class="p">(</span><span class="n">statusToSet</span><span class="o">==</span><span class="bp">True</span><span class="p">)</span><span class="ow">or</span><span class="p">(</span><span class="n">statusToSet</span><span class="o">==</span><span class="s">&quot;True&quot;</span><span class="p">):</span>
          <span class="n">statusToSet</span><span class="o">=</span><span class="s">&quot;1&quot;</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">statusToSet</span><span class="o">==</span><span class="bp">False</span><span class="p">)</span><span class="ow">or</span><span class="p">(</span><span class="n">statusToSet</span><span class="o">==</span><span class="s">&quot;False&quot;</span><span class="p">):</span>
          <span class="n">statusToSet</span><span class="o">=</span><span class="s">&quot;0&quot;</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">object_dict</span><span class="p">[</span><span class="n">obj_to_change</span><span class="p">]</span><span class="o">.</span><span class="n">validateStatusToSetObj</span><span class="p">(</span><span class="n">statusToSet</span><span class="p">)</span><span class="o">==</span><span class="mi">1</span><span class="p">):</span>  <span class="c">#the status to set is valid for the object</span>

          <span class="k">if</span> <span class="n">obj_to_change</span> <span class="ow">in</span> <span class="n">object_dict</span><span class="p">:</span>
            <span class="k">print</span> <span class="s">&quot;scenario act to change the weboject: &quot;</span><span class="p">,</span><span class="n">obj_to_change</span>
            <span class="n">layerExchangeDataQueue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span> <span class="p">{</span><span class="s">&quot;cmd&quot;</span><span class="p">:</span><span class="s">&quot;setSts&quot;</span><span class="p">,</span><span class="s">&quot;webObjectName&quot;</span><span class="p">:</span><span class="n">obj_to_change</span><span class="p">,</span><span class="s">&quot;status_to_set&quot;</span><span class="p">:</span><span class="n">statusToSet</span><span class="p">,</span><span class="s">&quot;write_to_hw&quot;</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span><span class="s">&quot;user&quot;</span><span class="p">:</span><span class="s">&quot;scenario&quot;</span><span class="p">,</span><span class="s">&quot;priority&quot;</span><span class="p">:</span><span class="n">scenario_priority</span><span class="p">,</span><span class="s">&quot;mail_report_list&quot;</span><span class="p">:[]})</span>
        <span class="k">else</span><span class="p">:</span>
          <span class="k">print</span> <span class="s">&quot;error in scenario op,statusToSet is :&quot;</span><span class="o">+</span><span class="n">statusToSet</span> 
          <span class="n">errorQueue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="s">&quot;error in scenario op,statusToSet is :&quot;</span><span class="o">+</span><span class="n">statusToSet</span> <span class="p">)</span>


    <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">e</span> <span class="p">:</span>
      <span class="k">print</span> <span class="s">&quot;error in the scenario for loop (for op in executionList) &quot;</span><span class="o">+</span><span class="s">&quot; e:&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">)</span>

      <span class="n">errorQueue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="s">&quot;error in the scenario for loop (for op in executionList) &quot;</span><span class="o">+</span><span class="s">&quot; e:&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">))</span>




    <span class="k">if</span> <span class="n">delayTime</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
      <span class="k">print</span> <span class="s">&quot;create a new scenario...banana&quot;</span>

      <span class="n">currentDayTime</span><span class="o">=</span><span class="n">object_dict</span><span class="p">[</span><span class="s">&quot;dayTime&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">getStatusForScenario</span><span class="p">()</span>
  
      <span class="k">if</span> <span class="p">(</span><span class="n">delayTime</span><span class="o">+</span><span class="n">currentDayTime</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">1440</span><span class="p">:</span>    <span class="c">#  1440 is 24 * 60   the max number of minuts in a day</span>
        <span class="n">selectedMinutes</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">currentDayTime</span><span class="o">+</span><span class="n">delayTime</span><span class="p">)</span>
      <span class="k">else</span><span class="p">:</span>
        <span class="n">selectedMinutes</span><span class="o">=</span><span class="nb">str</span><span class="p">((</span><span class="n">currentDayTime</span><span class="o">+</span><span class="n">delayTime</span><span class="p">)</span><span class="o">-</span><span class="mi">1440</span> <span class="p">)</span>   <span class="c"># restart the count from 0 minutes</span>
    
      <span class="n">new_scenario_name</span><span class="o">=</span><span class="s">&quot;delay_from&quot;</span><span class="o">+</span><span class="n">scenario_name</span>
      <span class="n">c</span><span class="o">=</span><span class="mi">0</span>
      <span class="k">while</span> <span class="n">new_scenario_name</span> <span class="ow">in</span> <span class="n">scenarioDict</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>  <span class="c"># if the name already exist  try another</span>
          <span class="n">new_scenario_name</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">c</span><span class="p">)</span><span class="o">+</span><span class="s">&quot;delay_from&quot;</span><span class="o">+</span><span class="n">scenario_name</span>
          <span class="n">c</span><span class="o">=</span><span class="n">c</span><span class="o">+</span><span class="mi">1</span>

  
      <span class="k">print</span> <span class="s">&quot;created delay scenario named:&quot;</span><span class="o">+</span><span class="n">new_scenario_name</span><span class="o">+</span><span class="s">&quot;with conditions:dayTime==&quot;</span><span class="o">+</span><span class="n">selectedMinutes</span>
      <span class="k">print</span> <span class="s">&quot;now real time is &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">((</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">today</span><span class="p">()</span><span class="o">.</span><span class="n">minute</span><span class="o">+</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">today</span><span class="p">()</span><span class="o">.</span><span class="n">hour</span><span class="p">)</span><span class="o">*</span><span class="mi">60</span> <span class="p">))</span><span class="o">+</span><span class="s">&quot; obj time is&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">currentDayTime</span><span class="p">)</span>
         
      <span class="n">scenarioDict</span><span class="p">[</span><span class="n">new_scenario_name</span><span class="p">]</span><span class="o">=</span><span class="p">{</span><span class="s">&quot;enabled&quot;</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span><span class="s">&quot;type_after_run&quot;</span><span class="p">:</span><span class="s">&quot;autodelete&quot;</span><span class="p">,</span><span class="s">&quot;conditions&quot;</span><span class="p">:</span><span class="s">&quot;#_dayTime_#==&quot;</span><span class="o">+</span><span class="n">selectedMinutes</span><span class="p">,</span><span class="s">&quot;functionsToRun&quot;</span><span class="p">:</span><span class="n">afterDelayFunctionsToRun</span><span class="p">,</span><span class="s">&quot;afterDelayFunctionsToRun&quot;</span><span class="p">:[],</span><span class="s">&quot;delayTime&quot;</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span><span class="s">&quot;priority&quot;</span><span class="p">:</span><span class="n">scenario_priority</span><span class="p">}</span>
      <span class="n">object_dict</span><span class="p">[</span><span class="s">&quot;dayTime&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">attachScenario</span><span class="p">(</span><span class="n">new_scenario_name</span><span class="p">)</span>
 
    <span class="k">if</span> <span class="n">type_after_run</span><span class="o">==</span><span class="s">&quot;autodelete&quot;</span><span class="p">:</span>
      <span class="k">del</span> <span class="n">scenarioDict</span><span class="p">[</span><span class="n">scenario_name</span><span class="p">]</span> 
      <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">object_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>   <span class="c"># delete the reference to this scenario from all the webobjects </span>
        <span class="n">object_dict</span><span class="p">[</span><span class="n">a</span><span class="p">]</span><span class="o">.</span><span class="n">removeAttachedScenario</span><span class="p">(</span><span class="n">scenario_name</span><span class="p">)</span> 
   
    <span class="k">if</span> <span class="n">type_after_run</span><span class="o">==</span><span class="s">&quot;one_time_shot&quot;</span><span class="p">:</span>
      <span class="k">print</span> <span class="s">&quot;i disable the one_time_shot :&quot;</span><span class="o">+</span><span class="n">scenario_name</span>
      <span class="n">scenarioDict</span><span class="p">[</span><span class="n">scenario_name</span><span class="p">][</span><span class="s">&quot;enabled&quot;</span><span class="p">]</span><span class="o">=</span><span class="mi">0</span>    


  <span class="k">else</span><span class="p">:</span> <span class="c"># #the condition are false </span>
    <span class="k">print</span> <span class="s">&quot;the scenarios  condition are false&quot;</span>



     




  <span class="k">print</span> <span class="s">&quot;end of checkwebObjectScenarios&quot;</span>
  <span class="k">return</span><span class="p">()</span>     

  









<span class="k">def</span> <span class="nf">compose_error_mail</span><span class="p">(</span><span class="n">error_type</span><span class="p">,</span><span class="n">objName</span><span class="o">=</span><span class="s">&quot;&quot;</span><span class="p">):</span></div>
<div class="viewcode-block" id="compose_error_mail"><a class="viewcode-back" href="../webserver.html#webserver.compose_error_mail">[docs]</a>  <span class="k">print</span> <span class="s">&quot;compose_error_mail executed&quot;</span>
  <span class="n">mailtext</span><span class="o">=</span><span class="s">&quot;&quot;</span>
  <span class="k">if</span> <span class="n">error_type</span><span class="o">==</span><span class="s">&quot;so_priority&quot;</span><span class="p">:</span>
    <span class="n">obj_previous_status</span><span class="o">=</span><span class="n">object_dict</span><span class="p">[</span><span class="n">objName</span><span class="p">]</span><span class="o">.</span><span class="n">getStatus</span><span class="p">()</span>
    <span class="n">mailtext</span><span class="o">=</span><span class="s">&quot;onos_report_message,&quot;</span><span class="o">+</span><span class="n">objName</span><span class="o">+</span><span class="s">&quot;,error_so_priority,obj stays,&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">obj_previous_status</span><span class="p">)</span>

  <span class="k">if</span> <span class="n">error_type</span><span class="o">==</span><span class="s">&quot;so_permissions&quot;</span><span class="p">:</span>
    <span class="n">obj_previous_status</span><span class="o">=</span><span class="n">object_dict</span><span class="p">[</span><span class="n">objName</span><span class="p">]</span><span class="o">.</span><span class="n">getStatus</span><span class="p">()</span>
    <span class="n">mailtext</span><span class="o">=</span><span class="s">&quot;onos_report_message,&quot;</span><span class="o">+</span><span class="n">objName</span><span class="o">+</span><span class="s">&quot;,error_so_permission,obj stays,&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">obj_previous_status</span><span class="p">)</span>

  <span class="k">if</span> <span class="n">error_type</span><span class="o">==</span><span class="s">&quot;wrong_password&quot;</span><span class="p">:</span>
    <span class="n">mailtext</span><span class="o">=</span><span class="s">&quot;onos_report_message,error_password,the password you send is wrong please check it&quot;</span>

  <span class="k">if</span> <span class="n">error_type</span><span class="o">==</span><span class="s">&quot;wrong_username&quot;</span><span class="p">:</span>
    <span class="n">mailtext</span><span class="o">=</span><span class="s">&quot;onos_report_message,error_username,your username does not exist  please add it from local web interface&quot;</span>

  <span class="k">if</span> <span class="n">error_type</span><span class="o">==</span><span class="s">&quot;white_list&quot;</span><span class="p">:</span>
    <span class="n">mailtext</span><span class="o">=</span><span class="s">&quot;onos_report_message,error_white_list,your mail is not in the white_list  please add it from local web interface&quot;</span>


  <span class="k">if</span> <span class="n">error_type</span><span class="o">==</span><span class="s">&quot;so_obj_not_exist&quot;</span><span class="p">:</span>
    <span class="n">mailtext</span><span class="o">=</span><span class="s">&quot;onos_report_message,&quot;</span><span class="o">+</span><span class="n">objName</span><span class="o">+</span><span class="s">&quot;,not_exist, webobject name does not exist please check it&quot;</span>


  <span class="k">if</span> <span class="n">error_type</span><span class="o">==</span><span class="s">&quot;so_value&quot;</span><span class="p">:</span>
    <span class="n">mailtext</span><span class="o">=</span><span class="s">&quot;onos_report_message,error_so_value,value not compatible with webobject please check it&quot;</span>



  <span class="k">if</span> <span class="n">error_type</span><span class="o">==</span><span class="s">&quot;parse_mail&quot;</span><span class="p">:</span>
    <span class="n">mailtext</span><span class="o">=</span><span class="s">&quot;onos_report_message,error_mail_parse,please check your mail syntax&quot;</span>


  <span class="n">mailtext</span><span class="o">=</span><span class="n">mailtext</span><span class="o">+</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span>


  <span class="k">return</span><span class="p">(</span><span class="n">mailtext</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">changeWebObjectStatus</span><span class="p">(</span><span class="n">objName</span><span class="p">,</span><span class="n">statusToSet</span><span class="p">,</span><span class="n">write_to_hardware</span><span class="p">,</span><span class="n">user</span><span class="o">=</span><span class="s">&quot;onos_sys&quot;</span><span class="p">,</span><span class="n">priority</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">mail_report_list</span><span class="o">=</span><span class="p">[]):</span><span class="c">#change a webobj status and its relative pin in the hardware_node class.</span></div>
<div class="viewcode-block" id="changeWebObjectStatus"><a class="viewcode-back" href="../webserver.html#webserver.changeWebObjectStatus">[docs]</a>
  <span class="k">print</span>  <span class="s">&quot;changeWebObjectStatus executed with obj=&quot;</span><span class="o">+</span><span class="n">objName</span>

  <span class="k">if</span> <span class="n">objName</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">object_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span> <span class="c">#if the web object does not exist exit</span>
    <span class="k">print</span> <span class="s">&quot;error the webobject does NOT exist in the dictionary object_dict &quot;</span>
    <span class="n">errorQueue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="s">&quot; error the webobject does NOT exist in the dictionary object_dict&quot;</span><span class="p">)</span>
    <span class="k">return</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>

  <span class="n">obj_previous_status</span><span class="o">=</span><span class="n">object_dict</span><span class="p">[</span><span class="n">objName</span><span class="p">]</span><span class="o">.</span><span class="n">getStatus</span><span class="p">()</span>



<span class="c">#  if (obj_previous_status==statusToSet): #&amp;(write_to_hardware==1) :  #the obj status didn&#39;t change</span>
<span class="c">#    print &quot;the webobject &quot;+objName+&quot;has already the status value you want to set &quot;</span>
<span class="c">#    errorQueue.put(&quot;the webobject &quot;+objName+&quot; has already the status value you want to set &quot;)</span>
<span class="c">#    return(1)</span>

  <span class="k">print</span> <span class="s">&quot;write_to_hardware=&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">write_to_hardware</span><span class="p">)</span>
  <span class="k">print</span> <span class="s">&quot;attached pin0 =&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">object_dict</span><span class="p">[</span><span class="n">objName</span><span class="p">]</span><span class="o">.</span><span class="n">getAttachedPinList</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span><span class="o">+</span><span class="s">&quot;;&quot;</span>    
  <span class="k">global</span> <span class="n">nodeDict</span> 



  <span class="c">#print &quot;24444444444444444444444444444444444444444444444444444444444&quot;,object_dict[objName].getMailReport()</span>
  <span class="n">mail_report_list</span><span class="o">=</span><span class="n">mail_report_list</span><span class="o">+</span><span class="n">object_dict</span><span class="p">[</span><span class="n">objName</span><span class="p">]</span><span class="o">.</span><span class="n">getMailReport</span><span class="p">()</span> <span class="c">#summ the 2 list</span>


  <span class="n">mail_report_list</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">mail_report_list</span><span class="p">))</span>   <span class="c">#removes duplicates</span>
  <span class="c">#print &quot;2222222222222222222222222222222222222222222222222222222222222&quot;,mail_report_list</span>

  <span class="k">if</span> <span class="n">object_dict</span><span class="p">[</span><span class="n">objName</span><span class="p">]</span><span class="o">.</span><span class="n">checkRequiredPriority</span><span class="p">(</span><span class="n">priority</span><span class="p">)</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>   <span class="c">#check priority </span>
    <span class="k">print</span> <span class="s">&quot;priority ok&quot;</span>
  <span class="k">else</span><span class="p">:</span>

    <span class="c">#obj_previous_status=object_dict[objName].getStatus()</span>
    <span class="n">mailText</span><span class="o">=</span><span class="n">compose_error_mail</span><span class="p">(</span><span class="s">&quot;so_priority&quot;</span><span class="p">,</span><span class="n">objName</span><span class="p">)</span>
    <span class="n">mailSubject</span><span class="o">=</span><span class="s">&quot;onos_report_error&quot;</span><span class="o">+</span><span class="n">objName</span>
    <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">mail_report_list</span><span class="p">:</span>
      <span class="c">#sendMail(m,mailtext,mailSubject,onos_mail_conf,smtplib,string)</span>
      <span class="n">mailQueue</span><span class="o">.</span><span class="n">put</span><span class="p">({</span><span class="s">&quot;mail_address&quot;</span><span class="p">:</span><span class="n">m</span><span class="p">,</span><span class="s">&quot;mailText&quot;</span><span class="p">:</span><span class="n">mailText</span><span class="p">,</span><span class="s">&quot;mailSubject&quot;</span><span class="p">:</span><span class="n">mailSubject</span><span class="p">})</span>

    <span class="k">print</span> <span class="s">&quot;error ,required priority is &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">object_dict</span><span class="p">[</span><span class="n">objName</span><span class="p">]</span><span class="o">.</span><span class="n">required_priority</span><span class="p">())</span>
    <span class="n">errorQueue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="s">&quot;error  priority not sufficent to change&quot;</span><span class="o">+</span><span class="n">objName</span><span class="o">+</span><span class="s">&quot; ,required priority is &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">object_dict</span><span class="p">[</span><span class="n">objName</span><span class="p">]</span><span class="o">.</span><span class="n">required_priority</span><span class="p">())</span> <span class="p">)</span> 


    <span class="k">return</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>

  <span class="k">if</span> <span class="n">object_dict</span><span class="p">[</span><span class="n">objName</span><span class="p">]</span><span class="o">.</span><span class="n">checkPermissions</span><span class="p">(</span><span class="n">user</span><span class="p">,</span><span class="s">&quot;x&quot;</span><span class="p">,</span><span class="n">priority</span><span class="p">):</span>   <span class="c">#check permission  </span>
    <span class="k">print</span> <span class="s">&quot;permission ok, i set the obj&quot;</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="c">#obj_previous_status=object_dict[objName].getStatus()</span>
    <span class="n">mailText</span><span class="o">=</span><span class="n">compose_error_mail</span><span class="p">(</span><span class="s">&quot;so_permissions&quot;</span><span class="p">,</span><span class="n">objName</span><span class="p">)</span>
    <span class="n">mailSubject</span><span class="o">=</span><span class="s">&quot;onos_report_error&quot;</span><span class="o">+</span><span class="n">objName</span>
    <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">mail_report_list</span><span class="p">:</span>
      <span class="c">#sendMail(m,mailtext,mailSubject,onos_mail_conf,smtplib,string)</span>
      <span class="n">mailQueue</span><span class="o">.</span><span class="n">put</span><span class="p">({</span><span class="s">&quot;mail_address&quot;</span><span class="p">:</span><span class="n">m</span><span class="p">,</span><span class="s">&quot;mailText&quot;</span><span class="p">:</span><span class="n">mailText</span><span class="p">,</span><span class="s">&quot;mailSubject&quot;</span><span class="p">:</span><span class="n">mailSubject</span><span class="p">})</span>

    <span class="k">print</span> <span class="s">&quot;error Permissions not sufficent to change&quot;</span><span class="o">+</span><span class="n">objName</span><span class="o">+</span><span class="s">&quot;,required required permission is &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">object_dict</span><span class="p">[</span><span class="n">objName</span><span class="p">]</span><span class="o">.</span><span class="n">getPermissions</span><span class="p">())</span>
    <span class="n">errorQueue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="s">&quot;error Permissions not sufficent to change&quot;</span><span class="o">+</span><span class="n">objName</span><span class="o">+</span><span class="s">&quot;,required permission is &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">object_dict</span><span class="p">[</span><span class="n">objName</span><span class="p">]</span><span class="o">.</span><span class="n">getPermissions</span><span class="p">()))</span> 
    <span class="k">return</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>






<span class="c">#  global object_dict  #banana  to remove?</span>


  <span class="k">if</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">object_dict</span><span class="p">[</span><span class="n">objName</span><span class="p">]</span><span class="o">.</span><span class="n">getAttachedPinList</span><span class="p">()[</span><span class="mi">0</span><span class="p">]))</span><span class="o">==</span><span class="mi">9999</span> <span class="p">:</span> <span class="c">#if there is no pins attached to this webobject</span>

    <span class="k">print</span> <span class="s">&quot;no pin attached to this webobject , i change its status&quot;</span>
    <span class="n">write_to_hardware</span><span class="o">=</span><span class="mi">0</span>





  <span class="k">if</span> <span class="p">(</span><span class="n">write_to_hardware</span><span class="o">==</span><span class="mi">0</span><span class="p">):</span>

    <span class="k">print</span> <span class="s">&quot;i change the webobject status&quot;</span>

    <span class="n">object_dict</span><span class="p">[</span><span class="n">objName</span><span class="p">]</span><span class="o">.</span><span class="n">setStatus</span><span class="p">(</span><span class="n">statusToSet</span><span class="p">)</span><span class="c">#set the web object status </span>
    <span class="k">if</span> <span class="p">(</span><span class="n">priority</span><span class="o">!=</span><span class="mi">99</span><span class="p">):</span>  <span class="c">#if priority == 99 will not write to webobject the new priority</span>
      <span class="n">object_dict</span><span class="p">[</span><span class="n">objName</span><span class="p">]</span><span class="o">.</span><span class="n">setRequiredPriority</span><span class="p">(</span><span class="n">priority</span><span class="p">)</span> <span class="c">#set the webobject priority</span>
    


    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">mail_report_list</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
      <span class="k">print</span> <span class="s">&quot;mail_report,&quot;</span><span class="o">+</span><span class="n">objName</span><span class="o">+</span><span class="s">&quot; changed to &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">statusToSet</span><span class="p">)</span>

      <span class="n">mailText</span><span class="o">=</span><span class="s">&quot;onos_report_message,&quot;</span><span class="o">+</span><span class="n">objName</span><span class="o">+</span><span class="s">&quot;,changed to:&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">statusToSet</span><span class="p">)</span>
      <span class="n">mailSubject</span><span class="o">=</span><span class="s">&quot;onos_report_about&quot;</span><span class="o">+</span><span class="n">objName</span>
      <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">mail_report_list</span><span class="p">:</span>
        <span class="c">#sendMail(m,mailtext,mailSubject,onos_mail_conf,smtplib,string)</span>
        <span class="n">mailQueue</span><span class="o">.</span><span class="n">put</span><span class="p">({</span><span class="s">&quot;mail_address&quot;</span><span class="p">:</span><span class="n">m</span><span class="p">,</span><span class="s">&quot;mailText&quot;</span><span class="p">:</span><span class="n">mailText</span><span class="p">,</span><span class="s">&quot;mailSubject&quot;</span><span class="p">:</span><span class="n">mailSubject</span><span class="p">})</span>


    <span class="n">scenarios_list</span><span class="o">=</span><span class="p">[]</span>
    <span class="n">scenarios_list</span><span class="o">=</span><span class="n">object_dict</span><span class="p">[</span><span class="n">objName</span><span class="p">]</span><span class="o">.</span><span class="n">getListAttachedScenarios</span><span class="p">()</span>  <span class="c">#get the list of scenarios where there is a reference to this webobject</span>
    <span class="k">print</span> <span class="s">&quot;scenarios_list:&quot;</span><span class="p">,</span><span class="n">scenarios_list</span>
    <span class="k">for</span> <span class="n">tmp_scenario</span> <span class="ow">in</span> <span class="n">scenarios_list</span><span class="p">:</span>
      <span class="k">print</span> <span class="s">&quot;scenario name:&quot;</span><span class="o">+</span><span class="n">tmp_scenario</span>
      <span class="c">#banana to add to queue</span>
      <span class="n">layerExchangeDataQueue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span> <span class="p">{</span><span class="s">&quot;cmd&quot;</span><span class="p">:</span><span class="s">&quot;scen_check&quot;</span><span class="p">,</span><span class="s">&quot;scenarioName&quot;</span><span class="p">:</span><span class="n">tmp_scenario</span><span class="p">})</span>
      <span class="c">#checkwebObjectScenarios(tmp_scenario)</span>


    <span class="k">return</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>


 




 <span class="c">#if write_to_hardware==1 then</span>


  <span class="k">print</span> <span class="s">&quot;write_to_hardware=&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">write_to_hardware</span><span class="p">)</span>
  <span class="k">try</span><span class="p">:</span><span class="c"># objName in object_dict.keys(): #if the web object exist    banana to remove</span>
    <span class="k">print</span> <span class="s">&quot;the web object:&quot;</span><span class="o">+</span><span class="n">objName</span><span class="o">+</span><span class="s">&quot; exist in the dict&quot;</span>

    <span class="n">nodeSerialNumber</span><span class="o">=</span><span class="n">object_dict</span><span class="p">[</span><span class="n">objName</span><span class="p">]</span><span class="o">.</span><span class="n">getHwNodeSerialNumber</span><span class="p">()</span>
    <span class="k">if</span>  <span class="n">nodeDict</span><span class="p">[</span><span class="n">nodeSerialNumber</span><span class="p">]</span><span class="o">.</span><span class="n">getNodeActivity</span><span class="p">()</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
      <span class="k">print</span> <span class="s">&quot;the web_object&quot;</span><span class="o">+</span><span class="n">objName</span><span class="o">+</span><span class="s">&quot; belongs to a disconnected node, i will not set it&quot;</span>
      <span class="n">errorQueue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="s">&quot;the web_object&quot;</span><span class="o">+</span><span class="n">objName</span><span class="o">+</span><span class="s">&quot; belongs to a disconnected node, i will not set it&quot;</span><span class="p">)</span>
      <span class="k">return</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>

    

    <span class="c">#except:</span>
    <span class="c">#  print &quot;statusToSet &quot;+statusToSet+&quot;can&#39;t be converted to a number &quot;</span>
    <span class="c">#  errorQueue.put(&quot;statusToSet &quot;+statusToSet+&quot;can&#39;t be converted to a number, obj:&quot;+objName)</span>



    <span class="k">if</span> <span class="p">(</span><span class="n">object_dict</span><span class="p">[</span><span class="n">objName</span><span class="p">]</span><span class="o">.</span><span class="n">validateStatusToSetObj</span><span class="p">(</span><span class="n">statusToSet</span><span class="p">)</span><span class="o">&lt;</span><span class="mi">1</span><span class="p">):</span>
      <span class="k">print</span> <span class="s">&quot;error the state&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">statusToSet</span><span class="p">)</span><span class="o">+</span><span class="s">&quot;is not valid for the obj:&quot;</span><span class="o">+</span><span class="n">objName</span>
      <span class="n">errorQueue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="s">&quot;error the state&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">statusToSet</span><span class="p">)</span><span class="o">+</span><span class="s">&quot;is not valid for the obj:&quot;</span><span class="o">+</span><span class="n">objName</span><span class="p">)</span>
      <span class="k">return</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>  

    <span class="n">statusToSet</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">statusToSet</span><span class="p">)</span>  <span class="c">#int nit float otherwise there will be errors</span>


    <span class="c">#obj_previous_status=object_dict[objName].getStatus()</span>
    <span class="c">#if statusToSet==obj_previous_status:</span>
    <span class="c">#  print &quot;nothing to change,the webobject status is already :&quot;+str(obj_previous_status)</span>
    <span class="c">#  return(1)</span>


    

    <span class="c">#if True:  # to remove..</span>
    <span class="k">print</span> <span class="s">&quot;there are one or more pins attached to this webobject&quot;</span>
    <span class="n">object_dict</span><span class="p">[</span><span class="n">objName</span><span class="p">]</span><span class="o">.</span><span class="n">setStatus</span><span class="p">(</span><span class="s">&quot;onoswait&quot;</span><span class="p">)</span><span class="c">#set the wait status</span>
    <span class="n">pins_to_set</span><span class="o">=</span><span class="n">object_dict</span><span class="p">[</span><span class="n">objName</span><span class="p">]</span><span class="o">.</span><span class="n">getAttachedPinList</span><span class="p">()</span>
    <span class="c">#single_pin=pins_to_set[0]</span>
    <span class="c">#nodeSerialNumber=object_dict[objName].getHwNodeSerialNumber()</span>
    <span class="k">print</span> <span class="s">&quot;obj node=&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">nodeSerialNumber</span><span class="p">)</span>
    <span class="c">#print nodeDict[nodeSerialNumber].getNodeName()</span>
    <span class="k">print</span> <span class="s">&quot;pins_to_set=&quot;</span><span class="p">,</span><span class="n">pins_to_set</span>

    <span class="k">print</span> <span class="s">&quot;status_to_set=&quot;</span><span class="p">,</span><span class="n">statusToSet</span>


    <span class="n">obj_type</span><span class="o">=</span><span class="n">object_dict</span><span class="p">[</span><span class="n">objName</span><span class="p">]</span><span class="o">.</span><span class="n">getType</span><span class="p">()</span>

    <span class="k">print</span> <span class="s">&quot;obj_name=&quot;</span><span class="o">+</span><span class="n">objName</span>
    <span class="k">print</span> <span class="s">&quot;obj_type=&quot;</span><span class="o">+</span><span class="n">obj_type</span>
      <span class="c">#nodeAddress=nodeDict[nodeSerialNumber].getNodeAddress()</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">obj_type</span><span class="o">==</span><span class="s">&quot;sr_relay&quot;</span><span class="p">):</span>
      <span class="k">if</span> <span class="nb">len</span> <span class="p">(</span><span class="n">pins_to_set</span><span class="p">)</span><span class="o">!=</span><span class="mi">2</span><span class="p">:</span>
        <span class="k">print</span> <span class="s">&quot;error , number of pins different from 2 for sr_relay type &quot;</span>
        <span class="n">errorQueue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="s">&quot; error , number of pins different from 2 for sr_relay type&quot;</span><span class="p">)</span>
        <span class="k">return</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>      

      

      <span class="k">if</span> <span class="n">statusToSet</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>    <span class="c"># set to 5 volt the set coil of the relay and reset the reset coil of the relay</span>
        <span class="c">#note  the set coil command is the first pin in the list , the second is the reset coil command</span>
        <span class="c">#nodeDict[nodeSerialNumber].setDigitalPinOutputStatus(pins_to_set[0],1)</span>
        <span class="c">#nodeDict[nodeSerialNumber].setDigitalPinOutputStatus(pins_to_set[1],0)</span>
        <span class="n">hardware</span><span class="o">.</span><span class="n">outputWrite</span><span class="p">(</span><span class="n">nodeSerialNumber</span><span class="p">,</span><span class="n">pins_to_set</span><span class="p">,[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span><span class="n">nodeDict</span><span class="p">[</span><span class="n">nodeSerialNumber</span><span class="p">],</span><span class="n">objName</span><span class="p">,</span><span class="n">obj_previous_status</span><span class="p">,</span><span class="n">statusToSet</span><span class="p">,</span><span class="n">obj_type</span><span class="p">,</span><span class="n">user</span><span class="p">,</span><span class="n">priority</span><span class="p">,</span><span class="n">mail_report_list</span><span class="p">)</span>
<span class="c"># note that  hardware=router_handler.RouterHandler(router_hardware,router_sn)   in conf.py</span>
          <span class="c"># put to rest the relay coil (the relay will continue to been mechanical activated)</span>
        <span class="c">#nodeDict[nodeSerialNumber].setDigitalPinOutputStatus(pins_to_set[0],0)</span>
        <span class="c">#nodeDict[nodeSerialNumber].setDigitalPinOutputStatus(pins_to_set[1],0)</span>
      <span class="k">if</span> <span class="n">statusToSet</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>    <span class="c"># set to 5 volt the reset coil of the relay and put to 0v the set coil of the relay</span>
        <span class="c">#nodeDict[nodeSerialNumber].setDigitalPinOutputStatus(pins_to_set[0],0)</span>
        <span class="c">#nodeDict[nodeSerialNumber].setDigitalPinOutputStatus(pins_to_set[1],1)</span>
        <span class="n">hardware</span><span class="o">.</span><span class="n">outputWrite</span><span class="p">(</span><span class="n">nodeSerialNumber</span><span class="p">,</span><span class="n">pins_to_set</span><span class="p">,[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span><span class="n">nodeDict</span><span class="p">[</span><span class="n">nodeSerialNumber</span><span class="p">],</span><span class="n">objName</span><span class="p">,</span><span class="n">obj_previous_status</span><span class="p">,</span><span class="n">statusToSet</span><span class="p">,</span><span class="n">obj_type</span><span class="p">,</span><span class="n">user</span><span class="p">,</span><span class="n">priority</span><span class="p">,</span><span class="n">mail_report_list</span><span class="p">)</span>

          <span class="c"># put to rest the relay coil (the relay will continue to been mechanical activated)</span>
        <span class="c">#nodeDict[nodeSerialNumber].setDigitalPinOutputStatus(pins_to_set[0],0)</span>
        <span class="c">#nodeDict[nodeSerialNumber].setDigitalPinOutputStatus(pins_to_set[1],0)</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">obj_type</span><span class="o">==</span><span class="s">&quot;analog_output&quot;</span><span class="p">):</span>
      <span class="k">print</span> <span class="s">&quot;analog output still to develop&quot;</span>  <span class="c">#banana to implement</span>
      <span class="n">hardware</span><span class="o">.</span><span class="n">outputWrite</span><span class="p">(</span><span class="n">nodeSerialNumber</span><span class="p">,</span><span class="n">pins_to_set</span><span class="p">,[</span><span class="n">statusToSet</span><span class="p">],</span><span class="n">nodeDict</span><span class="p">[</span><span class="n">nodeSerialNumber</span><span class="p">],</span><span class="n">objName</span><span class="p">,</span><span class="n">obj_previous_status</span><span class="p">,</span><span class="n">statusToSet</span><span class="p">,</span><span class="n">obj_type</span><span class="p">,</span><span class="n">user</span><span class="p">,</span><span class="n">priority</span><span class="p">,</span><span class="n">mail_report_list</span><span class="p">)</span>
      <span class="k">return</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>


    <span class="k">if</span> <span class="p">(</span><span class="n">obj_type</span><span class="o">==</span><span class="s">&quot;servo_output&quot;</span><span class="p">):</span>
      <span class="k">print</span> <span class="s">&quot;servo_output still to develop&quot;</span>  <span class="c">#banana to implement</span>
      <span class="n">hardware</span><span class="o">.</span><span class="n">outputWrite</span><span class="p">(</span><span class="n">nodeSerialNumber</span><span class="p">,</span><span class="n">pins_to_set</span><span class="p">,[</span><span class="n">statusToSet</span><span class="p">],</span><span class="n">nodeDict</span><span class="p">[</span><span class="n">nodeSerialNumber</span><span class="p">],</span><span class="n">objName</span><span class="p">,</span><span class="n">obj_previous_status</span><span class="p">,</span><span class="n">statusToSet</span><span class="p">,</span><span class="n">obj_type</span><span class="p">,</span><span class="n">user</span><span class="p">,</span><span class="n">priority</span><span class="p">,</span><span class="n">mail_report_list</span><span class="p">)</span>

      <span class="k">return</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

        
          

    <span class="k">if</span> <span class="p">((</span><span class="n">obj_type</span><span class="o">==</span><span class="s">&quot;b&quot;</span><span class="p">)</span><span class="o">|</span><span class="p">(</span><span class="n">obj_type</span><span class="o">==</span><span class="s">&quot;sb&quot;</span><span class="p">)</span><span class="o">|</span><span class="p">(</span><span class="n">obj_type</span><span class="o">==</span><span class="s">&quot;digital_output&quot;</span><span class="p">)):</span> <span class="c">#banana to check and leave only digital_output</span>
      <span class="k">if</span> <span class="p">(</span><span class="nb">len</span> <span class="p">(</span><span class="n">pins_to_set</span><span class="p">))</span><span class="o">!=</span><span class="mi">1</span><span class="p">:</span>
        <span class="k">print</span> <span class="s">&quot;error , number of pins different from 1 for button type &quot;</span>
        <span class="n">errorQueue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="s">&quot;error , number of pins different from 1 for button type , doutput section  &quot;</span><span class="p">)</span>
        <span class="k">return</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>      
      <span class="c">#nodeDict[nodeSerialNumber].setDigitalPinOutputStatus(pins_to_set[0],statusToSet)</span>
        <span class="c">#if (write_to_hardware==1): #only if you tell to write to hardware</span>
      <span class="n">hardware</span><span class="o">.</span><span class="n">outputWrite</span><span class="p">(</span><span class="n">nodeSerialNumber</span><span class="p">,</span><span class="n">pins_to_set</span><span class="p">,[</span><span class="n">statusToSet</span><span class="p">],</span><span class="n">nodeDict</span><span class="p">[</span><span class="n">nodeSerialNumber</span><span class="p">],</span><span class="n">objName</span><span class="p">,</span><span class="n">obj_previous_status</span><span class="p">,</span><span class="n">statusToSet</span><span class="p">,</span><span class="n">obj_type</span><span class="p">,</span><span class="n">user</span><span class="p">,</span><span class="n">priority</span><span class="p">,</span><span class="n">mail_report_list</span><span class="p">)</span>
      <span class="k">return</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>


    <span class="k">if</span> <span class="p">(</span><span class="n">obj_type</span><span class="o">==</span><span class="s">&quot;d_sensor&quot;</span><span class="p">)</span><span class="o">|</span><span class="p">(</span><span class="n">obj_type</span><span class="o">==</span><span class="s">&quot;digital_input&quot;</span><span class="p">):</span> <span class="c">#banana to check and leave only digital_input</span>
      <span class="k">if</span> <span class="p">(</span><span class="nb">len</span> <span class="p">(</span><span class="n">pins_to_set</span><span class="p">))</span><span class="o">!=</span><span class="mi">1</span><span class="p">:</span>
        <span class="k">print</span> <span class="s">&quot;error , number of pins different from 1 for d_sensor type &quot;</span>
        <span class="n">errorQueue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="s">&quot;error , number of pins different from 1 for d_sensor type  dread section &quot;</span><span class="p">)</span>
        <span class="k">return</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>  
      <span class="c">#nodeDict[nodeSerialNumber].setDigitalPinInputStatus(pins_to_set[0],statusToSet)</span>
      <span class="c">#if (write_to_hardware==1): #only if you tell to write to hardware</span>
      <span class="n">hardware</span><span class="o">.</span><span class="n">outputWrite</span><span class="p">(</span><span class="n">nodeSerialNumber</span><span class="p">,</span><span class="n">pins_to_set</span><span class="p">,[</span><span class="n">statusToSet</span><span class="p">],</span><span class="n">nodeDict</span><span class="p">[</span><span class="n">nodeSerialNumber</span><span class="p">],</span><span class="n">objName</span><span class="p">,</span><span class="n">obj_previous_status</span><span class="p">,</span><span class="n">statusToSet</span><span class="p">,</span><span class="n">obj_type</span><span class="p">,</span><span class="n">user</span><span class="p">,</span><span class="n">priority</span><span class="p">,</span><span class="n">mail_report_list</span><span class="p">)</span>

      <span class="k">return</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>    


  <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">e</span>  <span class="p">:</span> <span class="c"># the webobject does not exist</span>
    <span class="k">print</span> <span class="s">&quot;the webobject:&quot;</span><span class="o">+</span><span class="n">objName</span><span class="o">+</span><span class="s">&quot; doesn&#39;t exist,or others error happened&quot;</span><span class="o">+</span><span class="s">&quot; e:&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">)</span>
    <span class="n">errorQueue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="s">&quot;the webobject:&quot;</span><span class="o">+</span><span class="n">objName</span><span class="o">+</span><span class="s">&quot; doesn&#39;t exist,or others error happened&quot;</span><span class="o">+</span><span class="s">&quot; e:&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">))</span>
    <span class="k">return</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>

  <span class="k">return</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">NodePinToWebObject</span><span class="p">(</span><span class="n">node_sn</span><span class="p">,</span><span class="n">pin_number</span><span class="p">,</span><span class="n">pin_status</span><span class="p">):</span><span class="c">#change the webobject status given a node ,a pin and a status to set</span></div>
<div class="viewcode-block" id="NodePinToWebObject"><a class="viewcode-back" href="../webserver.html#webserver.NodePinToWebObject">[docs]</a>  <span class="n">write_hw_enable</span><span class="o">=</span><span class="mi">0</span>

  <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">object_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
    <span class="c">#print object_dict[a].getHwNodeSerialNumber()</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">object_dict</span><span class="p">[</span><span class="n">a</span><span class="p">]</span><span class="o">.</span><span class="n">getHwNodeSerialNumber</span><span class="p">()</span><span class="o">==</span><span class="n">node_sn</span><span class="p">):</span>
      <span class="c">#print &quot;node exist&quot;</span>
      <span class="k">if</span> <span class="n">object_dict</span><span class="p">[</span><span class="n">a</span><span class="p">]</span><span class="o">.</span><span class="n">getAttachedPinList</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span><span class="o">==</span><span class="nb">int</span><span class="p">(</span><span class="n">pin_number</span><span class="p">):</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">object_dict</span><span class="p">[</span><span class="n">a</span><span class="p">]</span><span class="o">.</span><span class="n">getAttachedPinList</span><span class="p">())</span><span class="o">==</span><span class="mi">1</span><span class="p">):</span><span class="c">#the sensor object must have only a pin attached</span>

 

          <span class="k">if</span> <span class="p">(</span><span class="n">object_dict</span><span class="p">[</span><span class="n">a</span><span class="p">]</span><span class="o">.</span><span class="n">validateStatusToSetObj</span><span class="p">(</span><span class="n">pin_status</span><span class="p">)</span><span class="o">&lt;</span><span class="mi">1</span><span class="p">):</span>
            <span class="k">print</span> <span class="s">&quot;error NodePinToWebObject the state&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">pin_status</span><span class="p">)</span><span class="o">+</span><span class="s">&quot;is not valid for the obj:&quot;</span><span class="o">+</span><span class="n">a</span>
            <span class="n">errorQueue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="s">&quot;error NodePinToWebObject the state&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">pin_status</span><span class="p">)</span><span class="o">+</span><span class="s">&quot;is not valid for the obj:&quot;</span><span class="o">+</span><span class="n">a</span><span class="p">)</span>
          <span class="k">else</span><span class="p">:</span><span class="c">#the status is legit with the webobj type</span>
            <span class="n">objName</span><span class="o">=</span><span class="n">object_dict</span><span class="p">[</span><span class="n">a</span><span class="p">]</span><span class="o">.</span><span class="n">getName</span><span class="p">()</span>                      
            <span class="c">#changeWebObjectStatus(objName,int (pin_status),write_hw_enable) #banana add to queue</span>
            <span class="n">layerExchangeDataQueue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span> <span class="p">{</span><span class="s">&quot;cmd&quot;</span><span class="p">:</span><span class="s">&quot;setSts&quot;</span><span class="p">,</span><span class="s">&quot;webObjectName&quot;</span><span class="p">:</span><span class="n">objName</span><span class="p">,</span><span class="s">&quot;status_to_set&quot;</span><span class="p">:</span><span class="nb">str</span> <span class="p">(</span><span class="n">pin_status</span><span class="p">),</span><span class="s">&quot;write_to_hw&quot;</span><span class="p">:</span><span class="n">write_hw_enable</span><span class="p">,</span><span class="s">&quot;user&quot;</span><span class="p">:</span><span class="s">&quot;onos_node&quot;</span><span class="p">,</span><span class="s">&quot;priority&quot;</span><span class="p">:</span><span class="mi">99</span><span class="p">,</span><span class="s">&quot;mail_report_list&quot;</span><span class="p">:[]})</span>

            <span class="k">print</span> <span class="s">&quot;pin changed from external node&quot;</span>                        

        <span class="k">else</span><span class="p">:</span>
          <span class="k">print</span> <span class="s">&quot;error number of pin in the NodePinToWebObject section&quot;</span>
          <span class="n">errorQueue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="s">&quot;error number of pin in the NodePinToWebObject section&quot;</span> <span class="p">)</span>  
          
  <span class="k">return</span><span class="p">()</span>



<span class="k">def</span> <span class="nf">setWebObjectDigitalStatusFromReg</span><span class="p">(</span><span class="n">node_sn_tmp</span><span class="p">,</span><span class="n">section_number</span><span class="p">,</span><span class="n">status_byte</span><span class="p">):</span></div>
<div class="viewcode-block" id="setWebObjectDigitalStatusFromReg"><a class="viewcode-back" href="../webserver.html#webserver.setWebObjectDigitalStatusFromReg">[docs]</a>  <span class="c">#change the webobject digital status given a node ,a number of section and the digital status register </span>
  <span class="n">pinToWrite</span><span class="o">=</span><span class="n">nodeDict</span><span class="p">[</span><span class="n">node_sn_tmp</span><span class="p">]</span><span class="o">.</span><span class="n">setNodeSectionDInputStatus</span><span class="p">(</span><span class="n">section_number</span><span class="p">,</span><span class="nb">ord</span><span class="p">(</span><span class="n">status_byte</span><span class="p">))</span>
  <span class="k">if</span> <span class="n">pinToWrite</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">pin</span> <span class="ow">in</span> <span class="n">pinToWrite</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
      <span class="n">status</span><span class="o">=</span><span class="n">pinToWrite</span><span class="p">[</span><span class="n">pin</span><span class="p">]</span>
      <span class="n">NodePinToWebObject</span><span class="p">(</span><span class="n">node_sn_tmp</span><span class="p">,</span><span class="n">pin</span><span class="p">,</span><span class="n">status</span><span class="p">)</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="k">print</span> <span class="s">&quot;void register&quot;</span>


  <span class="k">return</span><span class="p">()</span>


<span class="c">#def setWebObjectAnalogStatusFromReg(node_sn_tmp,analog_pin,analog_byte0,analog_byte1):</span>
<span class="k">def</span> <span class="nf">setWebObjectAnalogStatusFromReg</span><span class="p">(</span><span class="n">node_sn_tmp</span><span class="p">,</span><span class="n">analog_pin</span><span class="p">,</span><span class="n">analog_byte0</span><span class="p">):</span></div>
<div class="viewcode-block" id="setWebObjectAnalogStatusFromReg"><a class="viewcode-back" href="../webserver.html#webserver.setWebObjectAnalogStatusFromReg">[docs]</a>  <span class="c">#change the webobject analog status given a node ,an analog pin number and 2 byte register containing the analog value </span>
  <span class="c">#analogvalue=nodeDict[node_sn_tmp].setNodeAnalogInputStatusFromReg(analog_pin,ord(analog_byte0),ord(analog_byte1))</span>
  <span class="n">analogvalue</span><span class="o">=</span><span class="n">nodeDict</span><span class="p">[</span><span class="n">node_sn_tmp</span><span class="p">]</span><span class="o">.</span><span class="n">setNodeAnalogInputStatusFromReg</span><span class="p">(</span><span class="n">analog_pin</span><span class="p">,</span><span class="nb">ord</span><span class="p">(</span><span class="n">analog_byte0</span><span class="p">),</span><span class="mi">0</span><span class="p">)</span>
  <span class="k">if</span> <span class="n">analogvalue</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
      <span class="n">NodePinToWebObject</span><span class="p">(</span><span class="n">node_sn_tmp</span><span class="p">,</span><span class="n">analog_pin</span><span class="p">,</span><span class="n">analogvalue</span><span class="p">)</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="k">print</span> <span class="s">&quot;void register&quot;</span>

  <span class="k">return</span><span class="p">()</span>


<span class="k">def</span> <span class="nf">updateNodeInputStatusFromReg</span><span class="p">(</span><span class="n">node_sn0</span><span class="p">,</span><span class="n">register</span><span class="p">):</span>  </div>
<div class="viewcode-block" id="updateNodeInputStatusFromReg"><a class="viewcode-back" href="../webserver.html#webserver.updateNodeInputStatusFromReg">[docs]</a><span class="c">#decode the data register and then change the web objects status </span>
<span class="c"># and update the node status values </span>
  <span class="k">print</span> <span class="s">&quot;updateNodeInputStatusFromReg excuted with data=&quot;</span><span class="o">+</span><span class="n">register</span>
  <span class="k">print</span> <span class="s">&quot;first byte= &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="nb">ord</span><span class="p">(</span><span class="n">register</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
  <span class="k">print</span> <span class="s">&quot;len reg=&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">register</span><span class="p">))</span>
  <span class="n">setWebObjectDigitalStatusFromReg</span><span class="p">(</span><span class="n">node_sn0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">register</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>  
  <span class="n">setWebObjectDigitalStatusFromReg</span><span class="p">(</span><span class="n">node_sn0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">register</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>  
  <span class="n">setWebObjectDigitalStatusFromReg</span><span class="p">(</span><span class="n">node_sn0</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="n">register</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>  
  <span class="n">setWebObjectDigitalStatusFromReg</span><span class="p">(</span><span class="n">node_sn0</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="n">register</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>  
  <span class="n">setWebObjectDigitalStatusFromReg</span><span class="p">(</span><span class="n">node_sn0</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="n">register</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span>  
  <span class="n">setWebObjectDigitalStatusFromReg</span><span class="p">(</span><span class="n">node_sn0</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="n">register</span><span class="p">[</span><span class="mi">5</span><span class="p">])</span>  
  <span class="n">setWebObjectDigitalStatusFromReg</span><span class="p">(</span><span class="n">node_sn0</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="n">register</span><span class="p">[</span><span class="mi">6</span><span class="p">])</span>  
  <span class="n">setWebObjectDigitalStatusFromReg</span><span class="p">(</span><span class="n">node_sn0</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="n">register</span><span class="p">[</span><span class="mi">7</span><span class="p">])</span>  
  <span class="n">setWebObjectDigitalStatusFromReg</span><span class="p">(</span><span class="n">node_sn0</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="n">register</span><span class="p">[</span><span class="mi">8</span><span class="p">])</span> 
  <span class="n">msgr</span><span class="o">=</span><span class="s">&quot; &quot;</span>
  <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="nb">range</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">register</span><span class="p">)):</span>
    <span class="n">msgr</span><span class="o">=</span><span class="n">msgr</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="nb">ord</span><span class="p">(</span><span class="n">register</span><span class="p">[</span><span class="n">b</span><span class="p">]))</span><span class="o">+</span><span class="s">&quot;,&quot;</span>
  <span class="k">print</span> <span class="s">&quot;rx reg:&quot;</span><span class="o">+</span><span class="n">msgr</span>

 <span class="c"># time.sleep(3)#banana to remove</span>

  <span class="n">first_analog_pin</span><span class="o">=</span><span class="mi">14</span>
  <span class="n">last_analog_pin</span><span class="o">=</span><span class="mi">19</span>
  <span class="n">node_hw_type</span><span class="o">=</span><span class="n">nodeDict</span><span class="p">[</span><span class="n">node_sn0</span><span class="p">]</span><span class="o">.</span><span class="n">getHwType</span><span class="p">()</span>
  <span class="k">if</span> <span class="p">(</span> <span class="p">(</span><span class="n">node_hw_type</span><span class="o">==</span><span class="s">&quot;arduino2009&quot;</span><span class="p">)</span><span class="ow">or</span><span class="p">(</span><span class="n">node_hw_type</span><span class="o">==</span><span class="s">&quot;arduino_promini&quot;</span><span class="p">)</span><span class="ow">or</span><span class="p">(</span><span class="n">node_hw_type</span><span class="o">==</span><span class="s">&quot;arduino_uno&quot;</span><span class="p">)):</span>
    <span class="n">first_analog_pin</span><span class="o">=</span><span class="mi">14</span>
    <span class="n">last_analog_pin</span><span class="o">=</span><span class="mi">19</span>


  <span class="k">if</span> <span class="p">((</span><span class="n">node_hw_type</span><span class="o">==</span><span class="s">&quot;arduino_mega1280&quot;</span><span class="p">)</span><span class="ow">or</span><span class="p">(</span><span class="n">node_hw_type</span><span class="o">==</span><span class="s">&quot;arduino_mega2560&quot;</span><span class="p">)</span> <span class="p">):</span>
    <span class="n">first_analog_pin</span><span class="o">=</span><span class="mi">54</span>
    <span class="n">last_analog_pin</span><span class="o">=</span><span class="mi">69</span> 
  <span class="c">#on k=9 there is &#39;a&#39; </span>
  <span class="n">k</span><span class="o">=</span><span class="mi">10</span>
  <span class="k">for</span> <span class="n">a_pin</span> <span class="ow">in</span> <span class="nb">range</span> <span class="p">(</span><span class="n">first_analog_pin</span><span class="p">,</span><span class="n">last_analog_pin</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>   <span class="c">#for each analog pin in the hardware (2 bytes)</span>
    <span class="k">if</span> <span class="s">&quot;analog_input&quot;</span> <span class="ow">in</span> <span class="p">(</span><span class="n">hardwareModelDict</span><span class="p">[</span><span class="s">&quot;ProminiA&quot;</span><span class="p">][</span><span class="s">&quot;pin_mode&quot;</span><span class="p">]):</span>
      <span class="k">if</span> <span class="s">&quot;a_sensor&quot;</span> <span class="ow">in</span> <span class="p">(</span><span class="n">hardwareModelDict</span><span class="p">[</span><span class="s">&quot;ProminiA&quot;</span><span class="p">][</span><span class="s">&quot;pin_mode&quot;</span><span class="p">][</span><span class="s">&quot;analog_input&quot;</span><span class="p">]):</span>
        <span class="k">if</span> <span class="n">a_pin</span> <span class="ow">in</span> <span class="p">(</span><span class="n">hardwareModelDict</span><span class="p">[</span><span class="s">&quot;ProminiA&quot;</span><span class="p">][</span><span class="s">&quot;pin_mode&quot;</span><span class="p">][</span><span class="s">&quot;analog_input&quot;</span><span class="p">][</span><span class="s">&quot;a_sensor&quot;</span><span class="p">]):</span>
        <span class="c">#if the pin is used as analog input then read its value and set it in the node</span>
          <span class="k">try</span><span class="p">:</span>
           <span class="c"># setWebObjectAnalogStatusFromReg(node_sn0,a_pin,register[k+1],register[k])</span>
            <span class="n">setWebObjectAnalogStatusFromReg</span><span class="p">(</span><span class="n">node_sn0</span><span class="p">,</span><span class="n">a_pin</span><span class="p">,</span><span class="n">register</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>
            <span class="c">#print &quot;analog register=first:&quot;+str(ord(register[k]))+&quot; second:&quot;+str(ord(register[k+1]))</span>
            <span class="k">print</span> <span class="s">&quot;analog register=first:&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="nb">ord</span><span class="p">(</span><span class="n">register</span><span class="p">[</span><span class="n">k</span><span class="p">]))</span>
            <span class="k">print</span> <span class="s">&quot;analog real value=&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">((</span><span class="nb">ord</span><span class="p">(</span><span class="n">register</span><span class="p">[</span><span class="n">k</span><span class="p">])))</span>
          <span class="k">except</span><span class="p">:</span><span class="c">#banana ? error?</span>
            <span class="k">print</span> <span class="s">&quot;end of analog&quot;</span>
            <span class="k">return</span><span class="p">()</span>  
    <span class="k">print</span> <span class="s">&quot;k=&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
    <span class="c">#k=k+2</span>
    <span class="n">k</span><span class="o">=</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span>
  <span class="k">return</span><span class="p">()</span>    




<span class="k">def</span> <span class="nf">updateNodeAddress</span><span class="p">(</span><span class="n">node_sn0</span><span class="p">,</span><span class="n">node_ip</span><span class="p">):</span><span class="c"># update the node address </span></div>
<div class="viewcode-block" id="updateNodeAddress"><a class="viewcode-back" href="../webserver.html#webserver.updateNodeAddress">[docs]</a>  <span class="k">try</span><span class="p">:</span> <span class="c">#if (node_sn0 in nodeDict.keys()):</span>
    <span class="n">nodeDict</span><span class="p">[</span><span class="n">node_sn0</span><span class="p">]</span><span class="o">.</span><span class="n">updateLastNodeSync</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">())</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">nodeDict</span><span class="p">[</span><span class="n">node_sn0</span><span class="p">]</span><span class="o">.</span><span class="n">getNodeAddress</span><span class="p">())</span><span class="o">!=</span><span class="n">node_ip</span><span class="p">:</span>
      <span class="k">print</span> <span class="s">&quot;node &quot;</span><span class="o">+</span><span class="n">node_sn0</span><span class="o">+</span><span class="s">&quot; ip changed to &quot;</span><span class="o">+</span><span class="n">node_ip</span>
      <span class="n">nodeDict</span><span class="p">[</span><span class="n">node_sn0</span><span class="p">]</span><span class="o">.</span><span class="n">setNodeAddress</span><span class="p">(</span><span class="n">node_ip</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="k">print</span> <span class="s">&quot;the node has still the same ip&quot;</span>

  <span class="k">except</span><span class="p">:</span>
    <span class="k">print</span> <span class="s">&quot;error in updateNodeAddress()&quot;</span>
    <span class="n">errorQueue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span> <span class="s">&quot;error in updateNodeAddress()&quot;</span><span class="p">)</span>  

  <span class="k">return</span><span class="p">()</span>



<span class="k">def</span> <span class="nf">createNewWebObjFromNode</span><span class="p">(</span><span class="n">hwType0</span><span class="p">,</span><span class="n">node_sn</span><span class="p">):</span></div>
<div class="viewcode-block" id="createNewWebObjFromNode"><a class="viewcode-back" href="../webserver.html#webserver.createNewWebObjFromNode">[docs]</a>  <span class="n">progressive_number</span><span class="o">=</span><span class="n">node_sn</span>          <span class="c">#   [-4:]   #get 0001 from Plug6way0001 ,now get the full serial Plug6way0001</span>
  <span class="k">print</span> <span class="s">&quot;createNewWebObjFromNode executed with hwType0:&quot;</span><span class="o">+</span><span class="n">hwType0</span>
  <span class="k">global</span> <span class="n">zoneDict</span>
  <span class="k">global</span> <span class="n">object_dict</span>
  <span class="k">print</span> <span class="n">hardwareModelDict</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
  <span class="k">if</span> <span class="n">hwType0</span> <span class="ow">in</span> <span class="n">hardwareModelDict</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>  <span class="c">#if the type exist in the hardwareModelDict</span>
<span class="c">#hardwareModelDict[&quot;onosPlug6way&quot;][&quot;pin_mode&quot;][&quot;sr_relay&quot;][0]</span>
    <span class="k">print</span> <span class="s">&quot;i will create a new &quot;</span><span class="o">+</span><span class="n">hwType0</span><span class="o">+</span><span class="s">&quot;node &quot;</span>

<span class="c">#hardwareModelDict[&quot;onosPlug6way&quot;]={&quot;max_pin&quot;:12,&quot;hardware_type&quot;:&quot;arduino_2009&quot;,&quot;pin_mode&quot;:{&quot;sr_relay&quot;:{&quot;socket&quot;:[(1,2),(3,4),(5,6),(7,8),(9,10),(11,12)]}  }    }</span>


    <span class="n">list_of_different_objects_type</span><span class="o">=</span><span class="n">hardwareModelDict</span><span class="p">[</span><span class="n">hwType0</span><span class="p">][</span><span class="s">&quot;pin_mode&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="c">#get a list of different obj </span>
    <span class="k">print</span> <span class="s">&quot;list_of_different_objects_type:&quot;</span>
    <span class="k">print</span> <span class="n">list_of_different_objects_type</span>
    <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">list_of_different_objects_type</span><span class="p">:</span>
      <span class="c">#now i&#39;m inside #for example  hardwareModelDict[&quot;onosPlug6way&quot;][&quot;pin_mode&quot;]</span>
      <span class="c"># so the first a will be &quot;sr_relay&quot;</span>
      <span class="n">objType</span><span class="o">=</span><span class="n">a</span> 
      <span class="n">i</span><span class="o">=</span><span class="mi">0</span>
      <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">hardwareModelDict</span><span class="p">[</span><span class="n">hwType0</span><span class="p">][</span><span class="s">&quot;pin_mode&quot;</span><span class="p">][</span><span class="n">a</span><span class="p">]:</span>
        <span class="c">#now i&#39;m inside #for example  hardwareModelDict[&quot;onosPlug6way&quot;][&quot;pin_mode&quot;][&quot;sr_relay&quot;]</span>
        <span class="c">#print hardwareModelDict[hwType0][&quot;pin_mode&quot;][a][b]</span>
        <span class="c">#so the first b will be &quot;socket&quot;</span>
        
        <span class="n">list_of_different_webobject_names</span><span class="o">=</span><span class="n">hardwareModelDict</span><span class="p">[</span><span class="n">hwType0</span><span class="p">][</span><span class="s">&quot;pin_mode&quot;</span><span class="p">][</span><span class="n">a</span><span class="p">][</span><span class="n">b</span><span class="p">]</span>
         
        <span class="n">i</span><span class="o">=</span><span class="mi">0</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">list_of_different_webobject_names</span><span class="p">:</span> 
                     
          <span class="c">#print c</span>
          <span class="c">#now i&#39;m inside the last dictionary  </span>
          <span class="c">#the first c will be equal to (1,2) if the hwtype is sr_relay otherwise it will be like 1</span>
          <span class="c">#for example  hardwareModelDict[&quot;onosPlug6way&quot;][&quot;pin_mode&quot;][&quot;sr_relay&quot;][&quot;socket&quot;]</span>
          <span class="c">#in this example there aren&#39;t other webobject names...</span>
          <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="nb">tuple</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>  <span class="c">#if c is not a list , trasform it in a list of one element</span>
            <span class="n">c</span><span class="o">=</span><span class="p">[</span><span class="n">c</span><span class="p">]</span>
          <span class="n">new_obj_name</span><span class="o">=</span><span class="n">b</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">+</span><span class="s">&quot;_&quot;</span><span class="o">+</span><span class="n">progressive_number</span>
          <span class="n">i</span><span class="o">=</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span>            
          <span class="k">if</span> <span class="n">new_obj_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="n">zoneDict</span><span class="p">[</span><span class="n">node_sn</span><span class="p">][</span><span class="s">&quot;objects&quot;</span><span class="p">]):</span>
            <span class="n">zoneDict</span><span class="p">[</span><span class="n">node_sn</span><span class="p">][</span><span class="s">&quot;objects&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_obj_name</span><span class="p">)</span>   <span class="c">#add the object name to the zone</span>
          <span class="k">else</span><span class="p">:</span>
            <span class="k">print</span> <span class="s">&quot;warning000 the object &quot;</span><span class="o">+</span><span class="n">new_obj_name</span><span class="o">+</span><span class="s">&quot; already exist in the zoneDict &quot;</span> 
      
          <span class="k">if</span> <span class="n">new_obj_name</span> <span class="ow">not</span> <span class="ow">in</span>  <span class="n">object_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>  <span class="c">#if the object does not exist yet, create it: </span>
            <span class="k">print</span> <span class="s">&quot;added new webobj from node&quot;</span>         
            <span class="n">object_dict</span><span class="p">[</span><span class="n">new_obj_name</span><span class="p">]</span><span class="o">=</span><span class="n">newNodeWebObj</span><span class="p">(</span><span class="n">new_obj_name</span><span class="p">,</span><span class="n">objType</span><span class="p">,</span><span class="n">node_sn</span><span class="p">,</span><span class="n">c</span><span class="p">)</span>
          <span class="k">else</span><span class="p">:</span>
            <span class="k">print</span> <span class="s">&quot;warning001  the object &quot;</span><span class="o">+</span><span class="n">new_obj_name</span><span class="o">+</span><span class="s">&quot; already exist in the object_dict&quot;</span> 

  <span class="k">return</span><span class="p">()</span>





<span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">objectList</span> <span class="p">:</span>                <span class="c"># append to dictionary all the web object</span></div>
  <span class="n">object_dict</span><span class="p">[</span><span class="n">a</span><span class="o">.</span><span class="n">getName</span><span class="p">()]</span><span class="o">=</span><span class="n">a</span>
  <span class="n">changeWebObjectType</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">getName</span><span class="p">(),</span><span class="n">a</span><span class="o">.</span><span class="n">getType</span><span class="p">())</span>  <span class="c">#i call this in order to setup the node io conf for the webobjects</span>
  <span class="n">a</span><span class="o">.</span><span class="n">InitFunction</span><span class="p">()</span>
  <span class="n">s</span><span class="o">=</span><span class="n">a</span><span class="o">.</span><span class="n">getStartStatus</span><span class="p">()</span>
  <span class="n">a</span><span class="o">.</span><span class="n">setStatus</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>


<span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">object_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span><span class="c">#check and remove the not used scenarios from web_object attachedScenarios</span>
  <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">scenarioDict</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
    <span class="k">if</span> <span class="n">scenarioDict</span><span class="p">[</span><span class="n">b</span><span class="p">][</span><span class="s">&quot;conditions&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">a</span><span class="o">+</span><span class="s">&quot;_#&quot;</span><span class="p">)</span><span class="o">==-</span><span class="mi">1</span><span class="p">:</span> 
     <span class="c"># if the object is not in the conditions then remove it from web_object attachedScenarios</span>
      <span class="n">object_dict</span><span class="p">[</span><span class="n">a</span><span class="p">]</span><span class="o">.</span><span class="n">removeAttachedScenario</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">object_dict</span><span class="p">[</span><span class="n">a</span><span class="p">]</span><span class="o">.</span><span class="n">attachScenario</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>   








<span class="c">#object_dict[&quot;dayTime&quot;].attachScenario(&quot;scenario1&quot;)   #banana to remove</span>
<span class="c">#object_dict[&quot;hours&quot;].attachScenario(&quot;scenario2&quot;)   #banana to remove</span>
<span class="c">#object_dict[&quot;hours&quot;].attachScenario(&quot;scenario3&quot;)   #banana to remove</span>
<span class="c">#object_dict[&quot;hours&quot;].attachScenario(&quot;scenario4&quot;)   #banana to remove</span>
<span class="c">#object_dict[&quot;hours&quot;].attachScenario(&quot;scenario5&quot;)   #banana to remove</span>
<span class="c">#object_dict[&quot;hours&quot;].attachScenario(&quot;scenario6&quot;)   #banana to remove</span>
<span class="c">#object_dict[&quot;hours&quot;].attachScenario(&quot;scenario7&quot;)   #banana to remove</span>
<span class="c">#object_dict[&quot;hours&quot;].attachScenario(&quot;scenario10&quot;)   #banana to remove</span>

<span class="c">#object_dict[&quot;minutes&quot;].attachScenario(&quot;scenario2&quot;)   #banana to remove</span>
<span class="c">#object_dict[&quot;minutes&quot;].attachScenario(&quot;scenario3&quot;)   #banana to remove</span>
<span class="c">#object_dict[&quot;minutes&quot;].attachScenario(&quot;scenario4&quot;)   #banana to remove</span>
<span class="c">#object_dict[&quot;minutes&quot;].attachScenario(&quot;scenario5&quot;)   #banana to remove</span>
<span class="c">#object_dict[&quot;minutes&quot;].attachScenario(&quot;scenario6&quot;)   #banana to remove</span>
<span class="c">#object_dict[&quot;minutes&quot;].attachScenario(&quot;scenario7&quot;)   #banana to remove</span>
<span class="c">#object_dict[&quot;minutes&quot;].attachScenario(&quot;scenario8&quot;)   #banana to remove</span>
<span class="c">#object_dict[&quot;wifi0_Plug6way0001&quot;].attachScenario(&quot;scenario9&quot;)   #banana to remove</span>

<span class="c">#object_dict[&quot;Wifi_netgear&quot;].attachScenario(&quot;scenario10&quot;)   #banana to remove</span>
<span class="c">#object_dict[&quot;Caldaia&quot;].attachScenario(&quot;scenario11&quot;)   #banana to remove</span>
<span class="c">#object_dict[&quot;button0_RouterGL0000&quot;].setMailReport([&quot;electronicflame@gmail.com&quot;]) #banana to remove</span>
<span class="c">#object_dict[&quot;wifi0_Plug6way0001=0&quot;].setMailReport([&quot;electronicflame@gmail.com&quot;]) #banana to remove</span>
<span class="c">#print &quot;room dict=&quot;</span>
<span class="c">#print zoneDict</span>











<span class="k">def</span> <span class="nf">formParse</span><span class="p">(</span><span class="n">text</span><span class="p">):</span>
<div class="viewcode-block" id="formParse"><a class="viewcode-back" href="../webserver.html#webserver.formParse">[docs]</a>
  <span class="n">text</span><span class="o">=</span><span class="n">string</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="s">&quot;%20&quot;</span><span class="p">,</span> <span class="s">&quot; &quot;</span><span class="p">)</span>   <span class="c">#removes the %20 that were created instead of the spaces</span>
  <span class="n">text</span><span class="o">=</span><span class="n">string</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="s">&#39;,&amp;%&#39;</span><span class="p">,</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span> 
  <span class="n">text</span><span class="o">=</span><span class="n">string</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="s">&#39;%7D&#39;</span><span class="p">,</span> <span class="s">&#39;}&#39;</span><span class="p">)</span> 
  <span class="n">text</span><span class="o">=</span><span class="n">string</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="s">&#39;%7B&#39;</span><span class="p">,</span> <span class="s">&#39;{&#39;</span><span class="p">)</span> 
  <span class="k">return</span> <span class="p">(</span><span class="n">text</span><span class="p">)</span>


<span class="c">#if there is a css of a web_object and option is to remove this web_object then find it and remove the css part  #web_object</span>
<span class="c">#then find the id=web_object  and remove it </span>
<span class="c">#if the option is &quot;add&quot; then find the &quot;/*start of automatic css,do not remove this comment*/&quot; and add after this the reative css</span>
<span class="c">#add also the id=web_object  on the end of the body</span>

<span class="k">def</span> <span class="nf">findRoomName</span><span class="p">(</span><span class="n">path</span><span class="p">,</span><span class="n">roomDictionary</span><span class="p">):</span></div>
<div class="viewcode-block" id="findRoomName"><a class="viewcode-back" href="../webserver.html#webserver.findRoomName">[docs]</a>  <span class="k">print</span> <span class="s">&quot;findRoomName()  executed&quot;</span>
  <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">path</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">):</span>
    <span class="n">address_list</span><span class="o">=</span><span class="n">string</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">path</span><span class="p">,</span><span class="s">&quot;/&quot;</span><span class="p">)</span>  
    <span class="k">if</span> <span class="n">address_list</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">in</span> <span class="n">roomDictionary</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="p">:</span>    <span class="c">#if  the path is   /anyroomname/....   take the room name</span>
      <span class="n">room</span><span class="o">=</span><span class="n">address_list</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>    
      <span class="k">return</span><span class="p">(</span><span class="n">room</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span> 
      <span class="k">print</span> <span class="s">&quot;no room name found&quot;</span>
      <span class="k">return</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="c">#no room found</span>

  <span class="k">return</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>



<span class="k">def</span> <span class="nf">modPage</span><span class="p">(</span><span class="n">htmlPag</span><span class="p">,</span><span class="n">WebObjectdictionary</span><span class="p">,</span><span class="n">zone</span><span class="p">,</span><span class="n">zoneDictionary</span><span class="p">):</span></div>
<div class="viewcode-block" id="modPage"><a class="viewcode-back" href="../webserver.html#webserver.modPage">[docs]</a>

  <span class="c">#print &quot;java&quot;+onos_automatic_javascript</span>
  <span class="c">#print htmlPag</span>
  <span class="n">onos_automatic_meta</span><span class="o">=</span><span class="s">&#39;&#39;&#39;&lt;meta charset=&quot;utf-8&quot;&gt; &lt;meta name=&quot;viewport&quot; content=&quot;width=device-width&quot;&gt;&#39;&#39;&#39;</span>  
  <span class="n">onos_automatic_css_style</span><span class="o">=</span><span class="s">&#39;&#39;</span>


  <span class="k">print</span> <span class="s">&quot;modPage()  executed&quot;</span>
  <span class="k">if</span> <span class="n">zone</span> <span class="ow">in</span> <span class="n">zoneDictionary</span><span class="p">:</span>
    <span class="n">zoneObjList</span><span class="o">=</span><span class="n">zoneDictionary</span><span class="p">[</span><span class="n">zone</span><span class="p">][</span><span class="s">&quot;objects&quot;</span><span class="p">]</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="k">print</span> <span class="s">&quot;zone not in the system&quot;</span><span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">zone</span><span class="p">)</span>
    <span class="n">zoneObjList</span><span class="o">=</span><span class="p">[]</span>
    <span class="k">return</span><span class="p">(</span><span class="n">htmlPag</span><span class="p">)</span>
  <span class="n">tmp_pag</span><span class="o">=</span><span class="n">htmlPag</span>

  <span class="k">try</span><span class="p">:</span>
    <span class="n">onos_automatic_body_style</span><span class="o">=</span><span class="s">&#39;&#39;&#39; body {&#39;&#39;&#39;</span><span class="o">+</span><span class="n">WebObjectdictionary</span><span class="p">[</span><span class="n">zone</span><span class="o">+</span><span class="s">&#39;_body&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">getStyle</span><span class="p">()</span><span class="o">+</span><span class="s">&#39;&#39;&#39;}&#39;&#39;&#39;</span>
  <span class="k">except</span><span class="p">:</span>
    <span class="n">onos_automatic_body_style</span><span class="o">=</span><span class="s">&#39; &#39;</span>
    <span class="c">#print &quot;no  body obj found in zone&quot;+zone</span>
  <span class="c">#print zoneObjList</span>



  <span class="c">#zoneObjList.sort()</span>
  <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">zoneObjList</span> <span class="p">:</span>
    <span class="n">onos_automatic_css_style</span><span class="o">=</span><span class="n">onos_automatic_css_style</span><span class="o">+</span><span class="s">&#39;&#39;&#39;#&#39;&#39;&#39;</span><span class="o">+</span><span class="n">obj</span><span class="o">+</span><span class="s">&#39;&#39;&#39;{&#39;&#39;&#39;</span><span class="o">+</span><span class="n">WebObjectdictionary</span><span class="p">[</span><span class="n">obj</span><span class="p">]</span><span class="o">.</span><span class="n">getStyle</span><span class="p">()</span><span class="o">+</span><span class="s">&#39;&#39;&#39;}&#39;&#39;&#39;</span>

    

     <span class="c">#print &quot;zone+body=&quot;+zone+&#39;_body&#39;</span>
    <span class="k">if</span> <span class="n">string</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span><span class="n">zone</span><span class="o">+</span><span class="s">&quot;_body&quot;</span><span class="p">)</span><span class="o">!=-</span><span class="mi">1</span><span class="p">:</span><span class="c">#skip to display the body obj</span>
      <span class="k">continue</span>   
    <span class="c">#print &#39;obj=&#39;+obj      </span>
    <span class="n">status</span><span class="o">=</span><span class="n">WebObjectdictionary</span><span class="p">[</span><span class="n">obj</span><span class="p">]</span><span class="o">.</span><span class="n">getStatus</span><span class="p">()</span> 
    <span class="n">onos_automatic_local_style</span><span class="o">=</span><span class="s">&#39;&#39;&#39;style=&quot;&#39;&#39;&#39;</span><span class="o">+</span><span class="n">WebObjectdictionary</span><span class="p">[</span><span class="n">obj</span><span class="p">]</span><span class="o">.</span><span class="n">getStyle</span><span class="p">()</span><span class="o">+</span><span class="s">&#39;&#39;&#39;&quot;&#39;&#39;&#39;</span>     
    <span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span><span class="o">|</span><span class="p">(</span><span class="n">status</span><span class="o">==</span><span class="s">&quot;0&quot;</span><span class="p">):</span> <span class="c">#banana to implement  a method to allow analog status</span>
      <span class="n">status_to_set</span><span class="o">=</span><span class="s">&quot;1&quot;</span>
      <span class="n">img_html</span><span class="o">=</span><span class="s">&#39;&#39;&#39;&lt;!--start_img&#39;&#39;&#39;</span><span class="o">+</span><span class="n">obj</span><span class="o">+</span><span class="s">&#39;&#39;&#39;--&gt;&lt;img class=&quot;flex&quot; src=&quot;/img/on.png&quot; class=&quot;image&quot; /&gt;  &lt;!--end_img&#39;&#39;&#39;</span><span class="o">+</span><span class="n">obj</span><span class="o">+</span><span class="s">&#39;&#39;&#39;--&gt;&#39;&#39;&#39;</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">status_to_set</span><span class="o">=</span><span class="s">&quot;0&quot;</span>
      <span class="n">img_html</span><span class="o">=</span><span class="s">&#39;&#39;&#39;&lt;!--start_img&#39;&#39;&#39;</span><span class="o">+</span><span class="n">obj</span><span class="o">+</span><span class="s">&#39;&#39;&#39;--&gt;&lt;img class=&quot;flex&quot; src=&quot;/img/off.png&quot; class=&quot;image&quot; /&gt;  &lt;!--end_img&#39;&#39;&#39;</span><span class="o">+</span><span class="n">obj</span><span class="o">+</span><span class="s">&#39;&#39;&#39;--&gt;&#39;&#39;&#39;</span>

    <span class="n">onos_automatic_object_html</span><span class="o">=</span><span class="n">WebObjectdictionary</span><span class="p">[</span><span class="n">obj</span><span class="p">]</span><span class="o">.</span><span class="n">getHtml</span><span class="p">()</span>
    <span class="n">onos_automatic_object_id</span><span class="o">=</span><span class="s">&#39;&#39;&#39; id=&quot;&#39;&#39;&#39;</span><span class="o">+</span><span class="n">obj</span><span class="o">+</span><span class="s">&#39;&#39;&#39;&quot; &#39;&#39;&#39;</span>

    <span class="n">objType</span><span class="o">=</span><span class="n">WebObjectdictionary</span><span class="p">[</span><span class="n">obj</span><span class="p">]</span><span class="o">.</span><span class="n">getType</span><span class="p">()</span> 
    <span class="k">if</span> <span class="p">(</span><span class="n">objType</span><span class="o">==</span><span class="s">&quot;b&quot;</span><span class="p">)</span><span class="o">|</span><span class="p">(</span><span class="n">objType</span><span class="o">==</span><span class="s">&quot;sb&quot;</span><span class="p">)</span><span class="o">|</span><span class="p">(</span><span class="n">objType</span><span class="o">==</span><span class="s">&quot;sr_relay&quot;</span><span class="p">)</span><span class="o">|</span><span class="p">(</span><span class="n">objType</span><span class="o">==</span><span class="s">&quot;digital_output&quot;</span><span class="p">):</span>  <span class="c">#banana to use group</span>
      <span class="n">onos_automatic_object_href</span><span class="o">=</span><span class="s">&#39;&#39;&#39;href=&quot;?&#39;&#39;&#39;</span><span class="o">+</span><span class="n">obj</span><span class="o">+</span><span class="s">&#39;&#39;&#39;=&#39;&#39;&#39;</span><span class="o">+</span><span class="n">status_to_set</span><span class="o">+</span><span class="s">&#39;&#39;&#39;&quot;&#39;&#39;&#39;</span>
      <span class="n">onos_automatic_object</span><span class="o">=</span> <span class="s">&#39;&#39;&#39;&lt;a id=&quot;&#39;&#39;&#39;</span><span class="o">+</span><span class="n">obj</span><span class="o">+</span><span class="s">&#39;&#39;&#39;&quot; onmousedown=&quot;stopUpdate()&quot; onmouseout=&quot;restartUpdate()&quot; &#39;&#39;&#39;</span><span class="o">+</span> <span class="n">onos_automatic_object_href</span><span class="o">+</span><span class="s">&#39;&#39;&#39; &gt; &#39;&#39;&#39;</span><span class="o">+</span><span class="n">onos_automatic_object_html</span><span class="o">+</span><span class="s">&#39;&#39;&#39;&lt;/a&gt;&#39;&#39;&#39;</span>
      <span class="n">onos_automatic_object_a</span><span class="o">=</span><span class="s">&#39;&#39;&#39;&lt;a id=&quot;&#39;&#39;&#39;</span><span class="o">+</span><span class="n">obj</span><span class="o">+</span><span class="s">&#39;&#39;&#39;&quot; onmousedown=&quot;stopUpdate()&quot; onmouseout=&quot;restartUpdate()&quot; &#39;&#39;&#39;</span><span class="o">+</span> <span class="n">onos_automatic_object_href</span><span class="o">+</span><span class="s">&#39;&#39;&#39;&gt;&#39;&#39;&#39;</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">onos_automatic_object_href</span><span class="o">=</span><span class="s">&#39;&#39;</span>
      <span class="n">onos_automatic_object</span><span class="o">=</span> <span class="s">&#39;&#39;&#39;&lt;a id=&quot;&#39;&#39;&#39;</span><span class="o">+</span><span class="n">obj</span><span class="o">+</span><span class="s">&#39;&#39;&#39;&quot; &gt; &#39;&#39;&#39;</span><span class="o">+</span><span class="n">onos_automatic_object_html</span><span class="o">+</span><span class="s">&#39;&#39;&#39;&lt;/a&gt;&#39;&#39;&#39;</span>
      <span class="n">onos_automatic_object_a</span><span class="o">=</span><span class="s">&#39;&#39;</span>


 

    <span class="c">#current_time_hours=(int(strftime(&quot;%M&quot;, gmtime()))+time_gap+( int(strftime(&quot;%H&quot;, gmtime())) )*60)//60 </span>
    <span class="c">#current_time_minutes=(int(strftime(&quot;%M&quot;, gmtime()))+time_gap+(int(strftime(&quot;%H&quot;, gmtime())))*60)%60</span>
    <span class="c">#tmp_pag=tmp_pag.replace(&#39;&#39;&#39;&lt;!--onos_system_time--&gt;&#39;&#39;&#39;,str(current_time_hours)+&quot;:&quot;+str(current_time_minutes)+&quot;:&quot;+str(time.timezone),1)</span>

    <span class="n">tmp_pag</span><span class="o">=</span><span class="n">tmp_pag</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;&#39;&#39;&lt;!--onos_system_time--&gt;&#39;&#39;&#39;</span><span class="p">,</span><span class="nb">str</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">localtime</span><span class="p">()[</span><span class="mi">3</span><span class="p">])</span><span class="o">+</span><span class="s">&quot;:&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">localtime</span><span class="p">()[</span><span class="mi">4</span><span class="p">]),</span><span class="mi">1</span><span class="p">)</span>

    <span class="n">tmp_pag</span><span class="o">=</span><span class="n">tmp_pag</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;&#39;&#39;&lt;!--onos_automatic_local_style--&gt;&#39;&#39;&#39;</span><span class="p">,</span><span class="n">onos_automatic_local_style</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">tmp_pag</span><span class="o">=</span><span class="n">tmp_pag</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;&#39;&#39;&lt;!--onos_automatic_object--&gt;&#39;&#39;&#39;</span><span class="p">,</span><span class="n">onos_automatic_object</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">tmp_pag</span><span class="o">=</span><span class="n">tmp_pag</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;&#39;&#39;&lt;!--onos_automatic_object_a--&gt;&#39;&#39;&#39;</span><span class="p">,</span><span class="n">onos_automatic_object_a</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> 
    <span class="n">tmp_pag</span><span class="o">=</span><span class="n">tmp_pag</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;&#39;&#39;&lt;!--onos_automatic_object_id--&gt;&#39;&#39;&#39;</span><span class="p">,</span><span class="n">onos_automatic_object_id</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> 
    <span class="n">tmp_pag</span><span class="o">=</span><span class="n">tmp_pag</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;&#39;&#39;&lt;!--onos_automatic_object_href--&gt;&#39;&#39;&#39;</span><span class="p">,</span><span class="n">onos_automatic_object_href</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> 
    <span class="n">tmp_pag</span><span class="o">=</span><span class="n">tmp_pag</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;&#39;&#39;&lt;!--onos_automatic_object_html--&gt;&#39;&#39;&#39;</span><span class="p">,</span><span class="n">onos_automatic_object_html</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> 

    <span class="n">tmp_pag</span><span class="o">=</span><span class="n">tmp_pag</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;&#39;&#39;&lt;!--start_img&#39;&#39;&#39;</span><span class="o">+</span><span class="n">obj</span><span class="o">+</span><span class="s">&#39;&#39;&#39;--&gt;&lt;img class=&quot;flex&quot; src=&quot;/img/on.png&quot; class=&quot;image&quot; /&gt;  &lt;!--end_img&#39;&#39;&#39;</span><span class="o">+</span><span class="n">obj</span><span class="o">+</span><span class="s">&#39;&#39;&#39;--&gt;&#39;&#39;&#39;</span><span class="p">,</span><span class="n">img_html</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>     
    <span class="n">tmp_pag</span><span class="o">=</span><span class="n">tmp_pag</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;&#39;&#39;&lt;!--start_img&#39;&#39;&#39;</span><span class="o">+</span><span class="n">obj</span><span class="o">+</span><span class="s">&#39;&#39;&#39;--&gt;&lt;img class=&quot;flex&quot; src=&quot;/img/off.png&quot; class=&quot;image&quot; /&gt;  &lt;!--end_img&#39;&#39;&#39;</span><span class="o">+</span><span class="n">obj</span><span class="o">+</span><span class="s">&#39;&#39;&#39;--&gt;&#39;&#39;&#39;</span><span class="p">,</span><span class="n">img_html</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>     

    <span class="n">tmp_pag</span><span class="o">=</span><span class="n">tmp_pag</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;&#39;&#39;&lt;!--onos_automatic_object=&#39;&#39;&#39;</span><span class="o">+</span><span class="n">obj</span><span class="o">+</span><span class="s">&#39;&#39;&#39;--&gt;&#39;&#39;&#39;</span><span class="p">,</span><span class="n">onos_automatic_object</span><span class="p">)</span>  
    <span class="n">tmp_pag</span><span class="o">=</span><span class="n">tmp_pag</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;&#39;&#39;&lt;!--onos_automatic_object_href=&#39;&#39;&#39;</span><span class="o">+</span><span class="n">obj</span><span class="o">+</span><span class="s">&#39;&#39;&#39;--&gt;&#39;&#39;&#39;</span><span class="p">,</span><span class="n">onos_automatic_object_href</span><span class="p">)</span>  
    <span class="n">tmp_pag</span><span class="o">=</span><span class="n">tmp_pag</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;&#39;&#39;&lt;!--onos_automatic_object_html=&#39;&#39;&#39;</span><span class="o">+</span><span class="n">obj</span><span class="o">+</span><span class="s">&#39;&#39;&#39;--&gt;&#39;&#39;&#39;</span><span class="p">,</span><span class="n">onos_automatic_object_html</span><span class="p">)</span> 
 
  <span class="n">tmp_pag</span><span class="o">=</span><span class="n">tmp_pag</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;&#39;&#39;&lt;!--onos_automatic_body_style--&gt;&#39;&#39;&#39;</span><span class="p">,</span><span class="n">onos_automatic_body_style</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>    
  <span class="n">tmp_pag</span><span class="o">=</span><span class="n">tmp_pag</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;&#39;&#39;&lt;!--onos_automatic_meta--&gt;&#39;&#39;&#39;</span><span class="p">,</span><span class="n">onos_automatic_meta</span><span class="p">);</span>
  <span class="n">tmp_pag</span><span class="o">=</span><span class="n">tmp_pag</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;&#39;&#39;&lt;!--onos_automatic_javascript--&gt;&#39;&#39;&#39;</span><span class="p">,</span><span class="n">onos_automatic_javascript</span><span class="p">)</span>
  <span class="n">tmp_pag</span><span class="o">=</span><span class="n">tmp_pag</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;&#39;&#39;&lt;!--onos_automatic_css_style--&gt;&#39;&#39;&#39;</span><span class="p">,</span><span class="n">onos_automatic_css_style</span><span class="p">)</span>


<span class="c"># remove the unused reference</span>

  <span class="n">tmp_pag</span><span class="o">=</span><span class="n">tmp_pag</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;&#39;&#39;&lt;!--onos_automatic_local_style--&gt;&#39;&#39;&#39;</span><span class="p">,</span><span class="s">&#39; &#39;</span><span class="p">)</span>
  <span class="n">tmp_pag</span><span class="o">=</span><span class="n">tmp_pag</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;&#39;&#39;&lt;!--onos_automatic_object--&gt;&#39;&#39;&#39;</span><span class="p">,</span><span class="s">&#39; &#39;</span><span class="p">)</span> 
  <span class="n">tmp_pag</span><span class="o">=</span><span class="n">tmp_pag</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;&#39;&#39;&lt;!--onos_automatic_object_id--&gt;&#39;&#39;&#39;</span><span class="p">,</span><span class="s">&#39; &#39;</span><span class="p">)</span>
  <span class="n">tmp_pag</span><span class="o">=</span><span class="n">tmp_pag</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;&#39;&#39;&lt;!--onos_automatic_object_href--&gt;&#39;&#39;&#39;</span><span class="p">,</span><span class="s">&#39; &#39;</span><span class="p">)</span>  
  <span class="n">tmp_pag</span><span class="o">=</span><span class="n">tmp_pag</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;&#39;&#39;&lt;!--onos_automatic_object_html--&gt;&#39;&#39;&#39;</span><span class="p">,</span><span class="s">&#39; &#39;</span><span class="p">)</span>  

  <span class="n">tmp_pag</span><span class="o">=</span><span class="n">tmp_pag</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;&#39;&#39;&lt;!--onos_automatic_object_a--&gt;&#39;&#39;&#39;</span><span class="p">,</span><span class="s">&#39;&#39;&#39;style=&quot;visibility: hidden&quot;&#39;&#39;&#39;</span><span class="p">)</span> <span class="c">#hide the unused &lt;a&gt;</span>
  <span class="c">#because there are more request than the number of webobject in the zone ,hide the html for the empty ones..</span>


  <span class="k">return</span> <span class="p">(</span><span class="n">tmp_pag</span><span class="p">)</span>













<span class="k">def</span> <span class="nf">getRoomHtml</span><span class="p">(</span><span class="n">room</span><span class="p">,</span><span class="n">object_dictionary</span><span class="p">,</span><span class="n">path</span><span class="p">,</span><span class="n">roomDictionary</span><span class="p">):</span>  <span class="c">#render the html to insert in the index.html of a room directory  which must be inside the baseRoomPath directory, modify to read the html ..</span></div>
<div class="viewcode-block" id="getRoomHtml"><a class="viewcode-back" href="../webserver.html#webserver.getRoomHtml">[docs]</a>  <span class="k">print</span> <span class="s">&quot;getRoomHtml()executed&quot;</span>

  

  <span class="n">retval</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span>   <span class="c">#you musn&#39;t have spaces on the path..</span>
  <span class="c">#print &quot;retval:&quot;+retval</span>
  <span class="c">#x=retval+&quot;/&quot;room+&quot;/index.html&quot;</span>
  <span class="k">print</span> <span class="s">&quot;room passed=&quot;</span><span class="o">+</span><span class="n">room</span>
  <span class="n">x</span><span class="o">=</span><span class="n">retval</span><span class="o">+</span><span class="s">&quot;/&quot;</span><span class="o">+</span><span class="n">baseRoomPath</span><span class="o">+</span><span class="n">room</span><span class="o">+</span><span class="s">&quot;/index.html&quot;</span>
  <span class="c">#x=string.replace(x, &#39;,&amp;%&#39;, &#39;&#39;) </span>
  <span class="c">#x=string.replace(x, &#39;\n&#39;, &#39;&#39;) </span>
  <span class="n">readed_html</span><span class="o">=</span><span class="s">&quot;nothing&quot;</span>
  <span class="k">print</span> <span class="s">&quot;file to open=&quot;</span><span class="o">+</span><span class="n">x</span>

  

    
  <span class="k">try</span><span class="p">:</span>
    <span class="n">in_file</span><span class="o">=</span><span class="nb">open</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="s">&quot;r&quot;</span><span class="p">)</span>
    <span class="n">readed_html</span> <span class="o">=</span> <span class="n">in_file</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
    <span class="n">in_file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
 
      <span class="c">#readed_html =os.popen(&quot;cat &quot;+x).read()   # don&#39;t use the standard method because the file is opened  otherwere</span>
      
  <span class="k">except</span><span class="p">:</span>
    <span class="k">print</span> <span class="s">&quot;can&#39;t open file:&quot;</span><span class="o">+</span><span class="n">x</span><span class="o">+</span><span class="s">&quot;end&quot;</span>


  <span class="c">#print &quot;readed htm=&quot;+readed_html+&quot;end&quot;</span>


  

  <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">readed_html</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">10</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="n">string</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">readed_html</span><span class="p">,</span><span class="s">&#39;&lt;!--onos_automatic_page--&gt;&#39;</span><span class="p">)</span><span class="o">==-</span><span class="mi">1</span><span class="p">):</span>  <span class="c">#if the file exist and is not automatic then serve it as it is </span>

    <span class="c">#roomHtml=readed_html</span>
    <span class="k">return</span><span class="p">(</span><span class="n">readed_html</span><span class="p">)</span>
    <span class="c">#print &quot;html parsed &quot;</span>
    <span class="c">#if (string.find(readed_html,&#39;&lt;!--onos_automatic_page--&gt;&#39;)!=-1):</span>
      <span class="c">#roomHtml=modPage(readed_html,object_dictionary,room,roomDictionary) </span>
    <span class="c">#  return(roomHtml)</span>
    <span class="c">#else:</span>
    <span class="c">#  print &quot; readed_html is:not &lt;!--onos_automatic_page--&gt;&quot;</span>
    <span class="c">#  return(roomHtml)</span>

  <span class="k">else</span><span class="p">:</span>  <span class="c">#modify or update the page </span>
    <span class="k">print</span> <span class="s">&quot;readed_html is:not &lt;!--onos_automatic_page--&gt;&quot;</span>

  <span class="c">#if the file does not exist</span>
  <span class="c">#roomHtml=play_zone_start_html+ &#39;&#39;&#39;&lt;div id=&quot;header&quot;&gt;&#39;&#39;&#39;+room.upper()+&#39;&#39;&#39;&lt;/div&gt;&#39;&#39;&#39;</span>
  
  <span class="k">if</span> <span class="n">room</span> <span class="ow">in</span> <span class="n">roomDictionary</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>  
    <span class="n">cgi_name</span><span class="o">=</span><span class="s">&quot;gui/pag_creator.py&quot;</span>
    <span class="n">zone</span><span class="o">=</span><span class="n">zoneDict</span><span class="p">[</span><span class="n">room</span><span class="p">]</span>
    <span class="n">namespace</span><span class="o">=</span><span class="p">{}</span> 
    <span class="n">web_page</span><span class="o">=</span><span class="s">&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="nb">execfile</span><span class="p">(</span><span class="n">cgi_name</span><span class="p">,</span><span class="nb">locals</span><span class="p">(),</span><span class="n">namespace</span><span class="p">)</span>  <span class="c">#execute external script /gui/pag_creator.py</span>
      <span class="n">roomHtml</span><span class="o">=</span><span class="n">namespace</span><span class="p">[</span><span class="s">&quot;web_page&quot;</span><span class="p">]</span>  
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span> 
      <span class="k">print</span> <span class="s">&quot;error executing /gui/pag_creator.py e:&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">)</span>
      <span class="n">errorQueue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="s">&quot;error executing /gui/pag_creator.py e:&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">))</span> 
    <span class="n">roomHtml</span><span class="o">=</span><span class="s">&quot;error executing /gui/pag_creator.py&quot;</span>
    <span class="k">return</span><span class="p">(</span><span class="n">roomHtml</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">updateOneRoom</span><span class="p">(</span><span class="n">room</span><span class="p">):</span></div>
<div class="viewcode-block" id="updateOneRoom"><a class="viewcode-back" href="../webserver.html#webserver.updateOneRoom">[docs]</a>  <span class="n">retval</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span>
  <span class="n">html_file_location</span><span class="o">=</span><span class="n">retval</span><span class="o">+</span><span class="s">&quot;/&quot;</span><span class="o">+</span><span class="n">baseRoomPath</span><span class="o">+</span><span class="n">room</span><span class="o">+</span><span class="s">&quot;/index.html&quot;</span>
  <span class="k">print</span> <span class="s">&quot;updateOneRoom()  executed  with room:&quot;</span><span class="o">+</span><span class="n">room</span><span class="o">+</span><span class="s">&quot;;&quot;</span>
  <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">html_file_location</span><span class="p">):</span>   <span class="c">#if the directory exist don&#39;t create it</span>
    <span class="k">print</span> <span class="n">room</span><span class="o">+</span><span class="s">&quot; exist so i don&#39;t create it&quot;</span>
    <span class="n">fileToWrite</span><span class="o">=</span><span class="n">getRoomHtml</span><span class="p">(</span><span class="n">room</span><span class="p">,</span><span class="n">object_dict</span><span class="p">,</span><span class="s">&quot;&quot;</span><span class="p">,</span><span class="n">zoneDict</span><span class="p">)</span>
    <span class="n">file0</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">baseRoomPath</span><span class="o">+</span><span class="n">room</span><span class="o">+</span><span class="s">&quot;/index.html&quot;</span><span class="p">,</span> <span class="s">&quot;w&quot;</span><span class="p">)</span>
    <span class="n">file0</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">fileToWrite</span><span class="p">)</span>
    <span class="n">file0</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="c">#os.system(&quot;chmod 777 &quot;+html_file_location)</span>
    <span class="k">with</span> <span class="n">lock_bash_cmd</span><span class="p">:</span>
      <span class="n">subprocess</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="s">&quot;chmod 777 &quot;</span><span class="o">+</span><span class="n">html_file_location</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span><span class="n">close_fds</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

  <span class="k">else</span><span class="p">:</span>
    <span class="k">print</span> <span class="s">&quot;i make the directory&quot;</span><span class="o">+</span><span class="n">room</span>
    <span class="c">#os.system(&quot;mkdir &quot;+baseRoomPath+room) </span>
    <span class="k">with</span> <span class="n">lock_bash_cmd</span><span class="p">:</span>
      <span class="n">subprocess</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="s">&quot;mkdir &quot;</span><span class="o">+</span><span class="n">baseRoomPath</span><span class="o">+</span><span class="n">room</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span><span class="n">close_fds</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span> 
    <span class="n">fileToWrite</span><span class="o">=</span><span class="n">getRoomHtml</span><span class="p">(</span><span class="n">room</span><span class="p">,</span><span class="n">object_dict</span><span class="p">,</span><span class="s">&quot;&quot;</span><span class="p">,</span><span class="n">zoneDict</span><span class="p">)</span>
    <span class="n">file0</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">baseRoomPath</span><span class="o">+</span><span class="n">room</span><span class="o">+</span><span class="s">&quot;/index.html&quot;</span><span class="p">,</span> <span class="s">&quot;w&quot;</span><span class="p">)</span>
    <span class="n">file0</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">fileToWrite</span><span class="p">)</span>

    <span class="n">file0</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="c">#os.system(&quot;chmod 777 &quot;+html_file_location)</span>
    <span class="k">with</span> <span class="n">lock_bash_cmd</span><span class="p">:</span>
      <span class="n">subprocess</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="s">&quot;chmod 777 &quot;</span><span class="o">+</span><span class="n">html_file_location</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span><span class="n">close_fds</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>  
  <span class="k">return</span>

<span class="k">def</span> <span class="nf">updateDir</span><span class="p">():</span></div>
<div class="viewcode-block" id="updateDir"><a class="viewcode-back" href="../webserver.html#webserver.updateDir">[docs]</a>  <span class="n">retval</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span>
  <span class="k">print</span> <span class="s">&quot;updateDir()  executed&quot;</span>

  <span class="k">for</span> <span class="n">zone</span>  <span class="ow">in</span> <span class="n">zoneDict</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="p">:</span>  <span class="c">#will be call updateOneRoom()   ....onosimprove</span>
    
  
    <span class="n">index</span><span class="o">=</span><span class="n">retval</span><span class="o">+</span><span class="s">&quot;/&quot;</span><span class="o">+</span><span class="n">baseRoomPath</span><span class="o">+</span><span class="n">zone</span><span class="o">+</span><span class="s">&quot;/index.html&quot;</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">index</span><span class="p">):</span>   <span class="c">#if the directory exist don&#39;t create it</span>
      <span class="k">print</span> <span class="n">zone</span><span class="o">+</span><span class="s">&quot; exist so i don&#39;t create it&quot;</span>
      <span class="n">fileToWrite</span><span class="o">=</span><span class="n">getRoomHtml</span><span class="p">(</span><span class="n">zone</span><span class="p">,</span><span class="n">object_dict</span><span class="p">,</span><span class="s">&quot;&quot;</span><span class="p">,</span><span class="n">zoneDict</span><span class="p">)</span>
      <span class="n">file0</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">baseRoomPath</span><span class="o">+</span><span class="n">zone</span><span class="o">+</span><span class="s">&quot;/index.html&quot;</span><span class="p">,</span> <span class="s">&quot;w&quot;</span><span class="p">)</span>
      <span class="n">file0</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">fileToWrite</span><span class="p">)</span>
      <span class="n">file0</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
      <span class="c">#os.system(&quot;chmod 777 &quot;+baseRoomPath+zone+&quot;/index.html&quot;)</span>
      <span class="k">with</span> <span class="n">lock_bash_cmd</span><span class="p">:</span>
        <span class="n">subprocess</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="s">&quot;chmod 777 &quot;</span><span class="o">+</span><span class="n">baseRoomPath</span><span class="o">+</span><span class="n">zone</span><span class="o">+</span><span class="s">&quot;/index.html&quot;</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span><span class="n">close_fds</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>  
    <span class="k">else</span><span class="p">:</span>
      <span class="k">print</span> <span class="s">&quot;create the file&quot;</span><span class="o">+</span><span class="n">index</span>
      <span class="c">#os.system(&quot;mkdir &quot;+baseRoomPath+zone)</span>
      <span class="k">with</span> <span class="n">lock_bash_cmd</span><span class="p">:</span> 
        <span class="n">subprocess</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="s">&quot;mkdir &quot;</span><span class="o">+</span><span class="n">baseRoomPath</span><span class="o">+</span><span class="n">zone</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span><span class="n">close_fds</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>  
      <span class="n">fileToWrite</span><span class="o">=</span><span class="n">getRoomHtml</span><span class="p">(</span><span class="n">zone</span><span class="p">,</span><span class="n">object_dict</span><span class="p">,</span><span class="s">&quot;&quot;</span><span class="p">,</span><span class="n">zoneDict</span><span class="p">)</span>
      <span class="k">try</span><span class="p">:</span>
        <span class="n">file0</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="s">&quot;w&quot;</span><span class="p">)</span>
        <span class="n">file0</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">fileToWrite</span><span class="p">)</span>
        <span class="n">file0</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">with</span> <span class="n">lock_bash_cmd</span><span class="p">:</span> 
          <span class="n">subprocess</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="s">&quot;chmod 777 &quot;</span><span class="o">+</span><span class="n">baseRoomPath</span><span class="o">+</span><span class="n">zone</span><span class="o">+</span><span class="s">&quot;/index.html&quot;</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span><span class="n">close_fds</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>  
      <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span> 
        <span class="k">print</span> <span class="s">&quot;error creating &quot;</span><span class="o">+</span><span class="n">baseRoomPath</span><span class="o">+</span><span class="n">zone</span><span class="o">+</span><span class="s">&quot;/index.html  e:&quot;</span> <span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">)</span>
        <span class="n">errorQueue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="s">&quot;error creating &quot;</span><span class="o">+</span><span class="n">baseRoomPath</span><span class="o">+</span><span class="n">zone</span><span class="o">+</span><span class="s">&quot;/index.html  e:&quot;</span> <span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">))</span> 

      <span class="c">#os.system(&quot;chmod 777 &quot;+baseRoomPath+zone+&quot;/index.html&quot;)</span>


  <span class="k">return</span>


<span class="k">def</span> <span class="nf">createNewNode</span><span class="p">(</span><span class="n">node_sn</span><span class="p">,</span><span class="n">node_ip</span><span class="p">,</span><span class="n">node_fw</span><span class="p">):</span></div>
<div class="viewcode-block" id="createNewNode"><a class="viewcode-back" href="../webserver.html#webserver.createNewNode">[docs]</a>  <span class="n">msg</span><span class="o">=</span><span class="s">&quot;&quot;</span>
  <span class="k">if</span> <span class="n">node_sn</span> <span class="ow">in</span> <span class="n">nodeDict</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
    <span class="k">print</span> <span class="s">&quot;found node in the dict&quot;</span>
    <span class="c">#nodeDict[node_sn].setNodeAddress(node_ip)</span>
    <span class="n">updateNodeAddress</span><span class="p">(</span><span class="n">node_sn</span><span class="p">,</span><span class="n">node_ip</span><span class="p">)</span>
    <span class="n">msg</span><span class="o">=</span><span class="n">nodeDict</span><span class="p">[</span><span class="n">node_sn</span><span class="p">]</span><span class="o">.</span><span class="n">getSetupMsg</span><span class="p">()</span> 
  <span class="k">else</span><span class="p">:</span> <span class="c">#created a new node</span>
    <span class="k">print</span> <span class="s">&quot;requested setup for a node not existing yet &quot;</span>                  
    <span class="n">hwType</span><span class="o">=</span><span class="n">node_sn</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">4</span><span class="p">]</span>  <span class="c">#get Plug6way  from Plug6way0001</span>
     <span class="c">#cut the last 4 char which are the numeric sn, in order to get only the type of hardware</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">hwType</span> <span class="ow">in</span> <span class="n">hardwareModelDict</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>  <span class="c">#if the hardware is in the list </span>
      <span class="k">print</span> <span class="s">&quot;added node_hw from url :&quot;</span><span class="o">+</span><span class="n">hwType</span>
      <span class="k">print</span> <span class="s">&quot;obj_type_to_add_from_node=&quot;</span><span class="o">+</span><span class="n">hwType</span>
      <span class="n">hardware_node_model</span><span class="o">=</span><span class="n">hardwareModelDict</span><span class="p">[</span><span class="n">hwType</span><span class="p">]</span>

      <span class="k">if</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">node_sn</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)</span><span class="o">&amp;</span><span class="p">((</span><span class="n">node_sn</span><span class="p">)</span><span class="o">!=</span><span class="s">&quot; &quot;</span><span class="p">)):</span> 
          
        <span class="n">nodeDict</span><span class="p">[</span><span class="n">node_sn</span><span class="p">]</span><span class="o">=</span><span class="n">hw_node</span><span class="o">.</span><span class="n">HwNode</span><span class="p">(</span><span class="n">node_sn</span><span class="p">,</span><span class="n">hardware_node_model</span><span class="p">,</span><span class="n">node_ip</span><span class="p">,</span><span class="n">node_fw</span><span class="p">)</span> 
        <span class="n">nodeDict</span><span class="p">[</span><span class="n">node_sn</span><span class="p">]</span><span class="o">.</span><span class="n">updateLastNodeSync</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">())</span>
        <span class="c">#nodeDict[node_sn].setNodeAddress(node_ip)</span>
        <span class="n">msg</span><span class="o">=</span><span class="n">nodeDict</span><span class="p">[</span><span class="n">node_sn</span><span class="p">]</span><span class="o">.</span><span class="n">getSetupMsg</span><span class="p">()</span> 

        <span class="c">#if the room doesn&#39;t exist yet ...then:</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">node_sn</span> <span class="ow">in</span> <span class="n">zoneDict</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
          <span class="k">print</span> <span class="s">&quot;the node already exist in the zoneDict&quot;</span> 
        <span class="k">else</span><span class="p">:</span>
         <span class="c"># if (node_sn+&quot;_body&quot; in object_dict.keys()):</span>
         <span class="c">#   print &quot;the node body already exist in the web_object_dict&quot; </span>
         <span class="c"># else:</span>
         <span class="c">#   object_dict[node_sn+&quot;_body&quot;]=newDefaultWebObjBody(node_sn+&quot;_body&quot;)</span>
         <span class="c">#zoneDict[node_sn]=[node_sn+&quot;_body&quot;]  # modify to update also the webobject dict and list </span>
          <span class="n">zoneDict</span><span class="p">[</span><span class="n">node_sn</span><span class="p">]</span><span class="o">=</span><span class="p">{</span><span class="s">&quot;objects&quot;</span><span class="p">:[],</span><span class="s">&quot;order&quot;</span><span class="p">:</span><span class="nb">len</span><span class="p">(</span><span class="n">zoneDict</span><span class="o">.</span><span class="n">keys</span><span class="p">()),</span><span class="s">&quot;permissions&quot;</span><span class="p">:</span><span class="s">&quot;777&quot;</span><span class="p">,</span><span class="s">&quot;group&quot;</span><span class="p">:[],</span><span class="s">&quot;owner&quot;</span><span class="p">:</span><span class="s">&quot;onos_sys&quot;</span><span class="p">,</span><span class="s">&quot;hidden&quot;</span><span class="p">:</span><span class="mi">0</span><span class="p">}</span>


            <span class="c">#create a new web_object and insert only his name          </span>
          <span class="c">#os.system(&quot;mkdir &quot;+baseRoomPath+node_sn) </span>
          <span class="k">with</span> <span class="n">lock_bash_cmd</span><span class="p">:</span>
            <span class="n">subprocess</span><span class="o">.</span><span class="n">check_output</span><span class="p">(</span><span class="s">&quot;mkdir &quot;</span><span class="o">+</span><span class="n">baseRoomPath</span><span class="o">+</span><span class="n">node_sn</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span><span class="n">close_fds</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

          <span class="n">createNewWebObjFromNode</span><span class="p">(</span><span class="n">hwType</span><span class="p">,</span><span class="n">node_sn</span><span class="p">)</span>
          <span class="k">try</span><span class="p">:</span>
            <span class="n">text_file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">baseRoomPath</span><span class="o">+</span><span class="n">node_sn</span><span class="o">+</span><span class="s">&quot;/index.html&quot;</span><span class="p">,</span> <span class="s">&quot;w&quot;</span><span class="p">)</span>
            <span class="n">text_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">getRoomHtml</span><span class="p">(</span><span class="n">node_sn</span><span class="p">,</span><span class="n">object_dict</span><span class="p">,</span><span class="s">&quot;&quot;</span><span class="p">,</span><span class="n">zoneDict</span><span class="p">))</span>
            <span class="n">text_file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
          <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span> 
            <span class="k">print</span> <span class="s">&quot;error creating new node index file  &quot;</span><span class="o">+</span><span class="n">node_sn</span><span class="o">+</span><span class="s">&quot; e:&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">)</span>
            <span class="n">errorQueue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="s">&quot;error creating new node index file  &quot;</span><span class="o">+</span><span class="n">node_sn</span><span class="o">+</span><span class="s">&quot; e:&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">))</span>  


          <span class="c">#os.system(&quot;cat &quot;+getRoomHtml(node_sn,object_dict,&quot;&quot;,zoneDict)+&quot; &gt;&gt; &quot;+baseRoomPath+node_sn+&quot;/index.html&quot;)          </span>
          <span class="c">#os.system(&quot;chmod 777 &quot;+baseRoomPath+node_sn)</span>
          <span class="k">with</span> <span class="n">lock_bash_cmd</span><span class="p">:</span>
            <span class="n">subprocess</span><span class="o">.</span><span class="n">check_output</span><span class="p">(</span><span class="s">&quot;chmod 777 &quot;</span><span class="o">+</span><span class="n">baseRoomPath</span><span class="o">+</span><span class="n">node_sn</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span><span class="n">close_fds</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
          <span class="k">print</span> <span class="s">&quot;create a new zone&quot;</span><span class="o">+</span><span class="n">node_sn</span>
          <span class="c">#print zoneDict</span>
          <span class="n">updateOneRoom</span><span class="p">(</span><span class="n">node_sn</span><span class="p">)</span> 

  <span class="k">return</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>




<span class="k">def</span> <span class="nf">setNodePin</span><span class="p">(</span><span class="n">node_sn</span><span class="p">,</span><span class="n">pin_number</span><span class="p">,</span><span class="n">pin_status</span><span class="p">,</span><span class="n">write_hw_enable</span><span class="p">):</span>  <span class="c"># equal to NodePinToWebObject()</span></div>
<div class="viewcode-block" id="setNodePin"><a class="viewcode-back" href="../webserver.html#webserver.setNodePin">[docs]</a>  <span class="c">#to change all the webobjects status that have the node and the pin given:</span>
  <span class="k">print</span> <span class="s">&quot;setNodePin() executed&quot;</span>

  <span class="k">if</span> <span class="n">node_sn</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">nodeDict</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
    <span class="k">print</span> <span class="s">&quot;the serial number is not in the dictionary...so i add  the new node&quot;</span>
    <span class="k">return</span><span class="p">(</span><span class="s">&quot;error_the_node_does_not_exist&quot;</span><span class="p">)</span>
  <span class="n">found</span><span class="o">=</span><span class="mi">0</span>
  <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">object_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
    <span class="k">print</span> <span class="n">object_dict</span><span class="p">[</span><span class="n">a</span><span class="p">]</span><span class="o">.</span><span class="n">getHwNodeSerialNumber</span><span class="p">()</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">object_dict</span><span class="p">[</span><span class="n">a</span><span class="p">]</span><span class="o">.</span><span class="n">getHwNodeSerialNumber</span><span class="p">()</span><span class="o">==</span><span class="n">node_sn</span><span class="p">):</span>
      <span class="k">print</span> <span class="s">&quot;node exist&quot;</span>
      <span class="k">if</span> <span class="n">object_dict</span><span class="p">[</span><span class="n">a</span><span class="p">]</span><span class="o">.</span><span class="n">getAttachedPinList</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span><span class="o">==</span><span class="nb">int</span><span class="p">(</span><span class="n">pin_number</span><span class="p">):</span>
        <span class="n">found</span><span class="o">=</span><span class="mi">1</span>  
        <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">object_dict</span><span class="p">[</span><span class="n">a</span><span class="p">]</span><span class="o">.</span><span class="n">getAttachedPinList</span><span class="p">())</span><span class="o">==</span><span class="mi">1</span><span class="p">):</span><span class="c">#the sensor object must have only a pin attached</span>
          <span class="n">objName</span><span class="o">=</span><span class="n">object_dict</span><span class="p">[</span><span class="n">a</span><span class="p">]</span><span class="o">.</span><span class="n">getName</span><span class="p">()</span>                      
          <span class="c">#changeWebObjectStatus(objName,int (pin_status),write_hw_enable) #banana add to queue</span>
          <span class="n">layerExchangeDataQueue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span> <span class="p">{</span><span class="s">&quot;cmd&quot;</span><span class="p">:</span><span class="s">&quot;setSts&quot;</span><span class="p">,</span><span class="s">&quot;webObjectName&quot;</span><span class="p">:</span><span class="n">objName</span><span class="p">,</span><span class="s">&quot;status_to_set&quot;</span><span class="p">:</span><span class="nb">str</span><span class="p">(</span><span class="n">pin_status</span><span class="p">),</span><span class="s">&quot;write_to_hw&quot;</span><span class="p">:</span><span class="n">write_hw_enable</span> <span class="p">})</span>  
                

          <span class="k">print</span> <span class="s">&quot;pin&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">pin_number</span><span class="p">)</span><span class="o">+</span><span class="s">&quot; changed from setNodePin to:&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">pin_status</span><span class="p">)</span>                       

        <span class="k">else</span><span class="p">:</span>
          <span class="k">print</span> <span class="s">&quot;error number of pin in the setNodePin section&quot;</span> 
          <span class="n">errorQueue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="s">&quot;error number of pin in the setNodePin section&quot;</span>  <span class="p">)</span>  
          <span class="k">return</span><span class="p">(</span><span class="s">&quot;error_no_pin_found_in_the_node&quot;</span><span class="p">)</span>
  <span class="k">if</span> <span class="n">found</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
    <span class="k">print</span> <span class="s">&quot;error_no_pin_found_in_the_node&quot;</span>
    <span class="n">errorQueue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="s">&quot;error_no_pin_found_in_the_node&quot;</span> <span class="p">)</span>  
    <span class="k">return</span><span class="p">(</span><span class="s">&quot;error_no_pin_found_in_the_node&quot;</span><span class="p">)</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="k">return</span><span class="p">(</span><span class="s">&quot;ok&quot;</span><span class="p">)</span>








<span class="c">#router_sn is in globalVar.py</span>

<span class="n">createNewNode</span><span class="p">(</span><span class="n">router_sn</span><span class="p">,</span><span class="s">&quot;0&quot;</span><span class="p">,</span><span class="n">router_hardware_fw_version</span><span class="p">)</span> <span class="c">#make the router node</span></div>






<span class="k">def</span> <span class="nf">transform_object_to_dict</span><span class="p">(</span><span class="n">object_dictionary</span><span class="p">):</span>
<div class="viewcode-block" id="transform_object_to_dict"><a class="viewcode-back" href="../webserver.html#webserver.transform_object_to_dict">[docs]</a>

  <span class="n">obj_tmp_dict</span><span class="o">=</span><span class="p">{}</span>

  <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">object_dictionary</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
    <span class="n">a</span><span class="o">=</span><span class="n">object_dictionary</span><span class="p">[</span><span class="n">b</span><span class="p">]</span>   <span class="c">#bug  return ascii and not unicode?</span>
    <span class="n">name</span><span class="o">=</span><span class="n">a</span><span class="o">.</span><span class="n">getName</span><span class="p">()</span>
    <span class="n">obj_tmp_dict</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">=</span><span class="p">{</span><span class="s">u&quot;objname&quot;</span><span class="p">:</span><span class="n">name</span><span class="p">,</span><span class="s">u&quot;obj_type&quot;</span><span class="p">:</span><span class="n">a</span><span class="o">.</span><span class="n">getType</span><span class="p">(),</span><span class="s">u&quot;obj_status&quot;</span><span class="p">:</span><span class="n">a</span><span class="o">.</span><span class="n">getStatus</span><span class="p">(),</span><span class="s">u&quot;obj_style0&quot;</span><span class="p">:</span><span class="n">a</span><span class="o">.</span><span class="n">getStyle0</span><span class="p">(),</span><span class="s">u&quot;obj_style1&quot;</span><span class="p">:</span><span class="n">a</span><span class="o">.</span><span class="n">getStyle1</span><span class="p">(),</span><span class="s">u&quot;obj_html0&quot;</span><span class="p">:</span><span class="n">a</span><span class="o">.</span><span class="n">getHtml0</span><span class="p">(),</span><span class="s">u&quot;obj_html1&quot;</span><span class="p">:</span><span class="n">a</span><span class="o">.</span><span class="n">getHtml1</span><span class="p">(),</span><span class="s">u&quot;obj_cmd0&quot;</span><span class="p">:</span><span class="n">a</span><span class="o">.</span><span class="n">getCommand0</span><span class="p">(),</span><span class="s">u&quot;obj_cmd1&quot;</span><span class="p">:</span><span class="n">a</span><span class="o">.</span><span class="n">getCommand1</span><span class="p">(),</span><span class="s">u&quot;obj_init_cmd&quot;</span><span class="p">:</span><span class="n">a</span><span class="o">.</span><span class="n">getInitCommand</span><span class="p">(),</span><span class="s">u&quot;obj_notes&quot;</span><span class="p">:</span><span class="n">a</span><span class="o">.</span><span class="n">getNotes</span><span class="p">(),</span><span class="s">u&quot;node_serial_number&quot;</span><span class="p">:</span><span class="n">a</span><span class="o">.</span><span class="n">getHwNodeSerialNumber</span><span class="p">(),</span><span class="s">u&quot;obj_Pins&quot;</span><span class="p">:</span><span class="n">a</span><span class="o">.</span><span class="n">getAttachedPinList</span><span class="p">()}</span>
  <span class="k">return</span> <span class="p">(</span><span class="n">obj_tmp_dict</span><span class="p">)</span>  


<span class="k">def</span> <span class="nf">transform_object_to_dict_to_backup</span><span class="p">(</span><span class="n">object_dictionary</span><span class="p">):</span></div>
<div class="viewcode-block" id="transform_object_to_dict_to_backup"><a class="viewcode-back" href="../webserver.html#webserver.transform_object_to_dict_to_backup">[docs]</a>

  <span class="n">obj_tmp_dict</span><span class="o">=</span><span class="p">{}</span>

  <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">object_dictionary</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
    <span class="n">a</span><span class="o">=</span><span class="n">object_dictionary</span><span class="p">[</span><span class="n">b</span><span class="p">]</span>   <span class="c">#bug  return ascii and not unicode?</span>
    <span class="n">name</span><span class="o">=</span><span class="n">a</span><span class="o">.</span><span class="n">getName</span><span class="p">()</span>
    <span class="n">obj_tmp_dict</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">=</span><span class="n">a</span><span class="o">.</span><span class="n">getObjectDictionary</span><span class="p">()</span>
  <span class="k">return</span> <span class="p">(</span><span class="n">obj_tmp_dict</span><span class="p">)</span>  



<span class="k">def</span> <span class="nf">updateJson</span><span class="p">(</span><span class="n">object_dictionary</span><span class="p">,</span><span class="n">roomDictionary</span><span class="p">,</span><span class="n">scenarioDictionary</span><span class="p">):</span>  <span class="c"># save the current config to a json file named data.json</span></div>
<div class="viewcode-block" id="updateJson"><a class="viewcode-back" href="../webserver.html#webserver.updateJson">[docs]</a>
  <span class="k">print</span> <span class="s">&quot;updateJson executed&quot;</span>

<span class="c">#json doesn&#39;t support saving objects  ..so i save all the variables of each objects</span>
<span class="c">#to get back the pin of the object you have to write:</span>
<span class="c">#  dictionary_group[u&quot;objectDictionary&quot;][u&quot;name_of_the_object&quot;][u&quot;obj_pin&quot;] </span>
  <span class="n">obj_tmp_dict</span><span class="o">=</span><span class="n">transform_object_to_dict_to_backup</span><span class="p">(</span><span class="n">object_dictionary</span><span class="p">)</span>


  <span class="n">node_tmp_Dict</span><span class="o">=</span><span class="p">{}</span>
  <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">nodeDict</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
    <span class="n">a</span><span class="o">=</span><span class="n">nodeDict</span><span class="p">[</span><span class="n">b</span><span class="p">]</span>  
    <span class="n">sn</span><span class="o">=</span><span class="n">a</span><span class="o">.</span><span class="n">getNodeSerialNumber</span><span class="p">()</span> 
    <span class="n">node_tmp_Dict</span><span class="p">[</span><span class="n">sn</span><span class="p">]</span><span class="o">=</span><span class="p">{</span><span class="s">u&quot;node_serial_number&quot;</span><span class="p">:</span><span class="n">sn</span><span class="p">,</span><span class="s">u&quot;hwModelName&quot;</span><span class="p">:</span><span class="n">a</span><span class="o">.</span><span class="n">getNodeHwModel</span><span class="p">(),</span><span class="s">u&quot;nodeAddress&quot;</span><span class="p">:</span><span class="n">a</span><span class="o">.</span><span class="n">getNodeAddress</span><span class="p">()}</span>
    <span class="c"># note that the i/o modes for the node pins will be saved in the relative webobjects .</span>
    <span class="c"># the pins not used by a webobject will be configured as output and cleared to 0 </span>
        



  <span class="c">#print object_dictionary</span>
  <span class="c">#print roomDictionary</span>
  <span class="n">dictionary_group</span><span class="o">=</span><span class="p">{</span><span class="s">u&quot;objectDictionary&quot;</span><span class="p">:</span><span class="n">obj_tmp_dict</span><span class="p">,</span><span class="s">u&quot;roomDictionary&quot;</span><span class="p">:</span><span class="n">roomDictionary</span><span class="p">,</span><span class="s">u&quot;nodeDictionary&quot;</span><span class="p">:</span><span class="n">node_tmp_Dict</span><span class="p">,</span><span class="s">u&quot;scenarioDictionary&quot;</span><span class="p">:</span><span class="n">scenarioDictionary</span><span class="p">}</span>  <span class="c">#combined dictionary</span>
  <span class="c">#to add a new dictionary just add it in dictionary_group</span>

  <span class="c">#print dictionary_group</span>
  <span class="n">dictionary_group_json</span><span class="o">=</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">dictionary_group</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span><span class="n">sort_keys</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span> <span class="c">#make the json structure</span>
  <span class="n">file_to_save</span> <span class="o">=</span><span class="n">codecs</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">base_cfg_path</span><span class="o">+</span><span class="s">&quot;config_files/data.json&quot;</span><span class="p">,</span><span class="s">&quot;w&quot;</span><span class="p">,</span><span class="s">&quot;utf8&quot;</span><span class="p">)</span>     <span class="c">#utf8 is a type of  encoding for unicode strings</span>
  <span class="n">file_to_save</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">dictionary_group_json</span><span class="p">)</span>
  <span class="n">file_to_save</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

  <span class="n">conf_option</span><span class="o">=</span><span class="p">{</span><span class="s">u&quot;online_server_enable&quot;</span><span class="p">:</span><span class="n">online_server_enable</span><span class="p">,</span><span class="s">u&quot;enable_mail_service&quot;</span><span class="p">:</span><span class="n">enable_mail_service</span><span class="p">,</span><span class="s">u&quot;accept_only_from_white_list&quot;</span><span class="p">:</span><span class="n">accept_only_from_white_list</span><span class="p">,</span><span class="s">u&quot;mail_whiteList&quot;</span><span class="p">:</span><span class="n">mail_whiteList</span><span class="p">,</span><span class="s">u&quot;timezone&quot;</span><span class="p">:</span><span class="n">timezone</span><span class="p">,</span><span class="s">u&quot;login_required&quot;</span><span class="p">:</span><span class="n">login_required</span><span class="p">,</span><span class="s">u&quot;logTimeout&quot;</span><span class="p">:</span><span class="n">logTimeout</span><span class="p">,</span><span class="s">&quot;online_usersDict&quot;</span><span class="p">:</span><span class="n">online_usersDict</span><span class="p">,</span><span class="s">&quot;enable_onos_auto_update&quot;</span><span class="p">:</span><span class="n">enable_onos_auto_update</span><span class="p">}</span>
  <span class="n">conf_option_json</span><span class="o">=</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">conf_option</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span><span class="n">sort_keys</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span> <span class="c">#make the json structure</span>
  <span class="n">file_to_save2</span> <span class="o">=</span><span class="n">codecs</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">base_cfg_path</span><span class="o">+</span><span class="s">&quot;config_files/cfg.json&quot;</span><span class="p">,</span><span class="s">&quot;w&quot;</span><span class="p">,</span><span class="s">&quot;utf8&quot;</span><span class="p">)</span>     <span class="c">#utf8 is a type of  encoding for unicode strings</span>
  <span class="n">file_to_save2</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">conf_option_json</span><span class="p">)</span>
  <span class="n">file_to_save2</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
  <span class="c">#banana to load</span>




        
<span class="c">#moved to conf.py</span>
<span class="c">#def newDefaultWebObj(name):</span>
<span class="c">#  return(WebObject(name,&quot;b&quot;,0,&quot;/*background-color:green;*/&quot;,&quot;/*background-color:red;*/&quot;,name+&quot;=0&quot;,name+&quot;=1&quot;,&quot; &quot;,&quot; &quot;,&quot; &quot;,&quot; &quot;,9999))</span>


<span class="n">updateDir</span><span class="p">()</span></div>








<span class="k">def</span> <span class="nf">getUserFromIp</span><span class="p">(</span><span class="n">ipUserAddress</span><span class="p">):</span>
<div class="viewcode-block" id="getUserFromIp"><a class="viewcode-back" href="../webserver.html#webserver.getUserFromIp">[docs]</a>  <span class="k">print</span> <span class="s">&quot;getUserFromIp() executed&quot;</span>
  <span class="k">if</span> <span class="n">ipUserAddress</span> <span class="ow">in</span> <span class="n">user_active_time_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span> <span class="c"># the ip is in the dict</span>
      <span class="n">username</span><span class="o">=</span><span class="n">user_active_time_dict</span><span class="p">[</span><span class="n">ipUserAddress</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
      <span class="n">old_active_time</span><span class="o">=</span><span class="n">user_active_time_dict</span><span class="p">[</span><span class="n">ipUserAddress</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
      <span class="n">current_time</span><span class="o">=</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">today</span><span class="p">()</span><span class="o">.</span><span class="n">minute</span><span class="o">+</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">today</span><span class="p">()</span><span class="o">.</span><span class="n">hour</span><span class="p">)</span><span class="o">*</span><span class="mi">60</span> <span class="p">)</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">current_time</span> <span class="o">&gt;</span><span class="p">(</span><span class="n">old_active_time</span><span class="o">+</span><span class="n">logTimeout</span><span class="p">)</span> <span class="p">):</span>   <span class="c">#timeout</span>
      <span class="c">#if user was not active in the last 10 minutes logout</span>
        <span class="k">print</span> <span class="s">&quot;user:&quot;</span><span class="o">+</span><span class="n">username</span><span class="o">+</span><span class="s">&quot;logged out for timeout&quot;</span>
        <span class="k">del</span> <span class="n">user_active_time_dict</span><span class="p">[</span><span class="n">ipUserAddress</span><span class="p">]</span> <span class="c">#remove the ip from the dict   </span>
        <span class="k">print</span> <span class="s">&quot;deleted ip from user_active_time_dict &quot;</span>
        <span class="k">return</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
      <span class="k">else</span><span class="p">:</span>
        <span class="k">print</span> <span class="s">&quot;user:&quot;</span> <span class="o">+</span><span class="n">username</span><span class="o">+</span><span class="s">&quot;is still active&quot;</span> 
        <span class="n">user_active_time_dict</span><span class="p">[</span><span class="n">ipUserAddress</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span><span class="n">current_time</span>
        <span class="k">return</span><span class="p">(</span><span class="n">username</span><span class="p">)</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="k">print</span> <span class="s">&quot;ipaddress not in list&quot;</span>
    <span class="k">return</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>





<span class="k">class</span> <span class="nc">MyHandler</span><span class="p">(</span><span class="n">BaseHTTPRequestHandler</span><span class="p">):</span></div>
<div class="viewcode-block" id="MyHandler"><a class="viewcode-back" href="../webserver.html#webserver.MyHandler">[docs]</a>    <span class="c">#global object_dict  </span>
    <span class="c">#global roomDict</span>


    <span class="n">wbufsize</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
    <span class="c"># Disable Nagle&#39;s Algorithm (Python 2.7/3.2 and later).</span>
    <span class="n">disable_nagle_algorithm</span> <span class="o">=</span> <span class="bp">True</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">BaseHTTPRequestHandler</span><span class="p">,</span> <span class="s">&#39;disable_nagle_algorithm&#39;</span><span class="p">):</span>   <span class="c">#http://pydoc.net/Python/mrs-mapreduce/0.9/mrs.http/  https://aboutsimon.com/index.html%3Fp=85.html</span>
        <span class="k">def</span> <span class="nf">setup</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="n">BaseHTTPRequestHandler</span><span class="o">.</span><span class="n">setup</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">disable_nagle_algorithm</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">setsockopt</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">IPPROTO_TCP</span><span class="p">,</span>
                        <span class="n">socket</span><span class="o">.</span><span class="n">TCP_NODELAY</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>




    <span class="k">def</span> <span class="nf">finish</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="o">*</span><span class="n">args</span><span class="p">,</span><span class="o">**</span><span class="n">kw</span><span class="p">):</span>
<div class="viewcode-block" id="MyHandler.finish"><a class="viewcode-back" href="../webserver.html#webserver.MyHandler.finish">[docs]</a>      <span class="c">#print &quot;finish function called to close socket&quot;</span>
      
      <span class="c">#if not self.wfile.closed:</span>
      <span class="c">#  self.wfile.flush()</span>

      <span class="c">#self.wfile.close()</span>
      <span class="c">#self.rfile.close()</span>

      <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">wfile</span><span class="o">.</span><span class="n">closed</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
          <span class="bp">self</span><span class="o">.</span><span class="n">wfile</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
          <span class="bp">self</span><span class="o">.</span><span class="n">wfile</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">except</span> <span class="p">:</span>
          <span class="k">print</span> <span class="s">&quot;error in flush finish() socket closed &quot;</span>
          <span class="n">errorQueue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span> <span class="s">&quot;error in flush finish() socket closed &quot;</span><span class="p">)</span>  
          <span class="k">pass</span>  <span class="c">#ignore the error</span>

          <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">wfile</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
          <span class="k">except</span><span class="p">:</span>
            <span class="k">pass</span>  <span class="c">#ignore the error</span>
            <span class="k">print</span> <span class="s">&quot;error in self.wfile.close() finish() socket closed &quot;</span>
            <span class="n">errorQueue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span> <span class="s">&quot;error in self.wfile.close() finish() socket closed &quot;</span><span class="p">)</span>  
      <span class="k">try</span><span class="p">:</span>  
        <span class="bp">self</span><span class="o">.</span><span class="n">rfile</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
      <span class="k">except</span><span class="p">:</span>
        <span class="k">pass</span>
        <span class="k">print</span> <span class="s">&quot;error in self.wfile.close()  self.rfile.close()  socket closed &quot;</span>
        <span class="n">errorQueue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="s">&quot;error in self.wfile.close()  self.rfile.close()  socket closed &quot;</span> <span class="p">)</span>  
      <span class="k">return</span>        

    <span class="k">def</span> <span class="nf">clear_PostData</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">data</span><span class="p">):</span></div>
<div class="viewcode-block" id="MyHandler.clear_PostData"><a class="viewcode-back" href="../webserver.html#webserver.MyHandler.clear_PostData">[docs]</a>      <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
        <span class="k">print</span> <span class="s">&quot;empty form&quot;</span>
        <span class="k">return</span> <span class="p">(</span><span class="s">&quot;&quot;</span><span class="p">)</span>
      <span class="n">tmp_data</span><span class="o">=</span><span class="n">data</span>
      <span class="n">i</span><span class="o">=</span><span class="mi">0</span>
      <span class="n">en</span><span class="o">=</span><span class="mi">0</span>
      <span class="k">while</span> <span class="p">((</span><span class="n">i</span><span class="o">&lt;</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">))</span><span class="o">&amp;</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">==</span><span class="s">&quot; &quot;</span><span class="p">)):</span>  <span class="c">#remove all the starting spacing</span>
        <span class="n">i</span><span class="o">=</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span>
      <span class="n">tmp_data</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">:]</span> 
      <span class="n">i</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">tmp_data</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span>
      <span class="k">while</span> <span class="p">((</span><span class="n">i</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="n">tmp_data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">==</span><span class="s">&quot; &quot;</span><span class="p">)):</span> <span class="c">#remove all the spacing after the end of string</span>
        <span class="n">i</span><span class="o">=</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span>
      <span class="n">tmp_data</span><span class="o">=</span><span class="n">tmp_data</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
      <span class="n">tmp_data</span><span class="o">=</span><span class="n">string</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">tmp_data</span><span class="p">,</span> <span class="s">&quot; &quot;</span><span class="p">,</span> <span class="s">&quot;_&quot;</span><span class="p">)</span>
      <span class="k">return</span><span class="p">(</span><span class="n">tmp_data</span><span class="p">)</span>  
           



       <span class="c">#         self.path=string.replace(self.path, &quot;%20&quot;, &quot; &quot;)   #rimuovo i %20 che si formano al posto degli spazii</span>
        <span class="c">#        self.path=string.replace(self.path, &#39;,&amp;%&#39;, &#39;\n&#39;) </span>
        <span class="c">#        self.path=string.replace(self.path, &#39;%7D&#39;, &#39;}&#39;) </span>
         <span class="c">#       self.path=string.replace(self.path, &#39;%7B&#39;, &#39;{&#39;) </span>




    <span class="k">def</span> <span class="nf">get_login</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> </div>
<div class="viewcode-block" id="MyHandler.get_login"><a class="viewcode-back" href="../webserver.html#webserver.MyHandler.get_login">[docs]</a>      <span class="c">#self.send_response(301)</span>
      <span class="c">#self.send_header(&#39;Location&#39;,&#39;/login.html&#39;)</span>
      <span class="c">#self.end_headers()</span>
      <span class="k">try</span><span class="p">:</span>             
        <span class="n">h</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s">&quot;gui/login.html&quot;</span><span class="p">,</span><span class="s">&#39;r&#39;</span><span class="p">)</span>  
        <span class="n">web_page</span><span class="o">=</span><span class="n">h</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="n">h</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
      <span class="k">except</span><span class="p">:</span>
        <span class="k">print</span> <span class="s">&quot;no index.html found in root directory&quot;</span>
        <span class="n">web_page</span><span class="o">=</span><span class="n">web_page_not_found</span>   
      <span class="k">try</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">send_response</span><span class="p">(</span><span class="mi">200</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">send_header</span><span class="p">(</span><span class="s">&#39;Content-type&#39;</span><span class="p">,</span>	<span class="s">&#39;text/html&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">end_headers</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">web_page</span><span class="p">)</span> 
      <span class="k">except</span><span class="p">:</span>
        <span class="k">pass</span>
        <span class="k">print</span> <span class="s">&quot;error1 in send_header &quot;</span>
        <span class="n">errorQueue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span> <span class="s">&quot;error1 in send_header &quot;</span><span class="p">)</span>  
      <span class="k">return</span>   






    <span class="k">def</span> <span class="nf">get_WebOjectManager</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">obj_Dict</span><span class="p">):</span> </div>
<div class="viewcode-block" id="MyHandler.get_WebOjectManager"><a class="viewcode-back" href="../webserver.html#webserver.MyHandler.get_WebOjectManager">[docs]</a>    
      

      <span class="n">html_page</span><span class="o">=</span><span class="s">&#39;&#39;&#39;&lt;!DOCTYPE html&gt;</span>
<span class="s">&lt;html&gt;</span>
<span class="s">&lt;head&gt;</span>
<span class="s">  &lt;link rel=&quot;stylesheet&quot; href=&quot;/css/objects_manager.css&quot; type=&quot;text/css&quot; media=&quot;all&quot; /&gt;</span>
<span class="s">  &lt;meta charset=&quot;utf-8&quot;&gt;</span>
<span class="s">  &lt;title&gt;Web Objects Manager&lt;/title&gt;</span>

<span class="s">&lt;script type=&quot;text/javascript&quot; language=&quot;javascript&quot;&gt;function SelectAll(id){    document.getElementById(id).focus();   document.getElementById(id).select();}&lt;/script&gt;</span>
<span class="s">&lt;/head&gt;</span>
<span class="s">&lt;body&gt;</span>
<span class="s">  </span>
<span class="s">&lt;form action=&quot;&quot; method=&quot;POST&quot;&gt;&lt;input type=&quot;hidden&quot; name=&quot;objs_manager&quot; value=&quot;/setup/objs_manager&quot;&gt;</span>

<span class="s">  </span>
<span class="s">&lt;div id=&quot;buttons&quot;&gt;</span>
<span class="s">   </span>
<span class="s">  &lt;a href=&quot;/&quot;&gt;&lt;div id=&quot;home&quot;&gt;HOME&lt;/div&gt;&lt;/a&gt;</span>
<span class="s">  &lt;a href=&quot;/setup/&quot;&gt;&lt;div id=&quot;back&quot;&gt;BACK&lt;/div&gt;&lt;/a&gt;</span>
<span class="s"> </span>
<span class="s">&lt;/div&gt;</span>
<span class="s"> &lt;div id=&quot;header&quot;&gt;WEB OBJECTS MANAGER&lt;/div&gt;</span>

<span class="s">  </span>
<span class="s">&lt;div id=&quot;testo&quot;&gt;</span>
<span class="s">   </span>
<span class="s">&lt;input type=&quot;text&quot; id=&quot;create_web_obj&quot;  onclick=&quot;SelectAll(&#39;create_web_obj&#39;)&quot;; name=&quot;new_web_object&quot; value=&quot;TYPE A NEW OBJECT NAME HERE&quot;&gt;</span>
<span class="s">&lt;input type=&quot;submit&quot; value=&quot;CREATE&quot;&gt;</span>
<span class="s">&lt;/form&gt;</span>

<span class="s">&lt;/div&gt;</span>



<span class="s">  &#39;&#39;&#39;</span> 


      <span class="n">l</span><span class="o">=</span><span class="n">obj_Dict</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
      <span class="n">l</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
      <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">l</span><span class="p">:</span>
             
        <span class="n">html_page</span><span class="o">=</span><span class="n">html_page</span><span class="o">+</span><span class="s">&#39;&#39;&#39;</span>
<span class="s">&lt;div id=&quot;riga&quot;&gt;</span>
<span class="s">&lt;div id=&quot;NOMEOGGETTO&quot;&gt;&#39;&#39;&#39;</span><span class="o">+</span><span class="n">a</span><span class="o">+</span><span class="s">&#39;&#39;&#39;&lt;/div&gt;</span>
<span class="s">&lt;a href=&quot;/setup/web_obj_modifier/&#39;&#39;&#39;</span><span class="o">+</span><span class="n">a</span><span class="o">+</span><span class="s">&#39;&#39;&#39;&quot; &gt;&lt;div id=&quot;SETUP&quot;&gt;SETUP&lt;/div&gt;&lt;/a&gt;</span>
<span class="s">&lt;a href=&quot;/setup/web_obj_modifier/delete_item/&#39;&#39;&#39;</span><span class="o">+</span><span class="n">a</span><span class="o">+</span><span class="s">&#39;&#39;&#39;&quot;&gt;&lt;div id=&quot;DELETE&quot;&gt;DELETE&lt;/div&gt;&lt;/a&gt;</span>
<span class="s">&lt;/div&gt;</span>
<span class="s">  &#39;&#39;&#39;</span>

      <span class="n">html_page</span><span class="o">=</span><span class="n">html_page</span><span class="o">+</span><span class="s">&#39;&#39;&#39;</span>
<span class="s">&lt;div id=&quot;riga&quot; style=&quot; visibility: hidden;&quot;&gt;</span>
<span class="s">&lt;div id=&quot;NOMEOGGETTO&quot;&gt;&lt;/div&gt;</span>
<span class="s">&lt;div id=&quot;SETUP&quot;&gt;&lt;/div&gt;</span>
<span class="s">&lt;div id=&quot;DELETE&quot;&gt;&lt;/div&gt;</span>
<span class="s">&lt;/div&gt;</span>
<span class="s">  &#39;&#39;&#39;</span>

      <span class="n">html_page</span><span class="o">=</span><span class="n">html_page</span><span class="o">+</span><span class="s">&#39;&#39;&#39;&lt;/body&gt;&lt;/html&gt;&#39;&#39;&#39;</span>

      <span class="k">return</span><span class="p">(</span><span class="n">html_page</span><span class="p">)</span>











    <span class="k">def</span> <span class="nf">get_zone_manager</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">r_Dict</span><span class="p">):</span></div>
<div class="viewcode-block" id="MyHandler.get_zone_manager"><a class="viewcode-back" href="../webserver.html#webserver.MyHandler.get_zone_manager">[docs]</a>    
      
      <span class="n">r_list</span><span class="o">=</span><span class="n">r_Dict</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
      <span class="n">r_list</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span> <span class="c">#sort room by name</span>
      <span class="n">html</span><span class="o">=</span><span class="s">&#39;&#39;</span>
      <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">r_list</span> <span class="p">:</span>
        <span class="n">html</span><span class="o">=</span><span class="n">html</span><span class="o">+</span><span class="s">&#39;&#39;&#39;&lt;div id=&quot;riga&quot;&gt;</span>
<span class="s">   </span>
<span class="s">&lt;div id=&quot;nomezona&quot;&gt;&#39;&#39;&#39;</span><span class="o">+</span><span class="n">a</span><span class="o">+</span><span class="s">&#39;&#39;&#39;&lt;/div&gt;</span>
<span class="s">&lt;input type=&quot;text&quot; id=&quot;&#39;&#39;&#39;</span><span class="o">+</span><span class="n">a</span><span class="o">+</span><span class="s">&#39;&#39;&#39;&quot; name=&quot;&#39;&#39;&#39;</span><span class="o">+</span><span class="n">a</span><span class="o">+</span><span class="s">&#39;&#39;&#39;&quot; value=&quot;RENAME IT AND CLICK SUBMIT&quot;&gt;</span>
<span class="s">  </span>
<span class="s">  </span>
<span class="s">  &lt;div id=&quot;deletebox&quot;&gt;</span>
<span class="s">    &lt;div id=&quot;DELETE&quot;&gt;DELETE&lt;/div&gt;</span>
<span class="s">    &lt;input id=&quot;&#39;&#39;&#39;</span><span class="o">+</span><span class="n">a</span><span class="o">+</span><span class="s">&#39;&#39;&#39;&quot; type=&quot;checkbox&quot; name=&quot;delete_room_&#39;&#39;&#39;</span><span class="o">+</span><span class="n">a</span><span class="o">+</span><span class="s">&#39;&#39;&#39;&quot; /&gt;</span>
<span class="s">  &lt;/div&gt;</span>
<span class="s">	</span>
<span class="s">  &lt;a href=&quot;/zone_objects_setup/&#39;&#39;&#39;</span><span class="o">+</span><span class="n">a</span><span class="o">+</span><span class="s">&#39;&#39;&#39;&quot;&gt;&lt;div id=&quot;oggetti&quot;&gt;Objects&lt;/div&gt; &lt;/a&gt;  </span>


<span class="s">&lt;/div&gt;</span>
<span class="s">  &#39;&#39;&#39;</span>

      <span class="n">html_p</span><span class="o">=</span><span class="n">get_zone_manager_inner_html</span><span class="o">+</span><span class="n">html</span><span class="o">+</span><span class="s">&#39;&#39;&#39;&lt;/form&gt; </span>
<span class="s">&lt;/body&gt;</span>
<span class="s">&lt;/html&gt;&#39;&#39;&#39;</span>         
      <span class="k">return</span> <span class="p">(</span><span class="n">html_p</span><span class="p">)</span> 






      

    <span class="k">def</span> <span class="nf">get_Zone_Objects_Setup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">current_path</span><span class="p">,</span><span class="n">objectDictionary</span><span class="p">,</span><span class="n">zone</span><span class="p">):</span>         </div>
<div class="viewcode-block" id="MyHandler.get_Zone_Objects_Setup"><a class="viewcode-back" href="../webserver.html#webserver.MyHandler.get_Zone_Objects_Setup">[docs]</a>      <span class="k">print</span> <span class="s">&quot;current_path&quot;</span><span class="o">+</span><span class="n">current_path</span>
      <span class="k">if</span> <span class="n">string</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">current_path</span><span class="p">,</span><span class="s">&quot;/setup&quot;</span><span class="p">)</span><span class="o">!=-</span><span class="mi">1</span><span class="p">:</span>
        <span class="n">link_back</span><span class="o">=</span><span class="s">&quot;/setup/zone_manager/&quot;</span>
      <span class="k">else</span><span class="p">:</span>
        <span class="n">link_back</span><span class="o">=</span><span class="s">&quot;/zone_list&quot;</span>

      <span class="n">html_page</span><span class="o">=</span><span class="s">&#39;&#39;&#39;&lt;!DOCTYPE html&gt;</span>
<span class="s">&lt;html&gt;</span>
<span class="s">&lt;head&gt;</span>
<span class="s">  &lt;link rel=&quot;stylesheet&quot; href=&quot;/css/zone_object_setup_css.css&quot; type=&quot;text/css&quot; media=&quot;all&quot; /&gt;</span>

<span class="s">  &lt;meta name=&quot;viewport&quot; content=&quot;width=device-width&quot;  &gt;</span>
<span class="s">  &lt;meta charset=&quot;utf-8&quot;&gt;</span>
<span class="s">  &lt;title&gt;Zone_object_setup&lt;/title&gt;</span>
<span class="s">&lt;script type=&quot;text/javascript&quot; language=&quot;javascript&quot;&gt;function SelectAll(id){    document.getElementById(id).focus();   document.getElementById(id).select();}&lt;/script&gt;</span>
<span class="s">&lt;/head&gt;</span>
<span class="s">&lt;body&gt;</span>
<span class="s">&lt;form action=&quot;&quot; method=&quot;POST&quot;&gt;&lt;input type=&quot;hidden&quot; name=&quot;zone_objects_setup&quot; value=&quot;&#39;&#39;&#39;</span><span class="o">+</span><span class="n">zone</span><span class="o">+</span><span class="s">&#39;&#39;&#39;&quot;&gt;</span>
<span class="s">  </span>
<span class="s">&lt;div id=&quot;buttons&quot;&gt;</span>
<span class="s">  &lt;input type=&quot;submit&quot; value=&quot;SUBMIT&quot;&gt;</span>
<span class="s">  &lt;a href=&quot;/&quot;&gt;&lt;div id=&quot;home&quot;&gt;HOME&lt;/div&gt;&lt;/a&gt;</span>
<span class="s">  &lt;a href=&quot;&#39;&#39;&#39;</span><span class="o">+</span><span class="n">link_back</span><span class="o">+</span><span class="s">&#39;&#39;&#39;&quot;&gt;&lt;div id=&quot;back&quot;&gt;BACK&lt;/div&gt;&lt;/a&gt;</span>
<span class="s"> </span>
<span class="s">&lt;/div&gt;</span>
<span class="s">  </span>
<span class="s">  </span>
<span class="s">  </span>

<span class="s">  </span>
<span class="s"> &lt;div id=&quot;header&quot;&gt;&#39;&#39;&#39;</span><span class="o">+</span><span class="n">zone</span><span class="o">+</span><span class="s">&#39;&#39;&#39; objects setup&lt;/div&gt;</span>
<span class="s">  </span>
<span class="s">  </span>
<span class="s">&lt;div id=&quot;testo&quot;&gt;</span>
<span class="s">   </span>

<span class="s">&lt;input type=&quot;text&quot; name=&quot;new_objects&quot; id=&quot;create_zone_web_obj&quot;  onclick=&quot;SelectAll(&#39;create_zone_web_obj&#39;)&quot;;  value=&quot;TYPE_NEW_OBJECT_HERE&quot;&gt;</span>



<span class="s">&lt;/div&gt;&#39;&#39;&#39;</span>  



      <span class="k">if</span> <span class="n">zone</span>  <span class="ow">in</span> <span class="n">zoneDict</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="p">:</span>

        <span class="k">print</span> <span class="s">&quot;zone in zoneDict&quot;</span>
        <span class="n">obj_name_list</span><span class="o">=</span><span class="n">zoneDict</span><span class="p">[</span><span class="n">zone</span><span class="p">][</span><span class="s">&quot;objects&quot;</span><span class="p">]</span>
      
        <span class="n">tmp_html</span><span class="o">=</span><span class="s">&#39;&lt;tr&gt;&lt;td class=&quot;web_obj_name&quot;&gt;No web object present in this room&lt;/td&gt;&lt;td&gt;&lt;/td&gt;&lt;td class=&quot;web_obj_name&quot;&gt;&lt;/td&gt;&lt;/tr&gt;&#39;</span>


        <span class="n">obj_name_list</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">obj_name_list</span> <span class="p">:</span>
          <span class="n">c</span><span class="o">=</span><span class="n">a</span>
          <span class="c">#c=string.replace(a, &quot;_p_&quot;+zone, &quot;_p&quot;) </span>
          <span class="c">#c=string.replace(c,zone+&quot;_body&quot;, zone+&quot;_b_&quot;) </span>
          <span class="n">html_page</span><span class="o">=</span><span class="n">html_page</span><span class="o">+</span><span class="s">&#39;&#39;&#39;</span>
<span class="s">&lt;div id=&quot;riga&quot;&gt;</span>
<span class="s">&lt;div id=&quot;object&quot;&gt;&#39;&#39;&#39;</span><span class="o">+</span><span class="n">c</span><span class="o">+</span><span class="s">&#39;&#39;&#39;&lt;/div&gt;</span>
<span class="s">&lt;div id=&quot;used&quot;&gt;  </span>
<span class="s">  ADD</span>
<span class="s">  &lt;input type=&quot;checkbox&quot; name=&quot;&#39;&#39;&#39;</span><span class="o">+</span><span class="n">a</span><span class="o">+</span><span class="s">&#39;&#39;&#39;_sl_obj_room&quot; checked=&quot;checked&quot; /&gt;</span>
<span class="s">  &lt;/div&gt;</span>
<span class="s">&lt;/div&gt;</span>
<span class="s">  &#39;&#39;&#39;</span>
     






        <span class="n">l</span><span class="o">=</span><span class="p">[]</span>
        <span class="n">l</span><span class="o">=</span><span class="n">objectDictionary</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
        <span class="n">l</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">l</span><span class="p">:</span>


          <span class="n">body_found</span><span class="o">=</span><span class="n">string</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">b</span><span class="p">,</span><span class="s">&quot;_body&quot;</span><span class="p">)</span>
          <span class="n">part_without_body</span><span class="o">=</span><span class="s">&quot; &quot;</span>
          <span class="n">en</span><span class="o">=</span><span class="mi">1</span>

          <span class="k">if</span> <span class="p">(</span><span class="n">body_found</span><span class="o">!=-</span><span class="mi">1</span><span class="p">):</span>
            <span class="k">print</span> <span class="s">&quot;found a body:&quot;</span><span class="o">+</span><span class="n">b</span>
            <span class="n">part_without_body</span><span class="o">=</span><span class="n">string</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="s">&quot;_body&quot;</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">)</span>   <span class="c">#b[0:body_found]</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">part_without_body</span><span class="o">==</span><span class="n">zone</span><span class="p">):</span>
                <span class="k">print</span> <span class="s">&quot;body enabled&quot;</span>
                <span class="n">en</span><span class="o">=</span><span class="mi">1</span>                            <span class="c">#allow the display of the same body of the zone</span>
            <span class="k">else</span><span class="p">:</span> 
              <span class="k">print</span> <span class="s">&quot;body rejected&quot;</span>
              <span class="n">en</span><span class="o">=</span><span class="mi">0</span>                              <span class="c">#block the display of the body of others zones</span>


          <span class="n">private_found</span><span class="o">=</span><span class="n">string</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">b</span><span class="p">,</span><span class="s">&quot;_p_&quot;</span><span class="p">)</span>  <span class="c">#private object to show only in its zone</span>
          <span class="n">part_without_private</span><span class="o">=</span><span class="s">&quot; &quot;</span>
          <span class="n">en2</span><span class="o">=</span><span class="mi">1</span>
          <span class="k">if</span> <span class="p">(</span><span class="n">private_found</span><span class="o">!=-</span><span class="mi">1</span><span class="p">):</span>

            <span class="n">part_without_private</span><span class="o">=</span><span class="n">b</span><span class="p">[</span><span class="n">private_found</span><span class="o">+</span><span class="mi">3</span><span class="p">:]</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">part_without_private</span><span class="o">==</span><span class="n">zone</span><span class="p">):</span>
                <span class="n">en2</span><span class="o">=</span><span class="mi">1</span>                            <span class="c">#allow the display of private object of the zone</span>
            <span class="k">else</span><span class="p">:</span> 
              <span class="n">en2</span><span class="o">=</span><span class="mi">0</span>                              <span class="c">#block the display of private object of others zones</span>



          <span class="k">if</span> <span class="p">(</span><span class="n">b</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">obj_name_list</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="n">en</span><span class="o">==</span><span class="mi">1</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="n">en2</span><span class="o">==</span><span class="mi">1</span><span class="p">)</span> <span class="p">:</span>
            <span class="n">c</span><span class="o">=</span><span class="n">b</span>
            <span class="c">#c=string.replace(b, &quot;_p_&quot;+zone, &quot;_p&quot;) </span>
            <span class="c">#c=string.replace(c,zone+&quot;_body&quot;, zone+&quot;_b_&quot;) </span>
            <span class="n">html_page</span><span class="o">=</span><span class="n">html_page</span><span class="o">+</span><span class="s">&#39;&#39;&#39;</span>

<span class="s">&lt;div id=&quot;riga&quot;&gt;</span>

<span class="s">   </span>

<span class="s">&lt;div id=&quot;object&quot;&gt;&#39;&#39;&#39;</span><span class="o">+</span><span class="n">c</span><span class="o">+</span><span class="s">&#39;&#39;&#39;&lt;/div&gt;</span>
<span class="s">&lt;div id=&quot;add&quot;&gt;</span>
<span class="s">  ADD</span>
<span class="s">  &lt;input type=&quot;checkbox&quot; name=&quot;&#39;&#39;&#39;</span><span class="o">+</span><span class="n">b</span><span class="o">+</span><span class="s">&#39;&#39;&#39;_sl_obj_room&quot; /&gt;</span>
<span class="s">  &lt;/div&gt;</span>
<span class="s">&lt;/div&gt;</span>
<span class="s">  &#39;&#39;&#39;</span> 
        <span class="n">html_page</span><span class="o">=</span><span class="n">html_page</span><span class="o">+</span><span class="s">&#39;&#39;&#39;&lt;div id=&quot;riga&quot; style=&quot; visibility: hidden;&quot; &gt;&lt;div id=&quot;object&quot;&gt;&lt;/div&gt;&lt;div id=&quot;add&quot; style=&quot;border: 1px&quot;&gt;&lt;/div&gt;&lt;/div&gt;&#39;&#39;&#39;</span>  
        <span class="c">#to make the last element void in order to not be hidden a webobject under the submit button</span>
    

      <span class="k">else</span><span class="p">:</span>      <span class="c">#zone not the room object      </span>
        <span class="k">print</span> <span class="s">&quot;not a room&quot;</span>


      <span class="n">html_page</span><span class="o">=</span><span class="n">html_page</span><span class="o">+</span><span class="s">&#39;&#39;&#39;&lt;/form&gt;&lt;/body&gt;&lt;/html&gt;&#39;&#39;&#39;</span>

      <span class="k">return</span><span class="p">(</span><span class="n">html_page</span><span class="p">)</span>












    <span class="k">def</span> <span class="nf">get_RoomList</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span><span class="c">#return the html modifier for the web list of room</span></div>
<div class="viewcode-block" id="MyHandler.get_RoomList"><a class="viewcode-back" href="../webserver.html#webserver.MyHandler.get_RoomList">[docs]</a>      <span class="n">i</span><span class="o">=</span><span class="mi">0</span>
<span class="c">#&lt;script type=&quot;text/javascript&quot; src=&quot;/javascript/zone_modifier.js&quot;&gt;&lt;/script&gt;</span>

      <span class="n">html_tmp</span><span class="o">=</span><span class="s">&#39;&#39;&#39;&lt;html&gt;&lt;head&gt;&lt;meta name=&quot;viewport&quot; content=&quot;width=device-width&quot;&gt;&lt;link rel=&quot;stylesheet&quot; href=&quot;/css/mod-rooms-list.css&quot; type=&quot;text/css&quot; media=&quot;all&quot; /&gt; &lt;script type=&quot;text/javascript&quot; language=&quot;javascript&quot;&gt;function SelectAll(id){    document.getElementById(id).focus();   document.getElementById(id).select();}&lt;/script&gt;  &lt;meta charset=&quot;utf-8&quot;&gt; &lt;title&gt;ZONE CONFIGURATIONS&lt;/title&gt;&lt;style&gt; &lt;/style&gt;&lt;/head&gt;&lt;body&gt;&lt;form action=&quot;&quot; method=&quot;POST&quot;&gt; &lt;div class=&quot;tabella&quot;&gt;&lt;div class=&quot;riga&quot;&gt;&lt;div class=&quot;colonna&quot;&gt;ZONE NAME&lt;/div&gt;&lt;div class=&quot;colonna&quot;&gt;CHANGE ZONE NAME&lt;/div&gt;&lt;/div&gt;&#39;&#39;&#39;</span>

      <span class="n">l</span><span class="o">=</span><span class="p">[]</span>
      <span class="n">l</span><span class="o">=</span><span class="n">sortZonesByOrderNumber</span><span class="p">()</span>  <span class="c">#get the zone list sorted by order number</span>

      <span class="n">i</span><span class="o">=</span><span class="mi">0</span>
      <span class="k">for</span> <span class="n">room</span> <span class="ow">in</span> <span class="n">l</span><span class="p">:</span>  <span class="c">#for every object  in the dictionary</span>
        <span class="k">print</span> <span class="s">&quot;room[hidden]:&quot;</span><span class="p">,</span><span class="n">room</span><span class="p">[</span><span class="s">&quot;hidden&quot;</span><span class="p">]</span>
        <span class="c">#if (zoneDict[room][&quot;hidden&quot;]!=0):  #skip the hidden elements</span>
        <span class="c">#  continue</span>
                
        <span class="n">delete_room_check_box</span><span class="o">=</span><span class="s">&#39;&#39;&#39;Delete Room&lt;input type=&quot;checkbox&quot; name=&quot;delete_room_&#39;&#39;&#39;</span><span class="o">+</span><span class="n">room</span><span class="o">+</span><span class="s">&#39;&#39;&#39;&quot; value=&quot;&#39;&#39;&#39;</span><span class="o">+</span><span class="n">room</span><span class="o">+</span><span class="s">&#39;&#39;&#39;&quot;/&gt;&#39;&#39;&#39;</span>        
        <span class="c">##print roomList[i]</span>
        <span class="n">html_tmp</span><span class="o">=</span><span class="n">html_tmp</span><span class="o">+</span><span class="s">&#39;&#39;&#39; &lt;div class=&quot;riga&quot;&gt;&lt;div class=&quot;colonna&quot;&gt;&lt;a href=&quot;&#39;&#39;&#39;</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="o">+</span><span class="n">room</span><span class="o">+</span><span class="s">&#39;&#39;&#39;&quot;&gt;&#39;&#39;&#39;</span><span class="o">+</span><span class="n">room</span><span class="o">+</span><span class="s">&#39;&#39;&#39;&lt;/a&gt;&lt;/div&gt;&lt;div class=&quot;colonna&quot;&gt;&lt;input type=&quot;text&quot; id=&quot;text_name&#39;&#39;&#39;</span><span class="o">+</span><span class="n">room</span><span class="o">+</span><span class="s">&#39;&#39;&#39;&quot; onClick=&quot;SelectAll(&#39;text_name&#39;&#39;&#39;</span><span class="o">+</span><span class="n">room</span><span class="o">+</span><span class="s">&#39;&#39;&#39;&#39;);&quot;  name=&#39;&#39;&#39;</span><span class="o">+</span><span class="n">room</span><span class="o">+</span><span class="s">&#39;&#39;&#39; value=&quot;&#39;&#39;&#39;</span><span class="o">+</span><span class="n">room</span><span class="o">+</span><span class="s">&#39;&#39;&#39;&quot;&gt; &lt;/div&gt;&lt;div class=&quot;colonna&quot; &gt;&#39;&#39;&#39;</span><span class="o">+</span><span class="n">delete_room_check_box</span><span class="o">+</span><span class="s">&#39;&#39;&#39;&lt;/div&gt; &lt;/div&gt;&#39;&#39;&#39;</span>
        <span class="n">i</span><span class="o">=</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span>


      <span class="n">new_room</span><span class="o">=</span><span class="s">&#39;&#39;&#39;&lt;div id=&quot;last_row&quot; class=&quot;riga&quot;&gt;&lt;div id=&quot;last_row&quot; class=&quot;colonna&quot;&gt;CREATE NEW ZONE&lt;/div&gt;&lt;div id=&quot;last_row&quot;class=&quot;colonna&quot;&gt;&lt;input type=&quot;text&quot; id=&quot;last_row_text&quot; onClick=&quot;SelectAll(&#39;last_row_text&#39;)&quot;;  name=&quot;new_room&quot; value=&quot;&#39;&#39;&#39;</span><span class="o">+</span><span class="n">default_new_zone_value</span><span class="o">+</span><span class="s">&#39;&#39;&#39;&quot;&gt;&lt;/div&gt;&lt;/div&gt;&lt;input type=&quot;submit&quot; id=&quot;submit_button&quot; value=&quot;Submit&quot; &gt;&lt;/form&gt;&#39;&#39;&#39;</span>
      <span class="n">pag</span><span class="o">=</span><span class="n">html_tmp</span><span class="o">+</span><span class="n">new_room</span><span class="o">+</span><span class="s">&#39;&#39;&#39;&lt;/body&gt;&lt;/html&gt;&#39;&#39;&#39;</span>   
    <span class="c">#  print &quot;pagina mostrata&quot;+pag</span>
      <span class="k">return</span><span class="p">(</span><span class="n">pag</span><span class="p">)</span>



    <span class="k">def</span> <span class="nf">get_RoomObjectList</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">room</span><span class="p">,</span><span class="n">objectDictionary</span><span class="p">):</span><span class="c">#return the html for the web_objects form present in a room</span></div>
<div class="viewcode-block" id="MyHandler.get_RoomObjectList"><a class="viewcode-back" href="../webserver.html#webserver.MyHandler.get_RoomObjectList">[docs]</a>
      <span class="c">#room_index=roomList.index(room)</span>
      <span class="c">#updateOneRoom(room)          if uncommented make the htmlobj double...</span>
      <span class="n">html_tmp</span><span class="o">=</span><span class="s">&#39;&#39;&#39;&lt;html&gt;&lt;head&gt;&lt;meta name=&quot;viewport&quot; content=&quot;width=device-width&quot;&gt;&lt;link rel=&quot;stylesheet&quot; href=&quot;/css/zone_object_list_config.css&quot; type=&quot;text/css&quot; media=&quot;all&quot; /&gt;&lt;style&gt; &lt;/style&gt;&lt;script type=&quot;text/javascript&quot; language=&quot;javascript&quot;&gt;function SelectAll(id){    document.getElementById(id).focus();   document.getElementById(id).select();}&lt;/script&gt;&lt;/head&gt;&lt;body&gt;&lt;form action=&quot;&quot; method=&quot;POST&quot;&gt;&lt;input type=&quot;hidden&quot; name=&quot;current_room&quot; value=&quot;&#39;&#39;&#39;</span><span class="o">+</span><span class="n">room</span><span class="o">+</span><span class="s">&#39;&#39;&#39;&quot;&gt; &lt;table border=&quot;1&quot; style=&quot;width:100%&quot;&gt;&lt;tr class=&quot;web_obj_title&quot;&gt; &lt;td&gt;Room web objects , click them to modify:&lt;/td&gt;&lt;td&gt;Html example to use the web object on a html page&lt;/td&gt;&lt;/tr&gt;&#39;&#39;&#39;</span>
      <span class="n">html</span><span class="o">=</span><span class="s">&#39;&#39;</span>
      <span class="k">if</span> <span class="n">room</span>  <span class="ow">in</span> <span class="n">zoneDict</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="p">:</span>
        <span class="c">#print &quot;room in zoneDict&quot;</span>
        <span class="n">obj_name_list</span><span class="o">=</span><span class="n">zoneDict</span><span class="p">[</span><span class="n">room</span><span class="p">][</span><span class="s">&quot;objects&quot;</span><span class="p">]</span>
        <span class="n">i</span><span class="o">=</span><span class="mi">0</span>
        <span class="n">tmp_html</span><span class="o">=</span><span class="s">&#39;&lt;tr&gt;&lt;td class=&quot;web_obj_name&quot;&gt;No web object present in this room&lt;/td&gt;&lt;td&gt;&lt;/td&gt;&lt;td class=&quot;web_obj_name&quot;&gt;&lt;/td&gt;&lt;/tr&gt;&#39;</span>
        <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">obj_name_list</span> <span class="p">:</span>
          <span class="n">tmp_html</span><span class="o">=</span><span class="s">&#39;&#39;</span>           
        
          <span class="c">#print &quot;web obj in the room =&quot;+a</span>
          <span class="n">html</span><span class="o">=</span><span class="n">html</span><span class="o">+</span><span class="s">&#39;&lt;tr&gt;&lt;td class=&quot;web_obj_name&quot;&gt;&lt;a    href=&quot;&#39;</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="o">+</span><span class="s">&#39;/&#39;</span><span class="o">+</span><span class="n">a</span><span class="o">+</span><span class="s">&#39;&quot;&gt;&#39;</span><span class="o">+</span><span class="n">a</span><span class="o">+</span><span class="s">&#39;&lt;/a&gt;&lt;/td&gt;&lt;td class=&quot;web_obj_code&quot; &gt;&lt;xmp &gt;&lt;a id=&quot;&#39;</span><span class="o">+</span><span class="n">a</span><span class="o">+</span><span class="s">&#39;&quot;  href=&quot;?&#39;</span><span class="o">+</span><span class="n">a</span><span class="o">+</span><span class="s">&#39;=0&quot;&gt;&#39;</span><span class="o">+</span><span class="n">a</span><span class="o">+</span><span class="s">&#39;&lt;/a&gt; &lt;/xmp&gt;&lt;/td&gt;&lt;td class=&quot;web_obj_name&quot;&gt;Remove this web object from this Room &lt;input type=&quot;checkbox&quot; name=&quot;rm_obj_&#39;</span><span class="o">+</span><span class="n">a</span><span class="o">+</span><span class="s">&#39;_from_&#39;</span><span class="o">+</span><span class="n">room</span><span class="o">+</span><span class="s">&#39;&quot; value=&quot;&#39;</span><span class="o">+</span><span class="n">a</span><span class="o">+</span><span class="s">&#39;&quot;&gt;&lt;/td&gt;&lt;/tr&gt;&#39;</span>
      <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">tmp_html</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">4</span><span class="p">)</span> <span class="p">:</span>
        <span class="n">html</span><span class="o">=</span><span class="n">html</span><span class="o">+</span><span class="n">tmp_html</span>
      <span class="n">html</span><span class="o">=</span><span class="n">html</span><span class="o">+</span><span class="s">&#39;&lt;/table&gt;&#39;</span>
      <span class="n">html</span><span class="o">=</span><span class="n">html</span><span class="o">+</span><span class="s">&#39;&lt;table border=&quot;1&quot; style=&quot;width:100%&quot;&gt;&lt;tr&gt;&lt;br/&gt;&lt;/tr&gt;&lt;tr class=&quot;web_obj_title&quot; &gt;&lt;td&gt;Manage the web object not present in the room&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&#39;</span>
      <span class="n">html</span><span class="o">=</span><span class="n">html</span><span class="o">+</span><span class="s">&#39;&lt;table border=&quot;1&quot; style=&quot;width:100%&quot;&gt;&lt;tr&gt;&lt;td class=&quot;web_obj_name&quot;&gt;Add an existing web object to this room&lt;/td&gt;&lt;td class=&quot;web_obj_name&quot;&gt;&#39;</span> 


      <span class="c">#print &quot;room dict values:&quot;</span>
      <span class="c">#print zoneDict.values()</span>
      <span class="c">#print zoneDict.values()[0][0]</span>

      <span class="n">html</span><span class="o">=</span><span class="n">html</span><span class="o">+</span><span class="s">&#39;&lt;table border=&quot;1&quot; style=&quot;width:100%;text-align:center&quot;&gt;&#39;</span>
      


      <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span>  <span class="n">objectDictionary</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">body_found</span><span class="o">=</span><span class="n">string</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="s">&quot;_body&quot;</span><span class="p">)</span>
        <span class="n">part_without_body</span><span class="o">=</span><span class="s">&quot; &quot;</span>
        <span class="n">en</span><span class="o">=</span><span class="mi">1</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">body_found</span><span class="o">!=-</span><span class="mi">1</span><span class="p">):</span>
          <span class="n">part_without_body</span><span class="o">=</span><span class="n">s</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">body_found</span><span class="p">]</span>
          <span class="k">if</span> <span class="p">(</span><span class="n">part_without_body</span><span class="o">==</span><span class="n">room</span><span class="p">):</span>
              <span class="n">en</span><span class="o">=</span><span class="mi">1</span>                            <span class="c">#allow the display of the same body of the room</span>
          <span class="k">else</span><span class="p">:</span> 
            <span class="n">en</span><span class="o">=</span><span class="mi">0</span>                              <span class="c">#block the display of the body of others rooms</span>

        

        <span class="k">if</span> <span class="p">(</span><span class="n">objectDictionary</span><span class="p">[</span><span class="n">s</span><span class="p">]</span><span class="o">.</span><span class="n">getName</span><span class="p">()</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">zoneDict</span><span class="p">[</span><span class="n">room</span><span class="p">][</span><span class="s">&quot;objects&quot;</span> <span class="p">])</span><span class="o">&amp;</span> <span class="p">(</span><span class="n">en</span><span class="o">==</span><span class="mi">1</span><span class="p">):</span> <span class="c">#if web object not yet present in the room make possible to add it </span>

          <span class="n">html</span><span class="o">=</span><span class="n">html</span><span class="o">+</span><span class="s">&#39;&lt;tr&gt;&lt;td&gt;Add Web Object&lt;/td&gt;&lt;td&gt;&#39;</span><span class="o">+</span><span class="n">objectDictionary</span><span class="p">[</span><span class="n">s</span><span class="p">]</span><span class="o">.</span><span class="n">getName</span><span class="p">()</span><span class="o">+</span><span class="s">&#39; &lt;/td&gt;&lt;td&gt;To This Room &lt;input type=&quot;checkbox&quot; name=&quot;add_obj_to_room&#39;</span><span class="o">+</span><span class="n">objectDictionary</span><span class="p">[</span><span class="n">s</span><span class="p">]</span><span class="o">.</span><span class="n">getName</span><span class="p">()</span><span class="o">+</span><span class="s">&#39;&quot; value=&quot;&#39;</span><span class="o">+</span><span class="n">objectDictionary</span><span class="p">[</span><span class="n">s</span><span class="p">]</span><span class="o">.</span><span class="n">getName</span><span class="p">()</span><span class="o">+</span><span class="s">&#39;&quot;&gt; &lt;/td&gt;&lt;/tr&gt; &#39;</span>

      <span class="n">html</span><span class="o">=</span><span class="n">html</span><span class="o">+</span><span class="s">&#39;&lt;/table&gt;&#39;</span>
      <span class="n">html</span><span class="o">=</span><span class="n">html</span><span class="o">+</span><span class="s">&#39;&#39;&#39;&lt;tr&gt;&lt;td class=&quot;web_obj_name&quot;&gt;Create a new web object&lt;/td&gt;&lt;td&gt;&lt;input type=&quot;text&quot; onClick=&quot;SelectAll(&#39;new_object_text&#39;)&quot;;  id=&quot;new_object_text&quot;  name=&quot;new_web_object&quot; value=&quot;&#39;&#39;&#39;</span><span class="o">+</span><span class="n">default_new_obj_value</span><span class="o">+</span><span class="s">&#39;&#39;&#39;&quot;  size=&quot;50&quot; &gt;   &lt;/td&gt; &lt;/tr&gt;&#39;&#39;&#39;</span>
      <span class="n">html</span><span class="o">=</span><span class="n">html</span><span class="o">+</span><span class="s">&#39;&#39;&#39;&lt;/table&gt;&lt;input type=&quot;submit&quot; value=&quot;Submit&quot; &gt;&lt;/form&gt;&#39;&#39;&#39;</span> 
      <span class="c">#print &quot;stanza&quot; </span>
      <span class="c">#print room</span>
      <span class="n">html</span><span class="o">=</span><span class="n">html</span><span class="o">+</span><span class="s">&#39;&#39;&#39;&lt;table border=&quot;1&quot; style=&quot;width:100%&quot;&gt;&lt;tr&gt;&lt;td class=&quot;web_obj_title&quot;&gt;Modify the room html &lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&quot;web_obj_name&quot;&gt;&lt;a  href=&quot;/&#39;&#39;&#39;</span><span class="o">+</span><span class="n">baseDir</span><span class="o">+</span><span class="n">room</span><span class="o">+</span><span class="s">&#39;&#39;&#39;/index.html/?=&quot; &gt;Click Here to go to the room web page &lt;/a&gt; &lt;/td&gt;&lt;/tr&gt;&#39;&#39;&#39;</span>

      

      <span class="n">html</span><span class="o">=</span><span class="n">html</span><span class="o">+</span><span class="s">&#39;&lt;tr&gt;&lt;td&gt;&lt;form action=&quot;&quot; method=&quot;POST&quot;&gt;&lt;input type=&quot;hidden&quot; name=&quot;current_room_text_area&quot; value=&quot;&#39;</span><span class="o">+</span><span class="n">room</span><span class="o">+</span><span class="s">&#39;&quot;&gt;&lt;textarea name=&quot;html_room_mod&quot; cols=1 rows=5  style=&quot;width:100%&quot; &gt;&#39;</span><span class="o">+</span><span class="n">getRoomHtml</span><span class="p">(</span><span class="n">room</span><span class="p">,</span><span class="n">objectDictionary</span><span class="p">,</span><span class="s">&quot;&quot;</span><span class="p">,</span><span class="n">zoneDict</span><span class="p">)</span><span class="o">+</span><span class="s">&#39;&lt;/textarea&gt;&lt;/td&gt;&lt;/tr&gt;&#39;</span>
            
      <span class="n">pag</span><span class="o">=</span><span class="n">html_tmp</span><span class="o">+</span><span class="n">html</span><span class="o">+</span><span class="s">&#39;&lt;/table&gt;&lt;input type=&quot;submit&quot; value=&quot;Submit_textarea&quot; &gt;&lt;/form&gt;&lt;/body&gt;&lt;/html&gt;&#39;</span> 

      <span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="o">=</span><span class="s">&quot;/&quot;</span>
      <span class="k">return</span><span class="p">(</span><span class="n">pag</span><span class="p">)</span>



    <span class="k">def</span> <span class="nf">get_WebObjForm</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">web_obj</span><span class="p">):</span><span class="c">#return the html web form to modify a web object </span></div>
<div class="viewcode-block" id="MyHandler.get_WebObjForm"><a class="viewcode-back" href="../webserver.html#webserver.MyHandler.get_WebObjForm">[docs]</a>      <span class="n">style</span><span class="o">=</span><span class="n">web_obj</span><span class="o">.</span><span class="n">getStyle</span><span class="p">()</span>
      <span class="n">name</span><span class="o">=</span><span class="n">web_obj</span><span class="o">.</span><span class="n">getName</span><span class="p">()</span>
      <span class="n">html_obj</span><span class="o">=</span><span class="n">web_obj</span><span class="o">.</span><span class="n">getHtml</span><span class="p">()</span>

      <span class="n">templateFile</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s">&#39;setup/ModifyWebObjForm.template.html&#39;</span><span class="p">,</span><span class="s">&#39;rb&#39;</span><span class="p">)</span> <span class="c">#get the template to use in order to render the page</span>
      <span class="n">ModObjFormPage</span><span class="o">=</span><span class="n">templateFile</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
      <span class="n">templateFile</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

      <span class="n">notes</span><span class="o">=</span><span class="s">&quot;Enter_The_Web_Object_Notes&quot;</span>
      <span class="n">hardwarePin</span><span class="o">=</span><span class="n">no_pin_selected</span>  <span class="c">#string display when no pin has been assigned yet containing &quot;no_pin&quot;</span>
      <span class="n">type_b</span><span class="o">=</span><span class="s">&quot;&quot;</span>
      <span class="n">type_sb</span><span class="o">=</span><span class="s">&quot;&quot;</span>
      <span class="n">type_l</span><span class="o">=</span><span class="s">&quot;&quot;</span>
      <span class="n">type_d_sensor</span><span class="o">=</span><span class="s">&quot;&quot;</span>
      <span class="n">type_a_sensor</span><span class="o">=</span><span class="s">&quot;&quot;</span>
      <span class="n">current_status0</span><span class="o">=</span><span class="s">&quot; &quot;</span>
      <span class="n">current_status1</span><span class="o">=</span><span class="s">&quot; &quot;</span>
      <span class="n">style0</span><span class="o">=</span><span class="s">&quot;/*Enter here the style you want your web object to have when its status is 0 */&quot;</span>
      <span class="n">style1</span><span class="o">=</span><span class="s">&quot;/*Enter here the style you want your web object to have when its status is 0 */&quot;</span>
      <span class="n">html0</span><span class="o">=</span><span class="s">&quot;&lt;!-- Enter here the html you want your web object to display when its status is 0  --&gt;&quot;</span>
      <span class="n">html1</span><span class="o">=</span><span class="s">&quot;&lt;!-- Enter here the html you want your web object to display when its status is 1  --&gt;&quot;</span>
      <span class="n">command0</span><span class="o">=</span><span class="s">&quot; &quot;</span>
      <span class="n">command1</span><span class="o">=</span><span class="s">&quot; &quot;</span>
      <span class="n">init_command</span><span class="o">=</span><span class="s">&quot; &quot;</span>

      <span class="k">if</span> <span class="n">web_obj</span><span class="o">.</span><span class="n">getNotes</span><span class="p">()</span><span class="o">!=</span><span class="s">&quot; &quot;</span> <span class="p">:</span>
        <span class="n">notes</span><span class="o">=</span><span class="n">web_obj</span><span class="o">.</span><span class="n">getNotes</span><span class="p">()</span> 

      <span class="k">if</span> <span class="n">web_obj</span><span class="o">.</span><span class="n">getAttachedPinList</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span><span class="o">!=</span><span class="mi">9999</span> <span class="p">:</span>
        <span class="n">hardwarePin</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">web_obj</span><span class="o">.</span><span class="n">getAttachedPinList</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span> 

      <span class="k">if</span> <span class="n">web_obj</span><span class="o">.</span><span class="n">getType</span><span class="p">()</span><span class="o">==</span><span class="s">&quot;b&quot;</span> <span class="p">:</span>
        <span class="n">type_b</span><span class="o">=</span><span class="s">&quot;checked&quot;</span>


      <span class="k">if</span> <span class="n">web_obj</span><span class="o">.</span><span class="n">getType</span><span class="p">()</span><span class="o">==</span><span class="s">&quot;sb&quot;</span> <span class="p">:</span>
        <span class="n">type_sb</span><span class="o">=</span><span class="s">&quot;checked&quot;</span>


      <span class="k">if</span> <span class="n">web_obj</span><span class="o">.</span><span class="n">getType</span><span class="p">()</span><span class="o">==</span><span class="s">&quot;l&quot;</span> <span class="p">:</span>
        <span class="n">type_l</span><span class="o">=</span><span class="s">&quot;checked&quot;</span>

      <span class="k">if</span> <span class="n">web_obj</span><span class="o">.</span><span class="n">getType</span><span class="p">()</span><span class="o">==</span><span class="s">&quot;d_sensor&quot;</span> <span class="p">:</span>
        <span class="n">type_d_sensor</span><span class="o">=</span><span class="s">&quot;checked&quot;</span>

      <span class="k">if</span> <span class="n">web_obj</span><span class="o">.</span><span class="n">getType</span><span class="p">()</span><span class="o">==</span><span class="s">&quot;a_sensor&quot;</span> <span class="p">:</span>
        <span class="n">type_a_sensor</span><span class="o">=</span><span class="s">&quot;checked&quot;</span>

      <span class="k">if</span> <span class="n">web_obj</span><span class="o">.</span><span class="n">getStatus</span><span class="p">()</span><span class="o">==</span><span class="mi">0</span> <span class="p">:</span>
        <span class="n">current_status0</span><span class="o">=</span><span class="s">&quot;checked&quot;</span>
        <span class="n">current_status1</span><span class="o">=</span><span class="s">&quot;&quot;</span>
        <span class="n">status_link</span><span class="o">=</span><span class="s">&quot;1&quot;</span>
      <span class="k">else</span><span class="p">:</span>
        <span class="n">current_status0</span><span class="o">=</span><span class="s">&quot;&quot;</span>
        <span class="n">current_status1</span><span class="o">=</span><span class="s">&quot;checked&quot;</span>
        <span class="n">status_link</span><span class="o">=</span><span class="s">&quot;0&quot;</span>

      <span class="k">if</span> <span class="n">web_obj</span><span class="o">.</span><span class="n">getStyle0</span><span class="p">()</span><span class="o">!=</span><span class="s">&quot; &quot;</span> <span class="p">:</span>
        <span class="n">style0</span><span class="o">=</span><span class="n">web_obj</span><span class="o">.</span><span class="n">getStyle0</span><span class="p">()</span>

      <span class="k">if</span> <span class="n">web_obj</span><span class="o">.</span><span class="n">getStyle1</span><span class="p">()</span><span class="o">!=</span><span class="s">&quot; &quot;</span> <span class="p">:</span>
        <span class="n">style1</span><span class="o">=</span><span class="n">web_obj</span><span class="o">.</span><span class="n">getStyle1</span><span class="p">()</span>

      <span class="k">if</span> <span class="n">web_obj</span><span class="o">.</span><span class="n">getHtml0</span><span class="p">()</span><span class="o">!=</span><span class="s">&quot; &quot;</span> <span class="p">:</span>
        <span class="n">html0</span><span class="o">=</span><span class="n">web_obj</span><span class="o">.</span><span class="n">getHtml0</span><span class="p">()</span>

      <span class="k">if</span> <span class="n">web_obj</span><span class="o">.</span><span class="n">getHtml1</span><span class="p">()</span><span class="o">!=</span><span class="s">&quot; &quot;</span> <span class="p">:</span>
        <span class="n">html1</span><span class="o">=</span><span class="n">web_obj</span><span class="o">.</span><span class="n">getHtml1</span><span class="p">()</span>

      <span class="k">if</span> <span class="n">web_obj</span><span class="o">.</span><span class="n">getCommand0</span><span class="p">()</span><span class="o">!=</span><span class="s">&quot; &quot;</span> <span class="p">:</span>
        <span class="n">command0</span><span class="o">=</span><span class="n">web_obj</span><span class="o">.</span><span class="n">getCommand0</span><span class="p">()</span>

      <span class="k">if</span> <span class="n">web_obj</span><span class="o">.</span><span class="n">getCommand1</span><span class="p">()</span><span class="o">!=</span><span class="s">&quot; &quot;</span> <span class="p">:</span>
        <span class="n">command1</span><span class="o">=</span><span class="n">web_obj</span><span class="o">.</span><span class="n">getCommand1</span><span class="p">()</span>

      <span class="k">if</span> <span class="n">web_obj</span><span class="o">.</span><span class="n">getInitCommand</span><span class="p">()</span><span class="o">!=</span><span class="s">&quot; &quot;</span> <span class="p">:</span>
        <span class="n">init_command</span><span class="o">=</span><span class="n">web_obj</span><span class="o">.</span><span class="n">getInitCommand</span><span class="p">()</span>


 
      <span class="k">try</span><span class="p">:</span>
        <span class="s">&quot;style=&quot;</span><span class="o">+</span><span class="n">style</span>
      <span class="k">except</span><span class="p">:</span>
        <span class="n">style</span><span class="o">=</span><span class="s">&quot; &quot;</span>

      <span class="c">#use the template and replace the parts ONOS+name parts  with the right parts from system</span>
      <span class="n">ModObjFormPage</span><span class="o">=</span><span class="n">ModObjFormPage</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&quot;+ONOSstyle+&quot;</span><span class="p">,</span><span class="n">style</span><span class="p">);</span>
      <span class="n">ModObjFormPage</span><span class="o">=</span><span class="n">ModObjFormPage</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&quot;ONOSself.path+&quot;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">);</span>
      <span class="n">ModObjFormPage</span><span class="o">=</span><span class="n">ModObjFormPage</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&quot;+ONOSname+&quot;</span><span class="p">,</span><span class="n">name</span><span class="p">);</span>
      <span class="n">ModObjFormPage</span><span class="o">=</span><span class="n">ModObjFormPage</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&quot;+ONOSnotes+&quot;</span><span class="p">,</span><span class="n">notes</span><span class="p">);</span>
      <span class="n">ModObjFormPage</span><span class="o">=</span><span class="n">ModObjFormPage</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&quot;+ONOSpin+&quot;</span><span class="p">,</span><span class="n">hardwarePin</span><span class="p">);</span>
      <span class="n">ModObjFormPage</span><span class="o">=</span><span class="n">ModObjFormPage</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&quot;+ONOStype_b+&quot;</span><span class="p">,</span><span class="n">type_b</span><span class="p">);</span>
      <span class="n">ModObjFormPage</span><span class="o">=</span><span class="n">ModObjFormPage</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&quot;+ONOStype_sb+&quot;</span><span class="p">,</span><span class="n">type_sb</span><span class="p">);</span>
      <span class="n">ModObjFormPage</span><span class="o">=</span><span class="n">ModObjFormPage</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&quot;+ONOStype_l+&quot;</span><span class="p">,</span><span class="n">type_l</span><span class="p">);</span>
      <span class="n">ModObjFormPage</span><span class="o">=</span><span class="n">ModObjFormPage</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&quot;+ONOStype_d_sensor+&quot;</span><span class="p">,</span><span class="n">type_d_sensor</span><span class="p">);</span>
      <span class="n">ModObjFormPage</span><span class="o">=</span><span class="n">ModObjFormPage</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&quot;+ONOStype_a_sensor+&quot;</span><span class="p">,</span><span class="n">type_a_sensor</span><span class="p">);</span>
      <span class="n">ModObjFormPage</span><span class="o">=</span><span class="n">ModObjFormPage</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&quot;+ONOScurrent_status0+&quot;</span><span class="p">,</span><span class="n">current_status0</span><span class="p">);</span>
      <span class="n">ModObjFormPage</span><span class="o">=</span><span class="n">ModObjFormPage</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&quot;+ONOScurrent_status1+&quot;</span><span class="p">,</span><span class="n">current_status1</span><span class="p">);</span>
      <span class="n">ModObjFormPage</span><span class="o">=</span><span class="n">ModObjFormPage</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&quot;+ONOSstatus_link+&quot;</span><span class="p">,</span><span class="n">status_link</span><span class="p">);</span>
      <span class="n">ModObjFormPage</span><span class="o">=</span><span class="n">ModObjFormPage</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&quot;+ONOShtml_obj+&quot;</span><span class="p">,</span><span class="n">html_obj</span><span class="p">);</span>
      <span class="n">ModObjFormPage</span><span class="o">=</span><span class="n">ModObjFormPage</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&quot;+ONOSstyle0+&quot;</span><span class="p">,</span><span class="n">style0</span><span class="p">);</span>
      <span class="n">ModObjFormPage</span><span class="o">=</span><span class="n">ModObjFormPage</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&quot;+ONOSstyle1+&quot;</span><span class="p">,</span><span class="n">style1</span><span class="p">);</span>
      <span class="n">ModObjFormPage</span><span class="o">=</span><span class="n">ModObjFormPage</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&quot;+ONOShtml0+&quot;</span><span class="p">,</span><span class="n">html0</span><span class="p">);</span>
      <span class="n">ModObjFormPage</span><span class="o">=</span><span class="n">ModObjFormPage</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&quot;+ONOShtml1+&quot;</span><span class="p">,</span><span class="n">html1</span><span class="p">);</span>
      <span class="n">ModObjFormPage</span><span class="o">=</span><span class="n">ModObjFormPage</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&quot;+ONOScommand0+&quot;</span><span class="p">,</span><span class="n">command0</span><span class="p">);</span>
      <span class="n">ModObjFormPage</span><span class="o">=</span><span class="n">ModObjFormPage</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&quot;+ONOScommand1+&quot;</span><span class="p">,</span><span class="n">command1</span><span class="p">);</span>
      <span class="n">ModObjFormPage</span><span class="o">=</span><span class="n">ModObjFormPage</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&quot;+ONOSinit_command+&quot;</span><span class="p">,</span><span class="n">init_command</span><span class="p">);</span>



     <span class="c"># pag=&#39;&lt;html&gt;&lt;head&gt;&lt;style type=&quot;text/css&quot;&gt;.text{font-size:110%} .title{color: red;font-size:120%}&#39;+style+&#39;&lt;/style&gt;&lt;/head&gt;&lt;body&gt;&lt;form action=&quot;&quot; method=&quot;POST&quot;&gt;&lt;input type=&quot;hidden&quot; name=&quot;mod_object&quot; value=&quot;&#39;+self.path+&#39;&quot;&gt;&lt;table border=&quot;1&quot; style=&quot;width:100%&quot;&gt;&lt;tr&gt;&lt;td&gt;&lt;div class=&quot;title&quot;&gt; Web Object Name: &lt;/div&gt;&lt;br/&gt;&lt;input type=&quot;text&quot; name=&quot;obj_name&quot;  value=&quot;&#39;+name+&#39;&quot;  size=&quot;50&quot; style=&quot;width:100%&quot;&gt;&lt;br/&gt;&lt;br/&gt;&lt;/td&gt;&lt;td&gt;&lt;div class=&quot;title&quot;&gt;Web Object Notes: &lt;/div&gt;&lt;br/&gt;&lt;input type=&quot;text&quot; name=&quot;obj_notes&quot;  value=&quot;&#39;+notes+&#39;&quot;  size=&quot;50&quot;  style=&quot;width:100%&quot;&gt;&lt;br/&gt;&lt;br/&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;&lt;div class=&quot;title&quot;&gt; Web Object Type &lt;/div&gt;&lt;ul&gt;&lt;input type=&quot;radio&quot; name=&quot;obj_type&quot; value=&quot;b&quot; &#39;+type_b+&#39;&gt;Normal Button&lt;/ul&gt;&lt;ul&gt;&lt;input type=&quot;radio&quot; name=&quot;obj_type&quot; value=&quot;sb&quot; &#39;+type_sb+&#39;&gt;Static Button&lt;/ul&gt;&lt;ul&gt;&lt;input type=&quot;radio&quot; name=&quot;obj_type&quot;value=&quot;l&quot; &#39;+type_l+&#39; &gt;Web Label&lt;/ul&gt;&lt;br/&gt;&lt;br/&gt;&lt;br/&gt;&lt;/td&gt;&lt;td&gt;&lt;div class=&quot;title&quot;&gt; Web Object Current Status &lt;/div&gt;&lt;ul&gt;&lt;input type=&quot;radio&quot; name=&quot;obj_current_status&quot; value=&quot;0&quot; &#39;+current_status0+&#39;  &gt;0&lt;/ul&gt;&lt;ul&gt;&lt;input type=&quot;radio&quot; name=&quot;obj_current_status&quot; value=&quot;1&quot; &#39;+current_status1+&#39; &gt;1&lt;/ul&gt;&lt;br/&gt; &lt;a id=&quot;&#39;+name+&#39;&quot;  href=&quot;/?&#39;+name+&#39;=&#39;+status_link+&#39;&quot;&gt;&#39;+html_obj+&#39;&lt;/a&gt; &lt;br/&gt;&lt;xmp &gt;&lt;a id=&quot;&#39;+name+&#39;&quot;  href=&quot;/?&#39;+name+&#39;=&#39;+status_link+&#39;&quot;&gt;&#39;+html_obj+&#39;&lt;/a&gt;&lt;/xmp &gt;  &lt;br/&gt;&lt;/td&gt;&lt;/tr&gt;&lt;br/&gt;&lt;tr&gt;&lt;td class=&quot;title&quot;&gt;First Web Object Style &amp;nbsp;&lt;/td&gt;&lt;td class=&quot;title&quot;&gt;Second Web Object Style&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;  &lt;textarea name=&quot;obj_style0&quot; cols=1 rows=15 style=&quot;width:100%&quot; &gt;&#39;+style0+&#39;&lt;/textarea&gt;&lt;/td&gt; &lt;td&gt;    &lt;textarea name=&quot;obj_style1&quot; cols=1 rows=15 style=&quot;width:100%&quot;&gt;&#39;+style1+&#39;&lt;/textarea&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt; &lt;div class=&quot;title&quot;&gt;First Web Object Html &lt;/div&gt; Html displayed on web page when the web object status is 0&lt;/td&gt;&lt;td&gt;&lt;div class=&quot;title&quot;&gt;Second Web Object Html&lt;/div&gt;Html displayed on web page when the web object status is 1&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt; &lt;textarea name=&quot;obj_html0&quot; cols=1 rows=15 style=&quot;width:100%&quot;&gt;&#39;+html0+&#39;&lt;/textarea&gt;&lt;/td&gt; &lt;td&gt;    &lt;textarea name=&quot;obj_html1&quot; cols=1 rows=15 style=&quot;width:100%&quot;&gt;&#39;+html1+&#39;&lt;/textarea&gt;&lt;/td&gt; &lt;/tr&gt;&lt;tr&gt; &lt;td&gt;&lt;div class=&quot;title&quot;&gt;First Web Object Command&lt;/div&gt;Bash command executed when the web object status changes from 1 to 0 &lt;/td&gt;&lt;td&gt;&lt;div class=&quot;title&quot;&gt;Second Web Object Command&lt;/div&gt;Bash command executed when the web object status changes from 0 to 1 &lt;/td&gt; &lt;/tr&gt;&lt;tr&gt; &lt;td&gt; &lt;textarea name=&quot;obj_cmd0&quot; cols=1 rows=5 style=&quot;width:100%&quot;&gt;&#39;+command0+&#39;&lt;/textarea&gt;&lt;/td&gt; &lt;td&gt;    &lt;textarea name=&quot;obj_cmd1&quot; cols=1 rows=5 style=&quot;width:100%&quot;&gt;&#39;+command1+&#39;&lt;/textarea&gt;&lt;/td&gt; &lt;/tr&gt;&lt;tr&gt;&lt;table border=&quot;1&quot; style=&quot;width:100%&quot;&gt;&lt;tr&gt;&lt;td style=&quot;width:15%&quot; &gt;&lt;div class=&quot;title&quot; &gt; Web Object Init Command&lt;/div&gt;Command executed once only when you start the webserver&lt;/td&gt; &lt;td&gt;    &lt;textarea name=&quot;obj_init_cmd&quot; cols=1 rows=5 style=&quot;width:100%&quot;&gt;&#39;+init_command+&#39;&lt;/textarea&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/div&gt;&lt;br/&gt;&lt;br/&gt;&lt;br/&gt; &lt;input type=&quot;submit&quot; value=&quot;Submit&quot;&gt;&lt;input type=&quot;reset&quot; value=&quot;Reset&quot;&gt;&lt;/form&gt;&lt;/body&gt;&lt;/html&gt;&#39;</span>


      <span class="k">return</span><span class="p">(</span><span class="n">ModObjFormPage</span><span class="p">)</span>








  


 

    <span class="k">def</span> <span class="nf">do_GET</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></div>
<div class="viewcode-block" id="MyHandler.do_GET"><a class="viewcode-back" href="../webserver.html#webserver.MyHandler.do_GET">[docs]</a>
        <span class="k">try</span><span class="p">:</span>


            <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="o">==</span><span class="s">&quot;/&quot;</span><span class="p">):</span>
              <span class="c">#print &quot;rrrrrrrrrrrrrrrrrrrrrooooooooooooooooooooooot&quot;</span>
              <span class="n">namespace</span><span class="o">=</span><span class="p">{}</span>
              <span class="n">cgi_name</span><span class="o">=</span><span class="s">&quot;gui/play.py&quot;</span>       
              <span class="nb">execfile</span><span class="p">(</span><span class="n">cgi_name</span><span class="p">,</span><span class="nb">globals</span><span class="p">(),</span><span class="n">namespace</span><span class="p">)</span>
              <span class="n">web_page</span><span class="o">=</span><span class="n">namespace</span><span class="p">[</span><span class="s">&quot;web_page&quot;</span><span class="p">]</span>


              <span class="k">try</span><span class="p">:</span>     
                <span class="k">print</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span>      
                <span class="c">#h = open(&quot;index.html&quot;,&#39;r&#39;)  </span>
                <span class="c">#web_page=h.read()</span>
                <span class="c">#h.close()</span>

              <span class="k">except</span><span class="p">:</span>
                <span class="k">print</span> <span class="s">&quot;no index.html found in root directory&quot;</span>
                <span class="n">web_page</span><span class="o">=</span><span class="n">web_page_not_found</span>   
              <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">send_response</span><span class="p">(</span><span class="mi">200</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">send_header</span><span class="p">(</span><span class="s">&#39;Content-type&#39;</span><span class="p">,</span>	<span class="s">&#39;text/html&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">end_headers</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">wfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">web_page</span><span class="p">)</span> 
              <span class="k">except</span><span class="p">:</span>
                <span class="k">print</span> <span class="s">&quot;error2 in send_header &quot;</span>
                <span class="n">errorQueue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span> <span class="s">&quot;error2 in send_header &quot;</span><span class="p">)</span>  
              <span class="k">return</span>
            

             
            <span class="k">if</span> <span class="p">(</span>     <span class="p">(</span><span class="n">string</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">,</span><span class="s">&quot;info_hash=&quot;</span><span class="p">)</span><span class="o">!=-</span><span class="mi">1</span><span class="p">)):</span>  <span class="c"># if the address contain info_hash= then discard it </span>
              <span class="k">print</span> <span class="s">&quot;address discarded &quot;</span>
              <span class="k">return</span>


            <span class="k">if</span> <span class="p">(</span>     <span class="p">(</span><span class="n">string</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">,</span><span class="s">&quot;onos_cmd&quot;</span><span class="p">)</span><span class="o">!=-</span><span class="mi">1</span><span class="p">)):</span>  <span class="c"># if the url contain onos_cmd then parse it </span>

<span class="c">#example1:</span>
<span class="c">#localhost/onos_cmd?cmd=setSts&amp;obj=sensor1&amp;status=1&amp;hw=0__  this change only the webobject,use it to change sensor value..</span>
<span class="c">#example2:</span>
<span class="c">#localhost/onos_cmd?cmd=setSts&amp;obj=sensor1&amp;status=1&amp;hw=1__  this change both , the webobject and the hardware status</span>
<span class="c">#   </span>
<span class="c">#</span>
              <span class="n">url</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span>
              <span class="k">print</span> <span class="s">&quot;onos_cmd received&quot;</span>
              <span class="k">print</span> <span class="n">url</span>
              <span class="c">#example: /onos_cmd?cmd=setSts&amp;obj=sensor1&amp;status=1&amp;hw=0__</span>
              <span class="k">if</span> <span class="n">string</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">url</span><span class="p">,</span><span class="s">&quot;cmd=setSts&amp;obj=&quot;</span><span class="p">)</span><span class="o">!=-</span><span class="mi">1</span><span class="p">:</span>
                <span class="n">msg</span><span class="o">=</span><span class="s">&quot;ok&quot;</span>
                <span class="c">#start_obj_name=string.find(url,&#39;obj=&#39;)+4</span>
                <span class="c">#end_obj_name=string.find(url,&#39;&amp;&#39;,start_obj_name)</span>
                <span class="c">#webobjName=url[start_obj_name:end_obj_name]</span>


                <span class="k">try</span><span class="p">:</span>
                  <span class="n">objName</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s">&#39;setSts&amp;obj=(.+?)&amp;&#39;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">)</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
             
                <span class="c">#start_status=string.find(url,&#39;&amp;status=&#39;)+8</span>
                <span class="c">#end_status=string.find(url,&#39;&amp;&#39;,start_status)</span>
                <span class="c">#status_to_set=url[start_status:end_status]</span>
                  <span class="n">status_to_set</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s">&#39;&amp;status=(.+?)&amp;&#39;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">)</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

                <span class="c">#start_hw_flag=string.find(url,&#39;&amp;hw=&#39;)+4</span>
                <span class="c">#end_hw_flag=string.find(url,&#39;__&#39;,start_hw_flag)</span>
                <span class="c">#hw_flag=url[start_hw_flag:end_hw_flag]</span>
                  <span class="n">hw_flag</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s">&#39;&amp;hw=(.+?)__&#39;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">)</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>


                <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span> 

                  <span class="k">print</span> <span class="s">&quot;error in re.search 1   on onos_cmd url  &quot;</span><span class="o">+</span><span class="n">url</span><span class="o">+</span><span class="s">&quot; e:&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">)</span>
                  <span class="n">errorQueue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="s">&quot;error in re.search 1   on onos_cmd url  &quot;</span><span class="o">+</span><span class="n">url</span><span class="o">+</span><span class="s">&quot; e:&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">))</span>  





                <span class="k">try</span><span class="p">:</span>
                  <span class="n">write_hw_enable</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">hw_flag</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span> 
                  <span class="k">print</span> <span class="s">&quot;error in write_hw_enable  on onos_cmd url  &quot;</span><span class="o">+</span><span class="s">&quot; e:&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">)</span>
                  <span class="n">errorQueue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span> <span class="s">&quot;error in write_hw_enable  on onos_cmd url  &quot;</span><span class="o">+</span><span class="s">&quot; e:&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">))</span>  
                  <span class="n">write_hw_enable</span><span class="o">=</span><span class="mi">1</span>

                <span class="k">print</span> <span class="s">&quot;------set &quot;</span><span class="o">+</span><span class="n">objName</span><span class="o">+</span><span class="s">&quot;to&quot;</span><span class="o">+</span><span class="n">status_to_set</span>
                  
                <span class="c">#if objName in object_dict.keys():</span>
                <span class="c">#try:</span>
                  <span class="c">#changeWebObjectStatus(objName,int (status_to_set),write_hw_enable) </span>
                <span class="n">layerExchangeDataQueue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span> <span class="p">{</span><span class="s">&quot;cmd&quot;</span><span class="p">:</span><span class="s">&quot;setSts&quot;</span><span class="p">,</span><span class="s">&quot;webObjectName&quot;</span><span class="p">:</span><span class="n">objName</span><span class="p">,</span><span class="s">&quot;status_to_set&quot;</span><span class="p">:</span><span class="n">status_to_set</span><span class="p">,</span><span class="s">&quot;write_to_hw&quot;</span><span class="p">:</span><span class="n">write_hw_enable</span> <span class="p">})</span>  
                
                <span class="c">#except:</span>
                <span class="c">#  print &quot;error objName not in the dict &quot;</span>
                <span class="c">#  errorQueue.put(&quot;error objName not in the dict &quot; )  </span>
                <span class="c">#  msg=&quot;error objName not in the dict &quot; </span>

                <span class="c">#banana to add also the status check </span>
                <span class="k">try</span><span class="p">:</span>
                  <span class="bp">self</span><span class="o">.</span><span class="n">send_response</span><span class="p">(</span><span class="mi">200</span><span class="p">)</span>
                  <span class="bp">self</span><span class="o">.</span><span class="n">send_header</span><span class="p">(</span><span class="s">&#39;Content-type&#39;</span><span class="p">,</span>	<span class="s">&#39;text/html&#39;</span><span class="p">)</span>
                  <span class="bp">self</span><span class="o">.</span><span class="n">end_headers</span><span class="p">()</span>
                  <span class="bp">self</span><span class="o">.</span><span class="n">wfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span> 
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">e</span>  <span class="p">:</span>
                  <span class="k">pass</span>
                  <span class="k">print</span> <span class="s">&quot;error3 in send_header &quot;</span><span class="o">+</span><span class="s">&quot; e:&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">)</span>
                  <span class="n">errorQueue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span> <span class="s">&quot;error3 in send_header &quot;</span><span class="o">+</span><span class="s">&quot; e:&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">))</span>  
                <span class="k">return</span>





<span class="c">#  localhost/onos_cmd?cmd=setNodePin&amp;nodeSn=Plug6way0001&amp;pin=8&amp;status=0&amp;hw=0__ </span>
<span class="c">#to set only the status of webobjects that are enclosed in this node and use this pin (without writing to the hardware)</span>

<span class="c">#  localhost/onos_cmd?cmd=setNodePin&amp;nodeSn=Plug6way0001&amp;pin=8&amp;status=0&amp;hw=1__ </span>
<span class="c">#to set only the status of webobjects that are enclosed in this node and use this pin (writing to the hardware)</span>
<span class="c">#the webobject status will change only if the write to hardware is succesfull</span>


<span class="c">#  localhost/onos_cmd?cmd=setNodePin&amp;node_sn=RouterGL0001&amp;pin=22&amp;status=1&amp;hw=0__</span>

               <span class="c"># webobjName=re.search(&#39;setSts&amp;obj=(.+?)&amp;&#39;,self.path).group(1)</span>
              <span class="k">if</span> <span class="n">string</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">,</span><span class="s">&quot;onos_cmd?cmd=setNodePin&amp;&quot;</span><span class="p">)</span><span class="o">!=-</span><span class="mi">1</span><span class="p">:</span>
                <span class="k">print</span> <span class="s">&quot;received a onos_cmd?cmd=setNodePin  query&quot;</span>
                <span class="c">#start_node_sn=string.find(url,&#39;node_sn=&#39;)+8</span>
                <span class="c">#end_node_sn=string.find(url,&#39;&amp;&#39;,start_node_sn)</span>
                <span class="c">#node_sn=url[start_node_sn:end_node_sn]</span>
                <span class="n">node_sn</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s">&#39;&amp;node_sn=(.+?)&amp;&#39;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">)</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

                <span class="k">print</span> <span class="s">&quot;node_sn=&quot;</span><span class="o">+</span><span class="n">node_sn</span>             
                <span class="c">#pin_number_start=string.find(url,&#39;&amp;pin=&#39;)+5</span>
                <span class="c">#pin_number_end=string.find(url,&#39;&amp;&#39;,pin_number_start)</span>
                <span class="c">#pin_number=url[pin_number_start:pin_number_end]</span>
                <span class="n">pin_number</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s">&#39;&amp;pin=(.+?)&amp;&#39;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">)</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                <span class="k">print</span> <span class="s">&quot;pin_number=&quot;</span><span class="o">+</span><span class="n">pin_number</span>
                <span class="c">#pin_status_start=string.find(url,&#39;&amp;status=&#39;)+8</span>
                <span class="c">#pin_status_end=string.find(url,&#39;&amp;&#39;,pin_status_start)</span>
                <span class="c">#pin_status=url[pin_status_start:pin_status_end]</span>
                <span class="n">pin_status</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s">&#39;&amp;status=(.+?)&amp;&#39;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">)</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                <span class="k">print</span> <span class="s">&quot;pin_status=&quot;</span><span class="o">+</span><span class="n">pin_status</span>
                <span class="c">#start_hw_flag=string.find(url,&#39;&amp;hw=&#39;)+4</span>
                <span class="c">#end_hw_flag=string.find(url,&#39;__&#39;)</span>
                <span class="c">#hw_flag=url[start_hw_flag:end_hw_flag]</span>
                <span class="n">hw_flag</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s">&#39;&amp;hw=(.+?)__&#39;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">)</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

                <span class="k">print</span> <span class="s">&quot;hw_flag=&quot;</span><span class="o">+</span><span class="n">hw_flag</span>
                <span class="k">try</span><span class="p">:</span>
                  <span class="n">write_hw_enable</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">hw_flag</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">e</span>  <span class="p">:</span>
                  <span class="k">print</span> <span class="s">&quot;error in write_hw_enable  on onos_cmd url  &quot;</span><span class="o">+</span><span class="s">&quot; e:&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">)</span>
                  <span class="n">errorQueue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="s">&quot;error in write_hw_enable  on onos_cmd url  &quot;</span><span class="o">+</span><span class="s">&quot; e:&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">)</span> <span class="p">)</span>  
                  <span class="n">write_hw_enable</span><span class="o">=</span><span class="mi">1</span>                
<span class="c">#now i have to check in all the web obj which one is connected to the pin of this node</span>


                <span class="n">answer</span><span class="o">=</span><span class="n">setNodePin</span><span class="p">(</span><span class="n">node_sn</span><span class="p">,</span><span class="n">pin_number</span><span class="p">,</span><span class="n">pin_status</span><span class="p">,</span><span class="n">write_hw_enable</span><span class="p">)</span>
                

                <span class="k">try</span><span class="p">:</span>
                  <span class="bp">self</span><span class="o">.</span><span class="n">send_response</span><span class="p">(</span><span class="mi">200</span><span class="p">)</span>
                  <span class="bp">self</span><span class="o">.</span><span class="n">send_header</span><span class="p">(</span><span class="s">&#39;Content-type&#39;</span><span class="p">,</span>	<span class="s">&#39;text/html&#39;</span><span class="p">)</span>
                  <span class="bp">self</span><span class="o">.</span><span class="n">end_headers</span><span class="p">()</span>
                  <span class="bp">self</span><span class="o">.</span><span class="n">wfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">answer</span><span class="p">)</span> 
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">e</span>  <span class="p">:</span>
                  <span class="k">print</span> <span class="s">&quot;error4 in send_header &quot;</span><span class="o">+</span><span class="s">&quot; e:&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">)</span>
                  <span class="n">errorQueue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span> <span class="s">&quot;error4 in send_header &quot;</span><span class="o">+</span><span class="s">&quot; e:&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">))</span>  
                <span class="k">return</span>





<span class="c">#  localhost//onos_cmd?cmd=setNodeDReg&amp;node_sn=RouterGL0001&amp;reg=xxxxxxxxxxxxxx__</span>

<span class="c">#banana to implement ?</span>

              <span class="k">if</span> <span class="n">string</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">url</span><span class="p">,</span><span class="s">&quot;onos_cmd?cmd=setNodeDReg&amp;&quot;</span><span class="p">)</span><span class="o">!=-</span><span class="mi">1</span><span class="p">:</span>
                <span class="k">print</span> <span class="s">&quot;received a onos_cmd?cmd=setNodeDReg  query&quot;</span>
                <span class="n">start_node_sn</span><span class="o">=</span><span class="n">string</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">url</span><span class="p">,</span><span class="s">&#39;node_sn=&#39;</span><span class="p">)</span><span class="o">+</span><span class="mi">8</span>
                <span class="n">end_node_sn</span><span class="o">=</span><span class="n">string</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">url</span><span class="p">,</span><span class="s">&#39;&amp;&#39;</span><span class="p">,</span><span class="n">start_node_sn</span><span class="p">)</span>
                <span class="n">node_sn</span><span class="o">=</span><span class="n">url</span><span class="p">[</span><span class="n">start_node_sn</span><span class="p">:</span><span class="n">end_node_sn</span><span class="p">]</span>
                <span class="k">print</span> <span class="s">&quot;node_sn=&quot;</span><span class="o">+</span><span class="n">node_sn</span>             
                <span class="n">data_reg_start</span><span class="o">=</span><span class="n">string</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">url</span><span class="p">,</span><span class="s">&#39;&amp;pin=&#39;</span><span class="p">)</span><span class="o">+</span><span class="mi">5</span>
                <span class="n">data_reg_end</span><span class="o">=</span><span class="n">string</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">url</span><span class="p">,</span><span class="s">&#39;__&#39;</span><span class="p">,</span><span class="n">data_reg_start</span><span class="p">)</span>
                <span class="n">data_reg</span><span class="o">=</span><span class="n">url</span><span class="p">[</span><span class="n">data_reg_start</span><span class="p">:</span><span class="n">data_reg_end</span><span class="p">]</span>
                <span class="k">print</span> <span class="s">&quot;data reg received=&quot;</span><span class="o">+</span><span class="n">data_reg</span>
                <span class="k">print</span> <span class="s">&quot;len data recived=&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data_reg</span><span class="p">))</span>
          
<span class="c">#now i have to check in all the web obj which one is connected to the pin of this node</span>
<span class="c">#banana not working here?</span>
                <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">object_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                  <span class="k">print</span> <span class="n">object_dict</span><span class="p">[</span><span class="n">a</span><span class="p">]</span><span class="o">.</span><span class="n">getHwNodeSerialNumber</span><span class="p">()</span>
                  <span class="k">if</span> <span class="p">(</span><span class="n">object_dict</span><span class="p">[</span><span class="n">a</span><span class="p">]</span><span class="o">.</span><span class="n">getHwNodeSerialNumber</span><span class="p">()</span><span class="o">==</span><span class="n">node_sn</span><span class="p">):</span>

                    <span class="k">print</span> <span class="s">&quot;node exist&quot;</span>
                    <span class="c">#banana to implement a decoding mode to get all pin status from the data received</span>


                <span class="k">try</span><span class="p">:</span>
                  <span class="bp">self</span><span class="o">.</span><span class="n">send_response</span><span class="p">(</span><span class="mi">200</span><span class="p">)</span>
                  <span class="bp">self</span><span class="o">.</span><span class="n">send_header</span><span class="p">(</span><span class="s">&#39;Content-type&#39;</span><span class="p">,</span>	<span class="s">&#39;text/html&#39;</span><span class="p">)</span>
                  <span class="bp">self</span><span class="o">.</span><span class="n">end_headers</span><span class="p">()</span>
                  <span class="bp">self</span><span class="o">.</span><span class="n">wfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;ok&quot;</span><span class="p">)</span> 
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">e</span>  <span class="p">:</span>
                  <span class="k">pass</span>
                  <span class="k">print</span> <span class="s">&quot;error5 in send_header &quot;</span><span class="o">+</span><span class="s">&quot; e:&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">)</span>
                  <span class="n">errorQueue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span> <span class="s">&quot;error5 in send_header &quot;</span><span class="o">+</span><span class="s">&quot; e:&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">))</span>  
                <span class="k">return</span>



<span class="c">#write here the msg get setup__</span>
<span class="c">#example: </span>
<span class="c">#localhost/onos_cmd?cmd=pinsetup&amp;node_sn=Plug6way0001&amp;node_fw=4.85__</span>
<span class="c">#localhost/onos_cmd?cmd=pinsetup&amp;node_sn=Plug6way0002&amp;node_fw=4.85__</span>
<span class="c">#localhost/onos_cmd?cmd=pinsetup&amp;node_sn=ProminiA0001&amp;node_fw=4.85__</span>
<span class="c">#localhost/onos_cmd?cmd=pinsetup&amp;node_sn=ProminiA0002&amp;node_fw=4.85__</span>


              <span class="c">#OBSOLETE!!! </span>

              <span class="k">if</span> <span class="n">string</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">url</span><span class="p">,</span><span class="s">&quot;onos_cmd?cmd=pinsetup&amp;&quot;</span><span class="p">)</span><span class="o">!=-</span><span class="mi">1</span><span class="p">:</span>
                <span class="k">print</span> <span class="s">&quot;received a onos_cmd?cmd=pinsetup  query&quot;</span>
                <span class="c">#start_node_sn=string.find(url,&#39;node_sn=&#39;)+8</span>
                <span class="c">#end_node_sn=string.find(url,&#39;&amp;&#39;,start_node_sn)</span>
                <span class="c">#node_sn=url[start_node_sn:end_node_sn]</span>
                <span class="n">node_sn</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s">&#39;&amp;node_sn=(.+?)&amp;&#39;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">)</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                <span class="k">print</span> <span class="s">&quot;node_sn=&quot;</span><span class="o">+</span><span class="n">node_sn</span>

                <span class="c">#start_node_fw=string.find(url,&#39;node_fw=&#39;)+8</span>
                <span class="c">#end_node_fw=string.find(url,&#39;&amp;&#39;,start_node_fw)</span>
                <span class="c">#node_fw=url[start_node_fw:end_node_fw]</span>
                <span class="n">node_fw</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s">&#39;&amp;node_fw=(.+?)__&#39;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">)</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                <span class="k">print</span> <span class="s">&quot;node_fw=&quot;</span><span class="o">+</span><span class="n">node_fw</span>
                 
               <span class="c"># start_node_ip=string.find(url,&#39;node_ip=&#39;)+8</span>
               <span class="c"># end_node_ip=string.find(url,&#39;__&#39;,start_node_ip)</span>
                <span class="c">#node_ip=url[start_node_ip:end_node_ip]</span>
                <span class="n">node_ip</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">client_address</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="k">print</span> <span class="s">&quot;node_ip=&quot;</span><span class="o">+</span><span class="n">node_ip</span>

                <span class="n">msg</span><span class="o">=</span><span class="s">&quot;ok&quot;</span>
                <span class="n">msg</span><span class="o">=</span><span class="n">createNewNode</span><span class="p">(</span><span class="n">node_sn</span><span class="p">,</span><span class="n">node_ip</span><span class="p">,</span><span class="n">node_fw</span><span class="p">)</span>

                <span class="k">print</span> <span class="s">&quot;i try to send msg: &quot;</span><span class="o">+</span><span class="n">msg</span>
                <span class="k">try</span><span class="p">:</span>
                  <span class="bp">self</span><span class="o">.</span><span class="n">send_response</span><span class="p">(</span><span class="mi">200</span><span class="p">)</span>
                  <span class="bp">self</span><span class="o">.</span><span class="n">send_header</span><span class="p">(</span><span class="s">&#39;Content-Type: application/octet-stream&#39;</span><span class="p">,</span><span class="s">&#39;text/plain&#39;</span><span class="p">)</span>
                  <span class="bp">self</span><span class="o">.</span><span class="n">end_headers</span><span class="p">()</span>
                  <span class="bp">self</span><span class="o">.</span><span class="n">wfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span> 
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">e</span>  <span class="p">:</span>
                  <span class="k">pass</span>
                  <span class="k">print</span> <span class="s">&quot;error6 in send_header onos cmd 001&quot;</span><span class="o">+</span><span class="s">&quot; e:&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">)</span>
                  <span class="n">errorQueue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span> <span class="s">&quot;error6 in send_header onos cmd 001&quot;</span><span class="o">+</span><span class="s">&quot; e:&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">))</span>  
                <span class="k">return</span>


<span class="c">#localhost/onos_cmd?cmd=sync&amp;node_sn=ProminiA0002&amp;node_fw=4.85__</span>

              <span class="k">if</span> <span class="n">string</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">url</span><span class="p">,</span><span class="s">&quot;onos_cmd?cmd=sync&amp;&quot;</span><span class="p">)</span><span class="o">!=-</span><span class="mi">1</span><span class="p">:</span>
                <span class="k">print</span> <span class="s">&quot;received a onos_cmd?cmd=sync  query&quot;</span>
                <span class="c">#start_node_sn=string.find(url,&#39;node_sn=&#39;)+8</span>
                <span class="c">#end_node_sn=string.find(url,&#39;&amp;&#39;,start_node_sn)</span>
                <span class="c">#node_sn=url[start_node_sn:end_node_sn]</span>
                <span class="n">node_sn</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s">&#39;&amp;node_sn=(.+?)&amp;&#39;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">)</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                <span class="k">print</span> <span class="s">&quot;node_sn=&quot;</span><span class="o">+</span><span class="n">node_sn</span>

                <span class="c">#start_node_fw=string.find(url,&#39;node_fw=&#39;)+8</span>
                <span class="c">#end_node_fw=string.find(url,&#39;&amp;&#39;,start_node_fw)</span>
                <span class="c">#node_fw=url[start_node_fw:end_node_fw]</span>
                <span class="n">node_fw</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s">&#39;&amp;node_fw=(.+?)__&#39;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">)</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                <span class="k">print</span> <span class="s">&quot;node_fw=&quot;</span><span class="o">+</span><span class="n">node_fw</span>
                 
               <span class="c"># start_node_ip=string.find(url,&#39;node_ip=&#39;)+8</span>
               <span class="c"># end_node_ip=string.find(url,&#39;__&#39;,start_node_ip)</span>
                <span class="c">#node_ip=url[start_node_ip:end_node_ip]</span>
                <span class="n">node_ip</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">client_address</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="k">print</span> <span class="s">&quot;node_ip=&quot;</span><span class="o">+</span><span class="n">node_ip</span>


                <span class="n">msg</span><span class="o">=</span><span class="n">createNewNode</span><span class="p">(</span><span class="n">node_sn</span><span class="p">,</span><span class="n">node_ip</span><span class="p">,</span><span class="n">node_fw</span><span class="p">)</span>
                <span class="n">msg</span><span class="o">=</span><span class="s">&quot;ok&quot;</span>
                <span class="k">print</span> <span class="s">&quot;i try to send msg: &quot;</span><span class="o">+</span><span class="n">msg</span>
                <span class="k">try</span><span class="p">:</span>
                  <span class="bp">self</span><span class="o">.</span><span class="n">send_response</span><span class="p">(</span><span class="mi">200</span><span class="p">)</span>
                  <span class="bp">self</span><span class="o">.</span><span class="n">send_header</span><span class="p">(</span><span class="s">&#39;Content-Type: application/octet-stream&#39;</span><span class="p">,</span><span class="s">&#39;text/plain&#39;</span><span class="p">)</span>
                  <span class="bp">self</span><span class="o">.</span><span class="n">end_headers</span><span class="p">()</span>
                  <span class="bp">self</span><span class="o">.</span><span class="n">wfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span> 
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">e</span>  <span class="p">:</span>
                  <span class="k">pass</span>
                  <span class="k">print</span> <span class="s">&quot;error7 in send_header onos cmd 001&quot;</span><span class="o">+</span><span class="s">&quot; e:&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">)</span>
                  <span class="n">errorQueue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="s">&quot;error7 in send_header onos cmd 001&quot;</span><span class="o">+</span><span class="s">&quot; e:&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">)</span> <span class="p">)</span>  
                <span class="k">return</span>


    <span class="c">#          try:</span>
    <span class="c">#            self.send_response(200)</span>
    <span class="c">#            self.send_header(&#39;Content-type&#39;,	&#39;text/html&#39;)</span>
    <span class="c">#            self.end_headers()</span>
    <span class="c">#            self.wfile.write(&quot;error_onos_cmd&quot;) </span>
    <span class="c">#          except:</span>
    <span class="c">#            pass</span>
    <span class="c">#            print &quot;error in send_header &quot;</span>
    <span class="c">#          return   </span>


            <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="o">==</span><span class="s">&quot;/login.html&quot;</span><span class="p">):</span>
              
              
              <span class="k">try</span><span class="p">:</span>             
                <span class="n">h</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s">&quot;login.html&quot;</span><span class="p">,</span><span class="s">&#39;r&#39;</span><span class="p">)</span>  
                <span class="n">web_page</span><span class="o">=</span><span class="n">h</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
                <span class="n">h</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
              <span class="k">except</span><span class="p">:</span>
                <span class="k">print</span> <span class="s">&quot;no login.html found in root directory&quot;</span>
                <span class="n">web_page</span><span class="o">=</span><span class="n">web_page_not_found</span>   


              <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">send_response</span><span class="p">(</span><span class="mi">200</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">send_header</span><span class="p">(</span><span class="s">&#39;Content-type&#39;</span><span class="p">,</span>	<span class="s">&#39;text/html&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">end_headers</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">wfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">web_page</span><span class="p">)</span> 
              <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">e</span>  <span class="p">:</span>
                <span class="k">pass</span>
                <span class="k">print</span> <span class="s">&quot;error8 in send_header &quot;</span><span class="o">+</span><span class="s">&quot; e:&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">)</span>
                <span class="n">errorQueue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="s">&quot;error8 in send_header &quot;</span><span class="o">+</span><span class="s">&quot; e:&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">)</span> <span class="p">)</span>  
              <span class="k">return</span>   



            


            <span class="k">if</span> <span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s">&quot;.jpg&quot;</span><span class="p">))</span><span class="o">|</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s">&quot;.gif&quot;</span><span class="p">))</span><span class="o">|</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s">&quot;.png&quot;</span><span class="p">))</span><span class="o">|</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s">&quot;.JPG&quot;</span><span class="p">))</span><span class="o">|</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s">&quot;.PNG&quot;</span><span class="p">))):</span>
                <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">curdir</span> <span class="o">+</span> <span class="n">sep</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">,</span><span class="s">&#39;rb&#39;</span><span class="p">)</span> <span class="c">#self.path has /test.html</span>
                <span class="n">photoFile</span><span class="o">=</span><span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
                <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>


<span class="c">#note that this potentially makes every file on your computer readable by the internet</span>
                

                <span class="k">try</span><span class="p">:</span>
                  <span class="bp">self</span><span class="o">.</span><span class="n">send_response</span><span class="p">(</span><span class="mi">200</span><span class="p">)</span>
                  <span class="bp">self</span><span class="o">.</span><span class="n">send_header</span><span class="p">(</span><span class="s">&#39;Content-type&#39;</span><span class="p">,</span>        <span class="s">&#39;image/png&#39;</span><span class="p">)</span>
                  <span class="bp">self</span><span class="o">.</span><span class="n">send_header</span><span class="p">(</span><span class="s">&#39;Cache-Control&#39;</span><span class="p">,</span>        <span class="s">&#39;max-age=31536000&#39;</span><span class="p">)</span>  <span class="c">#set the cache of the image to a long time to prevent background image flipping</span>
                  <span class="bp">self</span><span class="o">.</span><span class="n">end_headers</span><span class="p">()</span>
                  <span class="bp">self</span><span class="o">.</span><span class="n">wfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">photoFile</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">e</span>  <span class="p">:</span>
                  <span class="k">pass</span>
                  <span class="k">print</span> <span class="s">&quot;error in send_header img&quot;</span><span class="o">+</span><span class="s">&quot; e:&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">)</span>
                  <span class="n">errorQueue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span> <span class="s">&quot;error in send_header img&quot;</span><span class="o">+</span><span class="s">&quot; e:&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">))</span>  
                
                <span class="k">return</span>



            <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s">&quot;.css&quot;</span><span class="p">))</span><span class="o">|</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s">&quot;.CSS&quot;</span><span class="p">)):</span>
                <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">curdir</span> <span class="o">+</span> <span class="n">sep</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">,</span><span class="s">&#39;rb&#39;</span><span class="p">)</span> <span class="c">#self.path has /test.html</span>
                <span class="n">cssFile</span><span class="o">=</span><span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
                <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="c">#note that this potentially makes every file on your computer readable by the internet</span>
                
                <span class="k">try</span><span class="p">:</span>
                  <span class="bp">self</span><span class="o">.</span><span class="n">send_response</span><span class="p">(</span><span class="mi">200</span><span class="p">)</span>
                  <span class="bp">self</span><span class="o">.</span><span class="n">send_header</span><span class="p">(</span><span class="s">&#39;Content-type&#39;</span><span class="p">,</span>        <span class="s">&#39;text/css&#39;</span><span class="p">)</span>
                  <span class="bp">self</span><span class="o">.</span><span class="n">send_header</span><span class="p">(</span><span class="s">&#39;Cache-Control&#39;</span><span class="p">,</span>        <span class="s">&#39;max-age=1&#39;</span><span class="p">)</span>  <span class="c">#set the cache of the image to a long time to prevent background image flipping</span>
                  <span class="bp">self</span><span class="o">.</span><span class="n">end_headers</span><span class="p">()</span>
                  <span class="bp">self</span><span class="o">.</span><span class="n">wfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">cssFile</span><span class="p">)</span>
                  <span class="c">#print &quot;served a css file&quot;</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">e</span>  <span class="p">:</span>
                  <span class="k">pass</span>
                  <span class="k">print</span> <span class="s">&quot;error9a in send_header &quot;</span><span class="o">+</span><span class="s">&quot; e:&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">)</span>   
                  <span class="n">errorQueue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="s">&quot;error9a in send_header &quot;</span><span class="o">+</span><span class="s">&quot; e:&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">)</span>  <span class="p">)</span>               
                <span class="k">return</span>



            <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s">&quot;.ttf&quot;</span><span class="p">))</span><span class="o">|</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s">&quot;.TTF&quot;</span><span class="p">)):</span>
                <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">curdir</span> <span class="o">+</span> <span class="n">sep</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">,</span><span class="s">&#39;rb&#39;</span><span class="p">)</span> <span class="c">#self.path has /test.html</span>
                <span class="n">cssFile</span><span class="o">=</span><span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
                <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="c">#note that this potentially makes every file on your computer readable by the internet</span>
                
                <span class="k">try</span><span class="p">:</span>
                  <span class="bp">self</span><span class="o">.</span><span class="n">send_response</span><span class="p">(</span><span class="mi">200</span><span class="p">)</span>
                  <span class="bp">self</span><span class="o">.</span><span class="n">send_header</span><span class="p">(</span><span class="s">&#39;Content-type&#39;</span><span class="p">,</span>        <span class="s">&#39;text/ttf&#39;</span><span class="p">)</span>
                  <span class="bp">self</span><span class="o">.</span><span class="n">send_header</span><span class="p">(</span><span class="s">&#39;Cache-Control&#39;</span><span class="p">,</span>        <span class="s">&#39;max-age=1&#39;</span><span class="p">)</span>  <span class="c">#set the cache of the image to a long time to prevent background image flipping</span>
                  <span class="bp">self</span><span class="o">.</span><span class="n">end_headers</span><span class="p">()</span>
                  <span class="bp">self</span><span class="o">.</span><span class="n">wfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">cssFile</span><span class="p">)</span>
                  <span class="c">#print &quot;served a css file&quot;</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">e</span>  <span class="p">:</span>
                  <span class="k">pass</span>
                  <span class="k">print</span> <span class="s">&quot;error9b in send_header &quot;</span><span class="o">+</span><span class="s">&quot; e:&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">)</span>   
                  <span class="n">errorQueue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="s">&quot;error9b in send_header &quot;</span><span class="o">+</span><span class="s">&quot; e:&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">)</span>  <span class="p">)</span>               
                <span class="k">return</span>




            <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s">&quot;.js&quot;</span><span class="p">))</span><span class="o">|</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s">&quot;.JS&quot;</span><span class="p">)):</span>
                <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">curdir</span> <span class="o">+</span> <span class="n">sep</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">,</span><span class="s">&#39;rb&#39;</span><span class="p">)</span> <span class="c">#self.path has /test.html</span>
                <span class="n">javaFile</span><span class="o">=</span><span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
                <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="c">#note that this potentially makes every file on your computer readable by the internet</span>
                <span class="k">try</span><span class="p">:</span>
                  <span class="bp">self</span><span class="o">.</span><span class="n">send_response</span><span class="p">(</span><span class="mi">200</span><span class="p">)</span>
                  <span class="bp">self</span><span class="o">.</span><span class="n">send_header</span><span class="p">(</span><span class="s">&#39;Content-type&#39;</span><span class="p">,</span>        <span class="s">&#39;text/javascript&#39;</span><span class="p">)</span>
                  <span class="bp">self</span><span class="o">.</span><span class="n">send_header</span><span class="p">(</span><span class="s">&#39;Cache-Control&#39;</span><span class="p">,</span>        <span class="s">&#39;max-age=1&#39;</span><span class="p">)</span>  <span class="c">#set the cache of the image to a long time to prevent background image flipping</span>
                  <span class="bp">self</span><span class="o">.</span><span class="n">end_headers</span><span class="p">()</span>
                  <span class="bp">self</span><span class="o">.</span><span class="n">wfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">javaFile</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">e</span>  <span class="p">:</span>
                  <span class="k">pass</span>
                  <span class="k">print</span> <span class="s">&quot;error10 in send_header &quot;</span><span class="o">+</span><span class="s">&quot; e:&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">)</span>  
                  <span class="n">errorQueue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span> <span class="s">&quot;error10 in send_header &quot;</span><span class="o">+</span><span class="s">&quot; e:&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">)</span> <span class="p">)</span>    
                
                <span class="k">return</span>









            <span class="c">#from here to the end the login is required , the above part is for the onos node use.</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">login_required</span><span class="o">==</span><span class="mi">1</span><span class="p">):</span>
              <span class="n">current_username</span><span class="o">=</span><span class="n">getUserFromIp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">client_address</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

              <span class="k">if</span> <span class="p">(</span><span class="n">current_username</span><span class="o">==-</span><span class="mi">1</span><span class="p">)</span> <span class="p">:</span> <span class="c">#user not logged</span>
                <span class="k">print</span> <span class="s">&quot;user not logged ,i show login page&quot;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">get_login</span><span class="p">()</span>  <span class="c">#show login page</span>
                <span class="k">return</span><span class="p">()</span>






                
                



            <span class="k">if</span> <span class="p">(</span><span class="nb">len</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">)</span><span class="o">&lt;</span><span class="mi">2</span><span class="p">):</span>
              <span class="k">print</span> <span class="s">&quot;main address..&quot;</span>
                <span class="c">#print stato_led1</span>

              <span class="k">try</span><span class="p">:</span>   

                <span class="n">namespace</span><span class="o">=</span><span class="p">{}</span>   
                <span class="n">cgi_name</span><span class="o">=</span><span class="s">&quot;/gui/play.py&quot;</span>       
                <span class="nb">execfile</span><span class="p">(</span><span class="n">cgi_name</span><span class="p">,</span><span class="nb">globals</span><span class="p">(),</span><span class="n">namespace</span><span class="p">)</span>
                <span class="n">web_page</span><span class="o">=</span><span class="n">namespace</span><span class="p">[</span><span class="s">&quot;web_page&quot;</span><span class="p">]</span>

                <span class="c">#h = open(&quot;index.html&quot;,&#39;r&#39;)  </span>
                <span class="c">#web_page=h.read()</span>
                <span class="c">#h.close()</span>
              <span class="k">except</span><span class="p">:</span>
                <span class="k">print</span> <span class="s">&quot;no index.html found in root directory&quot;</span>
                <span class="n">web_page</span><span class="o">=</span><span class="n">web_page_not_found</span>  

              <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">send_response</span><span class="p">(</span><span class="mi">200</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">send_header</span><span class="p">(</span><span class="s">&#39;Content-type&#39;</span><span class="p">,</span>	<span class="s">&#39;text/html&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">end_headers</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">wfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">web_page</span><span class="p">)</span> 
                <span class="k">print</span> <span class="s">&quot;percorso=&quot;</span>
                <span class="k">print</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span>     
                <span class="k">print</span> <span class="s">&quot;fine percorso&quot;</span>

              <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">e</span>  <span class="p">:</span>
                <span class="k">pass</span>
                <span class="k">print</span> <span class="s">&quot;error11 in send_header &quot;</span><span class="o">+</span><span class="s">&quot; e:&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">)</span>
                <span class="n">errorQueue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span> <span class="s">&quot;error11 in send_header &quot;</span><span class="o">+</span><span class="s">&quot; e:&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">))</span>       
                
              <span class="k">return</span>


   
            
            <span class="k">if</span>  <span class="p">(</span> <span class="n">string</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">,</span><span class="s">&quot;zone_list&quot;</span><span class="p">))</span><span class="o">!=-</span><span class="mi">1</span><span class="p">:</span>
                <span class="c">#print &quot;indirizzo a pag principale..&quot;</span>
                <span class="c">#print stato_led1 </span>
                <span class="c">#address_list=string.split(self.path,&quot;/&quot;) </span>
                <span class="n">home</span><span class="o">=</span><span class="s">&#39;/&#39;</span>   <span class="c">#the home page of onos</span>
                <span class="c">#back=address_list[0]</span>
                <span class="n">html</span><span class="o">=</span><span class="s">&#39;&#39;&#39;&lt;!DOCTYPE html&gt;&lt;html&gt; &lt;head&gt;&lt;link rel=&quot;stylesheet&quot; href=&quot;/css/zone_list.css&quot; type=&quot;text/css&quot; media=&quot;all&quot; /&gt;&lt;meta http-equiv=&quot;Content-Type&quot; content=&quot;text/html; charset=utf-8&quot; /&gt;&lt;meta name=&quot;viewport&quot; content=&quot;width=device-width, initial-scale=1, maximum-scale=1&quot;&gt;    &lt;meta charset=&quot;utf-8&quot;&gt;    &lt;title&gt;O.N.O.S&lt;/title&gt;&lt;/head&gt;  &lt;body&gt;&lt;div id=&quot;buttons&quot;&gt; &lt;a  href=&quot;&#39;&#39;&#39;</span><span class="o">+</span><span class="n">home</span><span class="o">+</span><span class="s">&#39;&#39;&#39;&quot;&gt;&lt;div id=&quot;home&quot;&gt;HOME&lt;/div&gt;&lt;a  href=&quot;&#39;&#39;&#39;</span><span class="o">+</span><span class="n">home</span><span class="o">+</span><span class="s">&#39;&#39;&#39;&quot;&gt;&lt;div id=&quot;back&quot;&gt;BACK&lt;/div&gt;&lt;/div&gt;  &lt;div id=&quot;header&quot;&gt;ZONES&lt;/div&gt;&lt;div id=&quot;riga&quot;&gt;&#39;&#39;&#39;</span>
                <span class="n">end_html</span><span class="o">=</span><span class="s">&#39;&#39;&#39;&lt;/div&gt;&lt;/body&gt;&lt;/html&gt;&#39;&#39;&#39;</span> 

                <span class="n">l</span><span class="o">=</span><span class="p">[]</span>
                <span class="n">l</span><span class="o">=</span><span class="n">sortZonesByOrderNumber</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">l</span> <span class="p">:</span>             

                  <span class="k">if</span> <span class="p">(</span><span class="n">zoneDict</span><span class="p">[</span><span class="n">a</span><span class="p">][</span><span class="s">&quot;hidden&quot;</span><span class="p">]</span><span class="o">!=</span><span class="mi">0</span><span class="p">):</span>  <span class="c">#skip the hidden elements</span>
                    <span class="k">continue</span>     
                  <span class="c">#html=html+&#39;&lt;div&gt;&lt;a href=&quot;/&#39;+a+&#39;/index.html?=&quot;&gt;&#39;+a+&#39;&lt;/a&gt;&lt;/div&gt;&#39;</span>
                  <span class="n">html</span><span class="o">=</span><span class="n">html</span><span class="o">+</span><span class="s">&#39;&#39;&#39;&lt;a href=&quot;/&#39;&#39;&#39;</span><span class="o">+</span><span class="n">a</span><span class="o">+</span><span class="s">&#39;&#39;&#39;/index.html?=&quot;&gt;&lt;div id=&quot;zone&quot;&gt;&#39;&#39;&#39;</span><span class="o">+</span><span class="n">a</span><span class="o">+</span><span class="s">&#39;&#39;&#39;&lt;/div&gt;&lt;/a&gt;&#39;&#39;&#39;</span>
                  <span class="n">html</span><span class="o">=</span><span class="n">html</span><span class="o">+</span><span class="s">&#39;&#39;&#39;&lt;a href=&quot;/zone_objects_setup/&#39;&#39;&#39;</span><span class="o">+</span><span class="n">a</span><span class="o">+</span><span class="s">&#39;&#39;&#39;&quot;&gt;&lt;div id=&quot;setup&quot;&gt;    setup&lt;/div&gt;&lt;/a&gt;&#39;&#39;&#39;</span>

                <span class="n">html</span><span class="o">=</span><span class="n">html</span><span class="o">+</span><span class="s">&#39;&#39;&#39;&lt;div id=&quot;zone&quot; style=&quot; visibility: hidden;&quot;&gt;&lt;/div&gt;&lt;/a&gt;&#39;&#39;&#39;</span> <span class="c">#void elements to make space</span>
                <span class="n">html</span><span class="o">=</span><span class="n">html</span><span class="o">+</span><span class="s">&#39;&#39;&#39;&lt;div id=&quot;setup&quot; style=&quot; visibility: hidden;&quot;&gt;  &lt;/div&gt;&lt;/a&gt;&#39;&#39;&#39;</span><span class="c">#void elements to make space</span>
                

 
                <span class="n">pag</span><span class="o">=</span><span class="n">html</span><span class="o">+</span><span class="n">end_html</span>      <span class="c">#+&#39;&lt;a    href=&quot;/setup/&quot;&gt;Rooms Configuration  &lt;/a&gt;&lt;br/&gt;&#39;</span>


                <span class="k">try</span><span class="p">:</span>
                  <span class="bp">self</span><span class="o">.</span><span class="n">send_response</span><span class="p">(</span><span class="mi">200</span><span class="p">)</span>
                  <span class="bp">self</span><span class="o">.</span><span class="n">send_header</span><span class="p">(</span><span class="s">&#39;Content-type&#39;</span><span class="p">,</span>	<span class="s">&#39;text/html&#39;</span><span class="p">)</span>
                  <span class="bp">self</span><span class="o">.</span><span class="n">end_headers</span><span class="p">()</span>
                  <span class="bp">self</span><span class="o">.</span><span class="n">wfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">pag</span><span class="p">)</span> 
                  <span class="k">print</span> <span class="s">&quot;percorso=&quot;</span>
                  <span class="k">print</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span>     
                  <span class="k">print</span> <span class="s">&quot;fine percorso&quot;</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">e</span>  <span class="p">:</span>
                  <span class="k">pass</span>
                  <span class="k">print</span> <span class="s">&quot;error12 in send_header &quot;</span><span class="o">+</span><span class="s">&quot; e:&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">)</span>   
                  <span class="n">errorQueue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="s">&quot;error12 in send_header &quot;</span><span class="o">+</span><span class="s">&quot; e:&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">)</span>  <span class="p">)</span>    
                
                <span class="k">return</span>









            <span class="c">#/RouterGL0001/index.html?=r_onos_s12</span>

            <span class="k">if</span>  <span class="p">(</span> <span class="n">string</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">,</span><span class="s">&quot;r_onos_s&quot;</span><span class="p">)</span><span class="o">!=-</span><span class="mi">1</span><span class="p">)</span><span class="o">&amp;</span> <span class="p">(</span> <span class="n">string</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">,</span><span class="s">&quot;?&quot;</span><span class="p">)</span><span class="o">!=-</span><span class="mi">1</span><span class="p">)</span><span class="o">&amp;</span> <span class="p">(</span> <span class="n">string</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">,</span><span class="s">&quot;=&quot;</span><span class="p">)</span><span class="o">!=-</span><span class="mi">1</span><span class="p">):</span>   <span class="c">#if is the javascript on the page asking to update the webpage             /</span>
                 <span class="c">#   global object_dict</span>
              
              <span class="k">global</span> <span class="n">oldpag</span>
              <span class="k">global</span> <span class="n">nothing_changed</span>
                 <span class="c">#   global  old_zoneDict</span>
                 <span class="c">#   global  old_object_dict</span>
                 <span class="c">#   global  old_web_page</span>
              <span class="n">end_file_name</span><span class="o">=</span><span class="mi">0</span>
              <span class="n">end_file_name</span><span class="o">=</span><span class="n">string</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">,</span><span class="s">&quot;.html&quot;</span><span class="p">)</span><span class="o">+</span><span class="mi">5</span>
              <span class="n">web_page</span><span class="o">=</span><span class="s">&#39;&#39;</span>
              <span class="k">try</span><span class="p">:</span>              
                <span class="n">b1</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">baseRoomPath</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="n">end_file_name</span><span class="p">]</span> <span class="p">,</span><span class="s">&#39;r&#39;</span><span class="p">)</span>    
                <span class="n">web_page</span><span class="o">=</span><span class="n">b1</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>    
                <span class="n">b1</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
              <span class="k">except</span><span class="p">:</span>
                <span class="k">print</span> <span class="s">&quot;error opening the file&quot;</span>
                <span class="n">errorQueue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="s">&quot;error opening the file&quot;</span> <span class="p">)</span>  



                   
              <span class="c">#if True : #to implement a check to not execute modPag if the dictionary are equal</span>
              <span class="n">pag</span><span class="o">=</span><span class="n">modPage</span><span class="p">(</span><span class="n">web_page</span><span class="p">,</span><span class="n">object_dict</span><span class="p">,</span><span class="n">findRoomName</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">,</span><span class="n">zoneDict</span><span class="p">),</span><span class="n">zoneDict</span><span class="p">)</span>
              <span class="n">p_start</span><span class="o">=</span><span class="n">string</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">pag</span><span class="p">,</span><span class="s">&#39;&lt;div id=&quot;ReloadThis&quot; &gt;&#39;</span><span class="p">)</span>
                
              <span class="n">pag</span><span class="o">=</span><span class="n">pag</span><span class="p">[</span><span class="n">p_start</span><span class="o">+</span><span class="nb">len</span><span class="p">(</span><span class="s">&#39;&lt;div id=&quot;ReloadThis&quot; &gt;&#39;</span><span class="p">):]</span> <span class="c">#send only the part of page to update </span>

                      <span class="c">#old_zoneDict=zoneDict</span>
                      <span class="c">#old_object_dict=object_dict</span>
                      <span class="c">#old_web_page=web_page</span>
                     
                <span class="c">#if (1):#  (oldpag!=pag):  removed the not updating part for problem with arduino update</span>
              <span class="n">nothing_changed</span><span class="o">=</span><span class="mi">0</span>
                <span class="c">#print &quot;web page changed&quot; </span>

              <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">send_response</span><span class="p">(</span><span class="mi">202</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">send_header</span><span class="p">(</span><span class="s">&#39;Content-type&#39;</span><span class="p">,</span>	<span class="s">&#39;text/html&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">end_headers</span><span class="p">()</span> 
                <span class="bp">self</span><span class="o">.</span><span class="n">wfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;ok&quot;</span><span class="o">+</span><span class="n">strftime</span><span class="p">(</span><span class="s">&quot;%S&quot;</span><span class="p">,</span> <span class="n">gmtime</span><span class="p">())</span><span class="o">+</span><span class="n">pag</span><span class="p">)</span> 
              <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">e</span>  <span class="p">:</span>
                <span class="k">pass</span>
                <span class="k">print</span> <span class="s">&quot;error in send_header r_onos_s  0 &quot;</span><span class="o">+</span><span class="s">&quot; e:&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">)</span>     
                <span class="n">errorQueue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="s">&quot;error in send_header r_onos_s  0 &quot;</span><span class="o">+</span><span class="s">&quot; e:&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">)</span>  <span class="p">)</span>  
              <span class="n">oldpag</span><span class="o">=</span><span class="n">pag</span>
                        
                <span class="c">#else:</span>
                <span class="c">#  print &quot;web page not changed 1&quot;  </span>
                <span class="c">#  nothing_changed=nothing_changed+1</span>
                <span class="c">#  try:</span>
                <span class="c">#    self.send_response(200)</span>
                <span class="c">#    self.send_header(&#39;Content-type&#39;,	&#39;text/html&#39;)</span>
                <span class="c">#    self.end_headers() </span>
                <span class="c">#    try:</span>
                <span class="c">#      self.wfile.write(&quot;ok&quot;+strftime(&quot;%S&quot;, gmtime())+pag)</span>
                <span class="c">#    except Exception, e  :</span>
                <span class="c">#      pass</span>
                <span class="c">#      print &quot;error in send_header  r_onos_s 2&quot;+&quot; e:&quot;+str(e.args)  </span>
                <span class="c">#      errorQueue.put(&quot;error in send_header  r_onos_s 2&quot;+&quot; e:&quot;+str(e.args) )  </span>
                       

                 <span class="c">#except Exception, e  :</span>
                 <span class="c">#   pass</span>
                 <span class="c">#   print &quot;error in send_header r_onos_s 3&quot;+&quot; e:&quot;+str(e.args)     </span>
                 <span class="c">#   errorQueue.put(&quot;error in send_header r_onos_s 3&quot;+&quot; e:&quot;+str(e.args)   )  </span>
                 <span class="c"># return</span>

              <span class="c">#else:        #never  executed for now</span>
              <span class="c">#  print &quot;web page not changed 2&quot;  </span>
              <span class="c">#  try:</span>
              <span class="c">#    self.send_response(200)</span>
              <span class="c">#    self.send_header(&#39;Content-type&#39;,	&#39;text/html&#39;)</span>
                 <span class="c">#self.send_header(&#39;Location&#39;, self.path)</span>
              <span class="c">#    self.end_headers() </span>
              <span class="c">#    self.wfile.write(&quot;ok&quot;+strftime(&quot;%S&quot;, gmtime())+&quot;nonews&quot;)   #remove comment to send page</span>
                  <span class="c">#self.wfile.write(&quot;oknothing_changed&quot;)   #remove comment to send page only when it change</span>

              <span class="c">#  except Exception, e  :</span>
              <span class="c">#    pass</span>
              <span class="c">#    print &quot;error in send_header r_onos_s 4 &quot;+&quot; e:&quot;+str(e.args)   </span>
              <span class="c">#    errorQueue.put( &quot;error in send_header r_onos_s 4 &quot;+&quot; e:&quot;+str(e.args))  </span>
  
              <span class="k">return</span>




            <span class="k">if</span> <span class="p">(</span>    <span class="p">(</span> <span class="n">string</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">,</span><span class="s">&quot;?&quot;</span><span class="p">)</span><span class="o">!=-</span><span class="mi">1</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="n">string</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">,</span><span class="s">&quot;=&quot;</span><span class="p">)</span><span class="o">!=-</span><span class="mi">1</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="n">string</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">,</span><span class="s">&quot;r_onos_s&quot;</span><span class="p">)</span><span class="o">==-</span><span class="mi">1</span><span class="p">)):</span>
              <span class="k">print</span> <span class="s">&quot;get query found############################################################################&quot;</span>
              <span class="n">end_file_name</span><span class="o">=</span><span class="mi">0</span>
              <span class="k">if</span> <span class="p">(</span>  <span class="p">(</span><span class="n">string</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">,</span><span class="s">&quot;.html&quot;</span><span class="p">)</span><span class="o">!=-</span><span class="mi">1</span><span class="p">)</span> <span class="p">):</span>  <span class="c">#if a html file is called</span>
             
                <span class="c">#start_file_name=&quot;&quot;</span>
                
                <span class="c">#x=(string.find(self.path,&quot;/&quot;)) </span>
                
                <span class="n">html_filename</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s">&#39;/(.+?).html&#39;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">)</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="s">&quot;.html&quot;</span>
                <span class="k">print</span>  <span class="s">&quot;html_filename=&quot;</span><span class="p">,</span><span class="n">html_filename</span>
                <span class="c">#end_file_name=string.find(self.path,&quot;.html&quot;)+5</span>

                <span class="c">#print &quot;addressbar1= &quot;+self.path</span>
                <span class="c">#print &quot;file:&quot;+self.path[1:end_file_name]  </span>
                <span class="k">try</span><span class="p">:</span>              
                  <span class="c">#b1 = open(baseRoomPath+self.path[1:end_file_name] ,&#39;r&#39;)    </span>
                  <span class="n">b1</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">baseRoomPath</span><span class="o">+</span><span class="n">html_filename</span> <span class="p">,</span><span class="s">&#39;r&#39;</span><span class="p">)</span>    
                  <span class="n">web_page</span><span class="o">=</span><span class="n">b1</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>    
                  <span class="n">b1</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">e</span>  <span class="p">:</span>
                  <span class="k">print</span> <span class="s">&quot;error opening the htlm file&quot;</span><span class="o">+</span><span class="s">&quot; e:&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">)</span>
                  <span class="n">errorQueue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span> <span class="s">&quot;error opening the htlm file&quot;</span><span class="o">+</span><span class="s">&quot; e:&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">))</span>  
                  <span class="n">web_page</span><span class="o">=</span><span class="s">&quot;error no html found&quot;</span>
                <span class="c">#print web_page</span>
                
              <span class="k">else</span><span class="p">:</span> <span class="c">#no .html in the address bar</span>
                <span class="n">k</span><span class="o">=</span><span class="mi">0</span>
                <span class="n">last_bar</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>
                <span class="k">while</span> <span class="p">((</span><span class="n">string</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">,</span><span class="s">&quot;/&quot;</span><span class="p">,</span><span class="n">k</span><span class="p">))</span><span class="o">!=-</span><span class="mi">1</span><span class="p">):</span>   <span class="c">#search for the last / in the address bar</span>
                  <span class="n">last_bar</span><span class="o">=</span><span class="n">string</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">,</span><span class="s">&quot;/&quot;</span><span class="p">,</span><span class="n">k</span><span class="p">)</span>
                  <span class="n">k</span><span class="o">=</span><span class="n">last_bar</span><span class="o">+</span><span class="mi">1</span>
              
              
                <span class="k">print</span> <span class="s">&quot;local address bar =&quot;</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">last_bar</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> 
                <span class="k">try</span><span class="p">:</span>              
                  <span class="n">b1</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">baseRoomPath</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="n">last_bar</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span><span class="s">&quot;index.html&quot;</span> <span class="p">,</span><span class="s">&#39;r&#39;</span><span class="p">)</span>   
                  
                  <span class="n">web_page</span><span class="o">=</span><span class="n">b1</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>    
                  <span class="n">b1</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">e</span>  <span class="p">:</span>
                  
                  <span class="k">print</span> <span class="s">&quot;error opening the file&quot;</span><span class="o">+</span><span class="s">&quot; e:&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">)</span>
                  <span class="n">errorQueue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="s">&quot;error opening the file local address bar =&quot;</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">last_bar</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span><span class="s">&quot;index.html&quot;</span><span class="o">+</span><span class="s">&quot; e:&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">))</span>  
                  <span class="k">print</span> <span class="s">&quot;local address bar =&quot;</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">last_bar</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span><span class="s">&quot;index.html&quot;</span> 
                  <span class="n">web_page</span><span class="o">=</span><span class="n">web_page_not_found</span>
                <span class="c">#print web_page</span>
            
                                  
                    
             
              <span class="n">address_bar</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">[</span><span class="n">end_file_name</span><span class="p">:]</span>
              <span class="c">#print &quot;a---&quot;+address_bar</span>
              <span class="c">#banana use regex to read all the obj and status to set</span>
              <span class="n">address_bar</span><span class="o">=</span><span class="n">address_bar</span><span class="p">[</span><span class="n">string</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">address_bar</span><span class="p">,</span><span class="s">&quot;?&quot;</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">:]</span>

              <span class="n">equal_position</span><span class="o">=</span><span class="n">string</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">address_bar</span><span class="p">,</span><span class="s">&quot;=&quot;</span><span class="p">)</span>
              <span class="n">next_point_position</span><span class="o">=</span><span class="n">string</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">address_bar</span><span class="p">,</span><span class="s">&quot;&amp;&quot;</span><span class="p">,</span><span class="n">equal_position</span><span class="p">)</span>
              <span class="n">objName</span><span class="o">=</span><span class="n">address_bar</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span> <span class="n">equal_position</span><span class="p">]</span>

              <span class="k">if</span> <span class="p">(</span><span class="n">next_point_position</span><span class="o">!=-</span><span class="mi">1</span><span class="p">):</span>
                <span class="n">status_to_set</span><span class="o">=</span><span class="p">(</span>  <span class="n">address_bar</span><span class="p">[(</span><span class="n">equal_position</span><span class="o">+</span><span class="mi">1</span><span class="p">):(</span><span class="n">next_point_position</span><span class="p">)]</span>  <span class="p">)</span>
                <span class="k">print</span> <span class="s">&quot;value=&quot;</span><span class="o">+</span><span class="p">(</span><span class="n">status_to_set</span><span class="p">)</span>
              <span class="k">else</span><span class="p">:</span>                     
                <span class="n">status_to_set</span><span class="o">=</span><span class="p">(</span><span class="n">address_bar</span><span class="p">[(</span><span class="n">equal_position</span><span class="o">+</span><span class="mi">1</span><span class="p">):])</span>
                <span class="k">print</span> <span class="s">&quot;value=&quot;</span><span class="o">+</span><span class="p">(</span><span class="n">status_to_set</span><span class="p">)</span>

              <span class="k">if</span> <span class="n">status_to_set</span><span class="o">==</span><span class="s">&quot;!&quot;</span><span class="p">:</span>  <span class="c"># to make a not of the current status</span>
                 <span class="c">#print &quot;make the opposite&quot;</span>
                <span class="n">status_to_set</span><span class="o">=</span><span class="ow">not</span> <span class="p">(</span><span class="n">object_dict</span><span class="p">[</span><span class="n">objName</span><span class="p">]</span><span class="o">.</span><span class="n">getStatus</span><span class="p">())</span>

              <span class="k">if</span> <span class="p">(</span>  <span class="n">objName</span>  <span class="ow">in</span> <span class="n">object_dict</span> <span class="p">):</span>
                <span class="c">#print &quot;pulsante trovato in dizionario&quot;                </span>
             
                <span class="k">if</span> <span class="n">status_to_set</span><span class="o">==</span><span class="s">&quot;!&quot;</span><span class="p">:</span>  <span class="c"># to make a not of the current status</span>
                    <span class="c">#print &quot;make the opposite&quot;</span>
                  <span class="n">status_to_set</span><span class="o">=</span><span class="ow">not</span> <span class="p">(</span><span class="n">object_dict</span><span class="p">[</span><span class="n">objName</span><span class="p">]</span><span class="o">.</span><span class="n">getStatus</span><span class="p">())</span>

                <span class="c">#changeWebObjectStatus(objName,status_to_set,1)  #banana to add usr,priority,mail_list_to_report_to</span>
                <span class="n">priorityCmdQueue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span> <span class="p">{</span><span class="s">&quot;cmd&quot;</span><span class="p">:</span><span class="s">&quot;setSts&quot;</span><span class="p">,</span><span class="s">&quot;webObjectName&quot;</span><span class="p">:</span><span class="n">objName</span><span class="p">,</span><span class="s">&quot;status_to_set&quot;</span><span class="p">:</span><span class="n">status_to_set</span><span class="p">,</span><span class="s">&quot;write_to_hw&quot;</span><span class="p">:</span><span class="mi">1</span><span class="p">})</span>  

                <span class="k">print</span> <span class="s">&quot;i set&quot;</span><span class="o">+</span><span class="n">objName</span><span class="o">+</span><span class="s">&quot; to :&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">status_to_set</span><span class="p">)</span>

              <span class="k">else</span><span class="p">:</span>
                <span class="k">print</span> <span class="s">&quot;command :&quot;</span><span class="o">+</span><span class="n">objName</span><span class="o">+</span><span class="s">&quot; not in dictionary&quot;</span>


              <span class="n">address_bar</span><span class="o">=</span><span class="n">address_bar</span><span class="p">[</span><span class="n">next_point_position</span><span class="o">-</span><span class="mi">2</span><span class="p">:]</span>

              <span class="c">#address_bar example  &quot;http://192.168.0.100/RouterGL0000/index.html?socket0_RouterGL0000=0&amp;socket0_RouterGL0020=1&amp;socket0_ttgg0000=69&quot;</span>
              <span class="k">while</span> <span class="p">(</span> <span class="p">(</span> <span class="n">string</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">address_bar</span><span class="p">,</span><span class="s">&quot;&amp;&quot;</span><span class="p">)</span><span class="o">!=-</span><span class="mi">1</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">address_bar</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">1</span> <span class="p">)):</span>
                <span class="n">point_position</span><span class="o">=</span><span class="n">string</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">address_bar</span><span class="p">,</span><span class="s">&quot;&amp;&quot;</span><span class="p">)</span>
                <span class="n">equal_position</span><span class="o">=</span><span class="n">string</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">address_bar</span><span class="p">,</span><span class="s">&quot;=&quot;</span><span class="p">,</span><span class="n">point_position</span><span class="p">)</span>
                <span class="n">next_point_position</span><span class="o">=</span><span class="n">string</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">address_bar</span><span class="p">,</span><span class="s">&quot;&amp;&quot;</span><span class="p">,</span><span class="n">equal_position</span><span class="p">)</span>
                <span class="n">objName</span><span class="o">=</span><span class="n">address_bar</span><span class="p">[</span><span class="n">point_position</span><span class="o">+</span><span class="mi">1</span><span class="p">:</span> <span class="n">equal_position</span><span class="p">]</span>
                
                <span class="c">#print &quot;cmd:&quot;+cmd</span>
                <span class="c">#print &quot;a:&quot;+address_bar[(equal_position):]</span>
                 
                <span class="k">try</span> <span class="p">:</span>
                  <span class="k">if</span> <span class="p">(</span><span class="n">next_point_position</span><span class="o">!=-</span><span class="mi">1</span><span class="p">):</span>
                    <span class="n">status_to_set</span><span class="o">=</span><span class="p">(</span>  <span class="n">address_bar</span><span class="p">[(</span><span class="n">equal_position</span><span class="o">+</span><span class="mi">1</span><span class="p">):(</span><span class="n">next_point_position</span><span class="p">)]</span>  <span class="p">)</span>
                    <span class="k">print</span> <span class="s">&quot;value=&quot;</span><span class="o">+</span><span class="p">(</span><span class="n">status_to_set</span><span class="p">)</span>
                  <span class="k">else</span><span class="p">:</span>                     
                    <span class="n">status_to_set</span><span class="o">=</span><span class="p">(</span><span class="n">address_bar</span><span class="p">[(</span><span class="n">equal_position</span><span class="o">+</span><span class="mi">1</span><span class="p">):])</span>
                    <span class="k">print</span> <span class="s">&quot;value=&quot;</span><span class="o">+</span><span class="p">(</span><span class="n">status_to_set</span><span class="p">)</span>

                <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">e</span>  <span class="p">:</span>
                
                  <span class="k">print</span> <span class="s">&quot;error in the status_to_set_value in the address bar&quot;</span><span class="o">+</span><span class="n">address_bar</span><span class="p">[(</span><span class="n">equal_position</span><span class="o">+</span><span class="mi">2</span><span class="p">):]</span><span class="o">+</span><span class="s">&quot; e:&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">)</span>
                  <span class="n">errorQueue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="s">&quot;error in the status_to_set_value in the address bar&quot;</span><span class="o">+</span><span class="n">address_bar</span><span class="p">[(</span><span class="n">equal_position</span><span class="o">+</span><span class="mi">2</span><span class="p">):]</span><span class="o">+</span><span class="s">&quot; e:&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">)</span> <span class="p">)</span> 
                  <span class="k">print</span> <span class="s">&quot;next:&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">next_point_position</span><span class="p">)</span>
                  <span class="k">print</span>  <span class="p">(</span><span class="n">address_bar</span><span class="p">[</span><span class="n">equal_position</span><span class="o">+</span><span class="mi">2</span><span class="p">:])</span> 
                  <span class="n">status_to_set</span><span class="o">=-</span><span class="mi">1</span>

                <span class="k">if</span> <span class="p">(</span>  <span class="n">objName</span>  <span class="ow">in</span> <span class="n">object_dict</span> <span class="p">):</span>
                <span class="c">#print &quot;pulsante trovato in dizionario&quot;                </span>
             
                  <span class="k">if</span> <span class="n">status_to_set</span><span class="o">==</span><span class="s">&quot;!&quot;</span><span class="p">:</span>  <span class="c"># to make a not of the current status</span>
                    <span class="c">#print &quot;make the opposite&quot;</span>
                    <span class="n">status_to_set</span><span class="o">=</span><span class="ow">not</span> <span class="p">(</span><span class="n">object_dict</span><span class="p">[</span><span class="n">objName</span><span class="p">]</span><span class="o">.</span><span class="n">getStatus</span><span class="p">())</span>

                  <span class="k">print</span> <span class="s">&quot;path=&quot;</span><span class="o">+</span><span class="n">address_bar</span>
                  <span class="c">#changeWebObjectStatus(objectName,status_to_set,1)  #banana to add usr,priority,mail_list_to_report_to</span>
                  <span class="n">priorityCmdQueue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span> <span class="p">{</span><span class="s">&quot;cmd&quot;</span><span class="p">:</span><span class="s">&quot;setSts&quot;</span><span class="p">,</span><span class="s">&quot;webObjectName&quot;</span><span class="p">:</span><span class="n">objName</span><span class="p">,</span><span class="s">&quot;status_to_set&quot;</span><span class="p">:</span><span class="n">status_to_set</span><span class="p">,</span><span class="s">&quot;write_to_hw&quot;</span><span class="p">:</span><span class="mi">1</span><span class="p">})</span>  

                  <span class="k">print</span> <span class="s">&quot;i set&quot;</span><span class="o">+</span><span class="n">objName</span><span class="o">+</span><span class="s">&quot; to :&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">status_to_set</span><span class="p">)</span>

                <span class="k">else</span><span class="p">:</span>
                  <span class="k">print</span> <span class="s">&quot;command :&quot;</span><span class="o">+</span><span class="n">objName</span><span class="o">+</span><span class="s">&quot; not in dictionary&quot;</span>
                

                <span class="n">address_bar</span><span class="o">=</span><span class="n">address_bar</span><span class="p">[(</span><span class="n">equal_position</span><span class="o">+</span><span class="mi">1</span><span class="p">):]</span> <span class="c">#remove the first &#39;?&#39;</span>
                <span class="c">#print &quot;addressbar= &quot;+address_bar</span>

              
              <span class="n">pag</span><span class="o">=</span><span class="n">modPage</span><span class="p">(</span><span class="n">web_page</span><span class="p">,</span><span class="n">object_dict</span><span class="p">,</span><span class="n">findRoomName</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">,</span><span class="n">zoneDict</span><span class="p">),</span><span class="n">zoneDict</span><span class="p">)</span>

              <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">send_response</span><span class="p">(</span><span class="mi">202</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">send_header</span><span class="p">(</span><span class="s">&#39;Content-type&#39;</span><span class="p">,</span>	<span class="s">&#39;text/html&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">end_headers</span><span class="p">()</span> 
                <span class="bp">self</span><span class="o">.</span><span class="n">wfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">pag</span><span class="p">)</span> 
        <span class="c">#      print &quot;percorso=&quot;+self.path+&quot;fine percorso&quot;   </span>
              <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">e</span>  <span class="p">:</span>
                <span class="k">pass</span>
                <span class="k">print</span> <span class="s">&quot;error11 in send_header &quot;</span><span class="o">+</span><span class="s">&quot; e:&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">)</span>      
                <span class="n">errorQueue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="s">&quot;error11 in send_header &quot;</span><span class="o">+</span><span class="s">&quot; e:&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">)</span> <span class="p">)</span> 

              <span class="k">return</span>


            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s">&quot;.json&quot;</span><span class="p">):</span>
                <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">curdir</span> <span class="o">+</span> <span class="n">sep</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">)</span> <span class="c">#self.path has /test.html</span>
                <span class="n">tmpF</span><span class="o">=</span><span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
                <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="c">#note that this potentially makes every file on your computer readable by the internet</span>
                <span class="k">try</span><span class="p">:</span>
                  <span class="bp">self</span><span class="o">.</span><span class="n">send_response</span><span class="p">(</span><span class="mi">200</span><span class="p">)</span>
                  <span class="bp">self</span><span class="o">.</span><span class="n">send_header</span><span class="p">(</span><span class="s">&#39;Content-Disposition: attachment&#39;</span><span class="p">,</span>	<span class="s">&#39;filename=&quot;config_files/data.json&quot;&#39;</span><span class="p">)</span>
                  <span class="bp">self</span><span class="o">.</span><span class="n">send_header</span><span class="p">(</span><span class="s">&#39;Content-Type: application/octet-stream&#39;</span><span class="p">,</span><span class="s">&#39;text/json&#39;</span> <span class="p">)</span>

                  <span class="bp">self</span><span class="o">.</span><span class="n">end_headers</span><span class="p">()</span>
                  <span class="bp">self</span><span class="o">.</span><span class="n">wfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">tmpF</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">e</span>  <span class="p">:</span>
                  <span class="k">pass</span>
                  <span class="k">print</span> <span class="s">&quot;error12 in send_header &quot;</span><span class="o">+</span><span class="s">&quot; e:&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">)</span>     
                  <span class="n">errorQueue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="s">&quot;error12 in send_header &quot;</span><span class="o">+</span><span class="s">&quot; e:&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">)</span> <span class="p">)</span>  
                <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                <span class="k">return</span>
                
  
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s">&quot;gui/new_user.py&quot;</span><span class="p">):</span> <span class="c"># render the scenario list </span>
              <span class="n">namespace</span><span class="o">=</span><span class="p">{}</span>
              <span class="n">message</span><span class="o">=</span><span class="s">&quot;&quot;</span>
              <span class="n">cgi_name</span><span class="o">=</span><span class="s">&quot;gui/new_user.py&quot;</span>       
              <span class="nb">execfile</span><span class="p">(</span><span class="n">cgi_name</span><span class="p">,</span><span class="nb">globals</span><span class="p">(),</span><span class="n">namespace</span><span class="p">)</span>
              <span class="n">web_page</span><span class="o">=</span><span class="n">namespace</span><span class="p">[</span><span class="s">&quot;web_page&quot;</span><span class="p">]</span>

              <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">send_response</span><span class="p">(</span><span class="mi">200</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">send_header</span><span class="p">(</span><span class="s">&#39;Content-type&#39;</span><span class="p">,</span>	<span class="s">&#39;text/html&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">end_headers</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">wfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">web_page</span><span class="p">)</span> 
              <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">e</span>  <span class="p">:</span>
                <span class="k">print</span> <span class="s">&quot;error12a in send_header &quot;</span><span class="o">+</span><span class="s">&quot; e:&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">)</span>
                <span class="n">errorQueue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span> <span class="s">&quot;error13a in send_header &quot;</span><span class="o">+</span><span class="s">&quot; e:&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">))</span>  
              <span class="k">return</span>



            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s">&quot;scenarios_list/&quot;</span><span class="p">):</span> <span class="c"># render the scenario list </span>
              <span class="n">namespace</span><span class="o">=</span><span class="p">{}</span>
              <span class="n">cgi_name</span><span class="o">=</span><span class="s">&quot;gui/scenarios_list.py&quot;</span>       
              <span class="nb">execfile</span><span class="p">(</span><span class="n">cgi_name</span><span class="p">,</span><span class="nb">globals</span><span class="p">(),</span><span class="n">namespace</span><span class="p">)</span>
              <span class="n">web_page</span><span class="o">=</span><span class="n">namespace</span><span class="p">[</span><span class="s">&quot;web_page&quot;</span><span class="p">]</span>

              <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">send_response</span><span class="p">(</span><span class="mi">200</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">send_header</span><span class="p">(</span><span class="s">&#39;Content-type&#39;</span><span class="p">,</span>	<span class="s">&#39;text/html&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">end_headers</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">wfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">web_page</span><span class="p">)</span> 
              <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">e</span>  <span class="p">:</span>
                <span class="k">print</span> <span class="s">&quot;error13a in send_header &quot;</span><span class="o">+</span><span class="s">&quot; e:&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">)</span>
                <span class="n">errorQueue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span> <span class="s">&quot;error13a in send_header &quot;</span><span class="o">+</span><span class="s">&quot; e:&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">))</span>  
              <span class="k">return</span>




            <span class="n">scenario_to_mod</span><span class="o">=</span><span class="s">&quot;&quot;</span>
            <span class="k">if</span> <span class="p">(</span>  <span class="n">string</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">,</span><span class="s">&quot;/mod_scenario/&quot;</span><span class="p">)</span><span class="o">!=-</span><span class="mi">1</span><span class="p">):</span> <span class="c"># render the mod scenario setup menu</span>
              <span class="k">print</span> <span class="s">&quot;scenario_to_mod&quot;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&quot;/&quot;</span><span class="p">)[</span><span class="mi">2</span><span class="p">]</span>
              <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&quot;/&quot;</span><span class="p">)[</span><span class="mi">2</span><span class="p">])</span><span class="ow">in</span> <span class="n">scenarioDict</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                  <span class="n">namespace</span><span class="o">=</span><span class="p">{</span><span class="s">&quot;scenario_to_mod&quot;</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&quot;/&quot;</span><span class="p">)[</span><span class="mi">2</span><span class="p">]}</span>
                  <span class="n">scenario_to_mod</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&quot;/&quot;</span><span class="p">))[</span><span class="mi">2</span><span class="p">]</span>
                  <span class="n">cgi_name</span><span class="o">=</span><span class="s">&quot;gui/mod_scenario.py&quot;</span>       
                  <span class="nb">execfile</span><span class="p">(</span><span class="n">cgi_name</span><span class="p">,</span><span class="nb">globals</span><span class="p">(),</span><span class="n">namespace</span><span class="p">)</span>
                  <span class="n">web_page</span><span class="o">=</span><span class="n">namespace</span><span class="p">[</span><span class="s">&quot;web_page&quot;</span><span class="p">]</span>

                  

              <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">e</span>  <span class="p">:</span>
                <span class="k">print</span> <span class="s">&quot;error, scenario name does not exist &quot;</span><span class="o">+</span><span class="s">&quot; e:&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">)</span>
                <span class="n">errorQueue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="s">&quot;error, scenario name does not exist &quot;</span><span class="o">+</span><span class="s">&quot; e:&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">))</span>   

                <span class="n">web_page</span><span class="o">=</span><span class="s">&quot;error, scenario name does not exist &quot;</span>


              <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">send_response</span><span class="p">(</span><span class="mi">200</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">send_header</span><span class="p">(</span><span class="s">&#39;Content-type&#39;</span><span class="p">,</span>	<span class="s">&#39;text/html&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">end_headers</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">wfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">web_page</span><span class="p">)</span> 
              <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">e</span>  <span class="p">:</span>
                <span class="k">print</span> <span class="s">&quot;error13a in send_header &quot;</span><span class="o">+</span><span class="s">&quot; e:&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">)</span>
                <span class="n">errorQueue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span> <span class="s">&quot;error13a in send_header &quot;</span><span class="o">+</span><span class="s">&quot; e:&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">))</span>  
              <span class="k">return</span>


            <span class="k">if</span> <span class="p">(</span>  <span class="n">string</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">,</span><span class="s">&quot;/scenario_conditions/&quot;</span><span class="p">)</span><span class="o">!=-</span><span class="mi">1</span><span class="p">):</span> <span class="c"># render the conditions mod scenario setup menu</span>
              
              <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&quot;/&quot;</span><span class="p">)[</span><span class="mi">2</span><span class="p">])</span><span class="ow">in</span> <span class="n">scenarioDict</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                  <span class="n">namespace</span><span class="o">=</span><span class="p">{</span><span class="s">&quot;scenario_to_mod&quot;</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&quot;/&quot;</span><span class="p">)[</span><span class="mi">2</span><span class="p">]}</span>
                  <span class="n">scenario_to_mod</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&quot;/&quot;</span><span class="p">))[</span><span class="mi">2</span><span class="p">]</span>
                  <span class="n">cgi_name</span><span class="o">=</span><span class="s">&quot;gui/scenario_conditions.py&quot;</span>       
                  
                  <span class="nb">execfile</span><span class="p">(</span><span class="n">cgi_name</span><span class="p">,</span><span class="nb">globals</span><span class="p">(),</span><span class="n">namespace</span><span class="p">)</span>
                  <span class="n">web_page</span><span class="o">=</span><span class="n">namespace</span><span class="p">[</span><span class="s">&quot;web_page&quot;</span><span class="p">]</span>

                  

              <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">e</span>  <span class="p">:</span>
                <span class="k">print</span> <span class="s">&quot;error, scenario name does not exist &quot;</span><span class="o">+</span><span class="s">&quot; e:&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">)</span>
                <span class="n">errorQueue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="s">&quot;error, scenario name does not exist &quot;</span><span class="o">+</span><span class="s">&quot; e:&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">))</span>   

                <span class="n">web_page</span><span class="o">=</span><span class="s">&quot;error, scenario name does not exist &quot;</span>


              <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">send_response</span><span class="p">(</span><span class="mi">200</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">send_header</span><span class="p">(</span><span class="s">&#39;Content-type&#39;</span><span class="p">,</span>	<span class="s">&#39;text/html&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">end_headers</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">wfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">web_page</span><span class="p">)</span> 
              <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">e</span>  <span class="p">:</span>
                <span class="k">print</span> <span class="s">&quot;error13ab in send_header &quot;</span><span class="o">+</span><span class="s">&quot; e:&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">)</span>
                <span class="n">errorQueue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span> <span class="s">&quot;error13ab in send_header &quot;</span><span class="o">+</span><span class="s">&quot; e:&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">))</span>  
              <span class="k">return</span>



            <span class="k">if</span> <span class="p">(</span>  <span class="n">string</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">,</span><span class="s">&quot;/function_to_run/&quot;</span><span class="p">)</span><span class="o">!=-</span><span class="mi">1</span><span class="p">):</span> <span class="c"># render the conditions mod scenario setup menu</span>
              
              <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&quot;/&quot;</span><span class="p">)[</span><span class="mi">2</span><span class="p">])</span><span class="ow">in</span> <span class="n">scenarioDict</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                  <span class="n">namespace</span><span class="o">=</span><span class="p">{</span><span class="s">&quot;scenario_to_mod&quot;</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&quot;/&quot;</span><span class="p">)[</span><span class="mi">2</span><span class="p">]}</span>
                  <span class="n">scenario_to_mod</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&quot;/&quot;</span><span class="p">))[</span><span class="mi">2</span><span class="p">]</span>
                  <span class="n">cgi_name</span><span class="o">=</span><span class="s">&quot;gui/scenario_f_to_run.py&quot;</span>       
                  
                  <span class="nb">execfile</span><span class="p">(</span><span class="n">cgi_name</span><span class="p">,</span><span class="nb">globals</span><span class="p">(),</span><span class="n">namespace</span><span class="p">)</span>
                  <span class="n">web_page</span><span class="o">=</span><span class="n">namespace</span><span class="p">[</span><span class="s">&quot;web_page&quot;</span><span class="p">]</span>

                  

              <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">e</span>  <span class="p">:</span>
                <span class="k">print</span> <span class="s">&quot;error, scenario name does not exist &quot;</span><span class="o">+</span><span class="s">&quot; e:&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">)</span>
                <span class="n">errorQueue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="s">&quot;error, scenario name does not exist &quot;</span><span class="o">+</span><span class="s">&quot; e:&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">))</span>   

                <span class="n">web_page</span><span class="o">=</span><span class="s">&quot;error, scenario name does not exist &quot;</span>


              <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">send_response</span><span class="p">(</span><span class="mi">200</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">send_header</span><span class="p">(</span><span class="s">&#39;Content-type&#39;</span><span class="p">,</span>	<span class="s">&#39;text/html&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">end_headers</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">wfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">web_page</span><span class="p">)</span> 
              <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">e</span>  <span class="p">:</span>
                <span class="k">print</span> <span class="s">&quot;error13ab in send_header &quot;</span><span class="o">+</span><span class="s">&quot; e:&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">)</span>
                <span class="n">errorQueue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span> <span class="s">&quot;error13ab in send_header &quot;</span><span class="o">+</span><span class="s">&quot; e:&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">))</span>  
              <span class="k">return</span>







            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s">&quot;setup/&quot;</span><span class="p">):</span> <span class="c"># render the setup menu</span>
              <span class="c">#print &quot;enter in  room setup&quot;</span>
              <span class="k">try</span><span class="p">:</span>              
                <span class="n">b1</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s">&#39;setup/select_config_menu.html&#39;</span><span class="p">,</span><span class="s">&#39;r&#39;</span><span class="p">)</span>    
                <span class="n">web_page</span><span class="o">=</span><span class="n">b1</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>    
                <span class="n">b1</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
              <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">e</span>  <span class="p">:</span>
                <span class="k">print</span> <span class="s">&quot;error opening the file&quot;</span><span class="o">+</span><span class="s">&quot; e:&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">)</span>
                <span class="n">errorQueue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="s">&quot;error opening the file&quot;</span><span class="o">+</span><span class="s">&quot; e:&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">)</span> <span class="p">)</span> 
                <span class="n">web_page</span><span class="o">=</span><span class="s">&quot;ERROR LOADING SELECT CONFIG MENU&quot;</span>

              <span class="k">try</span><span class="p">:</span>    
                <span class="bp">self</span><span class="o">.</span><span class="n">send_response</span><span class="p">(</span><span class="mi">200</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">send_header</span><span class="p">(</span><span class="s">&#39;Content-type&#39;</span><span class="p">,</span>	<span class="s">&#39;text/html&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">end_headers</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">wfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">web_page</span><span class="p">)</span> 
              <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">e</span>  <span class="p">:</span>
                <span class="k">pass</span>
                <span class="k">print</span> <span class="s">&quot;error13 in send_header &quot;</span><span class="o">+</span><span class="s">&quot; e:&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">)</span> 
                <span class="n">errorQueue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="s">&quot;error13 in send_header &quot;</span><span class="o">+</span><span class="s">&quot; e:&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">)</span>  <span class="p">)</span>                  
              <span class="k">return</span>



            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s">&quot;setup/obj_manager/&quot;</span><span class="p">):</span> 
              <span class="k">print</span> <span class="s">&quot;enter in  obj_manager&quot;</span>
              <span class="n">html_page</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_WebOjectManager</span><span class="p">(</span><span class="n">object_dict</span><span class="p">)</span>
                  
              <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">send_response</span><span class="p">(</span><span class="mi">200</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">send_header</span><span class="p">(</span><span class="s">&#39;Content-type&#39;</span><span class="p">,</span>	<span class="s">&#39;text/html&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">end_headers</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">wfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">html_page</span><span class="p">)</span> 
              <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">e</span>  <span class="p">:</span>
                <span class="k">pass</span>
                <span class="k">print</span> <span class="s">&quot;error14 in send_header &quot;</span><span class="o">+</span><span class="s">&quot; e:&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">)</span>   
                <span class="n">errorQueue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span> <span class="s">&quot;error14 in send_header &quot;</span><span class="o">+</span><span class="s">&quot; e:&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">))</span>                 
              <span class="k">return</span>



            <span class="k">if</span> <span class="p">((</span>  <span class="n">string</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">,</span><span class="s">&quot;cgi/&quot;</span><span class="p">)</span><span class="o">!=-</span><span class="mi">1</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span>  <span class="n">string</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">,</span><span class="s">&quot;.py&quot;</span><span class="p">)</span><span class="o">!=-</span><span class="mi">1</span><span class="p">)):</span>
              
              <span class="n">cgi_module_name_start</span><span class="o">=</span><span class="n">string</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">,</span><span class="s">&quot;cgi/&quot;</span><span class="p">)</span>
              <span class="c">#cgi_module_name_stop=len(self.path)-3    #remove the &quot;.py&quot;</span>
              <span class="n">cgi_name</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">[</span><span class="n">cgi_module_name_start</span><span class="p">:])</span>
              <span class="n">namespace</span><span class="o">=</span><span class="p">{}</span>
              <span class="n">web_page</span><span class="o">=</span><span class="s">&quot;cgi import or execute error&quot;</span>
              <span class="k">print</span> <span class="s">&quot;cgi_name:&quot;</span><span class="p">,</span><span class="n">cgi_name</span>

              <span class="k">if</span> <span class="p">(</span><span class="n">debug</span><span class="o">==</span><span class="mi">1</span><span class="p">):</span>  <span class="c"># in debug mode ..</span>

                <span class="nb">execfile</span><span class="p">(</span><span class="n">cgi_name</span><span class="p">,</span><span class="nb">globals</span><span class="p">(),</span><span class="n">namespace</span><span class="p">)</span>
                <span class="n">web_page</span><span class="o">=</span><span class="n">namespace</span><span class="p">[</span><span class="s">&quot;web_page&quot;</span><span class="p">]</span>

              <span class="k">else</span><span class="p">:</span>

                <span class="k">try</span><span class="p">:</span>
                
                  <span class="nb">execfile</span><span class="p">(</span><span class="n">cgi_name</span><span class="p">,</span><span class="nb">globals</span><span class="p">(),</span><span class="n">namespace</span><span class="p">)</span>
                  <span class="n">web_page</span><span class="o">=</span><span class="n">namespace</span><span class="p">[</span><span class="s">&quot;web_page&quot;</span><span class="p">]</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">e</span>  <span class="p">:</span>
                  <span class="k">print</span> <span class="s">&quot;error importing a module in cgi directory, cgi name:&quot;</span><span class="o">+</span><span class="n">cgi_name</span><span class="o">+</span><span class="s">&quot; e:&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">)</span>
                  <span class="n">errorQueue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span> <span class="s">&quot;error importing a module in cgi directory, cgi name:&quot;</span><span class="o">+</span><span class="n">cgi_name</span><span class="o">+</span><span class="s">&quot; e:&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">))</span> 

              <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">send_response</span><span class="p">(</span><span class="mi">200</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">send_header</span><span class="p">(</span><span class="s">&#39;Content-type&#39;</span><span class="p">,</span>	<span class="s">&#39;text/html&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">end_headers</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">wfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">web_page</span><span class="p">)</span> 
              <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">e</span>  <span class="p">:</span>
                <span class="k">pass</span>
                <span class="k">print</span> <span class="s">&quot;error15 in send_header &quot;</span><span class="o">+</span><span class="s">&quot; e:&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">)</span>                   
                <span class="n">errorQueue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span> <span class="s">&quot;error15 in send_header &quot;</span><span class="o">+</span><span class="s">&quot; e:&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">)</span>   <span class="p">)</span> 
              <span class="k">return</span> 







            <span class="k">if</span>  <span class="p">(</span> <span class="n">string</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">,</span><span class="s">&quot;/zone_objects_setup/&quot;</span><span class="p">)</span><span class="o">!=-</span><span class="mi">1</span><span class="p">):</span> <span class="c"># </span>

              <span class="k">print</span> <span class="s">&quot;enter in  obj_manager&quot;</span>
              <span class="n">zone</span><span class="o">=</span><span class="s">&#39;&#39;</span>

              <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">):</span>
                <span class="n">address_list</span><span class="o">=</span><span class="n">string</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">,</span><span class="s">&quot;/&quot;</span><span class="p">)</span>  
                <span class="k">if</span> <span class="n">address_list</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="ow">in</span> <span class="n">zoneDict</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="p">:</span>    <span class="c">#if  the path is   setup/zone_objects_setup/anyzonename....   take the room name</span>
                  <span class="n">zone</span><span class="o">=</span><span class="n">address_list</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>  
                <span class="k">else</span><span class="p">:</span> 
                  <span class="k">print</span> <span class="s">&quot;no room name found&quot;</span> 
                
              <span class="k">else</span><span class="p">:</span> 
                <span class="k">print</span> <span class="s">&quot;no room name found&quot;</span>
      


              <span class="n">html_page</span><span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_Zone_Objects_Setup</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">,</span><span class="n">object_dict</span><span class="p">,</span><span class="n">zone</span><span class="p">)</span>
              <span class="k">try</span><span class="p">:</span>    
                <span class="bp">self</span><span class="o">.</span><span class="n">send_response</span><span class="p">(</span><span class="mi">200</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">send_header</span><span class="p">(</span><span class="s">&#39;Content-type&#39;</span><span class="p">,</span>	<span class="s">&#39;text/html&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">end_headers</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">wfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">html_page</span><span class="p">)</span> 
              <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">e</span>  <span class="p">:</span>
                <span class="k">pass</span>
                <span class="k">print</span> <span class="s">&quot;error16 in send_header &quot;</span><span class="o">+</span><span class="s">&quot; e:&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">)</span>   
                <span class="n">errorQueue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="s">&quot;error16 in send_header &quot;</span><span class="o">+</span><span class="s">&quot; e:&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">)</span> <span class="p">)</span>                   
              <span class="k">return</span>










            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s">&quot;setup/save_configuration/&quot;</span><span class="p">):</span> <span class="c">#     </span>
              <span class="k">print</span> <span class="s">&quot;json saved&quot;</span>
              <span class="n">updateJson</span><span class="p">(</span> <span class="n">object_dict</span><span class="p">,</span><span class="n">zoneDict</span><span class="p">,</span><span class="n">scenarioDict</span><span class="p">)</span>
                  
              <span class="k">try</span><span class="p">:</span>              
                <span class="n">b1</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s">&#39;setup/select_config_menu.html&#39;</span><span class="p">,</span><span class="s">&#39;r&#39;</span><span class="p">)</span>    
                <span class="n">web_page</span><span class="o">=</span><span class="n">b1</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>    
                <span class="n">b1</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
              <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">e</span>  <span class="p">:</span>
                <span class="k">print</span> <span class="s">&quot;error2 opening the file&quot;</span><span class="o">+</span><span class="s">&quot; e:&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">)</span>
                <span class="n">errorQueue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="s">&quot;error2 opening the file&quot;</span><span class="o">+</span><span class="s">&quot; e:&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">)</span> <span class="p">)</span>  
                <span class="n">web_page</span><span class="o">=</span><span class="s">&quot;ERROR LOADING SELECT CONFIG MENU&quot;</span>
              
              <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">send_response</span><span class="p">(</span><span class="mi">200</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">send_header</span><span class="p">(</span><span class="s">&#39;Content-type&#39;</span><span class="p">,</span>	<span class="s">&#39;text/html&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">end_headers</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">wfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">web_page</span><span class="p">)</span> 
              <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">e</span>  <span class="p">:</span>
                <span class="k">pass</span>
                <span class="k">print</span> <span class="s">&quot;error in send_header &quot;</span><span class="o">+</span><span class="s">&quot; e:&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">)</span> 
                <span class="n">errorQueue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="s">&quot;error17 in send_header &quot;</span><span class="o">+</span><span class="s">&quot; e:&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">)</span> <span class="p">)</span>    
              <span class="k">return</span>




            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s">&quot;setup/restore_default_conf/&quot;</span><span class="p">):</span> <span class="c">#     </span>
              <span class="k">print</span> <span class="s">&quot;JSON RESTORED TO DEFAULT&quot;</span>
              <span class="c">#os.system(&#39;cp -f config_files/default.json config_files/data.json&#39;)</span>
              <span class="k">with</span> <span class="n">lock_bash_cmd</span><span class="p">:</span>
                <span class="n">subprocess</span><span class="o">.</span><span class="n">check_output</span><span class="p">(</span><span class="s">&#39;cp -f config_files/default.json config_files/data.json&#39;</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span><span class="n">close_fds</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>    
              <span class="k">try</span><span class="p">:</span>              
                <span class="n">b1</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s">&#39;setup/restored_configuration.html&#39;</span><span class="p">,</span><span class="s">&#39;r&#39;</span><span class="p">)</span>    
                <span class="n">web_page</span><span class="o">=</span><span class="n">b1</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>    
                <span class="n">b1</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
              <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">e</span>  <span class="p">:</span>
                <span class="k">print</span> <span class="s">&quot;error3 opening the file&quot;</span><span class="o">+</span><span class="s">&quot; e:&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">)</span>
                <span class="n">errorQueue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span> <span class="s">&quot;error3 opening the file&quot;</span><span class="o">+</span><span class="s">&quot; e:&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">))</span>  
                <span class="n">web_page</span><span class="o">=</span><span class="s">&quot;ERROR LOADING SELECT CONFIG MENU&quot;</span>
              
              <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">send_response</span><span class="p">(</span><span class="mi">200</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">send_header</span><span class="p">(</span><span class="s">&#39;Content-type&#39;</span><span class="p">,</span>	<span class="s">&#39;text/html&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">end_headers</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">wfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">web_page</span><span class="p">)</span> 
              <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">e</span>  <span class="p">:</span>
                <span class="k">pass</span>
                <span class="k">print</span> <span class="s">&quot;error18 in send_header &quot;</span><span class="o">+</span><span class="s">&quot; e:&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">)</span>     
                <span class="n">errorQueue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="s">&quot;error18 in send_header &quot;</span><span class="o">+</span><span class="s">&quot; e:&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">)</span>  <span class="p">)</span> 
              <span class="c">#os.execl(sys.executable, *([sys.executable]+sys.argv))</span>
              <span class="k">global</span> <span class="nb">exit</span>
              <span class="nb">exit</span><span class="o">=</span><span class="mi">1</span>
              <span class="c">#raise KeyboardInterrupt</span>
              <span class="k">return</span>


            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s">&quot;setup/zone_manager/&quot;</span><span class="p">):</span> <span class="c"># render the html list of room with the link to modify them   </span>
              <span class="k">print</span> <span class="s">&quot;enter in  zone_manager&quot;</span>
              <span class="n">html_page</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_zone_manager</span><span class="p">(</span><span class="n">zoneDict</span><span class="p">)</span>
                  
              <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">send_response</span><span class="p">(</span><span class="mi">200</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">send_header</span><span class="p">(</span><span class="s">&#39;Content-type&#39;</span><span class="p">,</span>	<span class="s">&#39;text/html&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">end_headers</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">wfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">html_page</span><span class="p">)</span> 
              <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">e</span>  <span class="p">:</span>
                <span class="k">pass</span>
                <span class="k">print</span> <span class="s">&quot;error19 in send_header &quot;</span><span class="o">+</span><span class="s">&quot; e:&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">)</span> 
                <span class="n">errorQueue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span> <span class="s">&quot;error19 in send_header &quot;</span><span class="o">+</span><span class="s">&quot; e:&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">)</span> <span class="p">)</span>                   
              <span class="k">return</span>


            <span class="k">if</span> <span class="p">((</span><span class="n">string</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">,</span><span class="s">&quot;/setup/web_obj_modifier/&quot;</span><span class="p">)</span><span class="o">!=-</span><span class="mi">1</span><span class="p">)):</span><span class="c">#render the web_object_form  to modify a webobj</span>
              <span class="n">lista</span><span class="o">=</span><span class="p">[]</span>
              <span class="n">lista</span><span class="o">=</span><span class="n">string</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">,</span><span class="s">&quot;/&quot;</span><span class="p">)</span> <span class="c">#split the path in a list of element divided by &quot;/&quot; </span>
              
              <span class="n">pag</span><span class="o">=</span><span class="s">&quot;no_web_object_to_modify&quot;</span>
              <span class="k">if</span> <span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">lista</span><span class="p">))</span><span class="o">==</span><span class="mi">4</span><span class="p">):</span>
                <span class="k">if</span> <span class="p">((</span><span class="n">lista</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="ow">in</span> <span class="n">object_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">())):</span>
                  <span class="k">print</span> <span class="s">&quot;edit a web object&quot;</span>
                  <span class="n">pag</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_WebObjForm</span><span class="p">(</span><span class="n">object_dict</span><span class="p">[</span><span class="n">lista</span><span class="p">[</span><span class="mi">3</span><span class="p">]])</span>


              <span class="k">if</span> <span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">lista</span><span class="p">))</span><span class="o">==</span><span class="mi">5</span><span class="p">):</span>
                <span class="k">if</span> <span class="p">((</span><span class="n">lista</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="ow">in</span> <span class="n">object_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span><span class="o">&amp;</span><span class="p">(</span><span class="n">lista</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">==</span><span class="s">&quot;delete_item&quot;</span><span class="p">)):</span>
                  <span class="k">print</span> <span class="s">&quot;deleted web object&quot;</span><span class="o">+</span><span class="n">lista</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
                  <span class="n">object_dict</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">lista</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span><span class="bp">None</span><span class="p">)</span>   <span class="c">#bug</span>
                  <span class="n">index</span><span class="o">=-</span><span class="mi">1</span>
                  <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">zoneDict</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="k">if</span> <span class="n">lista</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="ow">in</span> <span class="n">zoneDict</span><span class="p">[</span><span class="n">b</span><span class="p">][</span><span class="s">&quot;objects&quot;</span><span class="p">]:</span> 
                      <span class="n">index</span><span class="o">=</span><span class="n">zoneDict</span><span class="p">[</span><span class="n">b</span><span class="p">][</span><span class="s">&quot;objects&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">lista</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span>
                      <span class="n">zoneDict</span><span class="p">[</span><span class="n">b</span><span class="p">][</span><span class="s">&quot;objects&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>

   



                  <span class="c">#zoneDict=zoneDictMod </span>
                  <span class="c">#zoneDict.remove()</span>
                  <span class="n">pag</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_WebOjectManager</span><span class="p">(</span><span class="n">object_dict</span><span class="p">)</span>

                  <span class="n">updateDir</span><span class="p">()</span>          
              <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">send_response</span><span class="p">(</span><span class="mi">200</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">send_header</span><span class="p">(</span><span class="s">&#39;Content-type&#39;</span><span class="p">,</span>	<span class="s">&#39;text/html&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">end_headers</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">wfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">pag</span><span class="p">)</span> 
              <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">e</span>  <span class="p">:</span>
                <span class="k">pass</span>
                <span class="k">print</span> <span class="s">&quot;error20 in send_header &quot;</span><span class="o">+</span><span class="s">&quot; e:&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">)</span> 
                <span class="n">errorQueue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="s">&quot;error20 in send_header &quot;</span><span class="o">+</span><span class="s">&quot; e:&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">)</span>  <span class="p">)</span>                   
              <span class="k">return</span>


            <span class="n">lista</span><span class="o">=</span><span class="p">[]</span>
            <span class="n">setup_start</span><span class="o">=</span><span class="n">string</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">,</span><span class="s">&quot;setup/&quot;</span><span class="p">)</span>
            <span class="n">lista</span><span class="o">=</span><span class="n">string</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">,</span><span class="s">&quot;/&quot;</span><span class="p">)</span> <span class="c">#split the path in a list of element divided by &quot;/&quot; </span>
            <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">lista</span><span class="p">))</span><span class="o">&gt;</span><span class="mi">2</span><span class="p">:</span>
              <span class="n">room_t</span><span class="o">=</span><span class="n">lista</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
              <span class="n">room_t</span><span class="o">=</span><span class="s">&quot;not_A_room&quot;</span>
            <span class="c">#if (setup_start!=-1)&amp;((len(self.path)-setup_start)==11): # if path is like  /setup/Room0</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">setup_start</span><span class="o">!=-</span><span class="mi">1</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="n">room_t</span> <span class="ow">in</span> <span class="n">zoneDict</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span><span class="o">&amp;</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">lista</span><span class="p">)</span><span class="o">&lt;</span><span class="mi">4</span><span class="p">):</span> <span class="c"># if path is like  /setup/Room0</span>

              <span class="c">#print len(self.path)-setup_start</span>
              <span class="c">#print self.path</span>
              <span class="c">#print self.path[setup_start+6:]</span>
              
              <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">zoneDict</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="p">:</span>
                <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">[(</span><span class="n">setup_start</span><span class="o">+</span><span class="mi">6</span><span class="p">):]</span><span class="o">==</span><span class="n">a</span><span class="p">):</span>  <span class="c">#found a room in the address bar</span>
                  <span class="k">print</span> <span class="s">&quot;found a room in the address bar&quot;</span>
                  
                  <span class="n">pag</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_RoomObjectList</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">object_dict</span><span class="p">)</span> 
                  <span class="k">try</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">send_response</span><span class="p">(</span><span class="mi">200</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">send_header</span><span class="p">(</span><span class="s">&#39;Content-type&#39;</span><span class="p">,</span>	<span class="s">&#39;text/html&#39;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">end_headers</span><span class="p">()</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">wfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">pag</span><span class="p">)</span> 
                  <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">e</span>  <span class="p">:</span>
                    <span class="k">pass</span>
                    <span class="k">print</span> <span class="s">&quot;error21 in send_header &quot;</span><span class="o">+</span><span class="s">&quot; e:&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">)</span>  
                    <span class="n">errorQueue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span> <span class="s">&quot;error21 in send_header &quot;</span><span class="o">+</span><span class="s">&quot; e:&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">)</span> <span class="p">)</span>    
                  <span class="k">return</span>

              <span class="n">pag</span><span class="o">=</span><span class="s">&quot;&quot;</span>   
              <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">send_response</span><span class="p">(</span><span class="mi">200</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">send_header</span><span class="p">(</span><span class="s">&#39;Content-type&#39;</span><span class="p">,</span>	<span class="s">&#39;text/html&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">end_headers</span><span class="p">()</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">wfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">pag</span><span class="p">)</span> 
              <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">e</span>  <span class="p">:</span>
                <span class="k">pass</span>
                <span class="k">print</span> <span class="s">&quot;error22 in send_header &quot;</span><span class="o">+</span><span class="s">&quot; e:&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">)</span>  
                <span class="n">errorQueue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span> <span class="s">&quot;error22 in send_header &quot;</span><span class="o">+</span><span class="s">&quot; e:&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">)</span> <span class="p">)</span>                  
              <span class="k">return</span>

            <span class="k">else</span><span class="p">:</span> 
              
              <span class="k">print</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">[</span><span class="n">setup_start</span><span class="o">+</span><span class="mi">6</span><span class="p">:]</span>
              

              <span class="k">if</span> <span class="p">(</span> <span class="p">(</span><span class="n">setup_start</span><span class="o">!=-</span><span class="mi">1</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">lista</span><span class="p">)</span><span class="o">==</span><span class="mi">4</span><span class="p">)):</span> <span class="c">#if path is like  /setup/Room0/body</span>
                <span class="k">print</span> <span class="s">&quot;not show room modifier but obj modifier&quot;</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">lista</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="ow">in</span> <span class="n">object_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                  <span class="k">print</span> <span class="s">&quot;edit a web object&quot;</span>
                  <span class="n">pag</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_WebObjForm</span><span class="p">(</span><span class="n">object_dict</span><span class="p">[</span><span class="n">lista</span><span class="p">[</span><span class="mi">3</span><span class="p">]])</span>
                  <span class="k">try</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">send_response</span><span class="p">(</span><span class="mi">200</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">send_header</span><span class="p">(</span><span class="s">&#39;Content-type&#39;</span><span class="p">,</span>	<span class="s">&#39;text/html&#39;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">end_headers</span><span class="p">()</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">wfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">pag</span><span class="p">)</span> 
                  <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">e</span>  <span class="p">:</span>
                    <span class="k">pass</span>
                    <span class="k">print</span> <span class="s">&quot;error23 in send_header &quot;</span><span class="o">+</span><span class="s">&quot; e:&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">)</span>     
                    <span class="n">errorQueue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="s">&quot;error23 in send_header &quot;</span><span class="o">+</span><span class="s">&quot; e:&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">)</span>   <span class="p">)</span> 
                  <span class="k">return</span>
              <span class="c">#else:</span>
                <span class="c">#print &quot; &#39;/setup&#39; not found  or len list= &quot;+str(len(lista))  </span>
                  




            <span class="k">if</span> <span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s">&quot;?=&quot;</span><span class="p">))</span><span class="o">&amp;</span><span class="p">(</span><span class="n">string</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">,</span><span class="s">&quot;r_onos_s&quot;</span><span class="p">)</span><span class="o">==-</span><span class="mi">1</span><span class="p">)):</span>
              <span class="n">end_file_name</span><span class="o">=</span><span class="mi">0</span>
              <span class="n">end_file_name</span><span class="o">=</span><span class="n">string</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">,</span><span class="s">&quot;.html&quot;</span><span class="p">)</span><span class="o">+</span><span class="mi">5</span>              
              <span class="n">web_page</span><span class="o">=</span><span class="s">&#39;&#39;</span>
              <span class="k">try</span><span class="p">:</span>              
                <span class="n">b1</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">baseRoomPath</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="n">end_file_name</span><span class="p">]</span> <span class="p">,</span><span class="s">&#39;r&#39;</span><span class="p">)</span>    
                <span class="n">web_page</span><span class="o">=</span><span class="n">b1</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>    
                <span class="n">b1</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
              <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">e</span>  <span class="p">:</span>
                <span class="k">print</span> <span class="s">&quot;error4 opening the file&quot;</span><span class="o">+</span><span class="s">&quot; e:&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">)</span>
                <span class="n">errorQueue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span> <span class="s">&quot;error4 opening the file&quot;</span><span class="o">+</span><span class="s">&quot; e:&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">))</span>  
              
              <span class="n">pag</span><span class="o">=</span><span class="n">modPage</span><span class="p">(</span><span class="n">web_page</span><span class="p">,</span><span class="n">object_dict</span><span class="p">,</span><span class="n">findRoomName</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">,</span><span class="n">zoneDict</span><span class="p">),</span><span class="n">zoneDict</span><span class="p">)</span>
              <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">send_response</span><span class="p">(</span><span class="mi">202</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">send_header</span><span class="p">(</span><span class="s">&#39;Content-type&#39;</span><span class="p">,</span>	<span class="s">&#39;text/html&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">end_headers</span><span class="p">()</span>          
                <span class="bp">self</span><span class="o">.</span><span class="n">wfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">pag</span><span class="p">)</span> 
              <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">e</span>  <span class="p">:</span>
                <span class="k">pass</span>
                <span class="k">print</span> <span class="s">&quot;error24 in send_header &quot;</span><span class="o">+</span><span class="s">&quot; e:&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">)</span>    
                <span class="n">errorQueue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="s">&quot;error24 in send_header &quot;</span><span class="o">+</span><span class="s">&quot; e:&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">)</span>  <span class="p">)</span>  
              <span class="k">return</span>






            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s">&quot;.html&quot;</span><span class="p">):</span>
                <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">curdir</span> <span class="o">+</span> <span class="n">sep</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">)</span> <span class="c">#self.path has /test.html</span>
                <span class="n">tmpF</span><span class="o">=</span><span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
                <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="c">#note that this potentially makes every file on your computer readable by the internet</span>
                <span class="k">try</span><span class="p">:</span>
                  <span class="bp">self</span><span class="o">.</span><span class="n">send_response</span><span class="p">(</span><span class="mi">200</span><span class="p">)</span>
                  <span class="bp">self</span><span class="o">.</span><span class="n">send_header</span><span class="p">(</span><span class="s">&#39;Content-type&#39;</span><span class="p">,</span>	<span class="s">&#39;text/html&#39;</span><span class="p">)</span>
                  <span class="bp">self</span><span class="o">.</span><span class="n">end_headers</span><span class="p">()</span>
                  <span class="bp">self</span><span class="o">.</span><span class="n">wfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">tmpF</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">e</span>  <span class="p">:</span>
                  <span class="k">pass</span>
                  <span class="k">print</span> <span class="s">&quot;error25 in send_header &quot;</span><span class="o">+</span><span class="s">&quot; e:&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">)</span>     
                  <span class="n">errorQueue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="s">&quot;error25 in send_header &quot;</span><span class="o">+</span><span class="s">&quot; e:&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">)</span> <span class="p">)</span> 
                <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                <span class="k">return</span>
                
                
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s">&quot;/&quot;</span><span class="p">):</span> <span class="c">#the address bar end with /  so by default i try open the index.html in this directory</span>
                <span class="k">print</span> <span class="s">&quot;indirizzo a pag principale..&quot;</span>


                <span class="k">try</span><span class="p">:</span>              
                    <span class="n">b1</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span><span class="o">+</span><span class="s">&quot;index.html&quot;</span> <span class="p">,</span><span class="s">&#39;r&#39;</span><span class="p">)</span>   
                  
                    <span class="n">web_page</span><span class="o">=</span><span class="n">b1</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>    
                    <span class="n">b1</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">e</span>  <span class="p">:</span>
                  
                    <span class="k">print</span> <span class="s">&quot;error5 opening the file&quot;</span><span class="o">+</span><span class="s">&quot; e:&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">)</span>
                    <span class="n">errorQueue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="s">&quot;error5 opening the file,local address bar =&quot;</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="o">+</span><span class="s">&quot;index.html&quot;</span><span class="o">+</span><span class="s">&quot; e:&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">)</span>  <span class="p">)</span> 
                    <span class="k">print</span> <span class="s">&quot;local address bar =&quot;</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="o">+</span><span class="s">&quot;index.html&quot;</span> 
                    <span class="n">web_page</span><span class="o">=</span><span class="n">web_page_not_found</span>
                <span class="k">print</span> <span class="n">web_page</span>



                <span class="k">try</span><span class="p">:</span>
                  <span class="bp">self</span><span class="o">.</span><span class="n">send_response</span><span class="p">(</span><span class="mi">200</span><span class="p">)</span>
                  <span class="bp">self</span><span class="o">.</span><span class="n">send_header</span><span class="p">(</span><span class="s">&#39;Content-type&#39;</span><span class="p">,</span>	<span class="s">&#39;text/html&#39;</span><span class="p">)</span>
                  <span class="bp">self</span><span class="o">.</span><span class="n">end_headers</span><span class="p">()</span>
                  <span class="n">pag</span><span class="o">=</span><span class="n">modPage</span><span class="p">(</span><span class="n">web_page</span><span class="p">,</span><span class="n">object_dict</span><span class="p">,</span><span class="n">findRoomName</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">,</span><span class="n">zoneDict</span><span class="p">),</span><span class="n">zoneDict</span><span class="p">)</span>
                  <span class="bp">self</span><span class="o">.</span><span class="n">wfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">pag</span><span class="p">)</span> 
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">e</span>  <span class="p">:</span>
                  <span class="k">pass</span>
                  <span class="k">print</span> <span class="s">&quot;error26 in send_header &quot;</span><span class="o">+</span><span class="s">&quot; e:&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">)</span>                     
                  <span class="n">errorQueue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span> <span class="s">&quot;error26 in send_header &quot;</span><span class="o">+</span><span class="s">&quot; e:&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">)</span> <span class="p">)</span> 

                <span class="c">#print &quot;percorso=&quot;</span>
                <span class="c">#print self.path     </span>
                <span class="c">#print &quot;fine percorso&quot;</span>
                
                <span class="k">return</span>   
                
                
                
                
                
            <span class="k">return</span>
                
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">e</span>  <span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">send_error</span><span class="p">(</span><span class="mi">404</span><span class="p">,</span><span class="s">&#39;File Not Found: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>
            <span class="k">print</span> <span class="s">&quot;404,&#39;File Not Found&quot;</span><span class="o">+</span><span class="s">&quot; e:&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">)</span>
            <span class="n">errorQueue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="s">&quot;404,&#39;File Not Found&quot;</span><span class="o">+</span><span class="s">&quot; e:&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">)</span> <span class="p">)</span> 


              
                
    <span class="k">def</span> <span class="nf">do_POST</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>  <span class="c">#get posts data </span></div>
<div class="viewcode-block" id="MyHandler.do_POST"><a class="viewcode-back" href="../webserver.html#webserver.MyHandler.do_POST">[docs]</a>
        <span class="k">try</span><span class="p">:</span>
          <span class="n">ctype</span><span class="p">,</span> <span class="n">pdict</span> <span class="o">=</span> <span class="n">cgi</span><span class="o">.</span><span class="n">parse_header</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">getheader</span><span class="p">(</span><span class="s">&#39;content-type&#39;</span><span class="p">))</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">e</span>  <span class="p">:</span>
          <span class="k">print</span> <span class="s">&quot;some error occurred in post connection &quot;</span><span class="o">+</span><span class="s">&quot; e:&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">)</span>
          <span class="n">errorQueue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span> <span class="s">&quot;some error occurred in post connection &quot;</span><span class="o">+</span><span class="s">&quot; e:&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">))</span>
          <span class="k">return</span>

        <span class="k">if</span> <span class="n">ctype</span> <span class="o">==</span> <span class="s">&#39;onos/form-data&#39;</span><span class="p">:</span>
          <span class="k">print</span> <span class="s">&quot;received arduino post data!&quot;</span>
          <span class="n">length</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">getheader</span><span class="p">(</span><span class="s">&#39;content-length&#39;</span><span class="p">))</span>
          <span class="n">postvars</span> <span class="o">=</span> <span class="n">cgi</span><span class="o">.</span><span class="n">urlparse</span><span class="o">.</span><span class="n">parse_qs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rfile</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">length</span><span class="p">),</span> <span class="n">keep_blank_values</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
          <span class="n">node_ip</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">client_address</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>


          <span class="k">try</span><span class="p">:</span>        
            <span class="bp">self</span><span class="o">.</span><span class="n">send_response</span><span class="p">(</span><span class="mi">200</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">send_header</span><span class="p">(</span><span class="s">&#39;Content-type&#39;</span><span class="p">,</span>	<span class="s">&#39;text/html&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">end_headers</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">wfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;ok&quot;</span><span class="p">)</span>  
          <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">e</span>  <span class="p">:</span>
            <span class="k">pass</span>
            <span class="k">print</span> <span class="s">&quot;error in send_header &quot;</span><span class="o">+</span><span class="s">&quot; e:&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">)</span>     
            <span class="n">errorQueue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="s">&quot;error in send_header &quot;</span><span class="o">+</span><span class="s">&quot; e:&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">)</span>  <span class="p">)</span>
            
          <span class="k">print</span> <span class="s">&quot;postvars=&quot;</span>
          <span class="k">print</span> <span class="n">postvars</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
          <span class="k">print</span> <span class="s">&quot;data_received&quot;</span>   
          <span class="k">print</span> <span class="s">&quot;len data= &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">postvars</span><span class="o">.</span><span class="n">keys</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span> <span class="p">))</span>         
          <span class="k">print</span> <span class="n">postvars</span><span class="o">.</span><span class="n">keys</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>  
          <span class="k">if</span> <span class="p">(</span><span class="n">postvars</span><span class="o">.</span><span class="n">keys</span><span class="p">()[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">:</span><span class="mi">4</span><span class="p">]</span><span class="o">==</span><span class="s">&quot;onos&quot;</span><span class="p">):</span> 
            <span class="n">node_sn0</span><span class="o">=</span><span class="n">postvars</span><span class="o">.</span><span class="n">keys</span><span class="p">()[</span><span class="mi">0</span><span class="p">][</span><span class="mi">4</span><span class="p">:</span><span class="mi">16</span><span class="p">]</span>
            <span class="n">node_fw</span> <span class="o">=</span><span class="n">postvars</span><span class="o">.</span><span class="n">keys</span><span class="p">()[</span><span class="mi">0</span><span class="p">][</span><span class="mi">16</span><span class="p">:</span><span class="mi">20</span><span class="p">]</span>
            <span class="n">input_status_register</span><span class="o">=</span><span class="n">postvars</span><span class="o">.</span><span class="n">keys</span><span class="p">()[</span><span class="mi">0</span><span class="p">][</span><span class="mi">21</span><span class="p">:]</span>  <span class="c">#from 21 till the end</span>
            <span class="k">print</span> <span class="s">&quot;onos node input pin received from: &quot;</span><span class="o">+</span><span class="n">node_sn0</span><span class="o">+</span><span class="s">&quot; with ip: &quot;</span><span class="o">+</span><span class="n">node_ip</span><span class="o">+</span><span class="s">&quot;and fw=&quot;</span><span class="o">+</span><span class="n">node_fw</span>     


            <span class="k">if</span> <span class="n">node_sn0</span> <span class="ow">in</span> <span class="n">nodeDict</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
              <span class="k">print</span> <span class="s">&quot;the node exist so i update the pin input status&quot;</span>
              <span class="n">updateNodeAddress</span><span class="p">(</span><span class="n">node_sn0</span><span class="p">,</span><span class="n">node_ip</span><span class="p">)</span><span class="c"># update the node ip </span>
              
            <span class="k">else</span><span class="p">:</span>
              <span class="n">msg</span><span class="o">=</span><span class="n">createNewNode</span><span class="p">(</span><span class="n">node_sn0</span><span class="p">,</span><span class="n">node_ip</span><span class="p">,</span><span class="n">node_fw</span><span class="p">)</span>
              <span class="k">print</span> <span class="s">&quot;the serial number is not in the dictionary...so i add  the new node&quot;</span>

            <span class="n">updateNodeInputStatusFromReg</span><span class="p">(</span><span class="n">node_sn0</span><span class="p">,</span><span class="n">input_status_register</span><span class="p">)</span> <span class="c"># decode and update the data from the node</span>







        <span class="k">if</span> <span class="n">ctype</span> <span class="o">==</span> <span class="s">&#39;multipart/form-data&#39;</span><span class="p">:</span>
            <span class="c">#postvars = cgi.parse_multipart(self.rfile, pdict)</span>
            <span class="n">query</span><span class="o">=</span><span class="n">cgi</span><span class="o">.</span><span class="n">parse_multipart</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rfile</span><span class="p">,</span> <span class="n">pdict</span><span class="p">)</span>

            <span class="k">try</span><span class="p">:</span>
              <span class="bp">self</span><span class="o">.</span><span class="n">send_response</span><span class="p">(</span><span class="mi">301</span><span class="p">)</span>
              <span class="bp">self</span><span class="o">.</span><span class="n">end_headers</span><span class="p">()</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">e</span>  <span class="p">:</span>
              <span class="k">pass</span>
              <span class="k">print</span> <span class="s">&quot;error27 in send_header &quot;</span><span class="o">+</span><span class="s">&quot; e:&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">)</span>  
              <span class="n">errorQueue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="s">&quot;error27 in send_header &quot;</span><span class="o">+</span><span class="s">&quot; e:&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">)</span>  <span class="p">)</span>   
            <span class="n">upfilecontent</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;upfile&#39;</span><span class="p">)</span>
            <span class="k">print</span> <span class="s">&quot;filecontent&quot;</span><span class="p">,</span> <span class="n">upfilecontent</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

            <span class="k">if</span> <span class="nb">len</span> <span class="p">(</span><span class="n">upfilecontent</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">&gt;</span><span class="mi">10</span><span class="p">:</span>
              <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">wfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;&lt;HTML&gt;POST OK WAIT 2 SECONDS THEN GO BACK TO HOME&lt;BR&gt;&lt;BR&gt;&quot;</span><span class="p">);</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">wfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">upfilecontent</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
              <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">e</span>  <span class="p">:</span>
                <span class="k">pass</span>
                <span class="k">print</span> <span class="s">&quot;error28 in send_header &quot;</span><span class="o">+</span><span class="s">&quot; e:&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">)</span>  
                <span class="n">errorQueue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="s">&quot;error28 in send_header &quot;</span><span class="o">+</span><span class="s">&quot; e:&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">)</span>  <span class="p">)</span>
              <span class="k">try</span><span class="p">:</span>
                <span class="n">file0</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s">&#39;config_files/data.json&#39;</span><span class="p">,</span> <span class="s">&quot;w&quot;</span><span class="p">)</span>
                <span class="n">file0</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">upfilecontent</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">file0</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                <span class="k">global</span> <span class="nb">exit</span>
                <span class="nb">exit</span><span class="o">=</span><span class="mi">1</span>   <span class="c">#reboot the webserver </span>
              <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">e</span>  <span class="p">:</span>
                <span class="k">print</span> <span class="s">&quot;error importing json from user&quot;</span><span class="o">+</span><span class="s">&quot; e:&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">)</span>
                <span class="n">errorQueue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span> <span class="s">&quot;error importing json from user&quot;</span><span class="o">+</span><span class="s">&quot; e:&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">wfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;&lt;HTML&gt;error importing file&lt;BR&gt;&lt;BR&gt;&quot;</span><span class="p">);</span>
            <span class="k">else</span><span class="p">:</span>
              <span class="bp">self</span><span class="o">.</span><span class="n">wfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;&lt;HTML&gt;error importing file&lt;BR&gt;&lt;BR&gt;&quot;</span><span class="p">);</span>




        <span class="k">elif</span> <span class="n">ctype</span> <span class="o">==</span> <span class="s">&#39;application/x-www-form-urlencoded&#39;</span><span class="p">:</span>   <span class="c">#post data from onos web form</span>
            <span class="n">length</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">getheader</span><span class="p">(</span><span class="s">&#39;content-length&#39;</span><span class="p">))</span>
            <span class="n">postvars</span> <span class="o">=</span> <span class="n">cgi</span><span class="o">.</span><span class="n">urlparse</span><span class="o">.</span><span class="n">parse_qs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rfile</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">length</span><span class="p">),</span> <span class="n">keep_blank_values</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            
            <span class="k">print</span> <span class="s">&quot;postvars=&quot;</span>
            <span class="k">print</span> <span class="n">postvars</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">postvars</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
              <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">postvars</span><span class="p">[</span><span class="n">a</span><span class="p">])):</span>
                <span class="k">print</span> <span class="n">postvars</span><span class="p">[</span><span class="n">a</span><span class="p">][</span><span class="n">b</span><span class="p">]</span>
                <span class="k">print</span> <span class="s">&quot;...&quot;</span>
                <span class="n">postvars</span><span class="p">[</span><span class="n">a</span><span class="p">][</span><span class="n">b</span><span class="p">]</span><span class="o">=</span><span class="n">postvars</span><span class="p">[</span><span class="n">a</span><span class="p">][</span><span class="n">b</span><span class="p">]</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s">&quot;utf8&quot;</span><span class="p">,</span><span class="s">&quot;replace&quot;</span><span class="p">)</span>

                <span class="n">postvars</span><span class="p">[</span><span class="n">a</span><span class="p">][</span><span class="n">b</span><span class="p">]</span><span class="o">=</span><span class="n">postvars</span><span class="p">[</span><span class="n">a</span><span class="p">][</span><span class="n">b</span><span class="p">]</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s">&quot;ascii&quot;</span><span class="p">,</span><span class="s">&quot;replace&quot;</span><span class="p">)</span>

                <span class="n">postvars</span><span class="p">[</span><span class="n">a</span><span class="p">][</span><span class="n">b</span><span class="p">]</span><span class="o">=</span><span class="n">postvars</span><span class="p">[</span><span class="n">a</span><span class="p">][</span><span class="n">b</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&quot;?&quot;</span><span class="p">,</span> <span class="s">&quot;_&quot;</span><span class="p">)</span>
                <span class="n">postvars</span><span class="p">[</span><span class="n">a</span><span class="p">][</span><span class="n">b</span><span class="p">]</span><span class="o">=</span><span class="n">postvars</span><span class="p">[</span><span class="n">a</span><span class="p">][</span><span class="n">b</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&quot;.&quot;</span><span class="p">,</span> <span class="s">&quot;_&quot;</span><span class="p">)</span>

                <span class="c">#postvars[a][b]=postvars[a][b].replace(&quot;;&quot;, &quot;_&quot;)                 </span>

                <span class="c">#postvars[a][b]=postvars[a][b].replace(&quot;^&quot;, &quot;_&quot;)</span>
                <span class="c">#postvars[a][b]=postvars[a][b].replace(&quot;!&quot;, &quot;_&quot;)</span>
                <span class="c">#postvars[a][b]=postvars[a][b].replace(&#39;&quot;&#39;, &quot;_&quot;)</span>
                <span class="c">#postvars[a][b]=postvars[a][b].replace(&quot;&#39;&quot;, &quot;_&quot;)</span>
                <span class="c">#postvars[a][b]=postvars[a][b].replace(&quot;/&quot;, &quot;_&quot;)</span>
                <span class="c">#postvars[a][b]=postvars[a][b].replace(&quot;%&quot;, &quot;_&quot;)</span>
                <span class="c">#postvars[a][b]=postvars[a][b].replace(&quot;&amp;&quot;, &quot;_&quot;)</span>
                <span class="c">#postvars[a][b]=postvars[a][b].replace(&#39;:&#39;, &quot;_&quot;)</span>
               <span class="c"># postvars[a][b]=postvars[a][b].replace(&#39;*&#39;, &quot;_&quot;)</span>
                <span class="c">#postvars[a][b]=postvars[a][b].replace(&#39;[&#39;, &quot;_&quot;)</span>
               <span class="c"># postvars[a][b]=postvars[a][b].replace(&#39;]&#39;, &quot;_&quot;)       </span>




 <span class="c">#postvars is a dictionary that contain all the data sended by the user..the keys are each &lt;input&gt;  name..</span>
 <span class="c">#the data are the value of the input </span>

            <span class="n">data_to_update</span><span class="o">=</span><span class="mi">0</span>
            <span class="k">print</span> <span class="s">&quot;POST:&quot;</span>
            <span class="k">print</span> <span class="n">postvars</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>  
<span class="c">#&lt;form action=&quot;&quot; method=&quot;POST&quot;&gt;&lt;input type=&quot;hidden&quot; name=&quot;zone_manager&quot; value=&quot;/setup/zone_manager&quot;&gt;</span>
            <span class="n">location</span><span class="o">=</span><span class="s">&quot;zone_manager&quot;</span>
            <span class="k">if</span> <span class="n">location</span> <span class="ow">in</span> <span class="n">postvars</span><span class="p">:</span>   <span class="c">#if the path is ...</span>
              <span class="n">i</span><span class="o">=</span><span class="mi">0</span>
             
              <span class="k">for</span> <span class="n">room</span> <span class="ow">in</span> <span class="n">zoneDict</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="p">:</span> <span class="c">#for every room..read if the name of the room is being modify from user</span>
                <span class="c"># room=roomList[i]</span>
                 <span class="k">if</span> <span class="p">(</span><span class="n">room</span> <span class="ow">in</span> <span class="n">postvars</span><span class="p">):</span>
                   <span class="c">#print &quot;trovata:&quot;+room</span>
                   <span class="c">#print postvars[room][0]</span>
                   <span class="n">new_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">clear_PostData</span><span class="p">(</span><span class="n">postvars</span><span class="p">[</span><span class="n">room</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span><span class="c">#the new name of the directory</span>
                   <span class="n">new_name</span><span class="o">=</span><span class="n">new_name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&quot;/&quot;</span><span class="p">,</span><span class="s">&quot;_&quot;</span><span class="p">)</span>
                   <span class="k">if</span> <span class="p">((</span><span class="n">new_name</span><span class="o">!=</span><span class="n">default_rename_zone_value</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="n">new_name</span><span class="o">!=</span><span class="n">default_rename_zone_value2</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="n">new_name</span><span class="o">!=</span><span class="n">default_new_zone_value</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="n">new_name</span><span class="o">!=</span><span class="n">room</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="n">postvars</span><span class="p">[</span><span class="n">room</span><span class="p">]</span><span class="o">!=</span><span class="s">&quot; &quot;</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">new_name</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="n">new_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">zoneDict</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span> <span class="p">:</span> <span class="c">#value modified by the user</span>
                     <span class="c">#roomList[i]=name</span>


          

                                 
                     <span class="k">if</span> <span class="p">(</span><span class="n">room</span><span class="o">+</span><span class="s">&quot;_body&quot;</span> <span class="ow">in</span> <span class="n">object_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="p">:</span>
                       <span class="n">object_dict</span><span class="p">[</span><span class="n">new_name</span><span class="o">+</span><span class="s">&quot;_body&quot;</span><span class="p">]</span><span class="o">=</span><span class="n">object_dict</span><span class="p">[</span><span class="n">room</span><span class="o">+</span><span class="s">&quot;_body&quot;</span><span class="p">]</span>  <span class="c">#copy the body object from the old name</span>

                       <span class="n">object_dict</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">room</span><span class="o">+</span><span class="s">&quot;_body&quot;</span><span class="p">,</span><span class="bp">None</span><span class="p">)</span><span class="c">#del object_dict[room+&quot;_body&quot;]         #and delete the old key</span>
                       <span class="k">if</span>  <span class="n">room</span><span class="o">+</span><span class="s">&quot;_body&quot;</span>  <span class="ow">in</span> <span class="n">zoneDict</span><span class="p">[</span><span class="n">room</span><span class="p">][</span><span class="s">&quot;objects&quot;</span><span class="p">]</span> <span class="p">:</span>
                         <span class="k">print</span> <span class="s">&quot;i try to remove the object&quot;</span><span class="o">+</span><span class="n">room</span><span class="o">+</span><span class="s">&quot;_body  from zone&quot;</span><span class="o">+</span><span class="n">room</span>
                         <span class="n">index</span><span class="o">=</span><span class="n">zoneDict</span><span class="p">[</span><span class="n">room</span><span class="p">][</span><span class="s">&quot;objects&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">room</span><span class="o">+</span><span class="s">&quot;_body&quot;</span><span class="p">)</span>   
                         <span class="n">zoneDict</span><span class="p">[</span><span class="n">room</span><span class="p">][</span><span class="s">&quot;objects&quot;</span><span class="p">][</span><span class="n">index</span><span class="p">]</span><span class="o">=</span><span class="n">new_name</span><span class="o">+</span><span class="s">&quot;_body&quot;</span>   <span class="c">#rename the webobj in the room</span>

                       <span class="k">else</span><span class="p">:</span>
                         <span class="k">print</span> <span class="s">&quot;object not removed from zone beacuse not present there&quot;</span>


                       <span class="n">data_to_update</span><span class="o">=</span><span class="mi">1</span>  
                        
                     <span class="n">zoneDict</span><span class="p">[</span><span class="n">new_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">zoneDict</span><span class="p">[</span><span class="n">room</span><span class="p">]</span>   <span class="c">#update the zoneDict with the new key</span>
                     <span class="n">zoneDict</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">room</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>  <span class="c"># del zoneDict[room]            #and delete the old key</span>
                     <span class="c">#except:</span>
                      <span class="c"># print &quot;can&#39;t remove object from object_dict&quot;</span>


                     <span class="k">try</span> <span class="p">:</span> 
                       <span class="c">#os.system(&quot;mv &quot;+baseRoomPath+room+&quot; &quot;+baseRoomPath+new_name)   #rename the directory</span>
                       <span class="k">with</span> <span class="n">lock_bash_cmd</span><span class="p">:</span>
                         <span class="n">subprocess</span><span class="o">.</span><span class="n">check_output</span><span class="p">(</span><span class="s">&quot;mv &quot;</span><span class="o">+</span><span class="n">baseRoomPath</span><span class="o">+</span><span class="n">room</span><span class="o">+</span><span class="s">&quot; &quot;</span><span class="o">+</span><span class="n">baseRoomPath</span><span class="o">+</span><span class="n">new_name</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span><span class="n">close_fds</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>  
                       <span class="n">updateOneRoom</span><span class="p">(</span><span class="n">new_name</span><span class="p">)</span>
                       
                       <span class="k">print</span> <span class="p">(</span><span class="s">&quot;mv &quot;</span><span class="o">+</span><span class="n">room</span><span class="o">+</span><span class="s">&quot; &quot;</span><span class="o">+</span><span class="n">new_name</span><span class="p">)</span> 
                     <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">e</span>  <span class="p">:</span>
                       <span class="k">print</span> <span class="s">&quot;can&#39;t rename directory to&quot;</span><span class="o">+</span><span class="n">new_name</span><span class="o">+</span><span class="s">&quot; e:&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">)</span>

                <span class="c"># i=i+1</span>
              
              <span class="k">if</span> <span class="s">&quot;new_room&quot;</span> <span class="ow">in</span> <span class="n">postvars</span><span class="p">:</span> <span class="c">#the user wants to create a new room </span>
                <span class="k">print</span> <span class="n">postvars</span><span class="p">[</span><span class="s">&quot;new_room&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">new_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">clear_PostData</span><span class="p">(</span><span class="n">postvars</span><span class="p">[</span><span class="s">&quot;new_room&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">new_name</span><span class="o">=</span><span class="n">new_name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&quot;/&quot;</span><span class="p">,</span> <span class="s">&quot;_&quot;</span><span class="p">)</span>
                <span class="c">#print new_name</span>
                <span class="k">if</span><span class="p">((</span><span class="n">new_name</span><span class="o">!=</span><span class="n">default_new_zone_value</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="n">new_name</span><span class="o">!=</span><span class="n">default_rename_zone_value</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="n">new_name</span><span class="o">!=</span><span class="n">default_rename_zone_value2</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">new_name</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)</span><span class="o">&amp;</span><span class="p">((</span><span class="n">new_name</span><span class="p">)</span><span class="o">!=</span><span class="s">&quot; &quot;</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="n">new_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">zoneDict</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span><span class="o">&amp;</span><span class="p">(</span><span class="n">new_name</span><span class="o">+</span><span class="s">&quot;_body&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">object_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="p">)):</span> 
                  <span class="c">#roomList.append(new_name) #create a new room </span>
                  <span class="n">zoneDict</span><span class="p">[</span><span class="n">new_name</span><span class="p">]</span><span class="o">=</span><span class="p">{</span><span class="s">&quot;objects&quot;</span><span class="p">:[],</span><span class="s">&quot;order&quot;</span><span class="p">:</span><span class="nb">len</span><span class="p">(</span><span class="n">zoneDict</span><span class="o">.</span><span class="n">keys</span><span class="p">()),</span><span class="s">&quot;permissions&quot;</span><span class="p">:</span><span class="s">&quot;777&quot;</span><span class="p">,</span><span class="s">&quot;group&quot;</span><span class="p">:[],</span><span class="s">&quot;owner&quot;</span><span class="p">:</span><span class="s">&quot;onos_sys&quot;</span><span class="p">,</span><span class="s">&quot;hidden&quot;</span><span class="p">:</span><span class="mi">0</span><span class="p">}</span>
                  <span class="n">zoneDict</span><span class="p">[</span><span class="n">new_name</span><span class="p">][</span><span class="s">&quot;objects&quot;</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="n">new_name</span><span class="o">+</span><span class="s">&quot;_body&quot;</span><span class="p">]</span>  <span class="c"># modify to update also the webobject dict and list </span>
                  <span class="n">object_dict</span><span class="p">[</span><span class="n">new_name</span><span class="o">+</span><span class="s">&quot;_body&quot;</span><span class="p">]</span><span class="o">=</span><span class="n">newDefaultWebObjBody</span><span class="p">(</span><span class="n">new_name</span><span class="o">+</span><span class="s">&quot;_body&quot;</span><span class="p">)</span> <span class="c">#create a new web_object and insert only his name          </span>
                  <span class="c">#objectList.append(object_dict[new_name+&quot;_body&quot;])</span>
                  <span class="c">#os.system(&quot;mkdir &quot;+baseRoomPath+new_name) </span>
                  <span class="c">#os.system(&quot;cat &quot;+getRoomHtml(new_name,object_dict,&quot;&quot;,zoneDict)+&quot; &gt;&gt; &quot;+baseRoomPath+new_name+&quot;/index.html&quot;)</span>
                  <span class="c">#os.system(&quot;chmod 777 &quot;+new_name)</span>

                  <span class="k">with</span> <span class="n">lock_bash_cmd</span><span class="p">:</span>
                    <span class="n">subprocess</span><span class="o">.</span><span class="n">check_output</span><span class="p">(</span><span class="s">&quot;mkdir &quot;</span><span class="o">+</span><span class="n">baseRoomPath</span><span class="o">+</span><span class="n">new_name</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span><span class="n">close_fds</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>  
                    <span class="n">subprocess</span><span class="o">.</span><span class="n">check_output</span><span class="p">(</span><span class="s">&quot;cat &quot;</span><span class="o">+</span><span class="n">getRoomHtml</span><span class="p">(</span><span class="n">new_name</span><span class="p">,</span><span class="n">object_dict</span><span class="p">,</span><span class="s">&quot;&quot;</span><span class="p">,</span><span class="n">zoneDict</span><span class="p">)</span><span class="o">+</span><span class="s">&quot; &gt;&gt; &quot;</span><span class="o">+</span><span class="n">baseRoomPath</span><span class="o">+</span><span class="n">new_name</span><span class="o">+</span><span class="s">&quot;/index.html&quot;</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span><span class="n">close_fds</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>  
                    <span class="n">subprocess</span><span class="o">.</span><span class="n">check_output</span><span class="p">(</span><span class="s">&quot;chmod 777 &quot;</span><span class="o">+</span><span class="n">new_name</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span><span class="n">close_fds</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>  

                  <span class="n">updateOneRoom</span><span class="p">(</span><span class="n">new_name</span><span class="p">)</span>       
                  <span class="k">print</span> <span class="s">&quot;create a new room&quot;</span><span class="o">+</span><span class="n">new_name</span> 
                  <span class="n">data_to_update</span><span class="o">=</span><span class="mi">1</span>

              <span class="k">print</span> <span class="s">&quot;search in all the zones&quot;</span>
              <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">zoneDict</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="p">:</span>  <span class="c">#banana very slow..</span>

                <span class="k">if</span> <span class="p">(</span><span class="s">&quot;delete_room_&quot;</span><span class="o">+</span><span class="n">a</span><span class="p">)</span> <span class="ow">in</span> <span class="n">postvars</span><span class="p">:</span> 
                  <span class="k">print</span> <span class="s">&quot;delete room:&quot;</span><span class="o">+</span><span class="n">postvars</span><span class="p">[</span><span class="s">&quot;delete_room_&quot;</span><span class="o">+</span><span class="n">a</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                  <span class="k">if</span> <span class="n">postvars</span><span class="p">[</span><span class="s">&quot;delete_room_&quot;</span><span class="o">+</span><span class="n">a</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">==</span><span class="s">&#39;on&#39;</span><span class="p">:</span>
                    <span class="n">delete</span><span class="o">=</span><span class="n">a</span>


                  <span class="c">#  obj_name_list1=zoneDict[a]</span>
                 <span class="c">#   if a+&quot;_body&quot;  in  obj_name_list1:</span>
                 <span class="c">#     print &quot;i try to remove the object &quot;+a+&quot;_body  from the zone&quot;+a</span>
                 <span class="c">#     index=zoneDict[a].index(a+&quot;_body&quot;)</span>
                 <span class="c">#     zoneDict[a].pop(index)</span>

                    <span class="n">zoneDict</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="bp">None</span><span class="p">)</span>
                    <span class="n">object_dict</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">a</span><span class="o">+</span><span class="s">&quot;_body&quot;</span><span class="p">,</span><span class="bp">None</span><span class="p">)</span>  <span class="c"># remove also the web_obj body of the pag from the dict</span>
                    
                    <span class="c">#os.system(&quot;rm &quot;+baseRoomPath+a+&quot;/*&quot;)</span>
                    <span class="c">#os.system(&quot;rmdir &quot;+baseRoomPath+a)</span>
                    <span class="k">with</span> <span class="n">lock_bash_cmd</span><span class="p">:</span>
                      <span class="n">subprocess</span><span class="o">.</span><span class="n">check_output</span><span class="p">(</span><span class="s">&quot;rm &quot;</span><span class="o">+</span><span class="n">baseRoomPath</span><span class="o">+</span><span class="n">a</span><span class="o">+</span><span class="s">&quot;/*&quot;</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span><span class="n">close_fds</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>  
                      <span class="n">subprocess</span><span class="o">.</span><span class="n">check_output</span><span class="p">(</span><span class="s">&quot;rmdir &quot;</span><span class="o">+</span><span class="n">baseRoomPath</span><span class="o">+</span><span class="n">a</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span><span class="n">close_fds</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>  
                    <span class="n">data_to_update</span><span class="o">=</span><span class="mi">1</span>
  




              <span class="n">postvars</span> <span class="o">=</span> <span class="p">{}</span> 
              
              <span class="n">pag</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_zone_manager</span><span class="p">(</span><span class="n">zoneDict</span><span class="p">)</span>  
              <span class="k">try</span><span class="p">:</span>        
                <span class="bp">self</span><span class="o">.</span><span class="n">send_response</span><span class="p">(</span><span class="mi">200</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">send_header</span><span class="p">(</span><span class="s">&#39;Content-type&#39;</span><span class="p">,</span>	<span class="s">&#39;text/html&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">end_headers</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">wfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">pag</span><span class="p">)</span>  
              <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">e</span>  <span class="p">:</span>
                <span class="k">pass</span>
                <span class="k">print</span> <span class="s">&quot;error29 in send_header &quot;</span><span class="o">+</span><span class="s">&quot; e:&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">)</span> 
                <span class="n">errorQueue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="s">&quot;error29 in send_header &quot;</span><span class="o">+</span><span class="s">&quot; e:&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">)</span>  <span class="p">)</span>      
              <span class="c">#updateJson( object_dict,zoneDict)</span>
              <span class="n">updateDir</span><span class="p">()</span>     
     






            <span class="k">if</span> <span class="s">&quot;zone_objects_setup&quot;</span> <span class="ow">in</span> <span class="n">postvars</span><span class="p">:</span>   <span class="c">#   to add or remove objects to a zone </span>
              
              
              <span class="n">zone</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">clear_PostData</span><span class="p">(</span><span class="n">postvars</span><span class="p">[</span><span class="s">&quot;zone_objects_setup&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
              <span class="k">print</span> <span class="s">&quot;zone_objects_setup page send a post to mode zone&quot;</span><span class="o">+</span><span class="n">zone</span>
              
              <span class="n">obj_name_list</span><span class="o">=</span><span class="n">zoneDict</span><span class="p">[</span><span class="n">zone</span><span class="p">][</span><span class="s">&quot;objects&quot;</span><span class="p">]</span>


              <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span>  <span class="n">object_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="c">#a=b.replace(&quot;_sl_obj_room&quot;,&quot;&quot;)</span>
                

                <span class="k">if</span> <span class="p">(</span><span class="mi">1</span><span class="p">):</span>
                  <span class="k">if</span> <span class="p">(</span><span class="n">a</span><span class="o">+</span><span class="s">&quot;_sl_obj_room&quot;</span> <span class="ow">in</span> <span class="n">postvars</span><span class="p">):</span> 
                  
                    <span class="k">if</span> <span class="p">(</span><span class="n">postvars</span><span class="p">[</span><span class="n">a</span><span class="o">+</span><span class="s">&quot;_sl_obj_room&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">==</span><span class="s">&#39;on&#39;</span><span class="p">):</span>
                      <span class="k">if</span> <span class="n">a</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">obj_name_list</span><span class="p">:</span>
                        <span class="k">print</span> <span class="s">&quot;add obj to zone :&quot;</span><span class="o">+</span><span class="n">a</span>
                        <span class="n">zoneDict</span><span class="p">[</span><span class="n">zone</span><span class="p">][</span><span class="s">&quot;objects&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>   <span class="c">#add the </span>
                    <span class="k">else</span><span class="p">:</span><span class="c"># not checked , so remove the  object from the zone if it is there</span>
                      <span class="k">if</span> <span class="n">a</span> <span class="ow">in</span>  <span class="n">obj_name_list</span><span class="p">:</span> 
                        <span class="k">print</span> <span class="s">&quot;i try to remove the object &quot;</span><span class="o">+</span><span class="n">a</span><span class="o">+</span><span class="s">&quot;from the zone&quot;</span><span class="o">+</span><span class="n">zone</span>
                        <span class="n">index</span><span class="o">=</span><span class="n">zoneDict</span><span class="p">[</span><span class="n">zone</span><span class="p">][</span><span class="s">&quot;objects&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
                        <span class="n">zoneDict</span><span class="p">[</span><span class="n">zone</span><span class="p">][</span><span class="s">&quot;objects&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>

                  <span class="k">else</span><span class="p">:</span> <span class="c"># not checked , so remove the  object from the zone if it is there</span>
                  
                    <span class="k">if</span> <span class="n">a</span> <span class="ow">in</span>  <span class="n">obj_name_list</span><span class="p">:</span>
                      <span class="k">print</span> <span class="s">&quot;i try to remove the object &quot;</span><span class="o">+</span><span class="n">a</span><span class="o">+</span><span class="s">&quot;from the zone&quot;</span><span class="o">+</span><span class="n">zone</span>
                      <span class="n">index</span><span class="o">=</span><span class="n">zoneDict</span><span class="p">[</span><span class="n">zone</span><span class="p">][</span><span class="s">&quot;objects&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
                      <span class="n">zoneDict</span><span class="p">[</span><span class="n">zone</span><span class="p">][</span><span class="s">&quot;objects&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>




              <span class="k">if</span> <span class="p">(</span><span class="s">&quot;new_objects&quot;</span> <span class="ow">in</span> <span class="n">postvars</span><span class="p">):</span>
                <span class="n">new_obj0</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">clear_PostData</span><span class="p">(</span><span class="n">postvars</span><span class="p">[</span><span class="s">&quot;new_objects&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
                 
                <span class="n">new_obj</span><span class="o">=</span><span class="n">new_obj0</span><span class="o">+</span><span class="s">&#39;_p_&#39;</span><span class="o">+</span><span class="n">zone</span>
                <span class="k">if</span>  <span class="p">(</span> <span class="p">(</span><span class="n">new_obj0</span> <span class="o">!=</span><span class="s">&quot;TYPE_NEW_OBJECT_HERE&quot;</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="n">new_obj</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">object_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span><span class="o">&amp;</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">new_obj</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="n">new_obj</span><span class="o">!=</span><span class="s">&quot; &quot;</span><span class="p">)</span>   <span class="p">):</span>           
                  <span class="n">object_dict</span><span class="p">[</span><span class="n">new_obj</span><span class="p">]</span><span class="o">=</span><span class="n">newDefaultWebObj</span><span class="p">(</span><span class="n">new_obj</span><span class="p">)</span> <span class="c">#create a new object and insert it in the dictionary  </span>
                  <span class="n">zoneDict</span><span class="p">[</span><span class="n">zone</span><span class="p">][</span><span class="s">&quot;objects&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_obj</span><span class="p">)</span>   <span class="c">#add the object name to the zone</span>


              <span class="n">postvars</span><span class="o">=</span><span class="p">{}</span>
              <span class="n">updateOneRoom</span><span class="p">(</span><span class="n">zone</span><span class="p">)</span><span class="c">#to update the zone with the new objects</span>

              <span class="n">webpag</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_Zone_Objects_Setup</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">,</span><span class="n">object_dict</span><span class="p">,</span><span class="n">zone</span><span class="p">)</span>
              <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">send_response</span><span class="p">(</span><span class="mi">200</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">send_header</span><span class="p">(</span><span class="s">&#39;Content-type&#39;</span><span class="p">,</span>	<span class="s">&#39;text/html&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">end_headers</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">wfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">webpag</span><span class="p">)</span>     
              <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">e</span>  <span class="p">:</span>
                <span class="k">pass</span>
                <span class="k">print</span> <span class="s">&quot;error30 in send_header &quot;</span><span class="o">+</span><span class="s">&quot; e:&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">)</span>  
                <span class="n">errorQueue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="s">&quot;error30 in send_header &quot;</span><span class="o">+</span><span class="s">&quot; e:&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">)</span>   <span class="p">)</span>




            <span class="k">if</span> <span class="s">&quot;objs_manager&quot;</span> <span class="ow">in</span> <span class="n">postvars</span><span class="p">:</span>
              <span class="n">objs_manager</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">clear_PostData</span><span class="p">(</span><span class="n">postvars</span><span class="p">[</span><span class="s">&quot;objs_manager&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
              <span class="k">print</span> <span class="s">&quot;objs_manager&quot;</span><span class="o">+</span><span class="n">objs_manager</span>
              <span class="n">q</span><span class="o">=</span><span class="s">&quot;new_web_object&quot;</span>
              <span class="k">if</span> <span class="n">q</span> <span class="ow">in</span> <span class="n">postvars</span><span class="p">:</span>   
                <span class="n">new_obj</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">clear_PostData</span><span class="p">(</span><span class="n">postvars</span><span class="p">[</span><span class="n">q</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
                <span class="k">print</span> <span class="s">&quot;try to create a new webobj&quot;</span><span class="o">+</span><span class="n">new_obj</span>
                <span class="k">if</span><span class="p">((</span><span class="n">new_obj</span><span class="o">!=</span><span class="n">default_new_obj_value</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="n">new_obj</span><span class="o">!=</span><span class="n">default_new_obj_value2</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">new_obj</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)</span><span class="o">&amp;</span><span class="p">((</span><span class="n">new_obj</span><span class="p">)</span><span class="o">!=</span><span class="s">&quot; &quot;</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span>  <span class="n">new_obj</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">object_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="p">)</span> <span class="p">):</span> 
                  <span class="n">object_dict</span><span class="p">[</span><span class="n">new_obj</span><span class="p">]</span><span class="o">=</span><span class="n">newDefaultWebObj</span><span class="p">(</span><span class="n">new_obj</span><span class="p">)</span> <span class="c">#create a new web_object and insert only his name </span>
                 <span class="c"># objectList.append(object_dict[new_obj])</span>
                  <span class="k">print</span> <span class="s">&quot;created a new web object &quot;</span><span class="o">+</span><span class="n">object_dict</span><span class="p">[</span><span class="n">new_obj</span><span class="p">]</span><span class="o">.</span><span class="n">getName</span><span class="p">()</span> 
                  <span class="n">data_to_update</span><span class="o">=</span><span class="mi">1</span>  
                  
              <span class="n">postvars</span> <span class="o">=</span> <span class="p">{}</span>
              <span class="n">pag</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_WebOjectManager</span><span class="p">(</span><span class="n">object_dict</span><span class="p">)</span>
              <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">send_response</span><span class="p">(</span><span class="mi">200</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">send_header</span><span class="p">(</span><span class="s">&#39;Content-type&#39;</span><span class="p">,</span>	<span class="s">&#39;text/html&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">end_headers</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">wfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">pag</span><span class="p">)</span>  
              <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">e</span>  <span class="p">:</span>
                <span class="k">pass</span>
                <span class="k">print</span> <span class="s">&quot;error31 in send_header &quot;</span><span class="o">+</span><span class="s">&quot; e:&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">)</span>  
                <span class="n">errorQueue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span> <span class="s">&quot;error31 in send_header &quot;</span><span class="o">+</span><span class="s">&quot; e:&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">))</span>
              <span class="c">#updateJson( object_dict,zoneDict)      </span>

            <span class="k">if</span> <span class="s">&quot;current_room&quot;</span> <span class="ow">in</span> <span class="n">postvars</span><span class="p">:</span><span class="c">#if the current location is /setup/AnyRoomName  because &quot;current_room&quot;  is a post of that page</span>
              <span class="n">currentRoom</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">clear_PostData</span><span class="p">(</span><span class="n">postvars</span><span class="p">[</span><span class="s">&quot;current_room&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
              <span class="n">q</span><span class="o">=</span><span class="s">&quot;new_web_object&quot;</span>
              <span class="k">if</span> <span class="n">q</span> <span class="ow">in</span> <span class="n">postvars</span><span class="p">:</span>   
                <span class="n">new_obj</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">clear_PostData</span><span class="p">(</span><span class="n">postvars</span><span class="p">[</span><span class="n">q</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>

                <span class="k">if</span><span class="p">((</span><span class="n">new_obj</span><span class="o">!=</span><span class="n">default_new_obj_value</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="n">new_obj</span><span class="o">!=</span><span class="n">default_new_obj_value2</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">new_obj</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)</span><span class="o">&amp;</span><span class="p">((</span><span class="n">new_obj</span><span class="p">)</span><span class="o">!=</span><span class="s">&quot; &quot;</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span>  <span class="n">new_obj</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">object_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="p">)</span> <span class="p">):</span> 
                  <span class="n">object_dict</span><span class="p">[</span><span class="n">new_obj</span><span class="p">]</span><span class="o">=</span><span class="n">newDefaultWebObj</span><span class="p">(</span><span class="n">new_obj</span><span class="p">)</span> <span class="c">#create a new web_object and insert only his name </span>

                 <span class="c"># objectList.append(object_dict[new_obj])</span>
                  <span class="k">print</span> <span class="s">&quot;created a new web object &quot;</span><span class="o">+</span><span class="n">object_dict</span><span class="p">[</span><span class="n">new_obj</span><span class="p">]</span><span class="o">.</span><span class="n">getName</span><span class="p">()</span> 
                  <span class="n">data_to_update</span><span class="o">=</span><span class="mi">1</span>  
                  
              
              <span class="n">base_rm</span><span class="o">=</span><span class="s">&quot;rm_obj_&quot;</span>
              <span class="n">end_rm</span><span class="o">=</span><span class="s">&quot;_from_&quot;</span><span class="o">+</span><span class="n">currentRoom</span>
              <span class="c">#enabledToWrite=0  #tell the system if the textarea html has to be ignored or written to the file</span>

              <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">postvars</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="p">:</span>
                <span class="k">print</span> <span class="s">&quot;postvars=&quot;</span>
                <span class="k">print</span> <span class="n">postvars</span><span class="p">[</span><span class="n">a</span><span class="p">]</span>
                
                <span class="k">if</span> <span class="p">((</span><span class="n">string</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="s">&quot;add_obj_to_room&quot;</span><span class="p">)</span><span class="o">!=-</span><span class="mi">1</span><span class="p">)</span><span class="o">&amp;</span><span class="p">((</span><span class="n">postvars</span><span class="p">[</span><span class="n">a</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span> <span class="ow">in</span> <span class="n">object_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span><span class="o">&amp;</span><span class="p">(</span><span class="n">postvars</span><span class="p">[</span><span class="n">a</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="ow">not</span> <span class="ow">in</span> <span class="n">zoneDict</span><span class="p">[</span><span class="n">currentRoom</span><span class="p">][</span><span class="s">&quot;objects&quot;</span><span class="p">]</span>  <span class="p">)):</span>  <span class="c">#add a obj to the room</span>
                  <span class="n">zoneDict</span><span class="p">[</span><span class="n">currentRoom</span><span class="p">][</span><span class="s">&quot;objects&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">postvars</span><span class="p">[</span><span class="n">a</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
                  <span class="n">updateOneRoom</span><span class="p">(</span><span class="n">currentRoom</span><span class="p">)</span>
                  <span class="c">#html_to_write=getRoomHtml(currentRoom,object_dict,&quot;&quot;,zoneDict)</span>
                  <span class="c">#file0 = open(currentRoom+&quot;/index.html&quot;, &quot;w&quot;)</span>
                  <span class="c">#file0.write(html_to_write) </span>
                  <span class="c">#file0.close()</span>

                  <span class="k">print</span> <span class="s">&quot;found a add_obj post&quot;</span>
                   
                <span class="k">print</span> <span class="s">&quot;room list&quot;</span>
                <span class="k">print</span> <span class="n">zoneDict</span><span class="p">[</span><span class="n">currentRoom</span><span class="p">][</span><span class="s">&quot;objects&quot;</span><span class="p">]</span> 
                
                <span class="k">if</span> <span class="p">(</span><span class="n">string</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="s">&quot;rm_obj_&quot;</span><span class="p">)</span><span class="o">!=-</span><span class="mi">1</span><span class="p">)</span><span class="o">&amp;</span><span class="p">((</span><span class="n">postvars</span><span class="p">[</span><span class="n">a</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span> <span class="ow">in</span> <span class="n">zoneDict</span><span class="p">[</span><span class="n">currentRoom</span><span class="p">][</span><span class="s">&quot;objects&quot;</span><span class="p">]</span>  <span class="p">):</span>  <span class="c">#remove obj from the room</span>
                  <span class="n">index</span><span class="o">=</span><span class="n">zoneDict</span><span class="p">[</span><span class="n">currentRoom</span><span class="p">][</span><span class="s">&quot;objects&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">postvars</span><span class="p">[</span><span class="n">a</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
                  <span class="n">zoneDict</span><span class="p">[</span><span class="n">currentRoom</span><span class="p">][</span><span class="s">&quot;objects&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>
                  <span class="k">print</span> <span class="s">&quot;found a rm_obj post&quot;</span>
                  <span class="k">print</span> <span class="s">&quot;now the room is this&quot;</span>
                  <span class="k">print</span> <span class="n">zoneDict</span><span class="p">[</span><span class="n">currentRoom</span><span class="p">][</span><span class="s">&quot;objects&quot;</span><span class="p">]</span>
                  <span class="n">data_to_update</span><span class="o">=</span><span class="mi">1</span>  
                <span class="k">else</span><span class="p">:</span>
                  <span class="k">print</span> <span class="s">&quot;error obj to remove not found &quot;</span>
                  <span class="n">errorQueue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="s">&quot;error obj to remove not found &quot;</span> <span class="p">)</span>
                <span class="c">#updateOneRoom(currentRoom)           </span>
              <span class="k">if</span> <span class="n">data_to_update</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>    <span class="c">#update the html removing the webobj removed by the form </span>
                <span class="n">html_to_write</span><span class="o">=</span><span class="n">getRoomHtml</span><span class="p">(</span><span class="n">currentRoom</span><span class="p">,</span><span class="n">object_dict</span><span class="p">,</span><span class="s">&quot;&quot;</span><span class="p">,</span><span class="n">zoneDict</span><span class="p">)</span>
               <span class="c"># file0 = open(baseRoomPath+currentRoom+&quot;/index.html&quot;, &quot;w&quot;)</span>
               <span class="c"># file0.write(html_to_write) </span>
               <span class="c"># file0.close()</span>
                <span class="n">data_to_update</span><span class="o">=</span><span class="mi">0</span>
                <span class="k">print</span> <span class="s">&quot;object removed from html&quot;</span>

              <span class="n">postvars</span> <span class="o">=</span> <span class="p">{}</span>               
              <span class="c">#print &quot;actual room: &quot;+currentRoom</span>
              
              <span class="n">pag</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_RoomObjectList</span><span class="p">(</span><span class="n">currentRoom</span><span class="p">,</span><span class="n">object_dict</span><span class="p">)</span>  
              <span class="k">try</span><span class="p">:</span> 
                <span class="bp">self</span><span class="o">.</span><span class="n">send_response</span><span class="p">(</span><span class="mi">200</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">send_header</span><span class="p">(</span><span class="s">&#39;Content-type&#39;</span><span class="p">,</span>	<span class="s">&#39;text/html&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">end_headers</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">wfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">pag</span><span class="p">)</span>  
              <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">e</span>  <span class="p">:</span>
                <span class="k">pass</span>
                <span class="k">print</span> <span class="s">&quot;error32 in send_header &quot;</span><span class="o">+</span><span class="s">&quot; e:&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">)</span>  
                <span class="n">errorQueue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="s">&quot;error32 in send_header &quot;</span><span class="o">+</span><span class="s">&quot; e:&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">)</span> <span class="p">)</span>
              <span class="c">#updateJson( object_dict,zoneDict)</span>
              <span class="c">#updateOneRoom(currentRoom)        </span>
              

     
            <span class="k">if</span> <span class="s">&quot;current_room_text_area&quot;</span> <span class="ow">in</span> <span class="n">postvars</span><span class="p">:</span>
              <span class="n">currentRoom</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">clear_PostData</span><span class="p">(</span><span class="n">postvars</span><span class="p">[</span><span class="s">&quot;current_room_text_area&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
              <span class="n">new_html_room</span><span class="o">=</span><span class="n">postvars</span><span class="p">[</span><span class="s">&quot;html_room_mod&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
              <span class="k">print</span> <span class="s">&quot;new_html_room=&quot;</span><span class="o">+</span><span class="n">new_html_room</span>

              <span class="k">print</span> <span class="s">&quot;currentroom_modhtm=&quot;</span><span class="o">+</span><span class="n">currentRoom</span>
              <span class="c">#updateOneRoom(currentRoom)</span>
              <span class="n">html_to_write</span><span class="o">=</span><span class="n">modPage</span><span class="p">(</span><span class="n">new_html_room</span><span class="p">,</span><span class="n">object_dict</span><span class="p">,</span><span class="n">currentRoom</span><span class="p">,</span><span class="n">zoneDict</span><span class="p">)</span>
              <span class="k">print</span> <span class="s">&quot;html wrote to the file &quot;</span><span class="o">+</span><span class="n">currentRoom</span><span class="o">+</span><span class="s">&quot;/index.html=&quot;</span><span class="o">+</span><span class="n">html_to_write</span>
              <span class="k">print</span> <span class="s">&quot;correction..not wrote because commented part&quot;</span>
              <span class="c">#file0 = open(baseRoomPath+currentRoom+&quot;/index.html&quot;, &quot;w&quot;)</span>
              <span class="c">#file0.write(html_to_write) </span>
              <span class="c">#file0.close()</span>
              <span class="n">postvars</span> <span class="o">=</span> <span class="p">{}</span>
              <span class="n">pag</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_RoomObjectList</span><span class="p">(</span><span class="n">currentRoom</span><span class="p">,</span><span class="n">object_dict</span><span class="p">)</span>  
              <span class="k">try</span><span class="p">:</span> 
                <span class="bp">self</span><span class="o">.</span><span class="n">send_response</span><span class="p">(</span><span class="mi">200</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">send_header</span><span class="p">(</span><span class="s">&#39;Content-type&#39;</span><span class="p">,</span>	<span class="s">&#39;text/html&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">end_headers</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">wfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">pag</span><span class="p">)</span>   
              <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">e</span>  <span class="p">:</span>
                <span class="k">pass</span>
                <span class="k">print</span> <span class="s">&quot;error33 in send_header &quot;</span><span class="o">+</span><span class="s">&quot; e:&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">)</span>  
                <span class="n">errorQueue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="s">&quot;error33 in send_header &quot;</span><span class="o">+</span><span class="s">&quot; e:&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">)</span>  <span class="p">)</span>
              <span class="c">#updateJson( object_dict,zoneDict)</span>



            <span class="k">if</span> <span class="s">&quot;mod_object&quot;</span> <span class="ow">in</span> <span class="n">postvars</span><span class="p">:</span><span class="c">#if the current page is /setup/AnyRoomName/Anywebobject  because &quot;mod_object&quot;  is a post of that page     </span>
              <span class="k">print</span> <span class="s">&quot;found a mod_object request with path&quot;</span>
              <span class="n">path</span><span class="o">=</span><span class="n">postvars</span><span class="p">[</span><span class="s">&quot;mod_object&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
              <span class="k">print</span> <span class="n">path</span>
              <span class="n">web_object_name</span><span class="o">=</span><span class="n">string</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">path</span><span class="p">,</span><span class="s">&quot;/&quot;</span><span class="p">)[</span><span class="mi">3</span><span class="p">]</span>  <span class="c">#split the path in a list of string  </span>
              <span class="k">print</span> <span class="s">&quot;modify the web object:&quot;</span><span class="o">+</span><span class="n">web_object_name</span>
              <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">postvars</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="p">:</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">postvars</span><span class="p">[</span><span class="s">&quot;obj_notes&quot;</span><span class="p">]</span><span class="o">!=</span><span class="n">notes</span><span class="p">):</span>
                  <span class="n">object_dict</span><span class="p">[</span><span class="n">web_object_name</span><span class="p">]</span><span class="o">.</span><span class="n">setNotes</span><span class="p">(</span><span class="n">postvars</span><span class="p">[</span><span class="s">&quot;obj_notes&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>


                <span class="k">if</span> <span class="p">(</span><span class="n">postvars</span><span class="p">[</span><span class="s">&quot;obj_hardware_pin&quot;</span><span class="p">]</span><span class="o">!=</span><span class="n">no_pin_selected</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">postvars</span><span class="p">[</span><span class="s">&quot;obj_hardware_pin&quot;</span><span class="p">])</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">):</span>
                  <span class="k">try</span><span class="p">:</span>
                    <span class="n">object_dict</span><span class="p">[</span><span class="n">web_object_name</span><span class="p">]</span><span class="o">.</span><span class="n">setAttachedPin</span><span class="p">(</span><span class="nb">int</span> <span class="p">(</span><span class="n">postvars</span><span class="p">[</span><span class="s">&quot;obj_hardware_pin&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]))</span>
                  <span class="k">except</span><span class="p">:</span>
                    <span class="n">object_dict</span><span class="p">[</span><span class="n">web_object_name</span><span class="p">]</span><span class="o">.</span><span class="n">setAttachedPin</span><span class="p">(</span><span class="mi">9999</span><span class="p">)</span>


               <span class="c"># if (postvars[&quot;obj_type&quot;]!=object_dict[web_object_name].getType()):</span>
               <span class="c">#   changeWebObjectType(web_object_name,postvars[&quot;obj_type&quot;][0])</span>
                  <span class="c">#object_dict[web_object_name].setType(postvars[&quot;obj_type&quot;][0])</span>
                  

                <span class="k">if</span> <span class="p">(</span><span class="n">postvars</span><span class="p">[</span><span class="s">&quot;obj_current_status&quot;</span><span class="p">]</span><span class="o">!=</span><span class="nb">int</span> <span class="p">(</span><span class="n">object_dict</span><span class="p">[</span><span class="n">web_object_name</span><span class="p">]</span><span class="o">.</span><span class="n">getStatus</span><span class="p">())):</span>

                  <span class="c">#object_dict[web_object_name].setStatus(int(postvars[&quot;obj_current_status&quot;][0]))</span>
                  <span class="n">changeWebObjectStatus</span><span class="p">(</span><span class="n">web_object_name</span><span class="p">,</span><span class="nb">int</span> <span class="p">(</span><span class="n">postvars</span><span class="p">[</span><span class="s">&quot;obj_current_status&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]),</span><span class="mi">1</span><span class="p">)</span><span class="c">#banana add to queue</span>



                <span class="k">if</span> <span class="p">(</span><span class="n">postvars</span><span class="p">[</span><span class="s">&quot;obj_style0&quot;</span><span class="p">]</span><span class="o">!=</span><span class="n">style0</span><span class="p">):</span>
                  <span class="n">object_dict</span><span class="p">[</span><span class="n">web_object_name</span><span class="p">]</span><span class="o">.</span><span class="n">setStyle0</span><span class="p">(</span><span class="n">postvars</span><span class="p">[</span><span class="s">&quot;obj_style0&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>

                <span class="k">if</span> <span class="p">(</span><span class="n">postvars</span><span class="p">[</span><span class="s">&quot;obj_style1&quot;</span><span class="p">]</span><span class="o">!=</span><span class="n">style1</span><span class="p">):</span>
                  <span class="n">object_dict</span><span class="p">[</span><span class="n">web_object_name</span><span class="p">]</span><span class="o">.</span><span class="n">setStyle1</span><span class="p">(</span><span class="n">postvars</span><span class="p">[</span><span class="s">&quot;obj_style1&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>

                <span class="k">if</span> <span class="p">(</span><span class="n">postvars</span><span class="p">[</span><span class="s">&quot;obj_html0&quot;</span><span class="p">]</span><span class="o">!=</span><span class="n">html0</span><span class="p">):</span>
                  <span class="n">object_dict</span><span class="p">[</span><span class="n">web_object_name</span><span class="p">]</span><span class="o">.</span><span class="n">setHtml0</span><span class="p">(</span><span class="n">postvars</span><span class="p">[</span><span class="s">&quot;obj_html0&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>

                <span class="k">if</span> <span class="p">(</span><span class="n">postvars</span><span class="p">[</span><span class="s">&quot;obj_html1&quot;</span><span class="p">]</span><span class="o">!=</span><span class="n">html1</span><span class="p">):</span>
                  <span class="n">object_dict</span><span class="p">[</span><span class="n">web_object_name</span><span class="p">]</span><span class="o">.</span><span class="n">setHtml1</span><span class="p">(</span><span class="n">postvars</span><span class="p">[</span><span class="s">&quot;obj_html1&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>


                <span class="k">if</span> <span class="p">(</span><span class="n">postvars</span><span class="p">[</span><span class="s">&quot;obj_cmd0&quot;</span><span class="p">]</span><span class="o">!=</span><span class="s">&quot; &quot;</span><span class="p">):</span>
                  <span class="n">object_dict</span><span class="p">[</span><span class="n">web_object_name</span><span class="p">]</span><span class="o">.</span><span class="n">setCommand0</span><span class="p">(</span><span class="n">formParse</span><span class="p">(</span><span class="n">postvars</span><span class="p">[</span><span class="s">&quot;obj_cmd0&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]))</span>

                <span class="k">if</span> <span class="p">(</span><span class="n">postvars</span><span class="p">[</span><span class="s">&quot;obj_cmd1&quot;</span><span class="p">]</span><span class="o">!=</span><span class="s">&quot; &quot;</span><span class="p">):</span>
                  <span class="n">object_dict</span><span class="p">[</span><span class="n">web_object_name</span><span class="p">]</span><span class="o">.</span><span class="n">setCommand1</span><span class="p">(</span><span class="n">formParse</span><span class="p">(</span><span class="n">postvars</span><span class="p">[</span><span class="s">&quot;obj_cmd1&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]))</span>


                <span class="k">if</span> <span class="p">(</span><span class="n">postvars</span><span class="p">[</span><span class="s">&quot;obj_init_cmd&quot;</span><span class="p">]</span><span class="o">!=</span><span class="s">&quot; &quot;</span><span class="p">):</span>
                  <span class="n">object_dict</span><span class="p">[</span><span class="n">web_object_name</span><span class="p">]</span><span class="o">.</span><span class="n">setInitCommand</span><span class="p">(</span><span class="n">formParse</span><span class="p">(</span><span class="n">postvars</span><span class="p">[</span><span class="s">&quot;obj_init_cmd&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]))</span>
                  <span class="n">object_dict</span><span class="p">[</span><span class="n">web_object_name</span><span class="p">]</span><span class="o">.</span><span class="n">InitFunction</span><span class="p">()</span>  <span class="c">#execute the new init command</span>

              <span class="n">postvars</span> <span class="o">=</span> <span class="p">{}</span>
              <span class="n">data_to_update</span><span class="o">=</span><span class="mi">1</span> 
              <span class="n">pag</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_WebObjForm</span><span class="p">(</span><span class="n">object_dict</span><span class="p">[</span><span class="n">web_object_name</span><span class="p">])</span>
              <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">send_response</span><span class="p">(</span><span class="mi">200</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">send_header</span><span class="p">(</span><span class="s">&#39;Content-type&#39;</span><span class="p">,</span>	<span class="s">&#39;text/html&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">end_headers</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">wfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">pag</span><span class="p">)</span> 
              <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">e</span>  <span class="p">:</span>
                <span class="k">pass</span>
                <span class="k">print</span> <span class="s">&quot;error34 in send_header &quot;</span><span class="o">+</span><span class="s">&quot; e:&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">)</span>  
                <span class="n">errorQueue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span> <span class="s">&quot;error34 in send_header &quot;</span><span class="o">+</span><span class="s">&quot; e:&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">))</span>
              <span class="c">#updateJson( object_dict,zoneDict)</span>
              <span class="n">updateDir</span><span class="p">()</span>
                



            <span class="k">if</span> <span class="s">&quot;new_scenario&quot;</span> <span class="ow">in</span> <span class="n">postvars</span><span class="p">:</span><span class="c">#if the current page is /scenarios_list/  because &quot;new_scenario&quot;  is the hidden form name</span>
            <span class="c">#&lt;input type=&quot;hidden&quot; name=&quot;new_scenario&quot; value=&quot;/scenarios_list/&quot;&gt;</span>

              <span class="n">pag</span><span class="o">=</span><span class="s">&quot;&quot;</span>
              <span class="k">if</span> <span class="p">(</span><span class="n">postvars</span><span class="p">[</span><span class="s">&quot;new_scenario_name&quot;</span><span class="p">]</span><span class="o">!=</span><span class="s">&quot; &quot;</span><span class="p">):</span>
                <span class="n">new_scenario_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">clear_PostData</span><span class="p">(</span><span class="n">postvars</span><span class="p">[</span><span class="s">&quot;new_scenario_name&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">new_scenario_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">scenarioDict</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span> <span class="c">#if scenario name doesn&#39;t exist already</span>
                  <span class="n">scenarioDict</span><span class="p">[</span><span class="n">new_scenario_name</span><span class="p">]</span><span class="o">=</span><span class="p">{</span><span class="s">&quot;enabled&quot;</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span><span class="s">&quot;type_after_run&quot;</span><span class="p">:</span><span class="s">&quot;0&quot;</span><span class="p">,</span><span class="s">&quot;conditions&quot;</span><span class="p">:</span><span class="s">&quot;0&quot;</span><span class="p">,</span><span class="s">&quot;functionsToRun&quot;</span><span class="p">:[],</span><span class="s">&quot;delayTime&quot;</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span><span class="s">&quot;priority&quot;</span><span class="p">:</span><span class="mi">0</span><span class="p">}</span>
                  <span class="bp">self</span><span class="o">.</span><span class="n">send_response</span><span class="p">(</span><span class="mi">301</span><span class="p">)</span>
                  <span class="bp">self</span><span class="o">.</span><span class="n">send_header</span><span class="p">(</span><span class="s">&#39;Location&#39;</span><span class="p">,</span><span class="s">&#39;/mod_scenario/&#39;</span><span class="o">+</span><span class="n">new_scenario_name</span><span class="o">+</span><span class="s">&#39;/&#39;</span><span class="p">)</span>
                  <span class="bp">self</span><span class="o">.</span><span class="n">end_headers</span><span class="p">()</span>

                  <span class="k">return</span>



            <span class="k">if</span> <span class="s">&quot;delete_scenario&quot;</span> <span class="ow">in</span> <span class="n">postvars</span><span class="p">:</span><span class="c">#</span>

              <span class="k">if</span><span class="p">(</span><span class="n">postvars</span><span class="p">[</span><span class="s">&quot;delete_scenario&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">!=</span><span class="s">&quot; &quot;</span><span class="p">):</span>

                <span class="k">print</span> <span class="s">&quot;received delete_scenario&quot;</span> <span class="p">,</span> <span class="n">postvars</span><span class="p">[</span><span class="s">&quot;delete_scenario&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>

                <span class="n">del_scenario_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">clear_PostData</span><span class="p">(</span><span class="n">postvars</span><span class="p">[</span><span class="s">&quot;delete_scenario&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">del_scenario_name</span> <span class="ow">in</span> <span class="n">scenarioDict</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span> <span class="c">#if scenario name doesn&#39;t exist  </span>
                
                  <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">object_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span><span class="c">#check and remove the not used scenarios from web_object attachedScenarios</span>
                    <span class="n">tmp_list_scenarios</span><span class="o">=</span><span class="n">object_dict</span><span class="p">[</span><span class="n">a</span><span class="p">]</span><span class="o">.</span><span class="n">getListAttachedScenarios</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">del_scenario_name</span> <span class="ow">in</span> <span class="n">tmp_list_scenarios</span><span class="p">:</span> 
                      <span class="n">object_dict</span><span class="p">[</span><span class="n">a</span><span class="p">]</span><span class="o">.</span><span class="n">removeAttachedScenario</span><span class="p">(</span><span class="n">del_scenario_name</span><span class="p">)</span>
                  <span class="k">del</span> <span class="n">scenarioDict</span><span class="p">[</span><span class="n">del_scenario_name</span><span class="p">]</span>  


                <span class="bp">self</span><span class="o">.</span><span class="n">send_response</span><span class="p">(</span><span class="mi">301</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">send_header</span><span class="p">(</span><span class="s">&#39;Location&#39;</span><span class="p">,</span><span class="s">&#39;/scenarios_list/&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">end_headers</span><span class="p">()</span>
                  

                <span class="k">return</span>
                






            <span class="k">if</span> <span class="s">&quot;mod_scenario&quot;</span> <span class="ow">in</span> <span class="n">postvars</span><span class="p">:</span><span class="c">#if the current page is /mod_scenario/scenario name  because &quot;mod_scenario&quot;  is the hidden form name</span>
            <span class="c">#&lt;input type=&quot;hidden&quot; name=&quot;mod_scenario&quot; value=&quot;/scenarios_list/mod_scenario/&quot;&gt;</span>

              <span class="n">pag</span><span class="o">=</span><span class="s">&quot;&quot;</span>
              <span class="k">if</span> <span class="p">(</span><span class="n">postvars</span><span class="p">[</span><span class="s">&quot;mod_scenario&quot;</span><span class="p">]</span><span class="o">!=</span><span class="s">&quot; &quot;</span><span class="p">):</span>
                <span class="n">scenario_start_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">clear_PostData</span><span class="p">(</span><span class="n">postvars</span><span class="p">[</span><span class="s">&quot;mod_scenario&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span><span class="c">#get the current scenario name </span>

              <span class="k">if</span> <span class="p">(</span><span class="n">postvars</span><span class="p">[</span><span class="s">&quot;new_scenario_name&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">!=</span><span class="s">&quot; &quot;</span><span class="p">):</span>
                <span class="n">scenario_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">clear_PostData</span><span class="p">(</span><span class="n">postvars</span><span class="p">[</span><span class="s">&quot;new_scenario_name&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span><span class="c">#get the current scenario name</span>

                <span class="k">if</span> <span class="n">scenario_start_name</span> <span class="ow">in</span> <span class="n">scenarioDict</span><span class="p">:</span> <span class="c">#if the name exist in the dict</span>
                  <span class="k">if</span> <span class="n">scenario_name</span> <span class="o">!=</span> <span class="n">scenario_start_name</span> <span class="p">:</span>  <span class="c">#the scenario was renamed</span>
                    <span class="k">if</span> <span class="n">scenario_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">scenarioDict</span><span class="p">:</span>
                      <span class="n">scenarioDict</span><span class="p">[</span><span class="n">scenario_name</span><span class="p">]</span><span class="o">=</span><span class="n">scenarioDict</span><span class="p">[</span><span class="n">scenario_start_name</span><span class="p">]</span>
                      <span class="k">del</span> <span class="n">scenarioDict</span><span class="p">[</span><span class="n">scenario_start_name</span><span class="p">]</span>
                      <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">object_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                        <span class="n">object_dict</span><span class="p">[</span><span class="n">obj</span><span class="p">]</span><span class="o">.</span><span class="n">replaceAttachedScenario</span><span class="p">(</span><span class="n">scenario_start_name</span><span class="p">,</span><span class="n">scenario_name</span><span class="p">)</span> <span class="c">#replace the reference in the web object with the new one</span>
                  
                      


                  <span class="k">if</span> <span class="s">&quot;enabling&quot;</span> <span class="ow">in</span> <span class="n">postvars</span><span class="p">:</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">clear_PostData</span><span class="p">(</span><span class="n">postvars</span><span class="p">[</span><span class="s">&quot;enabling&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span><span class="o">==</span><span class="s">&quot;on&quot;</span><span class="p">:</span>
                      <span class="n">scenarioDict</span><span class="p">[</span><span class="n">scenario_name</span><span class="p">][</span><span class="s">&#39;enabled&#39;</span><span class="p">]</span><span class="o">=</span><span class="mi">1</span>
                    <span class="k">else</span><span class="p">:</span>
                      <span class="n">scenarioDict</span><span class="p">[</span><span class="n">scenario_name</span><span class="p">][</span><span class="s">&#39;enabled&#39;</span><span class="p">]</span><span class="o">=</span><span class="mi">0</span> 
                      <span class="c">#print &quot;scenario disabled&quot;</span>

                  <span class="k">else</span><span class="p">:</span>
                    <span class="n">scenarioDict</span><span class="p">[</span><span class="n">scenario_name</span><span class="p">][</span><span class="s">&#39;enabled&#39;</span><span class="p">]</span><span class="o">=</span><span class="mi">0</span> 
                    <span class="c">#print &quot;scenario disabled&quot;</span>
                   

                  <span class="k">if</span> <span class="s">&quot;set_type_after_run&quot;</span> <span class="ow">in</span> <span class="n">postvars</span><span class="p">:</span>
                    <span class="k">print</span> <span class="s">&quot;select:&quot;</span><span class="p">,</span><span class="n">postvars</span><span class="p">[</span><span class="s">&quot;set_type_after_run&quot;</span><span class="p">]</span>
                    <span class="k">print</span> <span class="s">&quot;select2:&quot;</span><span class="p">,</span><span class="n">postvars</span><span class="p">[</span><span class="s">&quot;set_type_after_run&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>


                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">clear_PostData</span><span class="p">(</span><span class="n">postvars</span><span class="p">[</span><span class="s">&quot;set_type_after_run&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span><span class="o">==</span><span class="s">&quot;autodelete&quot;</span><span class="p">:</span>
                      <span class="n">scenarioDict</span><span class="p">[</span><span class="n">scenario_name</span><span class="p">][</span><span class="s">&quot;type_after_run&quot;</span><span class="p">]</span><span class="o">=</span><span class="s">&quot;autodelete&quot;</span>
                    <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">clear_PostData</span><span class="p">(</span><span class="n">postvars</span><span class="p">[</span><span class="s">&quot;set_type_after_run&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span><span class="o">==</span><span class="s">&quot;one_time_shot&quot;</span><span class="p">:</span>
                      <span class="n">scenarioDict</span><span class="p">[</span><span class="n">scenario_name</span><span class="p">][</span><span class="s">&quot;type_after_run&quot;</span><span class="p">]</span><span class="o">=</span><span class="s">&quot;one_time_shot&quot;</span>
                    <span class="k">else</span><span class="p">:</span>
                      <span class="n">scenarioDict</span><span class="p">[</span><span class="n">scenario_name</span><span class="p">][</span><span class="s">&quot;type_after_run&quot;</span><span class="p">]</span><span class="o">=</span><span class="s">&quot;0&quot;</span> 


                  <span class="k">if</span> <span class="s">&quot;delay_time&quot;</span> <span class="ow">in</span> <span class="n">postvars</span><span class="p">:</span>
                      <span class="n">delay</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">clear_PostData</span><span class="p">(</span><span class="n">postvars</span><span class="p">[</span><span class="s">&quot;delay_time&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
                      <span class="k">try</span><span class="p">:</span>
                        <span class="n">delay</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">delay</span><span class="p">)</span>
                        <span class="n">scenarioDict</span><span class="p">[</span><span class="n">scenario_name</span><span class="p">][</span><span class="s">&quot;delayTime&quot;</span><span class="p">]</span><span class="o">=</span><span class="n">delay</span>
                      <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">e</span>  <span class="p">:</span>
                        <span class="k">print</span> <span class="s">&quot;error in mod_scenario delay_time form post parse  &quot;</span><span class="o">+</span><span class="s">&quot; e:&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">)</span> 

                  <span class="k">if</span> <span class="s">&quot;priority&quot;</span> <span class="ow">in</span> <span class="n">postvars</span><span class="p">:</span>
                      <span class="n">priority</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">clear_PostData</span><span class="p">(</span><span class="n">postvars</span><span class="p">[</span><span class="s">&quot;priority&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
                      <span class="k">try</span><span class="p">:</span>
                        <span class="n">priority</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">priority</span><span class="p">)</span>
                        <span class="n">scenarioDict</span><span class="p">[</span><span class="n">scenario_name</span><span class="p">][</span><span class="s">&quot;priority&quot;</span><span class="p">]</span><span class="o">=</span><span class="n">priority</span>
                      <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">e</span>  <span class="p">:</span>
                        <span class="k">print</span> <span class="s">&quot;error in mod_scenario priority form post parse  &quot;</span><span class="o">+</span><span class="s">&quot; e:&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">)</span> 


                  <span class="k">if</span> <span class="s">&quot;conditions&quot;</span> <span class="ow">in</span> <span class="n">postvars</span><span class="p">:</span>
                      <span class="n">conditions</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">clear_PostData</span><span class="p">(</span><span class="n">postvars</span><span class="p">[</span><span class="s">&quot;conditions&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
                      <span class="k">try</span><span class="p">:</span><span class="c"># deny the user to use a void string..</span>
                         
                        <span class="n">a</span><span class="o">=</span><span class="nb">eval</span><span class="p">(</span><span class="n">replace_conditions</span><span class="p">(</span><span class="n">conditions</span><span class="p">,</span><span class="n">scenario_name</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
                        <span class="n">scenarioDict</span><span class="p">[</span><span class="n">scenario_name</span><span class="p">][</span><span class="s">&quot;conditions&quot;</span><span class="p">]</span><span class="o">=</span><span class="n">conditions</span>




                        <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">object_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span><span class="c">#check and remove the not used scenarios from web_object attachedScenarios</span>
                          <span class="n">tmp_list_scenarios</span><span class="o">=</span><span class="n">object_dict</span><span class="p">[</span><span class="n">a</span><span class="p">]</span><span class="o">.</span><span class="n">getListAttachedScenarios</span><span class="p">()</span>
                          <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">tmp_list_scenarios</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">scenarioDict</span><span class="p">[</span><span class="n">b</span><span class="p">][</span><span class="s">&quot;conditions&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">a</span><span class="o">+</span><span class="s">&quot;_#&quot;</span><span class="p">)</span><span class="o">==-</span><span class="mi">1</span><span class="p">:</span> 
                             <span class="c"># if the object is not in the conditions then remove it from web_object attachedScenarios</span>
                              <span class="n">object_dict</span><span class="p">[</span><span class="n">a</span><span class="p">]</span><span class="o">.</span><span class="n">removeAttachedScenario</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
                      
                            


                        <span class="n">list_of_object_inside_conditions</span><span class="o">=</span><span class="n">replace_conditions</span><span class="p">(</span><span class="n">conditions</span><span class="p">,</span><span class="n">scenario_name</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> 
                        <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">list_of_object_inside_conditions</span> <span class="p">:</span><span class="c"># add the scenario to each web_object attachedScenarios    </span>
                          <span class="k">if</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">object_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>  
                            <span class="n">object_dict</span><span class="p">[</span><span class="n">a</span><span class="p">]</span><span class="o">.</span><span class="n">attachScenario</span><span class="p">(</span><span class="n">scenario_name</span><span class="p">)</span>  
                            <span class="c">#if the scenario is not included in the web_object attachedScenarios</span>


                      <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">e</span>  <span class="p">:</span>
                        <span class="k">print</span> <span class="s">&quot;error in mod_scenario conditions form post parse  &quot;</span><span class="o">+</span><span class="s">&quot; e:&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">)</span> 








                  <span class="k">if</span> <span class="s">&quot;functions&quot;</span> <span class="ow">in</span> <span class="n">postvars</span><span class="p">:</span>
                      <span class="n">functions</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">clear_PostData</span><span class="p">(</span><span class="n">postvars</span><span class="p">[</span><span class="s">&quot;functions&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
                      <span class="k">try</span><span class="p">:</span>
                         
                        <span class="c">#a=eval(replace_functions(functions,scenario_name))</span>
                        <span class="k">print</span> <span class="s">&quot;functionsToRun=&quot;</span><span class="p">,</span><span class="n">functions</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;;;;&#39;</span><span class="p">)</span> 
                        <span class="n">scenarioDict</span><span class="p">[</span><span class="n">scenario_name</span><span class="p">][</span><span class="s">&quot;functionsToRun&quot;</span><span class="p">]</span><span class="o">=</span><span class="n">functions</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;;;;&#39;</span><span class="p">)</span>  <span class="c">#banana no check if the functions are right</span>
                      <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">e</span>  <span class="p">:</span>
                        <span class="k">print</span> <span class="s">&quot;error in mod_scenario functions form post parse  &quot;</span><span class="o">+</span><span class="s">&quot; e:&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">)</span> 





                 <span class="c"># except Exception, e  :</span>
                
                  <span class="c">#  print &quot;error in mod_scenario form post parse  &quot;+&quot; e:&quot;+str(e.args)  </span>
                   <span class="c"># errorQueue.put( &quot;error in mod_scenario form post parse &quot;+&quot; e:&quot;+str(e.args))</span>


                  <span class="c">#scenarioDict[scenario_name]={&quot;enabled&quot;:0,&quot;type_after_run&quot;:&quot;0&quot;,&quot;conditions&quot;:&quot;0&quot;,&quot;functionsToRun&quot;:[],&quot;delayTime&quot;:0,&quot;priority&quot;:0}</span>

                  <span class="k">if</span> <span class="s">&quot;set_conditions_submit&quot;</span> <span class="ow">in</span> <span class="n">postvars</span><span class="p">:</span>

                    <span class="bp">self</span><span class="o">.</span><span class="n">send_response</span><span class="p">(</span><span class="mi">301</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">send_header</span><span class="p">(</span><span class="s">&#39;Location&#39;</span><span class="p">,</span><span class="s">&#39;/scenario_conditions/&#39;</span><span class="o">+</span><span class="n">scenario_name</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">end_headers</span><span class="p">()</span>

                  <span class="k">elif</span> <span class="s">&quot;set_function_submit&quot;</span> <span class="ow">in</span> <span class="n">postvars</span><span class="p">:</span>

                    <span class="bp">self</span><span class="o">.</span><span class="n">send_response</span><span class="p">(</span><span class="mi">301</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">send_header</span><span class="p">(</span><span class="s">&#39;Location&#39;</span><span class="p">,</span><span class="s">&#39;/function_to_run/&#39;</span><span class="o">+</span><span class="n">scenario_name</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">end_headers</span><span class="p">()</span>

                  <span class="k">elif</span> <span class="s">&quot;finish_scenario_setup&quot;</span> <span class="ow">in</span> <span class="n">postvars</span><span class="p">:</span>

                    <span class="bp">self</span><span class="o">.</span><span class="n">send_response</span><span class="p">(</span><span class="mi">301</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">send_header</span><span class="p">(</span><span class="s">&#39;Location&#39;</span><span class="p">,</span><span class="s">&#39;/scenarios_list/&#39;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">end_headers</span><span class="p">()</span>




                  <span class="k">return</span>



            <span class="k">if</span> <span class="s">&quot;mod_conditions&quot;</span> <span class="ow">in</span> <span class="n">postvars</span><span class="p">:</span><span class="c">#if the current page is /mod_conditions/scenario name  because &quot;mod_scenario&quot;  is the hidden form name</span>
            <span class="c">#&lt;input type=&quot;hidden&quot; name=&quot;mod_conditions&quot; value=&quot;&quot;&gt;</span>


              <span class="n">scenario_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">clear_PostData</span><span class="p">(</span><span class="n">postvars</span><span class="p">[</span><span class="s">&quot;mod_conditions&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span><span class="c">#get the current scenario name </span>

              <span class="k">if</span> <span class="n">scenario_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">scenarioDict</span><span class="p">:</span>
                <span class="k">return</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>

              <span class="k">if</span> <span class="p">(</span><span class="n">postvars</span><span class="p">[</span><span class="s">&quot;menu_number&quot;</span><span class="p">]</span><span class="o">!=</span><span class="s">&quot; &quot;</span><span class="p">):</span>
                <span class="n">menu_number</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">clear_PostData</span><span class="p">(</span><span class="n">postvars</span><span class="p">[</span><span class="s">&quot;menu_number&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]))</span>
                <span class="k">print</span> <span class="s">&quot;gggggggggggggggggggggggggggggggggggggggggggggggggggggggggggggggggggggggggggggggggg&quot;</span><span class="p">,</span><span class="n">menu_number</span>
              <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>

              <span class="c">#print &quot;menu_number&quot;,menu_number</span>
              <span class="n">conditions</span><span class="o">=</span><span class="s">&quot;&quot;</span>
              <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">menu_number</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                  <span class="n">left_element</span><span class="o">=</span><span class="s">&quot;#_&quot;</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">clear_PostData</span><span class="p">(</span><span class="n">postvars</span><span class="p">[</span><span class="s">&quot;select_l&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)][</span><span class="mi">0</span><span class="p">])</span><span class="o">+</span><span class="s">&quot;_#&quot;</span>
                  <span class="n">operator</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">clear_PostData</span><span class="p">(</span><span class="n">postvars</span><span class="p">[</span><span class="s">&quot;select_op&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)][</span><span class="mi">0</span><span class="p">])</span>
                  <span class="k">if</span> <span class="n">operator</span><span class="o">==</span><span class="s">&quot;=&quot;</span><span class="p">:</span>
                    <span class="n">operator</span><span class="o">=</span><span class="s">&quot;==&quot;</span>
                  <span class="n">right_element</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">clear_PostData</span><span class="p">(</span><span class="n">postvars</span><span class="p">[</span><span class="s">&quot;select_r&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)][</span><span class="mi">0</span><span class="p">])</span>
                  <span class="k">try</span><span class="p">:</span><span class="c">#detect if is a number</span>
                    <span class="n">a</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">right_element</span><span class="p">)</span>
                  <span class="k">except</span><span class="p">:</span>
                    <span class="n">right_element</span><span class="o">=</span><span class="s">&quot;#_&quot;</span><span class="o">+</span><span class="n">right_element</span><span class="o">+</span><span class="s">&quot;_#&quot;</span>

                  <span class="k">if</span> <span class="n">i</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span> <span class="c">#first time don&#39;t add &quot;&amp;&quot;</span>
                    <span class="n">conditions</span><span class="o">=</span><span class="s">&quot;(&quot;</span><span class="o">+</span><span class="n">left_element</span><span class="o">+</span><span class="n">operator</span><span class="o">+</span><span class="n">right_element</span><span class="o">+</span><span class="s">&quot;)&quot;</span>
                  <span class="k">else</span><span class="p">:</span>
                    <span class="n">conditions</span><span class="o">=</span><span class="n">conditions</span><span class="o">+</span><span class="s">&quot;&amp;(&quot;</span><span class="o">+</span><span class="n">left_element</span><span class="o">+</span><span class="n">operator</span><span class="o">+</span><span class="n">right_element</span><span class="o">+</span><span class="s">&quot;)&quot;</span>
                <span class="k">except</span><span class="p">:</span>
                  <span class="k">print</span> <span class="s">&quot;error get cond menu&quot;</span>

              <span class="k">try</span><span class="p">:</span>  
                <span class="n">l</span><span class="o">=</span><span class="s">&quot;#_&quot;</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">clear_PostData</span><span class="p">(</span><span class="n">postvars</span><span class="p">[</span><span class="s">&quot;select_new_l&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span><span class="o">+</span><span class="s">&quot;_#&quot;</span>
                <span class="n">o</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">clear_PostData</span><span class="p">(</span><span class="n">postvars</span><span class="p">[</span><span class="s">&quot;select_new_o&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>

                <span class="k">if</span> <span class="n">o</span><span class="o">==</span><span class="s">&quot;=&quot;</span><span class="p">:</span>
                  <span class="n">o</span><span class="o">=</span><span class="s">&quot;==&quot;</span>
                <span class="n">r</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">clear_PostData</span><span class="p">(</span><span class="n">postvars</span><span class="p">[</span><span class="s">&quot;select_new_r&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
                <span class="k">try</span><span class="p">:</span><span class="c">#detect if is a number</span>
                  <span class="n">a</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
                <span class="k">except</span><span class="p">:</span>
                  <span class="n">r</span><span class="o">=</span><span class="s">&quot;#_&quot;</span><span class="o">+</span><span class="n">r</span><span class="o">+</span><span class="s">&quot;_#&quot;</span>

                <span class="k">if</span> <span class="p">(</span><span class="n">l</span><span class="o">!=</span><span class="s">&quot;#_select_an_element_#&quot;</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="n">r</span><span class="o">!=</span><span class="s">&quot;#_select_an_element_#&quot;</span><span class="p">):</span>
                  <span class="k">if</span> <span class="n">menu_number</span><span class="o">&lt;</span><span class="mi">1</span><span class="p">:</span>
                    <span class="n">conditions</span><span class="o">=</span><span class="n">conditions</span><span class="o">+</span><span class="s">&quot;(&quot;</span><span class="o">+</span><span class="n">l</span><span class="o">+</span><span class="n">o</span><span class="o">+</span><span class="n">r</span><span class="o">+</span><span class="s">&quot;)&quot;</span>   
                  <span class="k">else</span><span class="p">:</span>
                    <span class="n">conditions</span><span class="o">=</span><span class="n">conditions</span><span class="o">+</span><span class="s">&quot;&amp;(&quot;</span><span class="o">+</span><span class="n">l</span><span class="o">+</span><span class="n">o</span><span class="o">+</span><span class="n">r</span><span class="o">+</span><span class="s">&quot;)&quot;</span>   
              <span class="k">except</span><span class="p">:</span>  
                <span class="k">print</span> <span class="s">&quot;error2 get cond menu&quot;</span>

              <span class="n">scenarioDict</span><span class="p">[</span><span class="n">scenario_name</span><span class="p">][</span><span class="s">&quot;conditions&quot;</span><span class="p">]</span><span class="o">=</span><span class="n">conditions</span>

              <span class="k">print</span> <span class="s">&quot;conditions&quot;</span><span class="p">,</span><span class="n">conditions</span> 


              <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">object_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span><span class="c">#check and remove the not used scenarios from web_object attachedScenarios</span>
                <span class="n">tmp_list_scenarios</span><span class="o">=</span><span class="n">object_dict</span><span class="p">[</span><span class="n">a</span><span class="p">]</span><span class="o">.</span><span class="n">getListAttachedScenarios</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">tmp_list_scenarios</span><span class="p">:</span>
                  <span class="k">if</span> <span class="n">scenarioDict</span><span class="p">[</span><span class="n">b</span><span class="p">][</span><span class="s">&quot;conditions&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">a</span><span class="o">+</span><span class="s">&quot;_#&quot;</span><span class="p">)</span><span class="o">==-</span><span class="mi">1</span><span class="p">:</span> 
                <span class="c"># if the object is not in the conditions then remove it from web_object attachedScenarios</span>
                    <span class="n">object_dict</span><span class="p">[</span><span class="n">a</span><span class="p">]</span><span class="o">.</span><span class="n">removeAttachedScenario</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
                  <span class="k">else</span><span class="p">:</span>
                    <span class="n">object_dict</span><span class="p">[</span><span class="n">a</span><span class="p">]</span><span class="o">.</span><span class="n">attachScenario</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>  


              <span class="n">list_of_object_inside_conditions</span><span class="o">=</span><span class="n">replace_conditions</span><span class="p">(</span><span class="n">conditions</span><span class="p">,</span><span class="n">scenario_name</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> 
              <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">list_of_object_inside_conditions</span> <span class="p">:</span><span class="c"># add the scenario to each web_object attachedScenarios    </span>
                <span class="k">if</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">object_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>  
                  <span class="n">object_dict</span><span class="p">[</span><span class="n">a</span><span class="p">]</span><span class="o">.</span><span class="n">attachScenario</span><span class="p">(</span><span class="n">scenario_name</span><span class="p">)</span>  
                  <span class="c">#if the scenario is not included in the web_object attachedScenarios</span>


                                   
                  
 


              <span class="k">if</span> <span class="s">&quot;condition_add_submit&quot;</span> <span class="ow">in</span> <span class="n">postvars</span><span class="p">:</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">send_response</span><span class="p">(</span><span class="mi">301</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">send_header</span><span class="p">(</span><span class="s">&#39;Location&#39;</span><span class="p">,</span><span class="s">&#39;/scenario_conditions/&#39;</span><span class="o">+</span><span class="n">scenario_name</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">end_headers</span><span class="p">()</span>
                <span class="k">return</span> 
              <span class="k">elif</span> <span class="s">&quot;finish_conditions_setup&quot;</span> <span class="ow">in</span> <span class="n">postvars</span><span class="p">:</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">send_response</span><span class="p">(</span><span class="mi">301</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">send_header</span><span class="p">(</span><span class="s">&#39;Location&#39;</span><span class="p">,</span><span class="s">&#39;/mod_scenario/&#39;</span><span class="o">+</span><span class="n">scenario_name</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">end_headers</span><span class="p">()</span>
                <span class="k">return</span> 





            <span class="k">if</span> <span class="s">&quot;function_to_run_1&quot;</span> <span class="ow">in</span> <span class="n">postvars</span><span class="p">:</span><span class="c">#if the current page is /function_to_run/scenario name  because &quot;function_to_run_1&quot;  is the hidden form name</span>
            <span class="c">#&lt;input type=&quot;hidden&quot; name=&quot;mod_functions1a&quot; value=&quot;&quot;&gt;</span>


              <span class="n">scenario_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">clear_PostData</span><span class="p">(</span><span class="n">postvars</span><span class="p">[</span><span class="s">&quot;function_to_run_1&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span><span class="c">#get the current scenario name </span>

              <span class="k">if</span> <span class="n">scenario_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">scenarioDict</span><span class="p">:</span>
                <span class="k">return</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>

              <span class="k">if</span> <span class="p">(</span><span class="n">postvars</span><span class="p">[</span><span class="s">&quot;menu_number&quot;</span><span class="p">]</span><span class="o">!=</span><span class="s">&quot; &quot;</span><span class="p">):</span>
                <span class="n">menu_number</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">clear_PostData</span><span class="p">(</span><span class="n">postvars</span><span class="p">[</span><span class="s">&quot;menu_number&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]))</span>
              <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>

              <span class="k">print</span> <span class="s">&quot;menu_number&quot;</span><span class="p">,</span><span class="n">menu_number</span>
              <span class="n">functions_list</span><span class="o">=</span><span class="p">[]</span>
              <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">menu_number</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                  <span class="n">left_element</span><span class="o">=</span><span class="s">&quot;#_&quot;</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">clear_PostData</span><span class="p">(</span><span class="n">postvars</span><span class="p">[</span><span class="s">&quot;select_l&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)][</span><span class="mi">0</span><span class="p">])</span><span class="o">+</span><span class="s">&quot;_#&quot;</span>
                  <span class="n">operator</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">clear_PostData</span><span class="p">(</span><span class="n">postvars</span><span class="p">[</span><span class="s">&quot;select_op&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)][</span><span class="mi">0</span><span class="p">])</span>
                  <span class="n">second_operator</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">clear_PostData</span><span class="p">(</span><span class="n">postvars</span><span class="p">[</span><span class="s">&quot;second_op&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)][</span><span class="mi">0</span><span class="p">])</span>
                  <span class="k">if</span> <span class="n">operator</span><span class="o">==</span><span class="s">&quot;==&quot;</span><span class="p">:</span>
                    <span class="n">operator</span><span class="o">=</span><span class="s">&quot;=&quot;</span>
                  <span class="n">right_element</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">clear_PostData</span><span class="p">(</span><span class="n">postvars</span><span class="p">[</span><span class="s">&quot;select_r&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)][</span><span class="mi">0</span><span class="p">])</span>
                  <span class="n">third_element</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">clear_PostData</span><span class="p">(</span><span class="n">postvars</span><span class="p">[</span><span class="s">&quot;third_element&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)][</span><span class="mi">0</span><span class="p">])</span>

                  <span class="k">try</span><span class="p">:</span><span class="c">#detect if is a number</span>
                    <span class="n">a</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">right_element</span><span class="p">)</span>
                  <span class="k">except</span><span class="p">:</span>
                    <span class="n">right_element</span><span class="o">=</span><span class="s">&quot;#_&quot;</span><span class="o">+</span><span class="n">right_element</span><span class="o">+</span><span class="s">&quot;_#&quot;</span>

                  <span class="k">if</span> <span class="p">(</span><span class="n">third_element</span><span class="o">!=</span><span class="s">&quot;&quot;</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="n">third_element</span><span class="o">!=</span><span class="s">&quot; &quot;</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="n">second_operator</span><span class="o">!=</span><span class="s">&quot;&quot;</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="n">second_operator</span><span class="o">!=</span><span class="s">&quot; &quot;</span><span class="p">):</span>
                    <span class="k">try</span><span class="p">:</span><span class="c">#detect if is a number</span>
                      <span class="n">a</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">third_element</span><span class="p">)</span>
                    <span class="k">except</span><span class="p">:</span>
                      <span class="n">third_element</span><span class="o">=</span><span class="s">&quot;#_&quot;</span><span class="o">+</span><span class="n">third_element</span><span class="o">+</span><span class="s">&quot;_#&quot;</span>


                  <span class="n">functions_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">left_element</span><span class="o">+</span><span class="n">operator</span><span class="o">+</span><span class="n">right_element</span><span class="o">+</span><span class="n">second_operator</span><span class="o">+</span><span class="n">third_element</span><span class="p">)</span>
                <span class="k">except</span><span class="p">:</span>
                  <span class="k">print</span> <span class="s">&quot;error get func menu&quot;</span>

              <span class="k">try</span><span class="p">:</span>  
                <span class="n">l</span><span class="o">=</span><span class="s">&quot;#_&quot;</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">clear_PostData</span><span class="p">(</span><span class="n">postvars</span><span class="p">[</span><span class="s">&quot;select_new_l&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span><span class="o">+</span><span class="s">&quot;_#&quot;</span>
                <span class="n">o</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">clear_PostData</span><span class="p">(</span><span class="n">postvars</span><span class="p">[</span><span class="s">&quot;select_new_o&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>

                <span class="k">if</span> <span class="n">o</span><span class="o">==</span><span class="s">&quot;==&quot;</span><span class="p">:</span>
                  <span class="n">o</span><span class="o">=</span><span class="s">&quot;=&quot;</span>
                <span class="n">r</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">clear_PostData</span><span class="p">(</span><span class="n">postvars</span><span class="p">[</span><span class="s">&quot;select_new_r&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
                <span class="k">try</span><span class="p">:</span><span class="c">#detect if is a number</span>
                  <span class="n">a</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
                <span class="k">except</span><span class="p">:</span>
                  <span class="n">r</span><span class="o">=</span><span class="s">&quot;#_&quot;</span><span class="o">+</span><span class="n">r</span><span class="o">+</span><span class="s">&quot;_#&quot;</span>

                <span class="k">if</span> <span class="p">(</span><span class="n">l</span><span class="o">!=</span><span class="s">&quot;#_select_an_element_#&quot;</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="n">r</span><span class="o">!=</span><span class="s">&quot;#_select_an_element_#&quot;</span><span class="p">):</span>
                  <span class="n">functions_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">l</span><span class="o">+</span><span class="n">o</span><span class="o">+</span><span class="n">r</span><span class="p">)</span>   
              <span class="k">except</span><span class="p">:</span>  
                <span class="k">print</span> <span class="s">&quot;error2 get cond menu&quot;</span>

              <span class="n">scenarioDict</span><span class="p">[</span><span class="n">scenario_name</span><span class="p">][</span><span class="s">&quot;functionsToRun&quot;</span><span class="p">]</span><span class="o">=</span><span class="n">functions_list</span>
              <span class="k">print</span> <span class="s">&quot;functions&quot;</span><span class="p">,</span><span class="n">functions_list</span> 

              <span class="k">if</span> <span class="s">&quot;condition_add_submit&quot;</span> <span class="ow">in</span> <span class="n">postvars</span><span class="p">:</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">send_response</span><span class="p">(</span><span class="mi">301</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">send_header</span><span class="p">(</span><span class="s">&#39;Location&#39;</span><span class="p">,</span><span class="s">&#39;/function_to_run/&#39;</span><span class="o">+</span><span class="n">scenario_name</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">end_headers</span><span class="p">()</span>
                <span class="k">return</span> 
              <span class="k">elif</span> <span class="s">&quot;finish_conditions_setup&quot;</span> <span class="ow">in</span> <span class="n">postvars</span><span class="p">:</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">send_response</span><span class="p">(</span><span class="mi">301</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">send_header</span><span class="p">(</span><span class="s">&#39;Location&#39;</span><span class="p">,</span><span class="s">&#39;/mod_scenario/&#39;</span><span class="o">+</span><span class="n">scenario_name</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">end_headers</span><span class="p">()</span>
                <span class="k">return</span> 










            <span class="k">if</span> <span class="s">&quot;login_form&quot;</span> <span class="ow">in</span> <span class="n">postvars</span><span class="p">:</span><span class="c">#if the current page is /login.html  because &quot;login_form&quot;  is the hidden form name</span>
            <span class="c">#&lt;form action=&quot;&quot; method=&quot;POST&quot;&gt;&lt;input type=&quot;hidden&quot; name=&quot;login_form&quot; value=&quot;/login&quot;&gt;</span>

              <span class="n">pag</span><span class="o">=</span><span class="s">&quot;&quot;</span>
              <span class="k">if</span> <span class="p">((</span><span class="n">postvars</span><span class="p">[</span><span class="s">&quot;username_form&quot;</span><span class="p">]</span><span class="o">!=</span><span class="s">&quot; &quot;</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="n">postvars</span><span class="p">[</span><span class="s">&quot;password_form&quot;</span><span class="p">]</span><span class="o">!=</span><span class="s">&quot; &quot;</span><span class="p">)):</span>
                <span class="n">username</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">clear_PostData</span><span class="p">(</span><span class="n">postvars</span><span class="p">[</span><span class="s">&quot;username_form&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">password</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">clear_PostData</span><span class="p">(</span><span class="n">postvars</span><span class="p">[</span><span class="s">&quot;password_form&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>

                <span class="k">if</span> <span class="p">(</span><span class="n">username</span> <span class="ow">in</span> <span class="n">usersDict</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>  <span class="c">#if the username exist</span>
                  <span class="k">if</span> <span class="n">usersDict</span><span class="p">[</span><span class="n">username</span><span class="p">][</span><span class="s">&quot;pw&quot;</span><span class="p">]</span><span class="o">==</span><span class="n">password</span> <span class="p">:</span> <span class="c">#if the password is correct</span>
                    <span class="n">user_active_time_dict</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">client_address</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">=</span><span class="p">[</span><span class="n">username</span><span class="p">,</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">today</span><span class="p">()</span><span class="o">.</span><span class="n">minute</span><span class="o">+</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">today</span><span class="p">()</span><span class="o">.</span><span class="n">hour</span><span class="p">)</span><span class="o">*</span><span class="mi">60</span> <span class="p">]</span>
                    <span class="k">print</span> <span class="s">&quot;user ip is:&quot;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">client_address</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

                    <span class="k">print</span> <span class="n">user_active_time_dict</span>
                    <span class="k">print</span> <span class="s">&quot;user :&quot;</span><span class="o">+</span><span class="n">username</span><span class="o">+</span><span class="s">&quot;logged succesfully&quot;</span>
                    <span class="c">#pag=&quot;successfully logged&quot;</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">send_response</span><span class="p">(</span><span class="mi">301</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">send_header</span><span class="p">(</span><span class="s">&#39;Location&#39;</span><span class="p">,</span><span class="s">&#39;/&#39;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">end_headers</span><span class="p">()</span>
                    <span class="k">return</span>

                  <span class="k">else</span><span class="p">:</span>
                    <span class="k">print</span> <span class="s">&quot;error user :&quot;</span><span class="o">+</span><span class="n">username</span><span class="o">+</span><span class="s">&quot;cant&#39;t log because of wrong password&quot;</span>
                    <span class="n">errorQueue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="s">&quot;error user :&quot;</span><span class="o">+</span><span class="n">username</span><span class="o">+</span><span class="s">&quot;cant&#39;t log because of wrong password&quot;</span> <span class="p">)</span>
                    <span class="c">#pag=&quot;wrong password&quot;</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">send_response</span><span class="p">(</span><span class="mi">301</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">send_header</span><span class="p">(</span><span class="s">&#39;Location&#39;</span><span class="p">,</span><span class="s">&#39;/gui/password_error.html&#39;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">end_headers</span><span class="p">()</span>
                    <span class="k">return</span>
                <span class="k">else</span><span class="p">:</span>
                  <span class="k">print</span> <span class="s">&quot;error an user tried to log in with a wrong username&quot;</span>
                  <span class="n">errorQueue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="s">&quot;error an user tried to log in with a wrong username&quot;</span> <span class="p">)</span>
                  <span class="bp">self</span><span class="o">.</span><span class="n">send_response</span><span class="p">(</span><span class="mi">301</span><span class="p">)</span>
                  <span class="bp">self</span><span class="o">.</span><span class="n">send_header</span><span class="p">(</span><span class="s">&#39;Location&#39;</span><span class="p">,</span><span class="s">&#39;/gui/user_error.html&#39;</span><span class="p">)</span>
                  <span class="bp">self</span><span class="o">.</span><span class="n">end_headers</span><span class="p">()</span>
                  <span class="k">return</span>
                  <span class="c">#pag=&quot;wrong username&quot;</span>


            <span class="k">if</span> <span class="s">&quot;new_user_form&quot;</span> <span class="ow">in</span> <span class="n">postvars</span><span class="p">:</span><span class="c">#if the current page is /create_user.html  because &quot;new_user_form&quot;  is the hidden form name</span>
            <span class="c">#  &lt;form action=&quot;&quot; method=&quot;POST&quot;&gt;&lt;input type=&quot;hidden&quot; name=&quot;new_user_form&quot; value=&quot;&quot;&gt;</span>

              <span class="n">pag</span><span class="o">=</span><span class="s">&quot;&quot;</span>
              <span class="k">if</span> <span class="p">((</span><span class="n">postvars</span><span class="p">[</span><span class="s">&quot;create_user_form&quot;</span><span class="p">]</span><span class="o">!=</span><span class="s">&quot; &quot;</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="n">postvars</span><span class="p">[</span><span class="s">&quot;create_password_form&quot;</span><span class="p">]</span><span class="o">!=</span><span class="s">&quot; &quot;</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="n">postvars</span><span class="p">[</span><span class="s">&quot;repeat_password_form&quot;</span><span class="p">]</span><span class="o">!=</span><span class="s">&quot; &quot;</span><span class="p">)):</span>
                <span class="n">username</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">clear_PostData</span><span class="p">(</span><span class="n">postvars</span><span class="p">[</span><span class="s">&quot;create_user_form&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">password</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">clear_PostData</span><span class="p">(</span><span class="n">postvars</span><span class="p">[</span><span class="s">&quot;create_password_form&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">repeated_password</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">clear_PostData</span><span class="p">(</span><span class="n">postvars</span><span class="p">[</span><span class="s">&quot;repeat_password_form&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">mail</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">clear_PostData</span><span class="p">(</span><span class="n">postvars</span><span class="p">[</span><span class="s">&quot;create_mail_form&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
                 




                <span class="k">if</span> <span class="p">(</span><span class="n">password</span><span class="o">!=</span><span class="n">repeated_password</span><span class="p">):</span> <span class="c">#wrong password entered</span>
   
                  <span class="n">message</span><span class="o">=</span><span class="s">&quot;error the two passwords entered are not the same, please retype&quot;</span>
                  <span class="k">print</span> <span class="n">message</span>
                  <span class="n">errorQueue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">message</span> <span class="p">)</span>
                  <span class="n">cgi_name</span><span class="o">=</span><span class="s">&quot;gui/new_user.py&quot;</span>

                  <span class="n">namespace</span><span class="o">=</span><span class="p">{}</span> 
                  <span class="n">web_page</span><span class="o">=</span><span class="s">&quot;&quot;</span>
                  <span class="nb">execfile</span><span class="p">(</span><span class="n">cgi_name</span><span class="p">,</span><span class="nb">locals</span><span class="p">(),</span><span class="n">namespace</span><span class="p">)</span>  <span class="c">#execute external script /gui/pag_creator.py                  </span>
                  <span class="n">web_page</span><span class="o">=</span><span class="n">namespace</span><span class="p">[</span><span class="s">&quot;web_page&quot;</span><span class="p">]</span>
                  <span class="bp">self</span><span class="o">.</span><span class="n">send_response</span><span class="p">(</span><span class="mi">200</span><span class="p">)</span>
                  <span class="bp">self</span><span class="o">.</span><span class="n">send_header</span><span class="p">(</span><span class="s">&#39;Content-type&#39;</span><span class="p">,</span>	<span class="s">&#39;text/html&#39;</span><span class="p">)</span>
                  <span class="bp">self</span><span class="o">.</span><span class="n">end_headers</span><span class="p">()</span>
                  <span class="bp">self</span><span class="o">.</span><span class="n">wfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">web_page</span><span class="p">)</span> 
                  <span class="k">return</span>



                <span class="k">if</span> <span class="p">(</span><span class="n">internet_connection</span><span class="o">!=</span><span class="mi">1</span><span class="p">):</span>  <span class="c"># no internet connection</span>
                  <span class="n">message</span><span class="o">=</span><span class="s">&quot;error internet connection lost while creating onos online user, please connect onos center to internet&quot;</span>
                  <span class="k">print</span> <span class="n">message</span>
                  <span class="n">errorQueue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
                  <span class="n">cgi_name</span><span class="o">=</span><span class="s">&quot;gui/new_user.py&quot;</span>

                  <span class="n">namespace</span><span class="o">=</span><span class="p">{}</span> 
                  <span class="n">web_page</span><span class="o">=</span><span class="s">&quot;&quot;</span>
                  <span class="nb">execfile</span><span class="p">(</span><span class="n">cgi_name</span><span class="p">,</span><span class="nb">locals</span><span class="p">(),</span><span class="n">namespace</span><span class="p">)</span>  <span class="c">#execute external script /gui/pag_creator.py                  </span>
                  <span class="n">web_page</span><span class="o">=</span><span class="n">namespace</span><span class="p">[</span><span class="s">&quot;web_page&quot;</span><span class="p">]</span>
                  <span class="bp">self</span><span class="o">.</span><span class="n">send_response</span><span class="p">(</span><span class="mi">200</span><span class="p">)</span>
                  <span class="bp">self</span><span class="o">.</span><span class="n">send_header</span><span class="p">(</span><span class="s">&#39;Content-type&#39;</span><span class="p">,</span>	<span class="s">&#39;text/html&#39;</span><span class="p">)</span>
                  <span class="bp">self</span><span class="o">.</span><span class="n">end_headers</span><span class="p">()</span>
                  <span class="bp">self</span><span class="o">.</span><span class="n">wfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">web_page</span><span class="p">)</span> 
                  <span class="k">return</span>







                <span class="k">if</span> <span class="p">(</span><span class="n">username</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">usersDict</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>  <span class="c">#if the username does not alredy exist in the local dictionary</span>
                  

  
                  <span class="n">site_query</span><span class="o">=</span><span class="n">onos_online_site_url</span><span class="o">+</span><span class="s">&quot;create_new_onos_user.php&quot;</span>
                  <span class="n">params</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;username&#39;</span><span class="p">:</span><span class="n">username</span><span class="p">,</span> <span class="s">&#39;onos_key&#39;</span><span class="p">:</span><span class="n">onos_online_key</span><span class="p">,</span><span class="s">&quot;user_pass&quot;</span><span class="p">:</span><span class="n">password</span><span class="p">,</span><span class="s">&quot;onos_password&quot;</span><span class="p">:</span><span class="n">onos_online_password</span><span class="p">}</span>     
                  <span class="k">try</span> <span class="p">:</span>

                    <span class="n">f</span><span class="o">=</span><span class="n">url_request_manager</span><span class="o">.</span><span class="n">request_encode_body</span><span class="p">(</span><span class="s">&#39;POST&#39;</span><span class="p">,</span><span class="n">site_query</span><span class="p">,</span><span class="n">params</span><span class="p">,</span><span class="n">timeout</span><span class="o">=</span><span class="n">Timeout</span><span class="p">(</span><span class="n">total</span><span class="o">=</span><span class="mi">20</span><span class="p">))</span>
                    <span class="n">result</span><span class="o">=</span><span class="n">f</span><span class="o">.</span><span class="n">data</span>
                    <span class="k">print</span> <span class="n">result</span>

                  <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">e</span>  <span class="p">:</span>

                    <span class="n">message</span><span class="o">=</span><span class="s">&quot;server online query to create new user failed,please check connection and retry&quot;</span><span class="o">+</span><span class="s">&quot; e:&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">)</span>
                    <span class="k">print</span> <span class="n">message</span>
                    <span class="n">errorQueue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">message</span> <span class="p">)</span>
                    <span class="n">cgi_name</span><span class="o">=</span><span class="s">&quot;gui/new_user.py&quot;</span>

                    <span class="n">namespace</span><span class="o">=</span><span class="p">{}</span> 
                    <span class="n">web_page</span><span class="o">=</span><span class="s">&quot;&quot;</span>
                    <span class="nb">execfile</span><span class="p">(</span><span class="n">cgi_name</span><span class="p">,</span><span class="nb">locals</span><span class="p">(),</span><span class="n">namespace</span><span class="p">)</span>  <span class="c">#execute external script /gui/pag_creator.py                  </span>
                    <span class="n">web_page</span><span class="o">=</span><span class="n">namespace</span><span class="p">[</span><span class="s">&quot;web_page&quot;</span><span class="p">]</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">send_response</span><span class="p">(</span><span class="mi">200</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">send_header</span><span class="p">(</span><span class="s">&#39;Content-type&#39;</span><span class="p">,</span>	<span class="s">&#39;text/html&#39;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">end_headers</span><span class="p">()</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">wfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">web_page</span><span class="p">)</span> 
                    <span class="k">return</span>


                  <span class="k">if</span> <span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&quot;syntax error&quot;</span><span class="p">)</span><span class="o">!=-</span><span class="mi">1</span><span class="p">)</span><span class="ow">or</span> <span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&quot;error_&quot;</span><span class="p">)</span><span class="o">!=-</span><span class="mi">1</span><span class="p">):</span>
   
                    <span class="n">message</span><span class="o">=</span><span class="s">&quot;error in the server answer while creating onos online user, please retry&quot;</span>
                    <span class="k">print</span> <span class="n">message</span>
                    <span class="n">errorQueue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">message</span> <span class="p">)</span>
                    <span class="n">cgi_name</span><span class="o">=</span><span class="s">&quot;gui/new_user.py&quot;</span>

                    <span class="n">namespace</span><span class="o">=</span><span class="p">{}</span> 
                    <span class="n">web_page</span><span class="o">=</span><span class="s">&quot;&quot;</span>
                    <span class="nb">execfile</span><span class="p">(</span><span class="n">cgi_name</span><span class="p">,</span><span class="nb">locals</span><span class="p">(),</span><span class="n">namespace</span><span class="p">)</span>  <span class="c">#execute external script /gui/pag_creator.py                  </span>
                    <span class="n">web_page</span><span class="o">=</span><span class="n">namespace</span><span class="p">[</span><span class="s">&quot;web_page&quot;</span><span class="p">]</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">send_response</span><span class="p">(</span><span class="mi">200</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">send_header</span><span class="p">(</span><span class="s">&#39;Content-type&#39;</span><span class="p">,</span>	<span class="s">&#39;text/html&#39;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">end_headers</span><span class="p">()</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">wfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">web_page</span><span class="p">)</span> 
                    <span class="k">return</span>

                  <span class="k">if</span> <span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&quot;#_onos_online_user_created&quot;</span><span class="p">)</span><span class="o">!=-</span><span class="mi">1</span><span class="p">):</span> <span class="c">#the username was created in the online server</span>
                  
                    <span class="n">usersDict</span><span class="p">[</span><span class="n">username</span><span class="p">]</span><span class="o">=</span><span class="p">{</span><span class="s">&quot;pw&quot;</span><span class="p">:</span><span class="n">password</span><span class="p">,</span><span class="s">&quot;mail_control_password&quot;</span><span class="p">:</span><span class="n">password</span><span class="p">,</span><span class="s">&quot;priority&quot;</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span><span class="s">&quot;user_mail&quot;</span><span class="p">:</span><span class="n">mail</span><span class="p">}</span>

                  

                    <span class="n">message</span><span class="o">=</span><span class="s">&quot;username created in the online server and in the onos server&quot;</span>
                    <span class="k">print</span> <span class="n">message</span>
                    <span class="n">errorQueue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">message</span> <span class="p">)</span>
                    <span class="n">cgi_name</span><span class="o">=</span><span class="s">&quot;gui/new_user.py&quot;</span>

                    <span class="n">namespace</span><span class="o">=</span><span class="p">{}</span> 
                    <span class="n">web_page</span><span class="o">=</span><span class="s">&quot;&quot;</span>
                    <span class="nb">execfile</span><span class="p">(</span><span class="n">cgi_name</span><span class="p">,</span><span class="nb">locals</span><span class="p">(),</span><span class="n">namespace</span><span class="p">)</span>  <span class="c">#execute external script /gui/pag_creator.py                  </span>
                    <span class="n">web_page</span><span class="o">=</span><span class="n">namespace</span><span class="p">[</span><span class="s">&quot;web_page&quot;</span><span class="p">]</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">send_response</span><span class="p">(</span><span class="mi">200</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">send_header</span><span class="p">(</span><span class="s">&#39;Content-type&#39;</span><span class="p">,</span>	<span class="s">&#39;text/html&#39;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">end_headers</span><span class="p">()</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">wfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">web_page</span><span class="p">)</span> 


                  <span class="k">else</span><span class="p">:</span>  <span class="c">#username already used on online server  </span>

                    <span class="n">message</span><span class="o">=</span><span class="s">&quot;error the username is already used in the online server,please choose another username and retry,result:&quot;</span><span class="o">+</span><span class="n">result</span>
                    <span class="k">print</span> <span class="n">message</span>
                    <span class="n">errorQueue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">message</span> <span class="p">)</span>
                    <span class="n">cgi_name</span><span class="o">=</span><span class="s">&quot;gui/new_user.py&quot;</span>

                    <span class="n">namespace</span><span class="o">=</span><span class="p">{}</span> 
                    <span class="n">web_page</span><span class="o">=</span><span class="s">&quot;&quot;</span>
                    <span class="nb">execfile</span><span class="p">(</span><span class="n">cgi_name</span><span class="p">,</span><span class="nb">locals</span><span class="p">(),</span><span class="n">namespace</span><span class="p">)</span>  <span class="c">#execute external script /gui/pag_creator.py                  </span>
                    <span class="n">web_page</span><span class="o">=</span><span class="n">namespace</span><span class="p">[</span><span class="s">&quot;web_page&quot;</span><span class="p">]</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">send_response</span><span class="p">(</span><span class="mi">200</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">send_header</span><span class="p">(</span><span class="s">&#39;Content-type&#39;</span><span class="p">,</span>	<span class="s">&#39;text/html&#39;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">end_headers</span><span class="p">()</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">wfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">web_page</span><span class="p">)</span> 
                    <span class="k">return</span>

                <span class="k">else</span><span class="p">:</span>
                  <span class="n">message</span><span class="o">=</span><span class="s">&quot;error the username is already used in the onosCenter,please choose another username and retry&quot;</span>
                  <span class="k">print</span> <span class="n">message</span>
                  <span class="n">errorQueue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">message</span> <span class="p">)</span>
                  <span class="n">cgi_name</span><span class="o">=</span><span class="s">&quot;gui/new_user.py&quot;</span>
                  <span class="n">namespace</span><span class="o">=</span><span class="p">{}</span> 
                  <span class="n">web_page</span><span class="o">=</span><span class="s">&quot;&quot;</span>
                  <span class="nb">execfile</span><span class="p">(</span><span class="n">cgi_name</span><span class="p">,</span><span class="nb">locals</span><span class="p">(),</span><span class="n">namespace</span><span class="p">)</span>  <span class="c">#execute external script /gui/pag_creator.py                  </span>
                  <span class="n">web_page</span><span class="o">=</span><span class="n">namespace</span><span class="p">[</span><span class="s">&quot;web_page&quot;</span><span class="p">]</span>
                  <span class="bp">self</span><span class="o">.</span><span class="n">send_response</span><span class="p">(</span><span class="mi">200</span><span class="p">)</span>
                  <span class="bp">self</span><span class="o">.</span><span class="n">send_header</span><span class="p">(</span><span class="s">&#39;Content-type&#39;</span><span class="p">,</span>	<span class="s">&#39;text/html&#39;</span><span class="p">)</span>
                  <span class="bp">self</span><span class="o">.</span><span class="n">end_headers</span><span class="p">()</span>
                  <span class="bp">self</span><span class="o">.</span><span class="n">wfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">web_page</span><span class="p">)</span> 
                  <span class="k">return</span>



      


            <span class="k">if</span> <span class="s">&quot;post0&quot;</span> <span class="ow">in</span> <span class="n">postvars</span><span class="p">:</span>
              <span class="k">print</span> <span class="s">&quot;received post0:&quot;</span>
              <span class="k">print</span> <span class="n">postvars</span><span class="p">[</span><span class="s">&quot;post0&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>  <span class="c">#  print the first post variable</span>
  

            <span class="k">if</span> <span class="p">(</span><span class="n">data_to_update</span><span class="o">==</span><span class="mi">100</span><span class="p">):</span>
              <span class="c">#updateJson( object_dict,zoneDict)</span>
              <span class="n">updateDir</span><span class="p">()</span>
              <span class="n">data_to_update</span><span class="o">=</span><span class="mi">0</span>   
             
        <span class="k">else</span><span class="p">:</span>
            <span class="n">postvars</span> <span class="o">=</span> <span class="p">{}</span>
        

<span class="c">#a timeout  </span>
<span class="k">class</span> <span class="nc">RequestHandler</span><span class="p">(</span><span class="n">BaseHTTPServer</span><span class="o">.</span><span class="n">BaseHTTPRequestHandler</span><span class="p">):</span>  <span class="c"># i don&#39;t know if usefull to close client timout connections</span></div></div>
<div class="viewcode-block" id="RequestHandler"><a class="viewcode-back" href="../webserver.html#webserver.RequestHandler">[docs]</a>  <span class="k">print</span> <span class="s">&quot;class RequestHandler executed()&quot;</span>  

  <span class="k">def</span> <span class="nf">setup</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<div class="viewcode-block" id="RequestHandler.setup"><a class="viewcode-back" href="../webserver.html#webserver.RequestHandler.setup">[docs]</a>    
    <span class="n">BaseHTTPServer</span><span class="o">.</span><span class="n">BaseHTTPRequestHandler</span><span class="o">.</span><span class="n">setup</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">settimeout</span><span class="p">(</span><span class="mi">30</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">finish_request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">client_address</span><span class="p">):</span>
        <span class="k">print</span> <span class="s">&quot;finish_request() executed&quot;</span> 
        <span class="n">request</span><span class="o">.</span><span class="n">settimeout</span><span class="p">(</span><span class="mi">30</span><span class="p">)</span>
        <span class="c"># &quot;super&quot; can not be used because BaseServer is not created from object</span>
        <span class="n">BaseHTTPServer</span><span class="o">.</span><span class="n">HTTPServer</span><span class="o">.</span><span class="n">finish_request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">client_address</span><span class="p">)</span>




 <span class="c">#another timeout </span>
<span class="c">#class RequestHandler(BaseHTTPServer.BaseHTTPRequestHandler):# i don&#39;t know if usefull to close client timout</span>
<span class="c">#  def __init__(self, request, client_address, server):</span>
<span class="c">#    BaseHTTPServer.BaseHTTPRequestHandler.__init__(self, request, client_address, server)   </span>
<span class="c">#    print &quot;classsee eseguitaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa&quot;  </span>




<span class="k">def</span> <span class="nf">onlineServerSync</span><span class="p">():</span></div></div>
<div class="viewcode-block" id="onlineServerSync"><a class="viewcode-back" href="../webserver.html#webserver.onlineServerSync">[docs]</a>  <span class="k">print</span> <span class="s">&quot;onlineServerSync() excuted&quot;</span>
  <span class="k">global</span> <span class="n">onlineServerSyncThreadIsrunning</span>
  <span class="k">global</span> <span class="n">online_first_contact</span>
  <span class="k">global</span> <span class="n">online_usersDict</span>
  <span class="k">global</span> <span class="n">force_online_sync_users</span>
  <span class="k">global</span> <span class="n">online_zone_dict</span>
  <span class="k">global</span> <span class="n">online_object_dict</span>
  <span class="n">result</span><span class="o">=</span><span class="s">&quot;&quot;</span>
  <span class="k">while</span> <span class="p">(</span><span class="nb">exit</span><span class="o">==</span><span class="mi">0</span><span class="p">):</span> <span class="c">#if exit ==1  then close the service    </span>
    <span class="n">onlineServerSyncThreadIsrunning</span><span class="o">=</span><span class="mi">1</span>


 <span class="c">#   try:</span>
 <span class="c">#     urllib2.urlopen(&quot;http://www.google.com&quot;)  </span>
 <span class="c">#   except:</span>
 <span class="c">#     print &quot;no internet connection&quot;</span>
 <span class="c">#     errorQueue.put(&quot;no internet connection&quot; )  </span>
      <span class="c">#time.sleep(30) #wait 60 seconds</span>
<span class="c">#      return</span>
     

    <span class="k">try</span><span class="p">:</span>
      <span class="n">object_tmp_dict</span><span class="o">=</span><span class="n">transform_object_to_dict</span><span class="p">(</span><span class="n">object_dict</span><span class="p">)</span> 
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">e</span>  <span class="p">:</span>
      <span class="k">print</span> <span class="s">&quot;error executing transform_object_to_dict()&quot;</span><span class="o">+</span><span class="s">&quot; e:&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">)</span>
      <span class="n">errorQueue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="s">&quot;error executing transform_object_to_dict()&quot;</span><span class="o">+</span><span class="s">&quot; e:&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">)</span> <span class="p">)</span>  


    <span class="k">if</span> <span class="p">(</span><span class="n">online_first_contact</span><span class="o">==</span><span class="mi">1</span><span class="p">)</span> <span class="p">:</span>

      <span class="n">zone_json_dictionary</span><span class="o">=</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">zoneDict</span><span class="p">)</span>
      
      <span class="n">object_json_dictionary</span><span class="o">=</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">object_tmp_dict</span><span class="p">)</span>

      <span class="c">#site_query=onos_online_site_url+&quot;create_new_onos_center.php&quot;</span>
      <span class="c">#params = urllib.urlencode({&#39;onos_key&#39;: onos_online_key, &#39;pass&#39;:onos_online_password,&#39;hw_fw_version&#39;:router_hardware_fw_version})</span>
      <span class="c">#f = urllib.urlopen(site_query, params)</span>
      <span class="c">#print f.read()  #banana check the answer to see if the database was created</span>
      

      <span class="c">#update all objects and zones</span>
      <span class="n">site_query</span><span class="o">=</span><span class="n">onos_online_site_url</span><span class="o">+</span><span class="s">&quot;db_sync_with_onos.php&quot;</span>
      <span class="n">params</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;onos_key&#39;</span><span class="p">:</span> <span class="n">onos_online_key</span><span class="p">,</span> <span class="s">&#39;onos_password&#39;</span><span class="p">:</span><span class="n">onos_online_password</span><span class="p">,</span><span class="s">&quot;zone_sync&quot;</span><span class="p">:</span><span class="s">&quot;1&quot;</span><span class="p">,</span><span class="s">&quot;zone_dict&quot;</span><span class="p">:</span><span class="n">zone_json_dictionary</span><span class="p">,</span><span class="s">&quot;obj_sync&quot;</span><span class="p">:</span><span class="s">&quot;all&quot;</span><span class="p">,</span><span class="s">&quot;obj_dict&quot;</span><span class="p">:</span><span class="n">object_json_dictionary</span><span class="p">}</span>     
      <span class="k">try</span> <span class="p">:</span>
        <span class="c">#f = urllib2.urlopen(site_query, params,timeout = 5)</span>
        <span class="n">f</span><span class="o">=</span><span class="n">url_request_manager</span><span class="o">.</span><span class="n">request_encode_body</span><span class="p">(</span><span class="s">&#39;POST&#39;</span><span class="p">,</span><span class="n">site_query</span><span class="p">,</span><span class="n">params</span><span class="p">,</span><span class="n">timeout</span><span class="o">=</span><span class="n">Timeout</span><span class="p">(</span><span class="n">total</span><span class="o">=</span><span class="mi">20</span><span class="p">))</span>
        <span class="n">result</span><span class="o">=</span><span class="n">f</span><span class="o">.</span><span class="n">data</span>
        <span class="k">print</span> <span class="n">result</span>
        <span class="n">online_first_contact</span><span class="o">=</span><span class="mi">0</span>
        <span class="n">online_object_dict</span><span class="o">=</span><span class="n">object_json_dictionary</span>
        <span class="n">online_zone_dict</span><span class="o">=</span><span class="n">zone_json_dictionary</span>

      <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">e</span>  <span class="p">:</span>
        <span class="k">print</span> <span class="s">&quot;first online contact failed&quot;</span> <span class="o">+</span><span class="s">&quot; e:&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">)</span>
        <span class="n">errorQueue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="s">&quot;first online contact failed&quot;</span><span class="o">+</span><span class="s">&quot; e:&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">)</span> <span class="p">)</span>   
        <span class="k">continue</span>

      <span class="k">if</span> <span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&quot;syntax error&quot;</span><span class="p">)</span><span class="o">!=-</span><span class="mi">1</span><span class="p">)</span><span class="ow">or</span> <span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&quot;error_&quot;</span><span class="p">)</span><span class="o">!=-</span><span class="mi">1</span><span class="p">):</span>
        <span class="n">online_object_dict</span><span class="o">=</span><span class="s">&quot;&quot;</span>
        <span class="n">online_zone_dict</span><span class="o">=</span><span class="s">&quot;&quot;</span>
        <span class="n">online_first_contact</span><span class="o">=</span><span class="mi">1</span>

      <span class="c">#time.sleep(online_server_delay)</span>
      <span class="c">#onlineServerSyncThreadIsrunning=0</span>
      <span class="c">#return</span>
      <span class="k">continue</span>

    


    <span class="c">#if (cmp(online_usersDict,online_synced_user_dict))!=0 : #the dictionaries are different banana, to get this value from the server</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">force_online_sync_users</span><span class="o">==</span><span class="mi">1</span><span class="p">):</span>
      <span class="c">#create a copy of all the local users in the online db</span>
      <span class="k">print</span> <span class="s">&quot;i create the remote users&quot;</span>
      <span class="n">site_query</span><span class="o">=</span><span class="n">onos_online_site_url</span><span class="o">+</span><span class="s">&quot;create_new_onos_user.php&quot;</span>
      <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">online_usersDict</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>  <span class="c"># for each local username    </span>
        <span class="n">params</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;onos_key&#39;</span><span class="p">:</span> <span class="n">onos_online_key</span><span class="p">,</span> <span class="s">&#39;onos_password&#39;</span><span class="p">:</span><span class="n">onos_online_password</span><span class="p">,</span><span class="s">&quot;username&quot;</span><span class="p">:</span><span class="n">a</span><span class="p">,</span><span class="s">&quot;user_pass&quot;</span><span class="p">:</span><span class="n">online_usersDict</span><span class="p">[</span><span class="n">a</span><span class="p">][</span><span class="s">&quot;pw&quot;</span><span class="p">]}</span>
        <span class="k">try</span><span class="p">:</span>
          <span class="c">#f = urllib2.urlopen(site_query, params,timeout = 5)</span>
          <span class="n">f</span><span class="o">=</span><span class="n">url_request_manager</span><span class="o">.</span><span class="n">request_encode_body</span><span class="p">(</span><span class="s">&#39;POST&#39;</span><span class="p">,</span><span class="n">site_query</span><span class="p">,</span><span class="n">params</span><span class="p">,</span><span class="n">timeout</span><span class="o">=</span><span class="n">Timeout</span><span class="p">(</span><span class="n">total</span><span class="o">=</span><span class="mi">20</span><span class="p">))</span>
          <span class="n">result</span><span class="o">=</span><span class="n">f</span><span class="o">.</span><span class="n">data</span>
          <span class="k">print</span> <span class="n">result</span>
          <span class="n">force_online_sync_users</span><span class="o">=</span><span class="mi">0</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">e</span>  <span class="p">:</span>
          <span class="k">print</span> <span class="s">&quot;error creating online user &quot;</span><span class="o">+</span><span class="s">&quot; e:&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">)</span>
          <span class="n">errorQueue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span> <span class="s">&quot;error creating online user &quot;</span><span class="o">+</span><span class="s">&quot; e:&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">))</span> 

         

        <span class="k">if</span> <span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&quot;syntax error&quot;</span><span class="p">)</span><span class="o">!=-</span><span class="mi">1</span><span class="p">)</span><span class="ow">or</span> <span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&quot;error_&quot;</span><span class="p">)</span><span class="o">!=-</span><span class="mi">1</span><span class="p">):</span>
          <span class="n">force_online_sync_users</span><span class="o">=</span><span class="mi">1</span>




    <span class="n">object_json_dictionary</span><span class="o">=</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">object_tmp_dict</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">object_json_dictionary</span><span class="o">!=</span><span class="n">online_object_dict</span><span class="p">):</span> <span class="c">#the dictionaries are different </span>
      <span class="k">print</span> <span class="s">&quot;i sync the remote object dict&quot;</span>  

      <span class="c">#print &quot;object_json_dictionary:&quot;+object_json_dictionary</span>

      <span class="n">site_query</span><span class="o">=</span><span class="n">onos_online_site_url</span><span class="o">+</span><span class="s">&quot;db_sync_with_onos.php&quot;</span>
      <span class="n">params</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;onos_key&#39;</span><span class="p">:</span> <span class="n">onos_online_key</span><span class="p">,</span> <span class="s">&#39;onos_password&#39;</span><span class="p">:</span><span class="n">onos_online_password</span><span class="p">,</span><span class="s">&quot;zone_sync&quot;</span><span class="p">:</span><span class="s">&quot;0&quot;</span><span class="p">,</span><span class="s">&quot;obj_sync&quot;</span><span class="p">:</span><span class="s">&quot;all&quot;</span><span class="p">,</span><span class="s">&quot;obj_dict&quot;</span><span class="p">:</span><span class="n">object_json_dictionary</span><span class="p">}</span>

      <span class="k">try</span><span class="p">:</span>
        <span class="c">#f = urllib2.urlopen(site_query, params,timeout = 5)</span>
        <span class="c">#result=f.read()</span>
        <span class="n">f</span><span class="o">=</span><span class="n">url_request_manager</span><span class="o">.</span><span class="n">request_encode_body</span><span class="p">(</span><span class="s">&#39;POST&#39;</span><span class="p">,</span><span class="n">site_query</span><span class="p">,</span><span class="n">params</span><span class="p">,</span><span class="n">timeout</span><span class="o">=</span><span class="n">Timeout</span><span class="p">(</span><span class="n">total</span><span class="o">=</span><span class="mi">20</span><span class="p">))</span>
        <span class="n">result</span><span class="o">=</span><span class="n">f</span><span class="o">.</span><span class="n">data</span>
        <span class="k">print</span> <span class="n">result</span>

        <span class="n">online_object_dict</span><span class="o">=</span><span class="n">object_json_dictionary</span>
      <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">e</span>  <span class="p">:</span>
        <span class="k">print</span> <span class="s">&quot;error in the remote object update&quot;</span><span class="o">+</span><span class="s">&quot; e:&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">)</span>
        <span class="n">errorQueue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="s">&quot;error in the remote object update&quot;</span><span class="o">+</span><span class="s">&quot; e:&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">)</span> <span class="p">)</span>
        <span class="n">online_object_dict</span><span class="o">=</span><span class="s">&quot;&quot;</span>
        <span class="k">continue</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&quot;syntax error&quot;</span><span class="p">)</span><span class="o">!=-</span><span class="mi">1</span><span class="p">)</span><span class="ow">or</span> <span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&quot;error_&quot;</span><span class="p">)</span><span class="o">!=-</span><span class="mi">1</span><span class="p">):</span>
        <span class="n">online_object_dict</span><span class="o">=</span><span class="s">&quot;&quot;</span>
        <span class="k">continue</span>





    <span class="n">zone_json_dictionary</span><span class="o">=</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">zoneDict</span><span class="p">)</span>
    <span class="c">#print &quot;cmp  zone----------------------------------------&quot;,cmp(zone_json_dictionary,online_zone_dict)</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">zone_json_dictionary</span><span class="o">!=</span><span class="n">online_zone_dict</span><span class="p">)</span> <span class="p">:</span> <span class="c">#the dictionaries are different  banana, to get this value from the server</span>
      <span class="k">print</span> <span class="s">&quot;i sync the remote zone dict&quot;</span>
 

      <span class="n">site_query</span><span class="o">=</span><span class="n">onos_online_site_url</span><span class="o">+</span><span class="s">&quot;db_sync_with_onos.php&quot;</span>
      <span class="n">params</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;onos_key&#39;</span><span class="p">:</span> <span class="n">onos_online_key</span><span class="p">,</span> <span class="s">&#39;onos_password&#39;</span><span class="p">:</span><span class="n">onos_online_password</span><span class="p">,</span><span class="s">&quot;zone_sync&quot;</span><span class="p">:</span><span class="s">&quot;1&quot;</span><span class="p">,</span><span class="s">&quot;zone_dict&quot;</span><span class="p">:</span><span class="n">zone_json_dictionary</span><span class="p">,</span><span class="s">&quot;obj_sync&quot;</span><span class="p">:</span><span class="s">&quot;0&quot;</span><span class="p">}</span>
      <span class="k">try</span><span class="p">:</span>
        <span class="c">#f = urllib2.urlopen(site_query, params,timeout = 5)</span>
        <span class="c">#result=f.read()</span>
        <span class="n">f</span><span class="o">=</span><span class="n">url_request_manager</span><span class="o">.</span><span class="n">request_encode_body</span><span class="p">(</span><span class="s">&#39;POST&#39;</span><span class="p">,</span><span class="n">site_query</span><span class="p">,</span><span class="n">params</span><span class="p">,</span><span class="n">timeout</span><span class="o">=</span><span class="n">Timeout</span><span class="p">(</span><span class="n">total</span><span class="o">=</span><span class="mi">20</span><span class="p">))</span>
        <span class="n">result</span><span class="o">=</span><span class="n">f</span><span class="o">.</span><span class="n">data</span>
        <span class="k">print</span> <span class="n">result</span>
        <span class="n">online_zone_dict</span><span class="o">=</span><span class="n">zone_json_dictionary</span>  <span class="c">#banana, to get this value from the server</span>
      <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">e</span>  <span class="p">:</span>
        <span class="k">print</span> <span class="s">&quot;error in the remote object update&quot;</span><span class="o">+</span><span class="s">&quot; e:&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">)</span>
        <span class="n">errorQueue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="s">&quot;error in the remote object update&quot;</span><span class="o">+</span><span class="s">&quot; e:&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">)</span> <span class="p">)</span>
        <span class="n">online_zone_dict</span><span class="o">=</span><span class="s">&quot;&quot;</span>
        <span class="k">continue</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&quot;syntax error&quot;</span><span class="p">)</span><span class="o">!=-</span><span class="mi">1</span><span class="p">)</span><span class="ow">or</span> <span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&quot;error_&quot;</span><span class="p">)</span><span class="o">!=-</span><span class="mi">1</span><span class="p">):</span>
        <span class="n">online_zone_dict</span><span class="o">=</span><span class="s">&quot;&quot;</span>
        <span class="k">continue</span>
    <span class="c">#time_sync=datetime.datetime.now().strftime(&quot;%Y-%m-%d-%H-%M-%S&quot;)   # &#39;2015-08-19-09-15-18&#39;   time to allow the server detect when the onos center is online</span>
    <span class="n">site_query</span><span class="o">=</span><span class="n">onos_online_site_url</span><span class="o">+</span><span class="s">&quot;get_sync_messages.php&quot;</span>
    <span class="n">params</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;onos_key&#39;</span><span class="p">:</span> <span class="n">onos_online_key</span><span class="p">,</span> <span class="s">&#39;onos_password&#39;</span><span class="p">:</span> <span class="n">onos_online_password</span><span class="p">,</span><span class="s">&#39;hw_fw_version&#39;</span><span class="p">:</span><span class="n">router_hardware_fw_version</span><span class="p">}</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="c">#f = urllib2.urlopen(site_query, params,timeout = 5)</span>
      <span class="c">#sync_message=f.read()</span>
      <span class="n">f</span><span class="o">=</span><span class="n">url_request_manager</span><span class="o">.</span><span class="n">request_encode_body</span><span class="p">(</span><span class="s">&#39;POST&#39;</span><span class="p">,</span><span class="n">site_query</span><span class="p">,</span><span class="n">params</span><span class="p">,</span><span class="n">timeout</span><span class="o">=</span><span class="n">Timeout</span><span class="p">(</span><span class="n">total</span><span class="o">=</span><span class="mi">20</span><span class="p">))</span>
      <span class="n">result</span><span class="o">=</span><span class="n">f</span><span class="o">.</span><span class="n">data</span>
      <span class="n">sync_message</span><span class="o">=</span><span class="n">result</span>
      <span class="k">print</span> <span class="n">sync_message</span>

    <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">e</span>  <span class="p">:</span>
      <span class="k">print</span> <span class="s">&quot;error contacting the online server to get sync message&quot;</span><span class="o">+</span><span class="s">&quot; e:&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">)</span>
      <span class="n">errorQueue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span> <span class="s">&quot;error contacting the online server to get sync message&quot;</span><span class="o">+</span><span class="s">&quot; e:&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">))</span>
      <span class="n">onlineServerSyncThreadIsrunning</span><span class="o">=</span><span class="mi">0</span>
      <span class="k">return</span><span class="p">()</span>

<span class="c">#message example :</span>
<span class="c">#  &#39;#start@#_@onosuser#_@obj_ch#_@obj1#_@objstatus_to_set#_#stop@&quot;      message for online obj changed to objstatus_to_set</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="c">###json_filtered_msg=re.match(r&#39;#_cmd_.+?_cmd_#&#39;,sync_message).group(1)</span>
      <span class="c">#re.search(&#39;#_cmd_(.+?)_cmd_#&#39;,sync_message).group(1)</span>
      <span class="c">#json_filtered_msg=sync_message.partition(&quot;#_cmd_&quot;)[2].partition(&quot;_cmd_#&quot;)[0]</span>
      <span class="n">json_filtered_msg</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s">&#39;#_cmd_(.+?)_cmd_#&#39;</span><span class="p">,</span><span class="n">sync_message</span><span class="p">)</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
      <span class="k">print</span> <span class="s">&quot;filtered sync_message :&quot;</span><span class="o">+</span><span class="n">json_filtered_msg</span>
      <span class="n">cmd_list</span><span class="o">=</span><span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">json_filtered_msg</span><span class="p">)</span>
      <span class="k">print</span> <span class="s">&quot;json_cmd_list:&quot;</span><span class="p">,</span><span class="n">cmd_list</span>
      <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">cmd_list</span> <span class="p">:</span>  <span class="c">#iterate the list</span>
        <span class="n">cmd_split</span><span class="o">=</span><span class="n">a</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&quot;#_@&quot;</span><span class="p">)</span>  <span class="c">#split    using #_@  as delimiter</span>
        <span class="k">print</span> <span class="s">&quot;cmd_split&quot;</span><span class="p">,</span><span class="n">cmd_split</span>
        <span class="n">username</span><span class="o">=</span><span class="n">cmd_split</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">username</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">usersDict</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
          <span class="k">print</span> <span class="s">&quot;error online username not in local users Dict&quot;</span>
          <span class="n">errorQueue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span> <span class="s">&quot;error online username not in local users Dict&quot;</span><span class="p">)</span>
          <span class="k">continue</span>
        <span class="n">cmd_code</span><span class="o">=</span><span class="n">cmd_split</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
        <span class="k">print</span> <span class="s">&quot;online username:&quot;</span><span class="o">+</span><span class="n">username</span>
        <span class="k">print</span> <span class="s">&quot;cmd code=&quot;</span><span class="o">+</span><span class="n">cmd_code</span>
        <span class="k">if</span> <span class="n">cmd_code</span><span class="o">==</span><span class="s">&quot;obj_ch&quot;</span><span class="p">:</span>
          <span class="n">obj_name</span><span class="o">=</span><span class="n">cmd_split</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
          <span class="n">status_to_set</span><span class="o">=</span><span class="n">cmd_split</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
          <span class="n">priority</span><span class="o">=</span><span class="n">usersDict</span><span class="p">[</span><span class="n">username</span><span class="p">][</span><span class="s">&quot;priority&quot;</span><span class="p">]</span>
          <span class="n">priorityCmdQueue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span> <span class="p">{</span><span class="s">&quot;cmd&quot;</span><span class="p">:</span><span class="s">&quot;setSts&quot;</span><span class="p">,</span><span class="s">&quot;webObjectName&quot;</span><span class="p">:</span><span class="n">obj_name</span><span class="p">,</span><span class="s">&quot;status_to_set&quot;</span><span class="p">:</span><span class="n">status_to_set</span><span class="p">,</span><span class="s">&quot;write_to_hw&quot;</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span><span class="s">&quot;priority&quot;</span><span class="p">:</span><span class="n">priority</span><span class="p">,</span><span class="s">&quot;user&quot;</span><span class="p">:</span><span class="n">username</span><span class="p">,</span><span class="s">&quot;mail_report_list&quot;</span><span class="p">:[]</span> <span class="p">})</span>  

    <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">e</span>  <span class="p">:</span>
      <span class="k">print</span> <span class="s">&quot;sync_message decoding error,sync_message:&quot;</span><span class="o">+</span><span class="n">sync_message</span><span class="o">+</span><span class="s">&quot; e:&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">)</span> 
      <span class="n">errorQueue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span> <span class="s">&quot;sync_message decoding error,sync_message&quot;</span><span class="o">+</span><span class="n">sync_message</span><span class="o">+</span><span class="s">&quot; e:&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">)</span> <span class="p">)</span>
    <span class="n">onlineServerSyncThreadIsrunning</span><span class="o">=</span><span class="mi">0</span>
    <span class="k">return</span><span class="p">()</span>



  <span class="n">onlineServerSyncThreadIsrunning</span><span class="o">=</span><span class="mi">0</span>
  <span class="k">return</span><span class="p">()</span>


<span class="k">def</span> <span class="nf">mailOutputHandler</span><span class="p">():</span></div>
<div class="viewcode-block" id="mailOutputHandler"><a class="viewcode-back" href="../webserver.html#webserver.mailOutputHandler">[docs]</a>  <span class="k">global</span> <span class="n">errorQueue</span>
  <span class="k">global</span> <span class="n">mailOutputHandler_is_running</span>

  <span class="n">mailOutputHandler_is_running</span><span class="o">=</span><span class="mi">1</span>
  <span class="k">print</span> <span class="s">&quot;mailOutputHandler thread executed&quot;</span>


  <span class="k">while</span> <span class="ow">not</span> <span class="n">mailQueue</span><span class="o">.</span><span class="n">empty</span><span class="p">():</span> <span class="c">#until there are no more mail to send</span>

    
    <span class="n">mail_to_send</span> <span class="o">=</span> <span class="n">mailQueue</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
    <span class="c">#mailQueue.task_done()</span>
    <span class="n">mail_address</span><span class="o">=</span><span class="n">mail_to_send</span><span class="p">[</span><span class="s">&quot;mail_address&quot;</span><span class="p">]</span>
    <span class="n">mailText</span><span class="o">=</span><span class="n">mail_to_send</span><span class="p">[</span><span class="s">&quot;mailText&quot;</span><span class="p">]</span>
    <span class="n">mailSubject</span><span class="o">=</span><span class="n">mail_to_send</span><span class="p">[</span><span class="s">&quot;mailSubject&quot;</span><span class="p">]</span>
    <span class="n">mail_sent</span><span class="o">=</span><span class="n">sendMail</span><span class="p">(</span><span class="n">mail_address</span><span class="p">,</span><span class="n">mailText</span><span class="p">,</span><span class="n">mailSubject</span><span class="p">,</span><span class="n">onos_mail_conf</span><span class="p">,</span><span class="n">smtplib</span><span class="p">,</span><span class="n">string</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">mail_sent</span><span class="o">!=</span><span class="mi">1</span> <span class="p">:</span> <span class="c">#mail error , onos was not able to send the mail and will try again</span>
      <span class="k">print</span> <span class="s">&quot;error cant send mail&quot;</span>
      <span class="n">errorQueue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="s">&quot;error cant send mail&quot;</span> <span class="p">)</span>
      <span class="n">errorQueue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">mail_sent</span><span class="p">)</span>
     
      <span class="n">mailQueue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">mail_to_send</span><span class="p">)</span>  <span class="c">#read the mail to the queue for further try</span>
      <span class="c">#mailQueue.put({&quot;mail_address&quot;:mail_address,&quot;mailText&quot;:mailText,&quot;mailSubject&quot;:mailSubject})</span>

      <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">mail_retry_timeout</span><span class="p">)</span> <span class="c"># wait before retry...to not overuse the cpu</span>
      

  <span class="n">mailOutputHandler_is_running</span><span class="o">=</span><span class="mi">0</span>
  <span class="k">return</span>


<span class="k">def</span> <span class="nf">mailCheckThread</span><span class="p">():</span></div>
<div class="viewcode-block" id="mailCheckThread"><a class="viewcode-back" href="../webserver.html#webserver.mailCheckThread">[docs]</a>  <span class="k">print</span> <span class="s">&quot;mailCheckThread() excuted&quot;</span>
  <span class="k">global</span> <span class="n">mailCheckThreadIsrunning</span>  
  <span class="n">mailCheckThreadIsrunning</span><span class="o">=</span><span class="mi">1</span>


  <span class="k">if</span> <span class="p">(</span><span class="nb">exit</span><span class="o">==</span><span class="mi">0</span><span class="p">):</span>   <span class="c">#if exit ==1  then close the webserver</span>

    <span class="c">#time.sleep(1)  #wait</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="n">mailList</span><span class="o">=</span><span class="n">receiveMail</span><span class="p">(</span><span class="n">onos_mail_conf</span><span class="p">,</span><span class="n">imaplib</span><span class="p">,</span><span class="n">email</span><span class="p">)</span>  <span class="c">#a list of list where the data are (msg_sender,msg_subject,msg_text)</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
      <span class="k">print</span> <span class="s">&quot;error in  mailagent&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">)</span>
      <span class="n">errorQueue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="s">&quot;error in  mailagent&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">))</span>
      <span class="n">mailList</span><span class="o">=-</span><span class="mi">1</span>

    <span class="k">if</span> <span class="n">mailList</span><span class="o">==-</span><span class="mi">1</span><span class="p">:</span>
      <span class="k">print</span> <span class="s">&quot;error mailagent ,  wrong username/password or no internet connection&quot;</span>
      <span class="n">errorQueue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span> <span class="s">&quot;error mailagent ,  wrong username/password or no internet connection,i disable the mail service&quot;</span><span class="p">)</span>
      <span class="k">print</span> <span class="s">&quot;i disable the mail service&quot;</span>
      <span class="n">enable_mail_service</span><span class="o">=</span><span class="mi">0</span>  
      <span class="k">return</span><span class="p">()</span> 

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">mailList</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>  <span class="c">#there are mails</span>
      <span class="k">for</span> <span class="n">rx_mail</span> <span class="ow">in</span> <span class="n">mailList</span><span class="p">:</span>
        <span class="c">#print &quot;rx mail=&quot;,rx_mail</span>
        <span class="n">m_sender</span><span class="o">=</span><span class="n">rx_mail</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">m_subject</span><span class="o">=</span><span class="n">rx_mail</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">m_text</span><span class="o">=</span><span class="n">rx_mail</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>

        <span class="n">rx_mail_lines</span><span class="o">=</span><span class="n">m_text</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()</span> <span class="c">#split by lines  </span>
        <span class="c">#answer_mail=[] </span>
        <span class="n">mailText</span><span class="o">=</span><span class="s">&quot;&quot;</span> <span class="c">#answer mail text</span>
        <span class="n">mailSubject</span><span class="o">=</span><span class="s">&quot;onos_report&quot;</span> <span class="c">#answer mail subject</span>


        <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">rx_mail_lines</span><span class="p">:</span>  <span class="c">#for each line there will be a command...</span>
          <span class="n">l</span><span class="o">=</span><span class="n">l</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="c">#remove start and end spaces </span>
          <span class="n">onos_usr</span><span class="o">=</span><span class="s">&quot;onos_mail_guest&quot;</span>
          <span class="n">usr_onos_mail_pw</span><span class="o">=</span><span class="n">usersDict</span><span class="p">[</span><span class="n">onos_usr</span><span class="p">][</span><span class="s">&quot;mail_control_password&quot;</span><span class="p">]</span>
          <span class="n">cmd_type</span><span class="o">=</span><span class="s">&quot;&quot;</span>
          <span class="n">cmd_argument</span><span class="o">=</span><span class="s">&quot;&quot;</span>
          <span class="n">priority</span><span class="o">=</span><span class="s">&quot;&quot;</span>
          <span class="n">log_enable</span><span class="o">=</span><span class="mi">0</span> 
          <span class="n">scenario_enable</span><span class="o">=</span><span class="s">&quot;&quot;</span>
          <span class="n">status</span><span class="o">=</span><span class="s">&quot;&quot;</span> 
   

          
  <span class="c"># example : onos=cmd:so,arg:button1_RouterGL0000,st:1,      note the end &quot;,&quot;  must be used          </span>
          <span class="k">if</span> <span class="mi">1</span><span class="p">:</span> 
            <span class="n">tmp_split</span><span class="o">=</span><span class="n">l</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&quot;,&quot;</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">t_arg</span> <span class="ow">in</span> <span class="n">tmp_split</span><span class="p">:</span>
              <span class="k">if</span> <span class="p">(</span><span class="n">t_arg</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">u&quot;usr:&quot;</span><span class="p">))</span><span class="o">!=-</span><span class="mi">1</span><span class="p">:</span>
                <span class="n">onos_usr</span><span class="o">=</span><span class="n">t_arg</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">u&quot;:&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>  <span class="c">#get onos_usr from  &quot;usr:onos_usr&quot;</span>
              <span class="k">if</span> <span class="p">(</span><span class="n">t_arg</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">u&quot;pw:&quot;</span><span class="p">))</span><span class="o">!=-</span><span class="mi">1</span><span class="p">:</span>
                <span class="n">usr_onos_mail_pw</span><span class="o">=</span><span class="n">t_arg</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">u&quot;:&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>  <span class="c">#get onos_pw from  &quot;pw:onos_pw&quot;</span>
              <span class="k">if</span> <span class="p">(</span><span class="n">t_arg</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">u&quot;cmd:&quot;</span><span class="p">))</span><span class="o">!=-</span><span class="mi">1</span><span class="p">:</span>
                <span class="n">cmd_type</span><span class="o">=</span><span class="n">t_arg</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">u&quot;:&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>  
              <span class="k">if</span> <span class="p">(</span><span class="n">t_arg</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">u&quot;st:&quot;</span><span class="p">))</span><span class="o">!=-</span><span class="mi">1</span><span class="p">:</span>
                <span class="n">status</span><span class="o">=</span><span class="n">t_arg</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">u&quot;:&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>  
              <span class="k">if</span> <span class="p">(</span><span class="n">t_arg</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">u&quot;arg:&quot;</span><span class="p">))</span><span class="o">!=-</span><span class="mi">1</span><span class="p">:</span>
                <span class="n">cmd_argument</span><span class="o">=</span><span class="n">t_arg</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">u&quot;:&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>  
              <span class="k">if</span> <span class="p">(</span><span class="n">t_arg</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">u&quot;priority:&quot;</span><span class="p">))</span><span class="o">!=-</span><span class="mi">1</span><span class="p">:</span>
                <span class="n">priority</span><span class="o">=</span><span class="n">t_arg</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">u&quot;:&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>  


            <span class="k">if</span> <span class="n">onos_usr</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">usersDict</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="p">:</span>
              <span class="k">print</span> <span class="s">&quot;error mail user  not in user list&quot;</span> 
              <span class="n">errorQueue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span> <span class="s">&quot;error mail user  not in user list&quot;</span> <span class="p">)</span> 
              <span class="n">mailText</span><span class="o">=</span><span class="n">mailText</span><span class="o">+</span><span class="n">compose_error_mail</span><span class="p">(</span><span class="s">&quot;wrong_username&quot;</span><span class="p">)</span>
              <span class="k">continue</span>   


            <span class="k">if</span> <span class="n">compareText</span><span class="p">(</span><span class="n">usr_onos_mail_pw</span><span class="p">,</span><span class="n">usersDict</span><span class="p">[</span><span class="n">onos_usr</span><span class="p">][</span><span class="s">&quot;mail_control_password&quot;</span><span class="p">])</span><span class="o">!=</span><span class="mi">1</span> <span class="p">:</span>
              <span class="k">print</span> <span class="s">&quot;error mail user password not correct&quot;</span>    
              <span class="n">errorQueue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span> <span class="s">&quot;error mail user password not correct&quot;</span> <span class="p">)</span>
              <span class="n">mailText</span><span class="o">=</span><span class="n">mailText</span><span class="o">+</span><span class="n">compose_error_mail</span><span class="p">(</span><span class="s">&quot;wrong_password&quot;</span><span class="p">)</span>
              <span class="k">continue</span>   


            <span class="k">if</span> <span class="n">compareText</span><span class="p">(</span><span class="n">onos_usr</span><span class="p">,</span><span class="n">onos_usr</span><span class="p">)</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span> <span class="c">#if the username is the default mail one.. </span>
              <span class="k">if</span> <span class="n">m_sender</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">mail_whiteList</span> <span class="p">:</span>
                <span class="k">print</span> <span class="s">&quot;error mail not in mail list&quot;</span>    
                <span class="n">errorQueue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="s">&quot;error mail not in mail list&quot;</span> <span class="p">)</span>
                <span class="n">mailText</span><span class="o">=</span><span class="n">mailText</span><span class="o">+</span><span class="n">compose_error_mail</span><span class="p">(</span><span class="s">&quot;white_list&quot;</span><span class="p">)</span>
                <span class="k">continue</span>   


            <span class="k">if</span> <span class="n">accept_only_from_white_list</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>

              <span class="k">if</span> <span class="n">m_sender</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">mail_whiteList</span> <span class="p">:</span>
                <span class="k">print</span> <span class="s">&quot;error mail not in mail list&quot;</span>  
                <span class="n">errorQueue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span> <span class="s">&quot;error mail not in mail list&quot;</span> <span class="p">)</span>  
                <span class="n">mailText</span><span class="o">=</span><span class="n">mailText</span><span class="o">+</span><span class="n">compose_error_mail</span><span class="p">(</span><span class="s">&quot;white_list&quot;</span><span class="p">)</span>
                <span class="k">continue</span>   

            

          <span class="k">else</span><span class="p">:</span>
            <span class="k">print</span> <span class="s">&quot;mail parsing error&quot;</span>
            <span class="n">errorQueue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="s">&quot;mail parsing error&quot;</span> <span class="p">)</span>
            <span class="n">mailText</span><span class="o">=</span><span class="n">mailText</span><span class="o">+</span><span class="n">compose_error_mail</span><span class="p">(</span><span class="s">&quot;parse&quot;</span><span class="p">)</span>
            <span class="k">continue</span>

          <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">priority</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">):</span>            
            <span class="n">priority</span><span class="o">=</span><span class="n">usersDict</span><span class="p">[</span><span class="n">onos_usr</span><span class="p">][</span><span class="s">&quot;priority&quot;</span><span class="p">]</span>
          <span class="c">#print &quot;priority set to :&quot;,priority</span>

          <span class="k">if</span> <span class="n">compareText</span><span class="p">(</span><span class="n">cmd_type</span><span class="p">,</span><span class="s">u&quot;so&quot;</span><span class="p">):</span>  <span class="c">#if the cmd type is set object..</span>

            

            <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">cmd_argument</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">status</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">):</span>  <span class="c">#the arguments lenghts are ok</span>
              <span class="k">if</span> <span class="n">cmd_argument</span> <span class="ow">in</span> <span class="n">object_dict</span><span class="p">:</span>  <span class="c">#the object exist</span>
                <span class="n">obj_previous_status</span><span class="o">=</span><span class="n">object_dict</span><span class="p">[</span><span class="n">cmd_argument</span><span class="p">]</span><span class="o">.</span><span class="n">getStatus</span><span class="p">()</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">object_dict</span><span class="p">[</span><span class="n">cmd_argument</span><span class="p">]</span><span class="o">.</span><span class="n">validateStatusToSetObj</span><span class="p">(</span><span class="n">status</span><span class="p">)</span><span class="o">==</span><span class="mi">1</span> <span class="p">):</span>  <span class="c">#if the status is ok and type is output  </span>
                  <span class="k">print</span> <span class="s">&quot;check priority&quot;</span>
                  <span class="k">if</span> <span class="n">object_dict</span><span class="p">[</span><span class="n">cmd_argument</span><span class="p">]</span><span class="o">.</span><span class="n">checkRequiredPriority</span><span class="p">(</span><span class="n">priority</span><span class="p">)</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>  <span class="c">#check priority </span>
                    <span class="k">print</span> <span class="s">&quot;priority ok&quot;</span>

                    <span class="c">#check permission  </span>
                    <span class="k">if</span> <span class="n">object_dict</span><span class="p">[</span><span class="n">cmd_argument</span><span class="p">]</span><span class="o">.</span><span class="n">checkPermissions</span><span class="p">(</span><span class="n">onos_usr</span><span class="p">,</span><span class="s">&quot;x&quot;</span><span class="p">,</span><span class="n">priority</span><span class="p">):</span><span class="c">#check if user has execution to obj                   </span>
                      <span class="k">print</span> <span class="s">&quot;permission ok ,i write to obj&quot;</span>
                      <span class="n">mailText</span><span class="o">=</span><span class="n">mailText</span><span class="o">+</span><span class="s">&quot;O.N.O.S. received the mail :&quot;</span><span class="o">+</span><span class="n">l</span><span class="o">+</span><span class="s">&quot; and is processing it ,&quot;</span>
                      <span class="n">priorityCmdQueue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span> <span class="p">{</span><span class="s">&quot;cmd&quot;</span><span class="p">:</span><span class="s">&quot;setSts&quot;</span><span class="p">,</span><span class="s">&quot;webObjectName&quot;</span><span class="p">:</span><span class="n">cmd_argument</span><span class="p">,</span><span class="s">&quot;status_to_set&quot;</span><span class="p">:</span><span class="n">status</span><span class="p">,</span><span class="s">&quot;write_to_hw&quot;</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span><span class="s">&quot;priority&quot;</span><span class="p">:</span><span class="n">priority</span><span class="p">,</span><span class="s">&quot;user&quot;</span><span class="p">:</span><span class="s">&quot;onos_usr&quot;</span><span class="p">,</span><span class="s">&quot;mail_report_list&quot;</span><span class="p">:[</span><span class="n">m_sender</span><span class="p">]</span> <span class="p">})</span>  
                      <span class="k">continue</span>

                    <span class="k">else</span><span class="p">:</span> <span class="c">#permission error</span>
                      <span class="n">mailText</span><span class="o">=</span><span class="n">mailText</span><span class="o">+</span><span class="n">compose_error_mail</span><span class="p">(</span><span class="s">&quot;so_permissions&quot;</span><span class="p">,</span><span class="n">cmd_argument</span><span class="p">)</span>
                      <span class="k">continue</span>
                                                           

 
                  <span class="k">else</span><span class="p">:</span>
                    <span class="k">print</span> <span class="s">&quot;error mail , user priority not sufficent to change the obj status&quot;</span>
                    <span class="n">errorQueue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="s">&quot;error mail , user priority not sufficent to change the obj status&quot;</span> <span class="p">)</span>
                    <span class="n">mailText</span><span class="o">=</span><span class="n">mailText</span><span class="o">+</span><span class="n">compose_error_mail</span><span class="p">(</span><span class="s">&quot;so_priority&quot;</span><span class="p">,</span><span class="n">cmd_argument</span><span class="p">)</span>
                    <span class="k">continue</span>


              
                <span class="k">else</span><span class="p">:</span>   
                  <span class="k">print</span> <span class="s">&quot;error mail ,object type not compatible with status passed &quot;</span>
                  <span class="n">errorQueue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="s">&quot;error mail ,object type not compatible with status passed &quot;</span> <span class="p">)</span>
                  <span class="n">mailText</span><span class="o">=</span><span class="n">mailText</span><span class="o">+</span><span class="n">compose_error_mail</span><span class="p">(</span><span class="s">&quot;so_value&quot;</span><span class="p">,</span><span class="n">cmd_argument</span><span class="p">)</span>
                  <span class="k">continue</span>


              <span class="k">else</span><span class="p">:</span>
                <span class="k">print</span> <span class="s">&quot;error mail, can&#39;t found the argument in the dictionary &quot;</span> 
                <span class="n">errorQueue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="s">&quot;error mail, can&#39;t found the argument in the dictionary &quot;</span>  <span class="p">)</span> 
                <span class="n">mailText</span><span class="o">=</span><span class="n">mailText</span><span class="o">+</span><span class="n">compose_error_mail</span><span class="p">(</span><span class="s">&quot;so_obj_not_exist&quot;</span><span class="p">,</span><span class="n">cmd_argument</span><span class="p">)</span>
                <span class="k">continue</span>                                         
            
            <span class="k">else</span><span class="p">:</span>
              <span class="k">print</span> <span class="s">&quot;error mail invalid arg len&quot;</span>
              <span class="n">errorQueue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="s">&quot;error mail invalid arg len&quot;</span> <span class="p">)</span>
              <span class="k">continue</span>
                      
          <span class="k">else</span><span class="p">:</span> <span class="c">#not a know cmdtype</span>
            <span class="k">print</span> <span class="s">&quot;unknow mail cmd&quot;</span>
            <span class="k">continue</span>                                  

        <span class="k">print</span> <span class="s">&quot;send mail..&quot;</span><span class="o">+</span><span class="n">mailText</span>

        <span class="n">mailQueue</span><span class="o">.</span><span class="n">put</span><span class="p">({</span><span class="s">&quot;mail_address&quot;</span><span class="p">:</span><span class="n">m_sender</span><span class="p">,</span><span class="s">&quot;mailText&quot;</span><span class="p">:</span><span class="n">mailText</span><span class="p">,</span><span class="s">&quot;mailSubject&quot;</span><span class="p">:</span><span class="n">mailSubject</span><span class="p">})</span>


    <span class="k">else</span><span class="p">:</span><span class="c">#no mail received</span>
      <span class="c">#time.sleep(mail_check_frequency)</span>
      <span class="n">mailCheckThreadIsrunning</span><span class="o">=</span><span class="mi">0</span>
      <span class="k">return</span><span class="p">()</span>            
  <span class="c">#time.sleep(mail_check_frequency)</span>
  <span class="n">mailCheckThreadIsrunning</span><span class="o">=</span><span class="mi">0</span>
  <span class="k">return</span><span class="p">()</span>




<span class="k">def</span> <span class="nf">hardwareHandlerThread</span><span class="p">():</span>  <span class="c">#check the nodes status and update the webobjects values </span></div>
<div class="viewcode-block" id="hardwareHandlerThread"><a class="viewcode-back" href="../webserver.html#webserver.hardwareHandlerThread">[docs]</a>  <span class="k">global</span> <span class="n">mailCheckThreadIsrunning</span>
  <span class="k">global</span> <span class="n">last_pin_read_time</span>
  <span class="k">global</span> <span class="n">last_mail_sync_time</span>
  <span class="k">global</span> <span class="n">last_server_sync_time</span>
  <span class="k">global</span> <span class="n">last_error_check_time</span>
  
  <span class="n">read_pin</span><span class="o">=</span><span class="mi">1</span>   <span class="c">#banana</span>
  <span class="c">#time.sleep(5)  #wait for webserver to startup </span>
  <span class="k">print</span> <span class="s">&quot;hardwareHandlerThread() executed&quot;</span>
  <span class="c">#if (exit==0):   #if exit ==1  then close the webserver</span>
  <span class="c">#print time.time()</span>
  <span class="c">#print &quot;last_mail_sync_time&quot;,last_mail_sync_time</span>
  <span class="c">#print  &quot;last_server_sync_time&quot;,last_server_sync_time</span>
  <span class="c">#print &quot;last_pin_read_time&quot;,last_pin_read_time</span>
  <span class="c">#print &quot;diff last_mail_sync_time&quot;,time.time()-last_mail_sync_time</span>
  <span class="c">#print &quot;diff last_server_sync_time&quot;,time.time()-last_server_sync_time</span>
  <span class="c">#print &quot;diff last_pin_read_time&quot;,time.time()-last_pin_read_time</span>
  <span class="n">last_node_check</span><span class="o">=</span><span class="mi">0</span>
  <span class="n">last_internet_check</span><span class="o">=</span><span class="mi">0</span>
  <span class="k">while</span> <span class="p">(</span><span class="nb">exit</span><span class="o">==</span><span class="mi">0</span><span class="p">):</span> 

    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">1.5</span><span class="p">)</span><span class="c">#to save cpu load</span>


    <span class="k">if</span> <span class="p">(</span> <span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="o">-</span><span class="n">last_internet_check</span><span class="p">)</span> <span class="o">&gt;</span><span class="mi">5</span> <span class="p">):</span>   <span class="c">#EVERY 5 SECONDS</span>
      <span class="n">last_internet_check</span><span class="o">=</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
      <span class="n">internet_connection</span><span class="o">=</span><span class="mi">0</span>
      <span class="k">try</span><span class="p">:</span>
        <span class="n">urllib2</span><span class="o">.</span><span class="n">urlopen</span><span class="p">(</span><span class="s">&quot;http://www.google.com&quot;</span><span class="p">)</span>  
        <span class="n">internet_connection</span><span class="o">=</span><span class="mi">1</span>
      <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span> 
        <span class="k">print</span> <span class="s">&quot;no internet connection 0&quot;</span><span class="o">+</span><span class="s">&quot; e:&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">)</span>
        <span class="c">#errorQueue.put(&quot;no internet connection 0&quot;+&quot; e:&quot;+str(e.args) )</span>
        <span class="n">internet_connection</span><span class="o">=</span><span class="mi">0</span>
 




    <span class="k">if</span> <span class="p">(</span> <span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="o">-</span><span class="n">last_node_check</span><span class="p">)</span> <span class="o">&gt;</span><span class="mi">2</span> <span class="p">):</span>   <span class="c">#EVERY 2 SECONDS</span>
      <span class="k">print</span> <span class="s">&quot;threads:&quot;</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">threading</span><span class="o">.</span><span class="n">enumerate</span><span class="p">())</span>
      <span class="k">print</span> <span class="s">&quot;check nodeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeee&quot;</span>
     
      <span class="n">last_node_check</span><span class="o">=</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
      <span class="c">#banana try...</span>
      <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">nodeDict</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">a</span><span class="o">==</span><span class="n">router_sn</span><span class="p">:</span>  <span class="c">#skip the router node</span>
          <span class="k">continue</span>

        <span class="k">if</span> <span class="n">nodeDict</span><span class="p">[</span><span class="n">a</span><span class="p">]</span><span class="o">.</span><span class="n">getNodeTimeout</span><span class="p">()</span><span class="o">==</span><span class="s">&quot;never&quot;</span><span class="p">:</span> <span class="c">#never timeout</span>
          <span class="k">continue</span>
         
        <span class="k">print</span> <span class="s">&quot;nodecheck:&quot;</span><span class="o">+</span><span class="n">a</span>
        <span class="c">#print &quot;last_node_sync:&quot;+str(nodeDict[a].getLastNodeSync()) </span>
        <span class="c">#print &quot;time_now:&quot;+str(time.time()) </span>
        <span class="k">print</span> <span class="s">&quot;difference=:&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="o">-</span><span class="n">nodeDict</span><span class="p">[</span><span class="n">a</span><span class="p">]</span><span class="o">.</span><span class="n">getLastNodeSync</span><span class="p">())</span>


        <span class="k">if</span>  <span class="p">(</span>  <span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="o">-</span><span class="n">nodeDict</span><span class="p">[</span><span class="n">a</span><span class="p">]</span><span class="o">.</span><span class="n">getLastNodeSync</span><span class="p">()</span> <span class="p">)</span><span class="o">&gt;</span><span class="n">nodeDict</span><span class="p">[</span><span class="n">a</span><span class="p">]</span><span class="o">.</span><span class="n">getNodeTimeout</span><span class="p">()</span>  <span class="p">)</span> <span class="p">:</span> <span class="c">#the node is not connected anymore          </span>
          <span class="k">if</span> <span class="n">nodeDict</span><span class="p">[</span><span class="n">a</span><span class="p">]</span><span class="o">.</span><span class="n">getNodeActivity</span><span class="p">()</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span> <span class="c">#if the node was already inactive</span>
            <span class="n">nodeDict</span><span class="p">[</span><span class="n">a</span><span class="p">]</span><span class="o">.</span><span class="n">updateLastNodeSync</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="o">-</span><span class="mi">99999</span><span class="p">)</span> <span class="c">#set this to prevent the overflow of the variable</span>
            <span class="k">continue</span> <span class="c">#skip</span>

          <span class="n">nodeDict</span><span class="p">[</span><span class="n">a</span><span class="p">]</span><span class="o">.</span><span class="n">setNodeActivity</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>  <span class="c">#set the node as inactive</span>
          <span class="k">print</span> <span class="s">&quot;the node:&quot;</span><span class="o">+</span><span class="n">a</span><span class="o">+</span><span class="s">&quot; IS NOT CONNECTED ANYMORE,did you disconnected it?&quot;</span>
          <span class="n">errorQueue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span> <span class="s">&quot;The node:&quot;</span><span class="o">+</span><span class="n">a</span><span class="o">+</span><span class="s">&quot; IS NOT CONNECTED ANYMORE,did you disconnected it?&quot;</span><span class="o">+</span><span class="s">&quot;at:&quot;</span> <span class="o">+</span><span class="n">getErrorTimeString</span><span class="p">())</span>
          <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">object_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">object_dict</span><span class="p">[</span><span class="n">b</span><span class="p">]</span><span class="o">.</span><span class="n">getHwNodeSerialNumber</span><span class="p">()</span><span class="o">==</span><span class="n">a</span> <span class="p">:</span>  <span class="c">#if the web object is from the node a then disactive it</span>
              <span class="c">#object_dict[b].setStatus(&quot;inactive&quot;)</span>
              <span class="n">priorityCmdQueue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span> <span class="p">{</span><span class="s">&quot;cmd&quot;</span><span class="p">:</span><span class="s">&quot;setSts&quot;</span><span class="p">,</span><span class="s">&quot;webObjectName&quot;</span><span class="p">:</span><span class="n">b</span><span class="p">,</span><span class="s">&quot;status_to_set&quot;</span><span class="p">:</span><span class="s">&quot;inactive&quot;</span><span class="p">,</span><span class="s">&quot;write_to_hw&quot;</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span><span class="s">&quot;user&quot;</span><span class="p">:</span><span class="s">&quot;onos_node&quot;</span><span class="p">,</span><span class="s">&quot;priority&quot;</span><span class="p">:</span><span class="mi">99</span><span class="p">,</span><span class="s">&quot;mail_report_list&quot;</span><span class="p">:[]})</span> 

        <span class="k">else</span><span class="p">:</span><span class="c">#now the node is connected</span>
          <span class="k">if</span> <span class="n">nodeDict</span><span class="p">[</span><span class="n">a</span><span class="p">]</span><span class="o">.</span><span class="n">getNodeActivity</span><span class="p">()</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span> <span class="c">#the node was not connected but now it is</span>
            <span class="n">nodeDict</span><span class="p">[</span><span class="n">a</span><span class="p">]</span><span class="o">.</span><span class="n">setNodeActivity</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>  <span class="c">#set the node as active</span>
            <span class="k">print</span> <span class="s">&quot;node:&quot;</span><span class="o">+</span><span class="n">a</span><span class="o">+</span><span class="s">&quot; returned active&quot;</span> 
            <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">object_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
              <span class="k">print</span> <span class="s">&quot;object_dict[b].getHwNodeSerialNumber():&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">object_dict</span><span class="p">[</span><span class="n">b</span><span class="p">]</span><span class="o">.</span><span class="n">getHwNodeSerialNumber</span><span class="p">())</span>
              <span class="k">if</span> <span class="n">object_dict</span><span class="p">[</span><span class="n">b</span><span class="p">]</span><span class="o">.</span><span class="n">getHwNodeSerialNumber</span><span class="p">()</span><span class="o">==</span><span class="n">a</span> <span class="p">:</span>  <span class="c">#if the web object is from the node a then reactive it</span>
                <span class="k">print</span> <span class="s">&quot;webobject:&quot;</span><span class="o">+</span><span class="n">b</span><span class="o">+</span><span class="s">&quot;returned active&quot;</span>
                <span class="n">prev_s</span><span class="o">=</span><span class="n">object_dict</span><span class="p">[</span><span class="n">b</span><span class="p">]</span><span class="o">.</span><span class="n">getPreviousStatus</span><span class="p">()</span> 
                <span class="n">current_s</span><span class="o">=</span><span class="n">object_dict</span><span class="p">[</span><span class="n">b</span><span class="p">]</span><span class="o">.</span><span class="n">getStatus</span><span class="p">()</span>
                <span class="k">if</span> <span class="p">((</span><span class="n">current_s</span><span class="o">==</span><span class="s">&quot;inactive&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">current_s</span><span class="o">==</span><span class="s">&quot;onoswait&quot;</span><span class="p">)</span> <span class="p">):</span> 
                <span class="c">#  prev_s=object_dict[b].getStartStatus()      #if the current status is &quot;inactive&quot; set it to the previous status</span>
                  <span class="k">print</span> <span class="s">&quot;the new status will be:&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">prev_s</span><span class="p">)</span>
                  <span class="n">priorityCmdQueue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span> <span class="p">{</span><span class="s">&quot;cmd&quot;</span><span class="p">:</span><span class="s">&quot;setSts&quot;</span><span class="p">,</span><span class="s">&quot;webObjectName&quot;</span><span class="p">:</span><span class="n">b</span><span class="p">,</span><span class="s">&quot;status_to_set&quot;</span><span class="p">:</span><span class="n">prev_s</span><span class="p">,</span><span class="s">&quot;write_to_hw&quot;</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span><span class="s">&quot;user&quot;</span><span class="p">:</span><span class="s">&quot;onos_node&quot;</span><span class="p">,</span><span class="s">&quot;priority&quot;</span><span class="p">:</span><span class="mi">99</span><span class="p">,</span><span class="s">&quot;mail_report_list&quot;</span><span class="p">:[]})</span>
                <span class="c">#set the web_object to the status before the disconnection </span>
          
          <span class="c">#nodeDict[a].updateLastNodeSync(time.time())</span>




    <span class="k">if</span> <span class="p">(</span><span class="n">online_server_enable</span><span class="o">==</span><span class="mi">1</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="n">internet_connection</span><span class="o">==</span><span class="mi">1</span><span class="p">):</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">onlineServerSyncThreadIsrunning</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span><span class="o">&amp;</span><span class="p">((</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="o">-</span><span class="n">last_server_sync_time</span><span class="p">)</span><span class="o">&gt;</span><span class="n">online_server_delay</span><span class="p">):</span>
        <span class="n">last_server_sync_time</span><span class="o">=</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="k">print</span> <span class="s">&quot;i started the online server sync service&quot;</span>
        <span class="k">try</span><span class="p">:</span>
          <span class="n">w4</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">onlineServerSync</span><span class="p">)</span>
          <span class="n">w4</span><span class="o">.</span><span class="n">daemon</span> <span class="o">=</span> <span class="bp">True</span>  <span class="c">#make the thread a daemon thread</span>
          <span class="n">w4</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">e</span> <span class="p">:</span>
          <span class="k">print</span> <span class="s">&quot;error executing onlineServerSync()&quot;</span><span class="o">+</span><span class="s">&quot; e:&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">)</span>
          <span class="n">errorQueue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span> <span class="s">&quot;error executing onlineServerSync()&quot;</span><span class="o">+</span><span class="s">&quot; e:&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">))</span>  
   <span class="c"># time.sleep(0.3) #don&#39;t remove this or else the router became instable</span>

   <span class="c">#the mail check will run only if the onlineServerSync is not running    </span>
    <span class="k">if</span> <span class="p">(</span><span class="n">enable_mail_service</span><span class="o">==</span><span class="mi">1</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="n">internet_connection</span><span class="o">==</span><span class="mi">1</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="n">onlineServerSyncThreadIsrunning</span><span class="o">==</span><span class="mi">0</span><span class="p">):</span>   
      <span class="k">if</span> <span class="p">(</span><span class="n">mailCheckThreadIsrunning</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span><span class="o">&amp;</span><span class="p">((</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="o">-</span><span class="n">last_mail_sync_time</span><span class="p">)</span><span class="o">&gt;</span><span class="n">mail_check_frequency</span><span class="p">):</span>
        <span class="n">last_mail_sync_time</span><span class="o">=</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
          <span class="n">w3</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">mailCheckThread</span><span class="p">)</span>
          <span class="n">w3</span><span class="o">.</span><span class="n">daemon</span> <span class="o">=</span> <span class="bp">True</span>  <span class="c">#make the thread a daemon thread</span>
          <span class="n">w3</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">e</span> <span class="p">:</span>
          <span class="k">print</span> <span class="s">&quot;error executing mailCheckThread()&quot;</span><span class="o">+</span><span class="s">&quot; e:&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">)</span>
          <span class="n">errorQueue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="s">&quot;error executing mailCheckThread()&quot;</span><span class="o">+</span><span class="s">&quot; e:&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">)</span> <span class="p">)</span> 
          <span class="c">#continue</span>
         
    <span class="c">#time.sleep(0.2)</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">read_pin</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)</span><span class="o">&amp;</span><span class="p">((</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="o">-</span><span class="n">last_pin_read_time</span><span class="p">)</span><span class="o">&gt;</span><span class="n">router_read_pin_frequency</span><span class="p">):</span>  <span class="c">#execute every n seconds</span>
      <span class="n">last_pin_read_time</span><span class="o">=</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
      <span class="c">#time.sleep(0.2)</span>

      <span class="c">#try:</span>
      <span class="c">#read local onosCenter pins (the router pin)</span>
      <span class="k">try</span><span class="p">:</span>
        <span class="n">read_pin</span><span class="o">=</span><span class="n">read_pin</span><span class="o">+</span><span class="n">hardware</span><span class="o">.</span><span class="n">read_router_pins</span><span class="p">()</span>  <span class="c"># if hardware.read_router_pins() is -1 for two times it will go to &lt;0</span>
      <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">e</span> <span class="p">:</span>
        <span class="k">print</span> <span class="s">&quot;error executing hardware.read_router_pins()&quot;</span><span class="o">+</span><span class="s">&quot; e:&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">)</span>
        <span class="n">errorQueue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span> <span class="s">&quot;error executing hardware.read_router_pins()&quot;</span><span class="o">+</span><span class="s">&quot; e:&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">))</span>  



    <span class="k">if</span> <span class="p">(</span><span class="n">mail_error_log_enable</span><span class="o">==</span><span class="mi">1</span><span class="p">):</span>

      <span class="k">if</span> <span class="p">(</span>  <span class="p">(</span>  <span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="o">-</span><span class="n">last_error_check_time</span><span class="p">)</span><span class="o">&gt;</span><span class="n">error_log_mail_frequency</span><span class="p">)</span>  <span class="p">):</span>
        <span class="n">last_error_check_time</span><span class="o">=</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
          
          <span class="n">error_text</span><span class="o">=</span><span class="s">&quot;&quot;</span>
          <span class="k">while</span> <span class="ow">not</span> <span class="n">errorQueue</span><span class="o">.</span><span class="n">empty</span><span class="p">():</span>
            <span class="n">error_text</span> <span class="o">=</span><span class="n">error_text</span><span class="o">+</span><span class="s">&quot;;;;</span><span class="se">\n</span><span class="s">&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">errorQueue</span><span class="o">.</span><span class="n">get</span><span class="p">())</span>
            <span class="c">#errorQueue.task_done()</span>
          <span class="k">if</span> <span class="p">(</span><span class="nb">len</span> <span class="p">(</span><span class="n">error_text</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
            <span class="n">mailQueue</span><span class="o">.</span><span class="n">put</span><span class="p">({</span><span class="s">&quot;mail_address&quot;</span><span class="p">:</span><span class="n">mail_where_to_send_errors</span><span class="p">,</span><span class="s">&quot;mailText&quot;</span><span class="p">:</span><span class="n">error_text</span><span class="p">,</span><span class="s">&quot;mailSubject&quot;</span><span class="p">:</span><span class="s">&quot;onos_errors_report&quot;</span><span class="p">})</span>

        <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
          <span class="k">print</span> <span class="s">&quot;error in the error mail log of hardwareHandlerThread !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!! &quot;</span><span class="o">+</span><span class="s">&quot; e:&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">)</span>
          <span class="k">print</span> <span class="n">error_text</span>
          <span class="n">errorQueue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="s">&quot;error in the error mail log of hardwareHandlerThread &quot;</span><span class="o">+</span><span class="s">&quot; e:&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">))</span>











    <span class="k">if</span> <span class="p">(</span> <span class="n">mailQueue</span><span class="o">.</span><span class="n">empty</span><span class="p">()</span><span class="o">==</span><span class="mi">0</span> <span class="p">)</span><span class="o">&amp;</span><span class="p">(</span> <span class="n">mailOutputHandler_is_running</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="n">internet_connection</span><span class="o">==</span><span class="mi">1</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="n">enable_mail_output_service</span><span class="o">==</span><span class="mi">1</span><span class="p">):</span>  <span class="c">#start the mail output thread if needed</span>
      <span class="c">#print &quot;mailOutputHandler_is_running=&quot;,mailOutputHandler_is_running</span>
      <span class="c">#print &quot;i execute mailOutputHandler thread ddddddddddddddddddddDDDDDDDDDDDDDDDDDDDdddddddddddDDDDDDDDDDDDDDDDdd &quot;</span>
      <span class="k">try</span><span class="p">:</span>
        <span class="n">send_mail</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">mailOutputHandler</span><span class="p">)</span>
        <span class="n">send_mail</span><span class="o">.</span><span class="n">daemon</span> <span class="o">=</span> <span class="bp">True</span>  <span class="c">#make the thread a daemon thread</span>
        <span class="n">send_mail</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

      <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>     
        <span class="k">print</span> <span class="s">&quot;error in the mail send of onosBusThread &quot;</span><span class="o">+</span><span class="s">&quot; e:&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">)</span>
        <span class="n">errorQueue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="s">&quot;error in the  mail send  of onosBusThread &quot;</span><span class="o">+</span><span class="s">&quot; e:&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">)</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">threading</span><span class="o">.</span><span class="n">active_count</span><span class="p">()))</span>
   
      <span class="c">#print &quot;mailOutputHandler_is_running=&quot;,mailOutputHandler_is_running</span>




<span class="k">def</span> <span class="nf">executeQueueFunction</span><span class="p">(</span><span class="n">dataExchanged</span><span class="p">):</span></div>
<div class="viewcode-block" id="executeQueueFunction"><a class="viewcode-back" href="../webserver.html#webserver.executeQueueFunction">[docs]</a>  <span class="k">if</span> <span class="p">((</span><span class="n">dataExchanged</span><span class="p">[</span><span class="s">&quot;cmd&quot;</span><span class="p">])</span><span class="o">==</span><span class="s">&quot;setNodePin&quot;</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span> 
      <span class="n">node_sn</span><span class="o">=</span><span class="n">dataExchanged</span><span class="p">[</span><span class="s">&quot;node_sn&quot;</span><span class="p">]</span>
      <span class="n">pin_number</span><span class="o">=</span><span class="n">dataExchanged</span><span class="p">[</span><span class="s">&quot;pinNumber&quot;</span><span class="p">]</span>
      <span class="n">pin_status</span><span class="o">=</span><span class="n">dataExchanged</span><span class="p">[</span><span class="s">&quot;status_to_set&quot;</span><span class="p">]</span>
      <span class="n">write_hw_enable</span><span class="o">=</span><span class="n">dataExchanged</span><span class="p">[</span><span class="s">&quot;write_to_hw&quot;</span><span class="p">]</span>
      <span class="n">mail_list_to_report_to</span><span class="o">=</span><span class="n">dataExchanged</span><span class="p">[</span><span class="s">&quot;mail_report_list&quot;</span><span class="p">]</span>
      <span class="n">setNodePin</span><span class="p">(</span><span class="n">node_sn</span><span class="p">,</span><span class="n">pin_number</span><span class="p">,</span><span class="n">pin_status</span><span class="p">,</span><span class="n">write_hw_enable</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">e</span> <span class="p">:</span>
      <span class="k">print</span> <span class="s">&quot;error in the setNodePin of onosBusThread &quot;</span><span class="o">+</span><span class="s">&quot; e:&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">)</span>
      <span class="n">errorQueue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="s">&quot;error in the setNodePin of onosBusThread &quot;</span><span class="o">+</span><span class="s">&quot; e:&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">))</span>

      <span class="k">return</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>

        

  <span class="k">if</span> <span class="p">(</span><span class="n">dataExchanged</span><span class="p">[</span><span class="s">&quot;cmd&quot;</span><span class="p">]</span><span class="o">==</span><span class="s">&quot;setSts&quot;</span><span class="p">):</span>    

    <span class="k">try</span><span class="p">:</span>          
      <span class="n">objName</span><span class="o">=</span><span class="n">dataExchanged</span><span class="p">[</span><span class="s">&quot;webObjectName&quot;</span><span class="p">]</span>
      <span class="n">status_to_set</span><span class="o">=</span><span class="n">dataExchanged</span><span class="p">[</span><span class="s">&quot;status_to_set&quot;</span><span class="p">]</span>
      <span class="n">write_hw_enable</span><span class="o">=</span><span class="n">dataExchanged</span><span class="p">[</span><span class="s">&quot;write_to_hw&quot;</span><span class="p">]</span>
      <span class="n">usr</span><span class="o">=</span><span class="s">&quot;onos_sys&quot;</span>
      <span class="n">priority</span><span class="o">=</span><span class="mi">0</span>
      <span class="n">mail_list_to_report_to</span><span class="o">=</span><span class="p">[]</span>
      <span class="k">if</span> <span class="s">&quot;mail_report_list&quot;</span> <span class="ow">in</span> <span class="n">dataExchanged</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">mail_list_to_report_to</span><span class="o">=</span><span class="n">dataExchanged</span><span class="p">[</span><span class="s">&quot;mail_report_list&quot;</span><span class="p">]</span>
      <span class="k">if</span> <span class="s">&quot;user&quot;</span> <span class="ow">in</span> <span class="n">dataExchanged</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">usr</span><span class="o">=</span><span class="n">dataExchanged</span><span class="p">[</span><span class="s">&quot;user&quot;</span><span class="p">]</span>
      <span class="k">if</span> <span class="s">&quot;priority&quot;</span> <span class="ow">in</span> <span class="n">dataExchanged</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">priority</span><span class="o">=</span><span class="n">dataExchanged</span><span class="p">[</span><span class="s">&quot;priority&quot;</span><span class="p">]</span>

      <span class="n">changeWebObjectStatus</span><span class="p">(</span><span class="n">objName</span><span class="p">,</span><span class="n">status_to_set</span><span class="p">,</span><span class="n">write_hw_enable</span><span class="p">,</span><span class="n">usr</span><span class="p">,</span><span class="n">priority</span><span class="p">,</span><span class="n">mail_list_to_report_to</span><span class="p">)</span>

    <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
      <span class="k">print</span> <span class="s">&quot;error in the setSts of onosBusThread &quot;</span><span class="o">+</span><span class="s">&quot; e:&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">)</span>
      <span class="n">errorQueue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="s">&quot;error in the setSts of onosBusThread: name:&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">objName</span><span class="p">)</span><span class="o">+</span><span class="s">&quot;,st:&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">status_to_set</span><span class="p">)</span><span class="o">+</span><span class="s">&quot;,wr_en:&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">write_hw_enable</span><span class="p">)</span><span class="o">+</span><span class="s">&quot;,usr:&quot;</span><span class="o">+</span><span class="n">usr</span><span class="o">+</span><span class="s">&quot;,priority:&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">priority</span><span class="p">)</span><span class="o">+</span><span class="s">&quot; e:&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">))</span> 


        
  <span class="k">if</span> <span class="p">(</span><span class="n">dataExchanged</span><span class="p">[</span><span class="s">&quot;cmd&quot;</span><span class="p">]</span><span class="o">==</span><span class="s">&quot;scen_check&quot;</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="n">scenarioName</span><span class="o">=</span><span class="n">dataExchanged</span><span class="p">[</span><span class="s">&quot;scenarioName&quot;</span><span class="p">]</span>
      <span class="n">checkwebObjectScenarios</span><span class="p">(</span><span class="n">scenarioName</span><span class="p">)</span> 
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
      <span class="k">print</span> <span class="s">&quot;error in the scen_check of onosBusThread ,scenario_name:&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">scenarioName</span><span class="p">)</span><span class="o">+</span><span class="s">&quot; e:&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">)</span>
      <span class="n">errorQueue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="s">&quot;error in the scen_check of onosBusThread ,scenario_name:&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">scenarioName</span><span class="p">)</span><span class="o">+</span><span class="s">&quot; e:&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">))</span>




  <span class="k">print</span> <span class="s">&quot;dataExchanged = : &quot;</span><span class="p">,</span> <span class="n">dataExchanged</span>

  <span class="k">return</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">onosBusThread</span><span class="p">():</span></div>
<div class="viewcode-block" id="onosBusThread"><a class="viewcode-back" href="../webserver.html#webserver.onosBusThread">[docs]</a>
  <span class="k">global</span> <span class="n">internet_connection</span>
  <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>  <span class="c">#wait for webserver to startup </span>
  <span class="k">while</span> <span class="p">(</span><span class="nb">exit</span><span class="o">==</span><span class="mi">0</span><span class="p">):</span>   <span class="c">#if exit ==1  then close the webserver</span>
    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.03</span><span class="p">)</span>    <span class="c">#wait until layerExchangeDataQueue has some element     </span>
    <span class="k">try</span><span class="p">:</span>



      <span class="k">while</span> <span class="ow">not</span> <span class="n">priorityCmdQueue</span><span class="o">.</span><span class="n">empty</span><span class="p">():</span>   <span class="c">#this has priority over the other layer</span>
        <span class="c">#if not priorityCmdQueue.empty():</span>
        <span class="n">executeQueueFunction</span><span class="p">(</span><span class="n">priorityCmdQueue</span><span class="o">.</span><span class="n">get</span><span class="p">())</span>


    
      <span class="k">while</span> <span class="ow">not</span> <span class="n">layerExchangeDataQueue</span><span class="o">.</span><span class="n">empty</span><span class="p">():</span>
        <span class="c">#if not layerExchangeDataQueue.empty():</span>

        <span class="k">while</span> <span class="ow">not</span> <span class="n">priorityCmdQueue</span><span class="o">.</span><span class="n">empty</span><span class="p">():</span>   <span class="c">#this has priority over the other layer</span>
          <span class="c">#if not priorityCmdQueue.empty():</span>
          <span class="n">executeQueueFunction</span><span class="p">(</span><span class="n">priorityCmdQueue</span><span class="o">.</span><span class="n">get</span><span class="p">())</span>
        


        <span class="n">executeQueueFunction</span><span class="p">(</span><span class="n">layerExchangeDataQueue</span><span class="o">.</span><span class="n">get</span><span class="p">())</span>
        <span class="c">#layerExchangeDataQueue.task_done()</span>



      

        







    <span class="c">#here starts the less important part ,executed only when there is nothing in layerExchangeDataQueue</span>

         
      <span class="k">try</span><span class="p">:</span>
        <span class="n">old_minutes</span><span class="o">=</span><span class="n">object_dict</span><span class="p">[</span><span class="s">&quot;minutes&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">getStatus</span><span class="p">()</span>
      <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>  
        <span class="k">print</span> <span class="s">&quot;error in the minutes update of onosBusThread &quot;</span><span class="o">+</span><span class="s">&quot; e:&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">)</span>
        <span class="n">errorQueue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="s">&quot;error in the  minutes update of onosBusThread &quot;</span><span class="o">+</span><span class="s">&quot; e:&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">))</span>  
        <span class="n">old_minutes</span><span class="o">=</span><span class="mi">0</span>

    <span class="c">#time_objects_handler</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">old_minutes</span><span class="o">!=</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">today</span><span class="p">()</span><span class="o">.</span><span class="n">minute</span><span class="p">):</span>  <span class="c">#each minute check</span>
        



        <span class="k">try</span><span class="p">:</span>
          <span class="n">changeWebObjectStatus</span><span class="p">(</span><span class="s">&quot;minutes&quot;</span><span class="p">,</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">today</span><span class="p">()</span><span class="o">.</span><span class="n">minute</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
          <span class="n">changeWebObjectStatus</span><span class="p">(</span><span class="s">&quot;dayTime&quot;</span><span class="p">,</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">today</span><span class="p">()</span><span class="o">.</span><span class="n">minute</span><span class="o">+</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">today</span><span class="p">()</span><span class="o">.</span><span class="n">hour</span><span class="p">)</span><span class="o">*</span><span class="mi">60</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>

          <span class="n">old_hours</span><span class="o">=</span><span class="n">object_dict</span><span class="p">[</span><span class="s">&quot;hours&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">getStatus</span><span class="p">()</span>
          <span class="n">old_day</span><span class="o">=</span><span class="n">object_dict</span><span class="p">[</span><span class="s">&quot;day&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">getStatus</span><span class="p">()</span>
          <span class="n">old_month</span><span class="o">=</span><span class="n">object_dict</span><span class="p">[</span><span class="s">&quot;month&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">getStatus</span><span class="p">()</span>
          <span class="n">old_year</span><span class="o">=</span><span class="n">object_dict</span><span class="p">[</span><span class="s">&quot;year&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">getStatus</span><span class="p">()</span>
          <span class="n">old_dayTime</span><span class="o">=</span><span class="n">object_dict</span><span class="p">[</span><span class="s">&quot;dayTime&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">getStatus</span><span class="p">()</span>  <span class="c">#hours of the day expressed in minutes</span>


          <span class="k">if</span> <span class="p">(</span><span class="n">old_hours</span><span class="o">!=</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">today</span><span class="p">()</span><span class="o">.</span><span class="n">hour</span><span class="p">):</span>
            <span class="c">#os.system(&#39;&#39;&#39;ntpd -q -p 0.openwrt.pool.ntp.org&#39;&#39;&#39;) #update from online time</span>
            <span class="k">with</span> <span class="n">lock_bash_cmd</span><span class="p">:</span>
              <span class="n">subprocess</span><span class="o">.</span><span class="n">check_output</span><span class="p">(</span><span class="s">&#39;&#39;&#39;ntpd -q -p 0.openwrt.pool.ntp.org&#39;&#39;&#39;</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span><span class="n">close_fds</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
            <span class="n">changeWebObjectStatus</span><span class="p">(</span><span class="s">&quot;hours&quot;</span><span class="p">,</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">today</span><span class="p">()</span><span class="o">.</span><span class="n">hour</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>

          <span class="k">if</span> <span class="p">(</span><span class="n">old_day</span><span class="o">!=</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">today</span><span class="p">()</span><span class="o">.</span><span class="n">day</span><span class="p">):</span>
            <span class="n">changeWebObjectStatus</span><span class="p">(</span><span class="s">&quot;day&quot;</span><span class="p">,</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">today</span><span class="p">()</span><span class="o">.</span><span class="n">day</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>

          <span class="k">if</span> <span class="p">(</span><span class="n">old_month</span><span class="o">!=</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">today</span><span class="p">()</span><span class="o">.</span><span class="n">month</span><span class="p">):</span>
            <span class="n">changeWebObjectStatus</span><span class="p">(</span><span class="s">&quot;month&quot;</span><span class="p">,</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">today</span><span class="p">()</span><span class="o">.</span><span class="n">month</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>

          <span class="k">if</span> <span class="p">(</span><span class="n">old_year</span><span class="o">!=</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">today</span><span class="p">()</span><span class="o">.</span><span class="n">year</span><span class="p">):</span>
            <span class="n">changeWebObjectStatus</span><span class="p">(</span><span class="s">&quot;year&quot;</span><span class="p">,</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">today</span><span class="p">()</span><span class="o">.</span><span class="n">year</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>

        <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span> 
          <span class="k">print</span> <span class="s">&quot;error in the time_objects_handler of onosBusThread &quot;</span><span class="o">+</span><span class="s">&quot; e:&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">)</span>
          <span class="n">errorQueue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="s">&quot;error in the time_objects_handler of onosBusThread&quot;</span><span class="o">+</span><span class="s">&quot; e:&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">))</span>    




        <span class="k">global</span> <span class="n">check_log_len_time</span>
    

        <span class="k">if</span> <span class="n">log_enable</span><span class="o">==</span><span class="mi">1</span> <span class="p">:</span>
          <span class="k">if</span> <span class="p">((</span><span class="n">old_dayTime</span><span class="o">-</span><span class="n">check_log_len_time</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">10</span><span class="p">):</span>  <span class="c">#each 10 minutes make a check,</span>

 <span class="c">#    for u in user_active_time_dict.keys(): #check the user login timout</span>

            <span class="n">check_log_len_time</span><span class="o">=</span><span class="n">old_dayTime</span>
            <span class="k">print</span> <span class="s">&quot;check_log_len_time &quot;</span>
            <span class="n">error_phrase</span><span class="o">=</span><span class="s">&quot;error&quot;</span>

            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">getsize</span><span class="p">(</span><span class="n">log_name</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">1000000</span><span class="p">:</span> <span class="c">#if log size &gt; 1 megabyte then save the errors and delete it</span>
              <span class="k">print</span> <span class="s">&quot;i clear the onos log&quot;</span> 
              <span class="c">#os.system(&#39;&#39;&#39;grep -B5 -A5 -P &#39;^&#39;&#39;&#39;+error_phrase+&#39;&#39;&#39;$&#39; &#39;&#39;&#39;+log_name+&#39;&#39;&#39;&gt;&gt;&#39;&#39;&#39;+error_log_name)  #save the 5 line prev and after the line with an error </span>
              <span class="k">with</span> <span class="n">lock_bash_cmd</span><span class="p">:</span>
                <span class="n">subprocess</span><span class="o">.</span><span class="n">check_output</span><span class="p">(</span><span class="s">&#39;&#39;&#39;grep -B5 -A5 -P &#39;^&#39;&#39;&#39;</span><span class="o">+</span><span class="n">error_phrase</span><span class="o">+</span><span class="s">&#39;&#39;&#39;$&#39; &#39;&#39;&#39;</span><span class="o">+</span><span class="n">log_name</span><span class="o">+</span><span class="s">&#39;&#39;&#39;&gt;&gt;&#39;&#39;&#39;</span><span class="o">+</span><span class="n">error_log_name</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span><span class="n">close_fds</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
      <span class="c">#grep -B5 -A5 -P &#39;^5$&#39; filename</span>
              <span class="c">#os.system(&#39;&#39;&#39;echo &quot; &quot; &gt;&#39;&#39;&#39;+log_name) #clear the file</span>
              <span class="k">with</span> <span class="n">lock_bash_cmd</span><span class="p">:</span>
                <span class="n">subprocess</span><span class="o">.</span><span class="n">check_output</span><span class="p">(</span><span class="s">&#39;&#39;&#39;echo &quot; &quot; &gt;&#39;&#39;&#39;</span><span class="o">+</span><span class="n">log_name</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span><span class="n">close_fds</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span> 

    <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span> 
      <span class="k">print</span> <span class="s">&quot;main error in onosBusThread() &quot;</span><span class="o">+</span><span class="s">&quot; e:&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">)</span>
      <span class="n">errorQueue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="s">&quot;main error in onosBusThread()&quot;</span><span class="o">+</span><span class="s">&quot; e:&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">))</span>   








<span class="k">def</span> <span class="nf">nodeTcpServer</span><span class="p">():</span></div>
<div class="viewcode-block" id="nodeTcpServer"><a class="viewcode-back" href="../webserver.html#webserver.nodeTcpServer">[docs]</a>


  <span class="k">while</span> <span class="p">(</span><span class="nb">exit</span><span class="o">==</span><span class="mi">0</span><span class="p">):</span>   <span class="c">#if exit ==1  then close the webserver</span>
    <span class="n">wait_because_node_is_talking</span><span class="o">=</span><span class="mi">0</span>  
    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.2</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="c"># Create a TCP/IP socket</span>
      <span class="n">sock</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_STREAM</span><span class="p">)</span>
      <span class="n">sock</span><span class="o">.</span><span class="n">setsockopt</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">SOL_SOCKET</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SO_REUSEADDR</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
  <span class="c">#    sock.setsockopt(socket.IPPROTO_TCP,socket.TCP_NODELAY, True) #disable_nagle_algorithm&#39;):   #http://pydoc.net/Python/mrs-mapreduce/0.9/mrs.http/  https://aboutsimon.com/index.html%3Fp=85.html</span>

      <span class="n">server_address</span> <span class="o">=</span> <span class="p">(</span><span class="n">onos_center_internal_ip</span><span class="p">,</span> <span class="n">service_webserver_port</span><span class="p">)</span> <span class="c">#stored in globalVar.py</span>
      <span class="k">print</span> <span class="o">&gt;&gt;</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&#39;starting up on </span><span class="si">%s</span><span class="s"> port </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">server_address</span>


      <span class="n">sock</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="n">server_address</span><span class="p">)</span>
      <span class="n">sock</span><span class="o">.</span><span class="n">listen</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

      <span class="c"># Listen for incoming connections</span>

      <span class="n">node_ip</span><span class="o">=</span><span class="s">&quot;&quot;</span>
      <span class="k">while</span> <span class="p">(</span><span class="nb">exit</span><span class="o">==</span><span class="mi">0</span><span class="p">):</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
        <span class="n">wait_because_node_is_talking</span><span class="o">=</span><span class="mi">0</span>  
        <span class="c"># Wait for a connection</span>
        <span class="n">sock</span><span class="o">.</span><span class="n">settimeout</span><span class="p">(</span><span class="mi">480</span><span class="p">)</span> 
       <span class="c"># print &gt;&gt;sys.stderr, &#39;waiting for a connection&#39;</span>
        <span class="k">try</span><span class="p">:</span>
          <span class="n">connection</span><span class="p">,</span> <span class="n">client_address</span> <span class="o">=</span> <span class="n">sock</span><span class="o">.</span><span class="n">accept</span><span class="p">()</span>  
          <span class="n">node_ip</span><span class="o">=</span><span class="n">client_address</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
          <span class="k">print</span> <span class="s">&quot;nodeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeee&quot;</span><span class="p">,</span><span class="n">node_ip</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">e</span>  <span class="p">:</span>
          <span class="k">print</span> <span class="s">&quot;timeout in receiving!!!&quot;</span><span class="p">,</span><span class="n">e</span>
          <span class="k">try</span><span class="p">:</span>
            <span class="n">connection</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">print</span> <span class="s">&quot;connection  closed&quot;</span>    
          <span class="k">except</span><span class="p">:</span>
            <span class="k">print</span> <span class="s">&quot;connection alredy closed&quot;</span>  
          <span class="k">print</span> <span class="s">&quot;error connection, client_address = sock.accept()  in nodeTcpServer()&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">)</span> 
          <span class="n">errorQueue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="s">&quot;error connection, client_address = sock.accept()  in nodeTcpServer()&quot;</span><span class="o">+</span><span class="s">&quot;at:&quot;</span><span class="o">+</span><span class="n">getErrorTimeString</span><span class="p">())</span>   





      
        <span class="k">else</span><span class="p">:</span> <span class="c"># if the try was executed without errors</span>
          <span class="n">received_message</span><span class="o">=</span><span class="s">&quot;&quot;</span>
          <span class="k">try</span><span class="p">:</span>
            <span class="c">#print &gt;&gt;sys.stderr, &#39;connection from&#39;, client_address</span>

          <span class="c"># Receive the data in small chunks and retransmit it</span>
            <span class="n">wait_because_node_is_talking</span><span class="o">=</span><span class="mi">1</span>
            <span class="k">while</span> <span class="p">(</span><span class="nb">exit</span><span class="o">==</span><span class="mi">0</span><span class="p">):</span>

              <span class="n">data</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">1024</span><span class="p">)</span> <span class="c">#accept data till 1024 bytes</span>


              <span class="n">received_message</span><span class="o">=</span><span class="n">received_message</span><span class="o">+</span><span class="n">data</span> 


  
             <span class="c"># print &gt;&gt;sys.stderr, &#39;received &quot;%s&quot;&#39; % data</span>
              <span class="k">if</span> <span class="n">data</span><span class="p">:</span>
                <span class="n">connection</span><span class="o">.</span><span class="n">settimeout</span><span class="p">(</span><span class="mf">2.0</span><span class="p">)</span> 
               <span class="c"># print &gt;&gt;sys.stderr, &#39;sending data back to the client&#39;</span>

                
                <span class="n">msg</span><span class="o">=</span><span class="n">received_message</span>
                <span class="k">if</span> <span class="n">data</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&quot;_#]&quot;</span><span class="p">)</span><span class="o">!=-</span><span class="mi">1</span><span class="p">:</span>   <span class="c"># if the message is completed close the connection</span>
                  <span class="k">print</span> <span class="s">&quot;end line received!!!! ----------------------------------------------------jjuyjytrty&quot;</span>
                  <span class="k">print</span> <span class="s">&quot;received_message:&quot;</span><span class="o">+</span><span class="n">received_message</span>  
<span class="c">#example:  &quot;pinsetup?node_sn=ProminiA0001&amp;fw=4.85_#]&quot;</span>

                  <span class="k">if</span> <span class="n">received_message</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&quot;pinsetup?&quot;</span><span class="p">)</span> <span class="p">:</span>                  
                    <span class="n">node_sn</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s">&#39;sn=(.+?)&amp;&#39;</span><span class="p">,</span><span class="n">received_message</span><span class="p">)</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> 
                    <span class="n">node_fw</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s">&#39;&amp;fw=(.+?)_#&#39;</span><span class="p">,</span><span class="n">received_message</span><span class="p">)</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                    <span class="k">print</span> <span class="s">&quot;node_sn&quot;</span><span class="o">+</span><span class="n">node_sn</span>
                    <span class="k">print</span> <span class="s">&quot;node_fw&quot;</span><span class="o">+</span><span class="n">node_fw</span>
                    <span class="k">print</span> <span class="s">&quot;nodeipfffffffffffffffffffffffffffffffffddddddd&quot;</span><span class="p">,</span><span class="n">node_ip</span>  
                    <span class="n">msg</span><span class="o">=</span><span class="n">createNewNode</span><span class="p">(</span><span class="n">node_sn</span><span class="p">,</span><span class="n">node_ip</span><span class="p">,</span><span class="n">node_fw</span><span class="p">)</span><span class="o">+</span><span class="s">&quot;_#]&quot;</span>
                    <span class="n">connection</span><span class="o">.</span><span class="n">sendall</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>  
                    <span class="n">connection</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>   
                    <span class="n">wait_because_node_is_talking</span><span class="o">=</span><span class="mi">0</span>        
                    <span class="k">break</span>


                  <span class="k">if</span> <span class="n">received_message</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&quot;n_sync?&quot;</span><span class="p">)</span> <span class="p">:</span>                  
                    <span class="n">node_sn</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s">&#39;sn=(.+?)&amp;&#39;</span><span class="p">,</span><span class="n">received_message</span><span class="p">)</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> 
                    <span class="n">node_fw</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s">&#39;&amp;fw=(.+?)_#&#39;</span><span class="p">,</span><span class="n">received_message</span><span class="p">)</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                    <span class="k">print</span> <span class="s">&quot;node_sn&quot;</span><span class="o">+</span><span class="n">node_sn</span>
                    <span class="k">print</span> <span class="s">&quot;node_fw&quot;</span><span class="o">+</span><span class="n">node_fw</span>
                    <span class="k">print</span> <span class="s">&quot;nodeipfffffffffffffffffffffffffffffffffddddddd&quot;</span><span class="p">,</span><span class="n">node_ip</span>  
                    <span class="n">connection</span><span class="o">.</span><span class="n">sendall</span><span class="p">(</span><span class="s">&#39;ok&#39;</span><span class="p">)</span>  
                    <span class="n">connection</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>   
                    <span class="n">msg</span><span class="o">=</span><span class="n">createNewNode</span><span class="p">(</span><span class="n">node_sn</span><span class="p">,</span><span class="n">node_ip</span><span class="p">,</span><span class="n">node_fw</span><span class="p">)</span><span class="o">+</span><span class="s">&quot;_#]&quot;</span> <span class="c">#i call createNewNode just to update the node ip ...</span>
                    <span class="n">wait_because_node_is_talking</span><span class="o">=</span><span class="mi">0</span>
                    <span class="k">break</span>

                  <span class="n">connection</span><span class="o">.</span><span class="n">sendall</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> 
                  <span class="n">connection</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                  <span class="n">wait_because_node_is_talking</span><span class="o">=</span><span class="mi">0</span>
                  <span class="k">break</span>

              <span class="k">else</span><span class="p">:</span>
                <span class="k">print</span> <span class="o">&gt;&gt;</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&#39;no more data from&#39;</span><span class="p">,</span> <span class="n">client_address</span>
                <span class="n">connection</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                <span class="n">wait_because_node_is_talking</span><span class="o">=</span><span class="mi">0</span>
                <span class="k">break</span>
    
          
          <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">e</span>  <span class="p">:</span>
            <span class="k">print</span> <span class="s">&quot;error tcp connection&quot;</span><span class="p">,</span><span class="n">e</span>
    


          <span class="k">finally</span><span class="p">:</span>

            <span class="k">try</span><span class="p">:</span>
              <span class="n">connection</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">except</span><span class="p">:</span>
              <span class="k">print</span> <span class="s">&quot;connection not created2&quot;</span> 



           
        <span class="k">try</span><span class="p">:</span>
        <span class="c"># Clean up the connection, close() is always called, even in the event of an error.</span>
          <span class="n">connection</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">except</span><span class="p">:</span>
          <span class="k">print</span> <span class="s">&quot;connection not created3&quot;</span> 


    <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">e</span>  <span class="p">:</span>
      <span class="k">print</span> <span class="s">&quot;error tcp server thread&quot;</span><span class="p">,</span><span class="n">e</span>
      <span class="n">errorQueue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="s">&quot;error tcp server thread&quot;</span><span class="o">+</span><span class="s">&quot; e:&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">)</span>  <span class="p">)</span> 

    <span class="k">finally</span><span class="p">:</span>

      <span class="k">try</span><span class="p">:</span>
        <span class="n">connection</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
      <span class="k">except</span><span class="p">:</span>
        <span class="k">print</span> <span class="s">&quot;connection not created 4&quot;</span> 


<span class="k">def</span> <span class="nf">run_while_true</span><span class="p">(</span><span class="n">server_class</span><span class="o">=</span><span class="n">BaseHTTPServer</span><span class="o">.</span><span class="n">HTTPServer</span><span class="p">,</span></div>
<div class="viewcode-block" id="run_while_true"><a class="viewcode-back" href="../webserver.html#webserver.run_while_true">[docs]</a>                   <span class="n">handler_class</span><span class="o">=</span><span class="n">RequestHandler</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This assumes that keep_running() is a function of no arguments which</span>
<span class="sd">    is tested initially and after each request.  If its return value</span>
<span class="sd">    is true, the server continues.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">server_address</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;&#39;</span><span class="p">,</span> <span class="n">gui_webserver_port</span><span class="p">)</span>
    <span class="n">httpd</span> <span class="o">=</span> <span class="n">server_class</span><span class="p">(</span><span class="n">server_address</span><span class="p">,</span> <span class="n">MyHandler</span><span class="p">)</span>

    <span class="k">while</span> <span class="nb">exit</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>   <span class="c">#if exit ==1  then close the webserver</span>

<span class="c">#main loop of the webserver</span>
      <span class="k">print</span> <span class="s">&quot;main webserver &quot;</span>

      <span class="k">try</span><span class="p">:</span>
        <span class="n">httpd</span><span class="o">.</span><span class="n">handle_request</span><span class="p">()</span> 
      <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">print</span> <span class="s">&quot;something went wrong on main Webserver handler &quot;</span><span class="o">+</span><span class="s">&quot; e:&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">)</span>       
        <span class="n">errorQueue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="s">&quot;something went wrong on main Webserver handler &quot;</span><span class="o">+</span><span class="s">&quot; e:&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">)</span>  <span class="p">)</span>      

<span class="k">def</span> <span class="nf">main</span><span class="p">():</span></div>
<div class="viewcode-block" id="main"><a class="viewcode-back" href="../webserver.html#webserver.main">[docs]</a>    <span class="k">global</span> <span class="nb">exit</span>
    <span class="k">try</span><span class="p">:</span>
        
        <span class="c">#server = HTTPServer((&#39;&#39;, 80), MyHandler)</span>
        <span class="k">print</span> <span class="s">&#39;started httpserver...&#39;</span>




        <span class="n">bus</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">onosBusThread</span><span class="p">)</span>
        <span class="n">bus</span><span class="o">.</span><span class="n">daemon</span> <span class="o">=</span> <span class="bp">True</span>  <span class="c">#make the thread a daemon thread</span>
        <span class="n">bus</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

        <span class="n">w2</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">nodeTcpServer</span><span class="p">)</span>
        <span class="n">w2</span><span class="o">.</span><span class="n">daemon</span> <span class="o">=</span> <span class="bp">True</span>  <span class="c">#make the thread a daemon thread</span>
        <span class="n">w2</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

        <span class="n">w1</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">hardwareHandlerThread</span><span class="p">)</span>
        <span class="n">w1</span><span class="o">.</span><span class="n">daemon</span> <span class="o">=</span> <span class="bp">True</span>  <span class="c">#make the thread a daemon thread</span>
        <span class="n">w1</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

        <span class="n">run_while_true</span><span class="p">()</span>



    <span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span>
         <span class="c">#updateJson(object_dict,zoneDict)</span>
        <span class="k">print</span> <span class="s">&#39;^C received, shutting down server&#39;</span>

        <span class="n">hardware</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="nb">exit</span><span class="o">=</span><span class="mi">1</span>
        <span class="n">server</span><span class="o">.</span><span class="n">socket</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&#39;__main__&#39;</span><span class="p">:</span></div>
    <span class="n">main</span><span class="p">()</span>
</pre></div>

          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2016, Author.
    </p>
  </div>

  <a href="https://github.com/snide/sphinx_rtd_theme">Sphinx theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>
</footer>
        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../',
            VERSION:'',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true
        };
    </script>
      <script type="text/javascript" src="../_static/jquery.js"></script>
      <script type="text/javascript" src="../_static/underscore.js"></script>
      <script type="text/javascript" src="../_static/doctools.js"></script>

  

  
  
    <script type="text/javascript" src="../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>